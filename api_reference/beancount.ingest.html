<!DOCTYPE html>

<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://xuhcc.github.io/beancount-docs/api_reference/beancount.ingest.html" rel="canonical"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>beancount.ingest - Beancount Documentation</title>
<link href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet">
<link href="../css/theme.css" rel="stylesheet">
<link href="../css/theme_extra.css" rel="stylesheet"/>
<link href="../css/custom.css" rel="stylesheet"/>
<script>
    // Current page data
    var mkdocs_page_name = "beancount.ingest";
    var mkdocs_page_input_path = "api_reference/beancount.ingest.md";
    var mkdocs_page_url = "/beancount-docs/api_reference/beancount.ingest.html";
  </script>
<script defer="" src="../js/jquery-2.1.1.min.js"></script>
<script defer="" src="../js/modernizr-2.8.3.min.js"></script>
</link></link></head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href=".."> Beancount Documentation</a>
</div>
<div aria-label="main navigation" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Index</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Outline</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="#">Documentation for Users</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../01_command_line_accounting_in_context.html">Command Line Accounting in Context</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../02_the_double_entry_counting_method.html">The Double Entry Counting Method</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../03_installing_beancount.html">Installing Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../04_running_beancount_and_generating_reports.html">Running Beancount and Generating Reports</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../05_getting_started_with_beancount.html">Getting Started with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../06_beancount_language_syntax.html">Beancount Language Syntax</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../07_beancount_options_reference.html">Beancount Options Reference</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../08_precision_tolerances.html">Precision Tolerances</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../09_beancount_query_language.html">Beancount Query Language</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../10_beancount_cheat_sheet.html">Beancount Cheat Sheet</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../11_how_inventories_work.html">How Inventories Work</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../12_exporting_your_portfolio.html">Exporting Your Portfolio</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../13_tutorial_example.html">Tutorial &amp; Example</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../14_beancount_history_and_credits.html">Beancount History and Credits</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../15_a_comparison_of_beancount_and_ledger_hledger.html">A Comparison of Beancount and Ledger Hledger</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../16_fetching_prices_in_beancount.html">Fetching Prices in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../17_importing_external_data.html">Importing External Data</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Cookbooks &amp; Examples</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../18_command_line_accounting_cookbook.html">Command Line Accounting Cookbook</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../19_trading_with_beancount.html">Trading with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../20_stock_vesting_in_beancount.html">Stock Vesting in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../21_sharing_expenses_with_beancount.html">Sharing Expenses with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../22_how_we_share_expenses.html">How We Share Expenses</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Documentation for Developers</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../23_beancount_scripting_plugins.html">Beancount Scripting Plugins</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../24_beancount_design_doc.html">Beancount Design Doc</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../25_ledgerhub_design_doc.html">Ledgerhub Design Doc</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../26_external_contributions.html">External Contributions</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Enhancement Proposals &amp; Discussions</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../27_a_proposal_for_an_improvement_on_inventory_booking.html">A Proposal for an Improvement on Inventory Booking</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../28_settlement_dates_in_beancount.html">Settlement Dates in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../29_balance_assertions_in_beancount.html">Balance Assertions in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../30_fund_accounting_with_beancount.html">Fund Accounting with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../31_rounding_precision_in_beancount.html">Rounding Precision in Beancount</a>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">beancount</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.core.html">beancount.core</a>
</li>
<li class="toctree-l1 current"><a class="reference internal current" href="beancount.ingest.html">beancount.ingest</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest">beancount.ingest</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.cache">cache</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.cache.contents">contents()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.cache.get_file">get_file()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.cache.head">head()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.cache.mimetype">mimetype()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.extract">extract</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.extract.add_arguments">add_arguments()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.extract.extract">extract()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.extract.extract_from_file">extract_from_file()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.extract.find_duplicate_entries">find_duplicate_entries()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.extract.print_extracted_entries">print_extracted_entries()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.extract.run">run()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.extract_test">extract_test</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.extract_test.TestPrintExtractedEntries">TestPrintExtractedEntries</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.extract_test.TestPrintExtractedEntries.ExtractTestImporter">ExtractTestImporter</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.extract_test.TestScriptExtract">TestScriptExtract</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.extract_test.TestScriptExtract.setUp">setUp()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.file">file</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.file.add_arguments">add_arguments()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.file.file">file()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.file.file_one_file">file_one_file()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.file.move_xdev_file">move_xdev_file()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.file.run">run()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.file_test">file_test</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.file_test.TestScriptFile">TestScriptFile</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.file_test.TestScriptFile.setUp">setUp()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.file_test.TestScriptFile.tearDown">tearDown()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.identify">identify</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.identify.add_arguments">add_arguments()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.identify.find_imports">find_imports()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.identify.identify">identify()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.identify.run">run()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.importer">importer</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.importer.ImporterProtocol">ImporterProtocol</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importer.ImporterProtocol.__str__">__str__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importer.ImporterProtocol.extract">extract()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importer.ImporterProtocol.file_account">file_account()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importer.ImporterProtocol.file_date">file_date()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importer.ImporterProtocol.file_name">file_name()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importer.ImporterProtocol.identify">identify()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importer.ImporterProtocol.name">name()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.importers">importers</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.importers.config">config</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.config.ConfigImporterMixin">ConfigImporterMixin</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.importers.config_test">config_test</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.config_test.TestConfigMixin">TestConfigMixin</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.importers.csv">csv</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.csv.Col">Col</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.csv.Importer">Importer</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.csv.get_amounts">get_amounts()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.csv.normalize_config">normalize_config()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.importers.fileonly">fileonly</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.fileonly.Importer">Importer</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.importers.mixins">mixins</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.mixins.config">config</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.mixins.filing">filing</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.mixins.identifier">identifier</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.importers.ofx">ofx</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.ofx.BalanceType">BalanceType</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.ofx.Importer">Importer</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.ofx.build_transaction">build_transaction()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.ofx.extract">extract()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.ofx.find_acctids">find_acctids()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.ofx.find_child">find_child()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.ofx.find_currency">find_currency()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.ofx.find_max_date">find_max_date()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.ofx.find_statement_transactions">find_statement_transactions()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.ofx.parse_ofx_time">parse_ofx_time()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.importers.ofx_test">ofx_test</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.importers.ofx_test.clean_xml">clean_xml()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.regression">regression</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.regression.ImportFileTestCase">ImportFileTestCase</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.regression.ImportFileTestCase.test_expect_extract">test_expect_extract()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.regression.ImportFileTestCase.test_expect_file_date">test_expect_file_date()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.regression.ImportFileTestCase.test_expect_file_name">test_expect_file_name()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.regression.ImportFileTestCase.test_expect_identify">test_expect_identify()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.regression.ToolNotInstalled">ToolNotInstalled</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.regression.compare_sample_files">compare_sample_files()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.regression.find_input_files">find_input_files()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.regression_pytest">regression_pytest</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.regression_pytest.ImporterTestBase">ImporterTestBase</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.regression_pytest.ImporterTestBase.test_extract">test_extract()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.regression_pytest.ImporterTestBase.test_file_account">test_file_account()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.regression_pytest.ImporterTestBase.test_file_date">test_file_date()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.regression_pytest.ImporterTestBase.test_file_name">test_file_name()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.regression_pytest.ImporterTestBase.test_identify">test_identify()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.regression_pytest.compare_contents_or_generate">compare_contents_or_generate()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.regression_pytest.find_input_files">find_input_files()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.regression_pytest.pytest_addoption">pytest_addoption()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.regression_pytest.with_importer">with_importer()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.regression_pytest.with_testdir">with_testdir()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.regression_test">regression_test</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.scripts_utils">scripts_utils</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.scripts_utils.TestScriptsBase">TestScriptsBase</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.scripts_utils.TestScriptsBase.setUp">setUp()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.scripts_utils.create_legacy_arguments_parser">create_legacy_arguments_parser()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.scripts_utils.ingest">ingest()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.scripts_utils.run_import_script_and_ingest">run_import_script_and_ingest()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.scripts_utils.trampoline_to_ingest">trampoline_to_ingest()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.similar">similar</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.similar.SimilarityComparator">SimilarityComparator</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.similar.SimilarityComparator.__call__">__call__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.similar.SimilarityComparator.__init__">__init__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.similar.amounts_map">amounts_map()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.similar.find_similar_entries">find_similar_entries()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ingest.similar_test">similar_test</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ingest.similar_test.TestSimilarityComparator">TestSimilarityComparator</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ingest.similar_test.TestSimilarityComparator.setUp">setUp()</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.loader.html">beancount.loader</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.ops.html">beancount.ops</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.parser.html">beancount.parser</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.plugins.html">beancount.plugins</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.prices.html">beancount.prices</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.query.html">beancount.query</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.reports.html">beancount.reports</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.scripts.html">beancount.scripts</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.utils.html">beancount.utils</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.web.html">beancount.web</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="top navigation" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="..">Beancount Documentation</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a href="..">Docs</a> »</li>
<li>API reference »</li>
<li>beancount.ingest</li>
<li class="wy-breadcrumbs-aside">
<a class="icon icon-github" href="https://github.com/xuhcc/beancount-docs/edit/master/docs/api_reference/beancount.ingest.md"> Edit on GitHub</a>
</li>
</ul>
<hr/>
</div>
<div role="main">
<div class="section">
<h1 id="beancountingest">beancount.ingest<a class="headerlink" href="#beancountingest" title="Permanent link"></a></h1>
<div class="doc doc-object doc-module">
<h2 class="hidden-toc" href="#beancount.ingest" id="beancount.ingest" style="visibility: hidden; width: 0; height: 0;">
<a class="headerlink" href="#beancount.ingest" title="Permanent link"></a></h2>
<div class="doc doc-contents first">
<p>Code to help identify, extract, and file external downloads.</p>
<p>This packages contains code to help you build importers and drive the process of
identifying which importer to run on an externally downloaded file, extract
transactions from them and file away these files under a clean and rigidly named
hierarchy for preservation.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.cache">
<code>cache</code>
<a class="headerlink" href="#beancount.ingest.cache" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>A file wrapper which acts as a cache for on-demand evaluation of conversions.</p>
<p>This object is used in lieu of a file in order to allow the various importers to
reuse each others' conversion results. Converting file contents, e.g. PDF to
text, can be expensive.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.cache.contents">
<code class="highlight language-python">
contents<span class="p">(</span><span class="n">filename</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.cache.contents" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>A converter that just reads the entire contents of a file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>num_bytes</code></td>
<td><code></code></td>
<td>
<p>The number of bytes to read.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A converter function.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/cache.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">contents</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">"""A converter that just reads the entire contents of a file.</span>

<span class="sd">    Args:</span>
<span class="sd">      num_bytes: The number of bytes to read.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A converter function.</span>
<span class="sd">    """</span>
    <span class="c1"># Attempt to detect the input encoding automatically, using chardet and a</span>
    <span class="c1"># decent amount of input.</span>
    <span class="n">rawdata</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">HEAD_DETECT_MAX_BYTES</span><span class="p">)</span>
    <span class="n">detected</span> <span class="o">=</span> <span class="n">chardet</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">rawdata</span><span class="p">)</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">detected</span><span class="p">[</span><span class="s1">'encoding'</span><span class="p">]</span>

    <span class="c1"># Ignore encoding errors for reading the contents because input files</span>
    <span class="c1"># routinely break this assumption.</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="s1">'ignore'</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.cache.get_file">
<code class="highlight language-python">
get_file<span class="p">(</span><span class="n">filename</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.cache.get_file" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Create or reuse a globally registered instance of a FileMemo.</p>
<p>Note: the FileMemo objects' lifetimes are reused for the duration of the
process. This is usually the intended behavior. Always create them by
calling this constructor.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>filename</code></td>
<td><code></code></td>
<td>
<p>A path string, the absolute name of the file whose memo to create.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A FileMemo instance.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/cache.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">"""Create or reuse a globally registered instance of a FileMemo.</span>

<span class="sd">    Note: the FileMemo objects' lifetimes are reused for the duration of the</span>
<span class="sd">    process. This is usually the intended behavior. Always create them by</span>
<span class="sd">    calling this constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename: A path string, the absolute name of the file whose memo to create.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A FileMemo instance.</span>

<span class="sd">    """</span>
    <span class="k">assert</span> <span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="p">(</span>
        <span class="s2">"Path should be absolute in order to guarantee a single call."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_CACHE</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.cache.head">
<code class="highlight language-python">
head<span class="p">(</span><span class="n">num_bytes</span><span class="o">=</span><span class="mi">8192</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.cache.head" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>A converter that just reads the first bytes of a file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>num_bytes</code></td>
<td><code></code></td>
<td>
<p>The number of bytes to read.</p>
</td>
<td><code>8192</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A converter function.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/cache.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>79
80
81
82
83
84
85
86
87
88
89
90
91
92
93</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="n">num_bytes</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>
    <span class="sd">"""A converter that just reads the first bytes of a file.</span>

<span class="sd">    Args:</span>
<span class="sd">      num_bytes: The number of bytes to read.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A converter function.</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="nf">head_reader</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">rawdata</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">num_bytes</span><span class="p">)</span>
            <span class="n">detected</span> <span class="o">=</span> <span class="n">chardet</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">rawdata</span><span class="p">)</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">detected</span><span class="p">[</span><span class="s1">'encoding'</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">rawdata</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">head_reader</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.cache.mimetype">
<code class="highlight language-python">
mimetype<span class="p">(</span><span class="n">filename</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.cache.mimetype" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>A converter that computes the MIME type of the file.</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A converter function.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/cache.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>70
71
72
73
74
75
76</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">mimetype</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">"""A converter that computes the MIME type of the file.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A converter function.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">file_type</span><span class="o">.</span><span class="n">guess_file_type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.extract">
<code>extract</code>
<a class="headerlink" href="#beancount.ingest.extract" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Extract script.</p>
<p>Read an import script and a list of downloaded filenames or directories of
downloaded files, and for each of those files, extract transactions from it.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.extract.add_arguments">
<code class="highlight language-python">
add_arguments<span class="p">(</span><span class="n">parser</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.extract.add_arguments" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Add arguments for the extract command.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/extract.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>224
225
226
227
228
229
230
231
232
233
234
235</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="sd">"""Add arguments for the extract command."""</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-e'</span><span class="p">,</span> <span class="s1">'-f'</span><span class="p">,</span> <span class="s1">'--existing'</span><span class="p">,</span> <span class="s1">'--previous'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">'BEANCOUNT_FILE'</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">'Beancount file or existing entries for de-duplication '</span>
                              <span class="s1">'(optional)'</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-r'</span><span class="p">,</span> <span class="s1">'--reverse'</span><span class="p">,</span> <span class="s1">'--descending'</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s1">'store_const'</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">'ascending'</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'Write out the entries in descending order'</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.extract.extract">
<code class="highlight language-python">
extract<span class="p">(</span><span class="n">importer_config</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">entries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mindate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detect_duplicates_func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.extract.extract" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Given an importer configuration, search for files that can be imported in the
list of files or directories, run the signature checks on them, and if it
succeeds, run the importer on the file.</p>
<p>A list of entries for an existing ledger can be provided in order to perform
de-duplication and a minimum date can be provided to filter out old entries.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>importer_config</code></td>
<td><code></code></td>
<td>
<p>A list of (regexps, importer) pairs, the configuration.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>files_or_directories</code></td>
<td><code></code></td>
<td>
<p>A list of strings, filenames or directories to be processed.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>output</code></td>
<td><code></code></td>
<td>
<p>A file object, to be written to.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives loaded from the existing file for the newly
extracted entries to be merged in.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>The options parsed from existing file.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>mindate</code></td>
<td><code></code></td>
<td>
<p>Optional minimum date to output transactions for.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>ascending</code></td>
<td><code></code></td>
<td>
<p>A boolean, true to print entries in ascending order, false if
descending is desired.</p>
</td>
<td><code>True</code></td>
</tr>
<tr>
<td><code>detect_duplicates_func</code></td>
<td><code></code></td>
<td>
<p>An optional function which accepts a list of
lists of imported entries and a list of entries already existing in
the user's ledger. See function find_duplicate_entries(), which is the
default implementation for this.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/extract.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="n">importer_config</span><span class="p">,</span>
            <span class="n">files_or_directories</span><span class="p">,</span>
            <span class="n">output</span><span class="p">,</span>
            <span class="n">entries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">options_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mindate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">detect_duplicates_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Given an importer configuration, search for files that can be imported in the</span>
<span class="sd">    list of files or directories, run the signature checks on them, and if it</span>
<span class="sd">    succeeds, run the importer on the file.</span>

<span class="sd">    A list of entries for an existing ledger can be provided in order to perform</span>
<span class="sd">    de-duplication and a minimum date can be provided to filter out old entries.</span>

<span class="sd">    Args:</span>
<span class="sd">      importer_config: A list of (regexps, importer) pairs, the configuration.</span>
<span class="sd">      files_or_directories: A list of strings, filenames or directories to be processed.</span>
<span class="sd">      output: A file object, to be written to.</span>
<span class="sd">      entries: A list of directives loaded from the existing file for the newly</span>
<span class="sd">        extracted entries to be merged in.</span>
<span class="sd">      options_map: The options parsed from existing file.</span>
<span class="sd">      mindate: Optional minimum date to output transactions for.</span>
<span class="sd">      ascending: A boolean, true to print entries in ascending order, false if</span>
<span class="sd">        descending is desired.</span>
<span class="sd">      detect_duplicates_func: An optional function which accepts a list of</span>
<span class="sd">        lists of imported entries and a list of entries already existing in</span>
<span class="sd">        the user's ledger. See function find_duplicate_entries(), which is the</span>
<span class="sd">        default implementation for this.</span>
<span class="sd">    """</span>
    <span class="n">allow_none_for_tags_and_links</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">options_map</span> <span class="ow">and</span> <span class="n">options_map</span><span class="p">[</span><span class="s2">"allow_deprecated_none_for_tags_and_links"</span><span class="p">])</span>

    <span class="c1"># Run all the importers and gather their result sets.</span>
    <span class="n">new_entries_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">importers</span> <span class="ow">in</span> <span class="n">identify</span><span class="o">.</span><span class="n">find_imports</span><span class="p">(</span><span class="n">importer_config</span><span class="p">,</span>
                                                     <span class="n">files_or_directories</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">importer</span> <span class="ow">in</span> <span class="n">importers</span><span class="p">:</span>
            <span class="c1"># Import and process the file.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_entries</span> <span class="o">=</span> <span class="n">extract_from_file</span><span class="p">(</span>
                    <span class="n">filename</span><span class="p">,</span>
                    <span class="n">importer</span><span class="p">,</span>
                    <span class="n">existing_entries</span><span class="o">=</span><span class="n">entries</span><span class="p">,</span>
                    <span class="n">min_date</span><span class="o">=</span><span class="n">mindate</span><span class="p">,</span>
                    <span class="n">allow_none_for_tags_and_links</span><span class="o">=</span><span class="n">allow_none_for_tags_and_links</span><span class="p">)</span>
                <span class="n">new_entries_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filename</span><span class="p">,</span> <span class="n">new_entries</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Importer </span><span class="si">%s</span><span class="s2">.extract() raised an unexpected error: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span>
                              <span class="n">importer</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">exc</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Traceback: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="k">continue</span>

    <span class="c1"># Find potential duplicate entries in the result sets, either against the</span>
    <span class="c1"># list of existing ones, or against each other. A single call to this</span>
    <span class="c1"># function is made on purpose, so that the function be able to merge</span>
    <span class="c1"># entries.</span>
    <span class="k">if</span> <span class="n">detect_duplicates_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">detect_duplicates_func</span> <span class="o">=</span> <span class="n">find_duplicate_entries</span>
    <span class="n">new_entries_list</span> <span class="o">=</span> <span class="n">detect_duplicates_func</span><span class="p">(</span><span class="n">new_entries_list</span><span class="p">,</span> <span class="n">entries</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_entries_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">new_entries</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">for</span> <span class="n">new_entries</span> <span class="ow">in</span> <span class="n">new_entries_list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">new_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">new_entries</span> <span class="ow">in</span> <span class="n">new_entries_list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">new_entries</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">new_entries</span> <span class="ow">in</span> <span class="n">new_entries_list</span><span class="p">)</span>

    <span class="c1"># Print out the results.</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">HEADER</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">new_entries</span> <span class="ow">in</span> <span class="n">new_entries_list</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">identify</span><span class="o">.</span><span class="n">SECTION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ascending</span><span class="p">:</span>
            <span class="n">new_entries</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">print_extracted_entries</span><span class="p">(</span><span class="n">new_entries</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.extract.extract_from_file">
<code class="highlight language-python">
extract_from_file<span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span> <span class="n">existing_entries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_none_for_tags_and_links</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.extract.extract_from_file" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Import entries from file 'filename' with the given matches,</p>
<p>Also cross-check against a list of provided 'existing_entries' entries,
de-duplicating and possibly auto-categorizing.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>filename</code></td>
<td><code></code></td>
<td>
<p>The name of the file to import.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>importer</code></td>
<td><code></code></td>
<td>
<p>An importer object that matched the file.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>existing_entries</code></td>
<td><code></code></td>
<td>
<p>A list of existing entries parsed from a ledger, used to
detect duplicates and automatically complete or categorize transactions.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>min_date</code></td>
<td><code></code></td>
<td>
<p>A date before which entries should be ignored. This is useful
when an account has a valid check/assert; we could just ignore whatever
comes before, if desired.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>allow_none_for_tags_and_links</code></td>
<td><code></code></td>
<td>
<p>A boolean, whether to allow plugins to
generate Transaction objects with None as value for the 'tags' or 'links'
attributes.</p>
</td>
<td><code>False</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new imported entries.</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Exception</code></td>
<td>
<p>If there is an error in the importer's extract() method.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/extract.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">extract_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span>
                      <span class="n">existing_entries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">min_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">allow_none_for_tags_and_links</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Import entries from file 'filename' with the given matches,</span>

<span class="sd">    Also cross-check against a list of provided 'existing_entries' entries,</span>
<span class="sd">    de-duplicating and possibly auto-categorizing.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename: The name of the file to import.</span>
<span class="sd">      importer: An importer object that matched the file.</span>
<span class="sd">      existing_entries: A list of existing entries parsed from a ledger, used to</span>
<span class="sd">        detect duplicates and automatically complete or categorize transactions.</span>
<span class="sd">      min_date: A date before which entries should be ignored. This is useful</span>
<span class="sd">        when an account has a valid check/assert; we could just ignore whatever</span>
<span class="sd">        comes before, if desired.</span>
<span class="sd">      allow_none_for_tags_and_links: A boolean, whether to allow plugins to</span>
<span class="sd">        generate Transaction objects with None as value for the 'tags' or 'links'</span>
<span class="sd">        attributes.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new imported entries.</span>
<span class="sd">    Raises:</span>
<span class="sd">      Exception: If there is an error in the importer's extract() method.</span>
<span class="sd">    """</span>
    <span class="c1"># Extract the entries.</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Note: Let the exception through on purpose. This makes developing</span>
    <span class="c1"># importers much easier by rendering the details of the exceptions.</span>
    <span class="c1">#</span>
    <span class="c1"># Note: For legacy support, support calling without the existing entries.</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">'existing_entries'</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">importer</span><span class="o">.</span><span class="n">extract</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">'existing_entries'</span><span class="p">]</span> <span class="o">=</span> <span class="n">existing_entries</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_entries</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Make sure the newly imported entries are sorted; don't trust the importer.</span>
    <span class="n">new_entries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">entry_sortkey</span><span class="p">)</span>

    <span class="c1"># Ensure that the entries are typed correctly.</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">new_entries</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">sanity_check_types</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">allow_none_for_tags_and_links</span><span class="p">)</span>

    <span class="c1"># Filter out entries with dates before 'min_date'.</span>
    <span class="k">if</span> <span class="n">min_date</span><span class="p">:</span>
        <span class="n">new_entries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">dropwhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">min_date</span><span class="p">,</span>
                                               <span class="n">new_entries</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">new_entries</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.extract.find_duplicate_entries">
<code class="highlight language-python">
find_duplicate_entries<span class="p">(</span><span class="n">new_entries_list</span><span class="p">,</span> <span class="n">existing_entries</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.extract.find_duplicate_entries" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Flag potentially duplicate entries.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>new_entries_list</code></td>
<td><code></code></td>
<td>
<p>A list of pairs of (key, lists of imported entries), one
for each importer. The key identifies the filename and/or importer that
yielded those new entries.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>existing_entries</code></td>
<td><code></code></td>
<td>
<p>A list of previously existing entries from the target
ledger.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of lists of modified new entries (like new_entries_list),
potentially with modified metadata to indicate those which are duplicated.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/extract.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_duplicate_entries</span><span class="p">(</span><span class="n">new_entries_list</span><span class="p">,</span> <span class="n">existing_entries</span><span class="p">):</span>
    <span class="sd">"""Flag potentially duplicate entries.</span>

<span class="sd">    Args:</span>
<span class="sd">      new_entries_list: A list of pairs of (key, lists of imported entries), one</span>
<span class="sd">        for each importer. The key identifies the filename and/or importer that</span>
<span class="sd">        yielded those new entries.</span>
<span class="sd">      existing_entries: A list of previously existing entries from the target</span>
<span class="sd">        ledger.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of lists of modified new entries (like new_entries_list),</span>
<span class="sd">      potentially with modified metadata to indicate those which are duplicated.</span>
<span class="sd">    """</span>
    <span class="n">mod_entries_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">new_entries</span> <span class="ow">in</span> <span class="n">new_entries_list</span><span class="p">:</span>
        <span class="c1"># Find similar entries against the existing ledger only.</span>
        <span class="n">duplicate_pairs</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">find_similar_entries</span><span class="p">(</span><span class="n">new_entries</span><span class="p">,</span> <span class="n">existing_entries</span><span class="p">)</span>

        <span class="c1"># Add a metadata marker to the extracted entries for duplicates.</span>
        <span class="n">duplicate_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">duplicate_pairs</span><span class="p">)</span>
        <span class="n">mod_entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">new_entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="ow">in</span> <span class="n">duplicate_set</span><span class="p">:</span>
                <span class="n">marked_meta</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">marked_meta</span><span class="p">[</span><span class="n">DUPLICATE_META</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">marked_meta</span><span class="p">)</span>
            <span class="n">mod_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="n">mod_entries_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">mod_entries</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mod_entries_list</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.extract.print_extracted_entries">
<code class="highlight language-python">
print_extracted_entries<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.extract.print_extracted_entries" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Print a list of entries.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of extracted entries.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>file</code></td>
<td><code></code></td>
<td>
<p>A file object to write to.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/extract.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">print_extracted_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="sd">"""Print a list of entries.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of extracted entries.</span>
<span class="sd">      file: A file object to write to.</span>
<span class="sd">    """</span>
    <span class="c1"># Print the filename and which modules matched.</span>
    <span class="c1"># pylint: disable=invalid-name</span>
    <span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
    <span class="n">pr</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>

    <span class="c1"># Print out the entries.</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="c1"># Check if this entry is a dup, and if so, comment it out.</span>
        <span class="k">if</span> <span class="n">DUPLICATE_META</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">DUPLICATE_META</span><span class="p">)</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>
            <span class="n">entry_string</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">printer</span><span class="o">.</span><span class="n">format_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">),</span> <span class="s1">'; '</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entry_string</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">format_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="n">pr</span><span class="p">(</span><span class="n">entry_string</span><span class="p">)</span>

    <span class="n">pr</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.extract.run">
<code class="highlight language-python">
run<span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">importers_list</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">,</span> <span class="n">detect_duplicates_func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.extract.run" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Run the subcommand.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/extract.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">importers_list</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">,</span> <span class="n">detect_duplicates_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Run the subcommand."""</span>

    <span class="c1"># Load the ledger, if one is specified.</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">existing</span><span class="p">:</span>
        <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">options_map</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">existing</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">extract</span><span class="p">(</span><span class="n">importers_list</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
            <span class="n">entries</span><span class="o">=</span><span class="n">entries</span><span class="p">,</span>
            <span class="n">options_map</span><span class="o">=</span><span class="n">options_map</span><span class="p">,</span>
            <span class="n">mindate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ascending</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ascending</span><span class="p">,</span>
            <span class="n">detect_duplicates_func</span><span class="o">=</span><span class="n">detect_duplicates_func</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.extract_test">
<code>extract_test</code>
<a class="headerlink" href="#beancount.ingest.extract_test" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ingest.extract_test.TestPrintExtractedEntries">
<code>TestPrintExtractedEntries</code>
<a class="headerlink" href="#beancount.ingest.extract_test.TestPrintExtractedEntries" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.ingest.extract_test.TestPrintExtractedEntries.ExtractTestImporter">
<code>ExtractTestImporter</code>
<a class="headerlink" href="#beancount.ingest.extract_test.TestPrintExtractedEntries.ExtractTestImporter" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.ingest.extract_test.TestPrintExtractedEntries.ExtractTestImporter.file_account">
<code class="highlight language-python">
file_account<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.extract_test.TestPrintExtractedEntries.ExtractTestImporter.file_account" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Return an account associated with the given file.</p>
<p>Note: If you don't implement this method you won't be able to move the
files into its preservation hierarchy; the bean-file command won't
work.</p>
<p>Also, normally the returned account is not a function of the input
file--just of the importer--but it is provided anyhow.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>file</code></td>
<td><code></code></td>
<td>
<p>A cache.FileMemo instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>The name of the account that corresponds to this importer.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/extract_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>169
170</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">file_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">'Assets:Account1'</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ingest.extract_test.TestScriptExtract">
<code>TestScriptExtract</code>
<a class="headerlink" href="#beancount.ingest.extract_test.TestScriptExtract" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.extract_test.TestScriptExtract.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.extract_test.TestScriptExtract.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/extract_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span> <span class="s1">'extract.import'</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">"""</span><span class="se">\</span>
<span class="s2">          #!/usr/bin/env python3</span>
<span class="s2">          from beancount.ingest import extract_test</span>
<span class="s2">          CONFIG = [</span>
<span class="s2">            extract_test._LoaderImporter('checking.dl', 'Assets:Checking'),</span>
<span class="s2">            extract_test._LoaderImporter('credit.dl', 'Liabilities:CreditCard'),</span>
<span class="s2">          ]</span>
<span class="s2">        """</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">downloads</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span> <span class="s1">'Downloads'</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downloads</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">dl_checking</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downloads</span><span class="p">,</span> <span class="s1">'checking.dl'</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_checking</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">"""</span><span class="se">\</span>

<span class="s2">          plugin "beancount.plugins.auto_accounts"</span>

<span class="s2">          2016-06-08 * "Withdrawal"</span>
<span class="s2">            Assets:Checking           -300.00 USD</span>
<span class="s2">            Assets:Cash</span>

<span class="s2">          2016-06-10 * "Electricity"</span>
<span class="s2">            Assets:Checking            -48.34 USD</span>
<span class="s2">            Expenses:Electricity</span>

<span class="s2">          2016-06-14 * "Internet"</span>
<span class="s2">            Assets:Checking            -48.34 USD</span>
<span class="s2">            Expenses:Internet</span>

<span class="s2">        """</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">dl_credit</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downloads</span><span class="p">,</span> <span class="s1">'credit.dl'</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_credit</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">"""</span><span class="se">\</span>

<span class="s2">          plugin "beancount.plugins.auto_accounts"</span>

<span class="s2">          2016-06-04 * "Drinks"</span>
<span class="s2">            Liabilities:CreditCard     -32.23 USD</span>
<span class="s2">            Expenses:Alcohol</span>

<span class="s2">          2016-06-07 * "Books"</span>
<span class="s2">            Liabilities:CreditCard     -87.30 USD</span>
<span class="s2">            Expenses:Books</span>

<span class="s2">          2016-06-10 * "Clothing"</span>
<span class="s2">            Liabilities:CreditCard     -87.30 USD</span>
<span class="s2">            Expenses:Clothing</span>

<span class="s2">        """</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.file">
<code>file</code>
<a class="headerlink" href="#beancount.ingest.file" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Filing script.</p>
<p>Read an import script and a list of downloaded filenames or directories of
downloaded files, and for each of those files, move the file under an account
corresponding to the filing directory.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.file.add_arguments">
<code class="highlight language-python">
add_arguments<span class="p">(</span><span class="n">parser</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.file.add_arguments" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Add arguments for the extract command.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/file.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>265
266
267
268
269
270
271
272
273
274
275
276
277
278</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="sd">"""Add arguments for the extract command."""</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-o'</span><span class="p">,</span> <span class="s1">'--output'</span><span class="p">,</span> <span class="s1">'--output-dir'</span><span class="p">,</span> <span class="s1">'--destination'</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s1">'output_dir'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"The root of the documents tree to move the files to."</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-n'</span><span class="p">,</span> <span class="s1">'--dry-run'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">"Just print where the files would be moved; "</span>
                              <span class="s2">"don't actually move them."</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--no-overwrite'</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">'overwrite'</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s1">'store_false'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"Don't overwrite destination files with the same name."</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.file.file">
<code class="highlight language-python">
file<span class="p">(</span><span class="n">importer_config</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mkdirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">idify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.file.file" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>File importable files under a destination directory.</p>
<p>Given an importer configuration object, search for files that can be
imported under the given list of files or directories and moved them under
the given destination directory with the date computed by the module
prepended to the filename. If the date cannot be extracted, use a reasonable
default for the date (e.g. the last modified time of the file itself).</p>
<p>If 'mkdirs' is True, create the destination directories before moving the
files.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>importer_config</code></td>
<td><code></code></td>
<td>
<p>A list of importer instances that define the config.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>files_or_directories</code></td>
<td><code></code></td>
<td>
<p>a list of files of directories to walk recursively and
hunt for files to import.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>destination</code></td>
<td><code></code></td>
<td>
<p>A string, the root destination directory where the files are
to be filed. The files are organized there under a hierarchy mirrorring
that of the chart of accounts.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>dry_run</code></td>
<td><code></code></td>
<td>
<p>A flag, if true, don't actually move the files.</p>
</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>mkdirs</code></td>
<td><code></code></td>
<td>
<p>A flag, if true, make all the intervening directories; otherwise,
fail to move files to non-existing dirs.</p>
</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>overwrite</code></td>
<td><code></code></td>
<td>
<p>A flag, if true, overwrite an existing destination file.</p>
</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>idify</code></td>
<td><code></code></td>
<td>
<p>A flag, if true, remove whitespace and funky characters in the destination
filename.</p>
</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>logfile</code></td>
<td><code></code></td>
<td>
<p>A file object to write log entries to, or None, in which case no log is
written out.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/file.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">file</span><span class="p">(</span><span class="n">importer_config</span><span class="p">,</span>
         <span class="n">files_or_directories</span><span class="p">,</span>
         <span class="n">destination</span><span class="p">,</span>
         <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">mkdirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">idify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""File importable files under a destination directory.</span>

<span class="sd">    Given an importer configuration object, search for files that can be</span>
<span class="sd">    imported under the given list of files or directories and moved them under</span>
<span class="sd">    the given destination directory with the date computed by the module</span>
<span class="sd">    prepended to the filename. If the date cannot be extracted, use a reasonable</span>
<span class="sd">    default for the date (e.g. the last modified time of the file itself).</span>

<span class="sd">    If 'mkdirs' is True, create the destination directories before moving the</span>
<span class="sd">    files.</span>

<span class="sd">    Args:</span>
<span class="sd">      importer_config: A list of importer instances that define the config.</span>
<span class="sd">      files_or_directories: a list of files of directories to walk recursively and</span>
<span class="sd">        hunt for files to import.</span>
<span class="sd">      destination: A string, the root destination directory where the files are</span>
<span class="sd">        to be filed. The files are organized there under a hierarchy mirrorring</span>
<span class="sd">        that of the chart of accounts.</span>
<span class="sd">      dry_run: A flag, if true, don't actually move the files.</span>
<span class="sd">      mkdirs: A flag, if true, make all the intervening directories; otherwise,</span>
<span class="sd">        fail to move files to non-existing dirs.</span>
<span class="sd">      overwrite: A flag, if true, overwrite an existing destination file.</span>
<span class="sd">      idify: A flag, if true, remove whitespace and funky characters in the destination</span>
<span class="sd">        filename.</span>
<span class="sd">      logfile: A file object to write log entries to, or None, in which case no log is</span>
<span class="sd">        written out.</span>
<span class="sd">    """</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">importers</span> <span class="ow">in</span> <span class="n">identify</span><span class="o">.</span><span class="n">find_imports</span><span class="p">(</span><span class="n">importer_config</span><span class="p">,</span>
                                                     <span class="n">files_or_directories</span><span class="p">,</span>
                                                     <span class="n">logfile</span><span class="p">):</span>
        <span class="c1"># If we're debugging, print out the match text.</span>
        <span class="c1"># This option is useful when we're building our importer configuration,</span>
        <span class="c1"># to figure out which patterns to create as unique signatures.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">importers</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Process a single file.</span>
        <span class="n">new_fullname</span> <span class="o">=</span> <span class="n">file_one_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">importers</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">idify</span><span class="p">,</span> <span class="n">logfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_fullname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Check if the destination directory exists.</span>
        <span class="n">new_dirname</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">new_fullname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_dirname</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mkdirs</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Destination directory '</span><span class="si">{}</span><span class="s2">' does not exist."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_dirname</span><span class="p">))</span>
            <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>

        <span class="c1"># Check if the destination file already exists; we don't want to clobber</span>
        <span class="c1"># it by accident.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_fullname</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Destination file '</span><span class="si">{}</span><span class="s2">' already exists."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_fullname</span><span class="p">))</span>
            <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>

        <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filename</span><span class="p">,</span> <span class="n">new_fullname</span><span class="p">))</span>

    <span class="c1"># Check if any two imported files would be colliding in their destination</span>
    <span class="c1"># name, before we move anything.</span>
    <span class="n">destmap</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
        <span class="n">destmap</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dest</span><span class="p">,</span> <span class="n">sources</span> <span class="ow">in</span> <span class="n">destmap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Collision in destination filenames '</span><span class="si">{}</span><span class="s2">': from </span><span class="si">{}</span><span class="s2">."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">dest</span><span class="p">,</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">"'</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">])))</span>
            <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># If there are any errors, just don't do anything at all. This is a nicer</span>
    <span class="c1"># behaviour than moving just *some* files.</span>
    <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">or</span> <span class="n">has_errors</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Actually carry out the moving job.</span>
    <span class="k">for</span> <span class="n">old_filename</span><span class="p">,</span> <span class="n">new_filename</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
        <span class="n">move_xdev_file</span><span class="p">(</span><span class="n">old_filename</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">,</span> <span class="n">mkdirs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jobs</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.file.file_one_file">
<code class="highlight language-python">
file_one_file<span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">importers</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">idify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.file.file_one_file" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Move a single filename using its matched importers.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>filename</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the downloaded file to be processed.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>importers</code></td>
<td><code></code></td>
<td>
<p>A list of importer instances that handle this file.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>destination</code></td>
<td><code></code></td>
<td>
<p>A string, the root destination directory where the files are
to be filed. The files are organized there under a hierarchy mirrorring
that of the chart of accounts.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>idify</code></td>
<td><code></code></td>
<td>
<p>A flag, if true, remove whitespace and funky characters in the destination
filename.</p>
</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>logfile</code></td>
<td><code></code></td>
<td>
<p>A file object to write log entries to, or None, in which case no log is
written out.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>The full new destination filename on success, and None if there was an error.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/file.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">file_one_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">importers</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">idify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Move a single filename using its matched importers.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename: A string, the name of the downloaded file to be processed.</span>
<span class="sd">      importers: A list of importer instances that handle this file.</span>
<span class="sd">      destination: A string, the root destination directory where the files are</span>
<span class="sd">        to be filed. The files are organized there under a hierarchy mirrorring</span>
<span class="sd">        that of the chart of accounts.</span>
<span class="sd">      idify: A flag, if true, remove whitespace and funky characters in the destination</span>
<span class="sd">        filename.</span>
<span class="sd">      logfile: A file object to write log entries to, or None, in which case no log is</span>
<span class="sd">        written out.</span>
<span class="sd">    Returns:</span>
<span class="sd">      The full new destination filename on success, and None if there was an error.</span>
<span class="sd">    """</span>
    <span class="c1"># Create an object to cache all the conversions between the importers</span>
    <span class="c1"># and phases and what-not.</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Get the account corresponding to the file.</span>
    <span class="n">file_accounts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">importer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">importers</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">account_</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">file_account</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">account_</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Importer </span><span class="si">%s</span><span class="s2">.file_account() raised an unexpected error: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span>
                          <span class="n">importer</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">exc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">account_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_accounts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">account_</span><span class="p">)</span>

    <span class="n">file_accounts_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">file_accounts</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_accounts_set</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"No account provided by importers: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="n">importers</span><span class="p">)))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_accounts_set</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Ambiguous accounts from many importers: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_accounts_set</span><span class="p">)))</span>
        <span class="c1"># Note: Don't exit; select the first matching importer's account.</span>

    <span class="n">file_account</span> <span class="o">=</span> <span class="n">file_accounts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Given multiple importers, select the first one that was yielded to</span>
    <span class="c1"># obtain the date and process the filename.</span>
    <span class="n">importer</span> <span class="o">=</span> <span class="n">importers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Compute the date from the last modified time.</span>
    <span class="n">mtime</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">mtime_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">mtime</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="c1"># Try to get the file's date by calling a module support function. The</span>
    <span class="c1"># module may be able to extract the date from the filename, from the</span>
    <span class="c1"># contents of the file itself (e.g. scraping some text from the PDF</span>
    <span class="c1"># contents, or grabbing the last line of a CSV file).</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">file_date</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Importer </span><span class="si">%s</span><span class="s2">.file_date() raised an unexpected error: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span>
                      <span class="n">importer</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">exc</span><span class="p">)</span>
        <span class="n">date</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Fallback on the last modified time of the file.</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">mtime_date</span>
        <span class="n">date_source</span> <span class="o">=</span> <span class="s1">'mtime'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">date_source</span> <span class="o">=</span> <span class="s1">'contents'</span>

    <span class="c1"># Apply filename renaming, if implemented.</span>
    <span class="c1"># Otherwise clean up the filename.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">clean_filename</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="c1"># Warn the importer implementor if a name is returned and it's an</span>
        <span class="c1"># absolute filename.</span>
        <span class="k">if</span> <span class="n">clean_filename</span> <span class="ow">and</span> <span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">clean_filename</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="ow">in</span> <span class="n">clean_filename</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">((</span><span class="s2">"The importer '</span><span class="si">%s</span><span class="s2">' file_name() method should return a relative "</span>
                           <span class="s2">"filename; the filename '</span><span class="si">%s</span><span class="s2">' is absolute or contains path "</span>
                           <span class="s2">"separators"</span><span class="p">),</span>
                          <span class="n">importer</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">clean_filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Importer </span><span class="si">%s</span><span class="s2">.file_name() raised an unexpected error: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span>
                      <span class="n">importer</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">exc</span><span class="p">)</span>
        <span class="n">clean_filename</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">clean_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If no filename has been provided, use the basename.</span>
        <span class="n">clean_filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">'\d\d\d\d-\d\d-\d\d'</span><span class="p">,</span> <span class="n">clean_filename</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"The importer '</span><span class="si">%s</span><span class="s2">' file_name() method should not date the "</span>
                      <span class="s2">"returned filename. Implement file_date() instead."</span><span class="p">)</span>

    <span class="c1"># We need a simple filename; remove the directory part if there is one.</span>
    <span class="n">clean_basename</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">clean_filename</span><span class="p">)</span>

    <span class="c1"># Remove whitespace if requested.</span>
    <span class="k">if</span> <span class="n">idify</span><span class="p">:</span>
        <span class="n">clean_basename</span> <span class="o">=</span> <span class="n">misc_utils</span><span class="o">.</span><span class="n">idify</span><span class="p">(</span><span class="n">clean_basename</span><span class="p">)</span>

    <span class="c1"># Prepend the date prefix.</span>
    <span class="n">new_filename</span> <span class="o">=</span> <span class="s1">'{0:%Y-%m-</span><span class="si">%d</span><span class="s1">}.</span><span class="si">{1}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">clean_basename</span><span class="p">)</span>

    <span class="c1"># Prepend destination directory.</span>
    <span class="n">new_fullname</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span>
                                           <span class="n">file_account</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">),</span>
                                           <span class="n">new_filename</span><span class="p">))</span>

    <span class="c1"># Print the filename and which modules matched.</span>
    <span class="k">if</span> <span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'Importer:    </span><span class="si">{}</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">importer</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">if</span> <span class="n">importer</span> <span class="k">else</span> <span class="s1">'-'</span><span class="p">))</span>
        <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'Account:     </span><span class="si">{}</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_account</span><span class="p">))</span>
        <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'Date:        </span><span class="si">{}</span><span class="s1"> (from </span><span class="si">{}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">date_source</span><span class="p">))</span>
        <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'Destination: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_fullname</span><span class="p">))</span>
        <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_fullname</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.file.move_xdev_file">
<code class="highlight language-python">
move_xdev_file<span class="p">(</span><span class="n">src_filename</span><span class="p">,</span> <span class="n">dst_filename</span><span class="p">,</span> <span class="n">mkdirs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.file.move_xdev_file" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Move a file, potentially across devices.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src_filename</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the file to copy.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>dst_filename</code></td>
<td><code></code></td>
<td>
<p>A string, where to copy the file.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>mkdirs</code></td>
<td><code></code></td>
<td>
<p>A flag, true if we should create a non-existing destination directory.</p>
</td>
<td><code>False</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/file.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">move_xdev_file</span><span class="p">(</span><span class="n">src_filename</span><span class="p">,</span> <span class="n">dst_filename</span><span class="p">,</span> <span class="n">mkdirs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Move a file, potentially across devices.</span>

<span class="sd">    Args:</span>
<span class="sd">      src_filename: A string, the name of the file to copy.</span>
<span class="sd">      dst_filename: A string, where to copy the file.</span>
<span class="sd">      mkdirs: A flag, true if we should create a non-existing destination directory.</span>
<span class="sd">    """</span>
    <span class="c1"># Create missing directory if required.</span>
    <span class="n">dst_dirname</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dst_filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mkdirs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst_dirname</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dst_dirname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst_dirname</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">"Destination directory '</span><span class="si">{}</span><span class="s2">' does not exist."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dst_dirname</span><span class="p">))</span>

    <span class="c1"># Copy the file to its new name.</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src_filename</span><span class="p">,</span> <span class="n">dst_filename</span><span class="p">)</span>

    <span class="c1"># Remove the old file. Note that we copy and remove to support</span>
    <span class="c1"># cross-device moves, because it's sensible that the destination might</span>
    <span class="c1"># be on an encrypted device.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">src_filename</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.file.run">
<code class="highlight language-python">
run<span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">importers_list</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">,</span> <span class="n">detect_duplicates_func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.file.run" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Run the subcommand.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/file.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">importers_list</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">,</span> <span class="n">detect_duplicates_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Run the subcommand."""</span>

    <span class="c1"># If the output directory is not specified, move the files at the root of</span>
    <span class="c1"># the configuration file. (Providing this default seems better than using a</span>
    <span class="c1"># required option.)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>

    <span class="c1"># Make sure the output directory exists.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">'Output directory "</span><span class="si">{}</span><span class="s1">" does not exist.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span>

    <span class="n">file</span><span class="p">(</span><span class="n">importers_list</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
         <span class="n">dry_run</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">,</span>
         <span class="n">mkdirs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
         <span class="n">overwrite</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">overwrite</span><span class="p">,</span>
         <span class="n">idify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
         <span class="n">logfile</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.file_test">
<code>file_test</code>
<a class="headerlink" href="#beancount.ingest.file_test" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ingest.file_test.TestScriptFile">
<code>TestScriptFile</code>
<a class="headerlink" href="#beancount.ingest.file_test.TestScriptFile" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.file_test.TestScriptFile.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.file_test.TestScriptFile.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/file_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>20
21
22
23
24</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">downloads</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span> <span class="s1">'Downloads'</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">documents</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span> <span class="s1">'Documents'</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">documents</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.file_test.TestScriptFile.tearDown">
<code class="highlight language-python">
tearDown<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.file_test.TestScriptFile.tearDown" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for deconstructing the test fixture after testing it.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/file_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>324</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span> <span class="c1">## FIXME: remove</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.identify">
<code>identify</code>
<a class="headerlink" href="#beancount.ingest.identify" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Identify script.</p>
<p>Read an import script and a list of downloaded filenames or directories of
2downloaded files, and for each of those files, identify which importer it should
be associated with.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.identify.add_arguments">
<code class="highlight language-python">
add_arguments<span class="p">(</span><span class="n">parser</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.identify.add_arguments" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Add arguments for the identify command.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/identify.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>94
95</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="sd">"""Add arguments for the identify command."""</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.identify.find_imports">
<code class="highlight language-python">
find_imports<span class="p">(</span><span class="n">importer_config</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.identify.find_imports" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Given an importer configuration, search for files that can be imported in the
list of files or directories, run the signature checks on them and return a list
of (filename, importers), where 'importers' is a list of importers that matched
the file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>importer_config</code></td>
<td><code></code></td>
<td>
<p>a list of importer instances that define the config.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>files_or_directories</code></td>
<td><code></code></td>
<td>
<p>a list of files of directories to walk recursively and
                    hunt for files to import.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>logfile</code></td>
<td><code></code></td>
<td>
<p>A file object to write log entries to, or None, in which case no log is
written out.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p>Yields:
  Triples of filename found, textified contents of the file, and list of
  importers matching this file.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/identify.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_imports</span><span class="p">(</span><span class="n">importer_config</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Given an importer configuration, search for files that can be imported in the</span>
<span class="sd">    list of files or directories, run the signature checks on them and return a list</span>
<span class="sd">    of (filename, importers), where 'importers' is a list of importers that matched</span>
<span class="sd">    the file.</span>

<span class="sd">    Args:</span>
<span class="sd">      importer_config: a list of importer instances that define the config.</span>
<span class="sd">      files_or_directories: a list of files of directories to walk recursively and</span>
<span class="sd">                            hunt for files to import.</span>
<span class="sd">      logfile: A file object to write log entries to, or None, in which case no log is</span>
<span class="sd">        written out.</span>
<span class="sd">    Yields:</span>
<span class="sd">      Triples of filename found, textified contents of the file, and list of</span>
<span class="sd">      importers matching this file.</span>
<span class="sd">    """</span>
    <span class="c1"># Iterate over all files found; accumulate the entries by identification.</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">file_utils</span><span class="o">.</span><span class="n">find_files</span><span class="p">(</span><span class="n">files_or_directories</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">SECTION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

        <span class="c1"># Skip files that are simply too large.</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">FILE_TOO_LARGE_THRESHOLD</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"File too large: '</span><span class="si">{}</span><span class="s2">' (</span><span class="si">{}</span><span class="s2"> bytes); skipping."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="c1"># For each of the sources the user has declared, identify which</span>
        <span class="c1"># match the text.</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">matching_importers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">importer</span> <span class="ow">in</span> <span class="n">importer_config</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">identify</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">matched</span><span class="p">:</span>
                    <span class="n">matching_importers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">importer</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Importer </span><span class="si">%s</span><span class="s2">.identify() raised an unexpected error: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span>
                              <span class="n">importer</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">exc</span><span class="p">)</span>

        <span class="k">yield</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">matching_importers</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.identify.identify">
<code class="highlight language-python">
identify<span class="p">(</span><span class="n">importers_list</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.identify.identify" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Run the identification loop.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>importers_list</code></td>
<td><code></code></td>
<td>
<p>A list of importer instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>files_or_directories</code></td>
<td><code></code></td>
<td>
<p>A list of strings, files or directories.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/identify.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>74
75
76
77
78
79
80
81
82
83
84
85
86
87
88</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">identify</span><span class="p">(</span><span class="n">importers_list</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">):</span>
    <span class="sd">"""Run the identification loop.</span>

<span class="sd">    Args:</span>
<span class="sd">      importers_list: A list of importer instances.</span>
<span class="sd">      files_or_directories: A list of strings, files or directories.</span>
<span class="sd">    """</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">importers</span> <span class="ow">in</span> <span class="n">find_imports</span><span class="p">(</span><span class="n">importers_list</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">,</span>
                                            <span class="n">logfile</span><span class="o">=</span><span class="n">logfile</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">importer</span> <span class="ow">in</span> <span class="n">importers</span><span class="p">:</span>
            <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'Importer:    </span><span class="si">{}</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">importer</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">if</span> <span class="n">importer</span> <span class="k">else</span> <span class="s1">'-'</span><span class="p">))</span>
            <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'Account:     </span><span class="si">{}</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">importer</span><span class="o">.</span><span class="n">file_account</span><span class="p">(</span><span class="n">file</span><span class="p">)))</span>
            <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.identify.run">
<code class="highlight language-python">
run<span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">importers_list</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">,</span> <span class="n">detect_duplicates_func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.identify.run" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Run the subcommand.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/identify.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 98
 99
100</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">importers_list</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">,</span> <span class="n">detect_duplicates_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Run the subcommand."""</span>
    <span class="k">return</span> <span class="n">identify</span><span class="p">(</span><span class="n">importers_list</span><span class="p">,</span> <span class="n">files_or_directories</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.importer">
<code>importer</code>
<a class="headerlink" href="#beancount.ingest.importer" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Importer protocol.</p>
<p>All importers must comply with this interface and implement at least some of its
methods. A configuration consists in a simple list of such importer instances.
The importer processes run through the importers, calling some of its methods in
order to identify, extract and file the downloaded files.</p>
<p>Each of the methods accept a cache.FileMemo object which has a 'name' attribute
with the filename to process, but which also provides a place to cache
conversions. Use its convert() method whenever possible to avoid carrying out
the same conversion multiple times. See beancount.ingest.cache for more details.</p>
<p>Synopsis:</p>
<p>name(): Return a unique identifier for the importer instance.
 identify(): Return true if the identifier is able to process the file.
 extract(): Extract directives from a file's contents and return of list of entries.
 file_account(): Return an account name associated with the given file for this importer.
 file_date(): Return a date associated with the downloaded file (e.g., the statement date).
 file_name(): Return a cleaned up filename for storage (optional).</p>
<p>Just to be clear: Although this importer will not raise NotImplementedError
exceptions (it returns default values for each method), you NEED to derive from
it in order to do anything meaningful. Simply instantiating this importer will
not match not provide any useful information. It just defines the protocol for
all importers.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ingest.importer.ImporterProtocol">
<code>ImporterProtocol</code>
<a class="headerlink" href="#beancount.ingest.importer.ImporterProtocol" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Interface that all source importers need to comply with.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.importer.ImporterProtocol.__str__">
<code class="highlight language-python">
__str__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ingest.importer.ImporterProtocol.__str__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a unique id/name for this importer.</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A string which uniquely identifies this importer.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importer.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>41
42
43
44
45
46
47
48</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Return a unique id/name for this importer.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string which uniquely identifies this importer.</span>
<span class="sd">    """</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="k">return</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.importer.ImporterProtocol.extract">
<code class="highlight language-python">
extract<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">existing_entries</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importer.ImporterProtocol.extract" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Extract transactions from a file.</p>
<p>If the importer would like to flag a returned transaction as a known
duplicate, it may opt to set the special flag "<strong>duplicate</strong>" to True,
and the transaction should be treated as a duplicate by the extraction
code. This is a way to let the importer use particular information about
previously imported transactions in order to flag them as duplicates.
For example, if an importer has a way to get a persistent unique id for
each of the imported transactions. (See this discussion for context:
https://groups.google.com/d/msg/beancount/0iV-ipBJb8g/-uk4wsH2AgAJ)</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>file</code></td>
<td><code></code></td>
<td>
<p>A cache.FileMemo instance.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>existing_entries</code></td>
<td><code></code></td>
<td>
<p>An optional list of existing directives loaded from
the ledger which is intended to contain the extracted entries. This
is only provided if the user provides them via a flag in the
extractor program.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new, imported directives (usually mostly Transactions)
extracted from the file.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importer.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">existing_entries</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Extract transactions from a file.</span>

<span class="sd">    If the importer would like to flag a returned transaction as a known</span>
<span class="sd">    duplicate, it may opt to set the special flag "__duplicate__" to True,</span>
<span class="sd">    and the transaction should be treated as a duplicate by the extraction</span>
<span class="sd">    code. This is a way to let the importer use particular information about</span>
<span class="sd">    previously imported transactions in order to flag them as duplicates.</span>
<span class="sd">    For example, if an importer has a way to get a persistent unique id for</span>
<span class="sd">    each of the imported transactions. (See this discussion for context:</span>
<span class="sd">    https://groups.google.com/d/msg/beancount/0iV-ipBJb8g/-uk4wsH2AgAJ)</span>

<span class="sd">    Args:</span>
<span class="sd">      file: A cache.FileMemo instance.</span>
<span class="sd">      existing_entries: An optional list of existing directives loaded from</span>
<span class="sd">        the ledger which is intended to contain the extracted entries. This</span>
<span class="sd">        is only provided if the user provides them via a flag in the</span>
<span class="sd">        extractor program.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new, imported directives (usually mostly Transactions)</span>
<span class="sd">      extracted from the file.</span>
<span class="sd">    """</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.importer.ImporterProtocol.file_account">
<code class="highlight language-python">
file_account<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importer.ImporterProtocol.file_account" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return an account associated with the given file.</p>
<p>Note: If you don't implement this method you won't be able to move the
files into its preservation hierarchy; the bean-file command won't
work.</p>
<p>Also, normally the returned account is not a function of the input
file--just of the importer--but it is provided anyhow.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>file</code></td>
<td><code></code></td>
<td>
<p>A cache.FileMemo instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>The name of the account that corresponds to this importer.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importer.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>84
85
86
87
88
89
90
91
92
93
94
95
96
97
98</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">file_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="sd">"""Return an account associated with the given file.</span>

<span class="sd">    Note: If you don't implement this method you won't be able to move the</span>
<span class="sd">    files into its preservation hierarchy; the bean-file command won't</span>
<span class="sd">    work.</span>

<span class="sd">    Also, normally the returned account is not a function of the input</span>
<span class="sd">    file--just of the importer--but it is provided anyhow.</span>

<span class="sd">    Args:</span>
<span class="sd">      file: A cache.FileMemo instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      The name of the account that corresponds to this importer.</span>
<span class="sd">    """</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.importer.ImporterProtocol.file_date">
<code class="highlight language-python">
file_date<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importer.ImporterProtocol.file_date" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Attempt to obtain a date that corresponds to the given file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>file</code></td>
<td><code></code></td>
<td>
<p>A cache.FileMemo instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A date object, if successful, or None if a date could not be extracted.
(If no date is returned, the file creation time is used. This is the
default.)</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importer.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>114
115
116
117
118
119
120
121
122
123</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">file_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="sd">"""Attempt to obtain a date that corresponds to the given file.</span>

<span class="sd">    Args:</span>
<span class="sd">      file: A cache.FileMemo instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A date object, if successful, or None if a date could not be extracted.</span>
<span class="sd">      (If no date is returned, the file creation time is used. This is the</span>
<span class="sd">      default.)</span>
<span class="sd">    """</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.importer.ImporterProtocol.file_name">
<code class="highlight language-python">
file_name<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importer.ImporterProtocol.file_name" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>A filter that optionally renames a file before filing.</p>
<p>This is used to make tidy filenames for filed/stored document files. If
you don't implement this and return None, the same filename is used.
Note that if you return a filename, a simple, RELATIVE filename must be
returned, not an absolute filename.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>file</code></td>
<td><code></code></td>
<td>
<p>A cache.FileMemo instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>The tidied up, new filename to store it as.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importer.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>100
101
102
103
104
105
106
107
108
109
110
111
112</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="sd">"""A filter that optionally renames a file before filing.</span>

<span class="sd">    This is used to make tidy filenames for filed/stored document files. If</span>
<span class="sd">    you don't implement this and return None, the same filename is used.</span>
<span class="sd">    Note that if you return a filename, a simple, RELATIVE filename must be</span>
<span class="sd">    returned, not an absolute filename.</span>

<span class="sd">    Args:</span>
<span class="sd">      file: A cache.FileMemo instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      The tidied up, new filename to store it as.</span>
<span class="sd">    """</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.importer.ImporterProtocol.identify">
<code class="highlight language-python">
identify<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importer.ImporterProtocol.identify" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return true if this importer matches the given file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>file</code></td>
<td><code></code></td>
<td>
<p>A cache.FileMemo instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A boolean, true if this importer can handle this file.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importer.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>52
53
54
55
56
57
58
59</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">identify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="sd">"""Return true if this importer matches the given file.</span>

<span class="sd">    Args:</span>
<span class="sd">      file: A cache.FileMemo instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A boolean, true if this importer can handle this file.</span>
<span class="sd">    """</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.importer.ImporterProtocol.name">
<code class="highlight language-python">
name<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importer.ImporterProtocol.name" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a unique id/name for this importer.</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A string which uniquely identifies this importer.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importer.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>41
42
43
44
45
46
47
48</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Return a unique id/name for this importer.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string which uniquely identifies this importer.</span>
<span class="sd">    """</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="k">return</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.importers">
<code>importers</code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ingest.importers" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.ingest.importers.config">
<code>config</code>
<a class="headerlink" href="#beancount.ingest.importers.config" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Mixin to add support for configuring importers with multiple accounts.</p>
<p>This importer implements some simple common functionality to create importers
which accept a long number of account names or regular expressions on the set of
account names. This is inspired by functionality in the importers in the
previous iteration of the ingest code, which used to be its own project.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.ingest.importers.config.ConfigImporterMixin">
<code>ConfigImporterMixin</code>
<a class="headerlink" href="#beancount.ingest.importers.config.ConfigImporterMixin" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>A mixin class which supports configuration of account names.</p>
<pre><code>Mix this into the implementation of a importer.ImporterProtocol.
</code></pre>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.ingest.importers.config.ConfigImporterMixin.__init__">
<code class="highlight language-python">
__init__<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ingest.importers.config.ConfigImporterMixin.__init__" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Provide a list of accounts and regexps as configuration to the importer.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>config</code></td>
<td><code></code></td>
<td>
<p>A dict of configuration accounts, that must match the values
declared in the class' REQUIRED_CONFIG.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/config.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="sd">"""Provide a list of accounts and regexps as configuration to the importer.</span>

<span class="sd">    Args:</span>
<span class="sd">      config: A dict of configuration accounts, that must match the values</span>
<span class="sd">        declared in the class' REQUIRED_CONFIG.</span>
<span class="sd">    """</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># Check that the required configuration values are present.</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s2">"Configuration must be a dict type"</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Invalid config </span><span class="si">{}</span><span class="s2">, requires </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">REQUIRED_CONFIG</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.ingest.importers.config_test">
<code>config_test</code>
<a class="headerlink" href="#beancount.ingest.importers.config_test" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.ingest.importers.config_test.TestConfigMixin">
<code>TestConfigMixin</code>
<a class="headerlink" href="#beancount.ingest.importers.config_test.TestConfigMixin" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.ingest.importers.config_test.TestConfigMixin.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.config_test.TestConfigMixin.setUp" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/config_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>23
24
25</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s1">'Assets:Something'</span>
                           <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">SimpleTestImporter</span><span class="o">.</span><span class="n">REQUIRED_CONFIG</span><span class="p">}</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.ingest.importers.csv">
<code>csv</code>
<a class="headerlink" href="#beancount.ingest.importers.csv" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>CSV importer.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.ingest.importers.csv.Col">
<code>Col</code>
<a class="headerlink" href="#beancount.ingest.importers.csv.Col" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>The set of interpretable columns.</p>
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.ingest.importers.csv.Importer">
<code>Importer</code>
<a class="headerlink" href="#beancount.ingest.importers.csv.Importer" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Importer for CSV files.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.ingest.importers.csv.Importer.__init__">
<code class="highlight language-python">
__init__<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">regexps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_lines</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last4_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">categorizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">institution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">csv_dialect</span><span class="o">=</span><span class="s1">'excel'</span><span class="p">,</span> <span class="n">dateutil_kwds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">narration_sep</span><span class="o">=</span><span class="s1">'; '</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ingest.importers.csv.Importer.__init__" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Constructor.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>config</code></td>
<td><code></code></td>
<td>
<p>A dict of Col enum types to the names or indexes of the columns.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account</code></td>
<td><code></code></td>
<td>
<p>An account string, the account to post this to.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>currency</code></td>
<td><code></code></td>
<td>
<p>A currency string, the currency of this account.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>regexps</code></td>
<td><code></code></td>
<td>
<p>A list of regular expression strings.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>skip_lines</code></td>
<td><code>int</code></td>
<td>
<p>Skip first x (garbage) lines of file.</p>
</td>
<td><code>0</code></td>
</tr>
<tr>
<td><code>last4_map</code></td>
<td><code>Optional[Dict]</code></td>
<td>
<p>A dict that maps last 4 digits of the card to a friendly string.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>categorizer</code></td>
<td><code>Optional[Callable]</code></td>
<td>
<p>A callable that attaches the other posting (usually expenses)
to a transaction with only single posting.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>institution</code></td>
<td><code>Optional[str]</code></td>
<td>
<p>An optional name of an institution to rename the files to.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>debug</code></td>
<td><code>bool</code></td>
<td>
<p>Whether or not to print debug information</p>
</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>csv_dialect</code></td>
<td><code>Union[str, csv.Dialect]</code></td>
<td>
<p>A <code>csv</code> dialect given either as string or as instance or
subclass of <code>csv.Dialect</code>.</p>
</td>
<td><code>'excel'</code></td>
</tr>
<tr>
<td><code>dateutil_kwds</code></td>
<td><code>Optional[Dict]</code></td>
<td>
<p>An optional dict defining the dateutil parser kwargs.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>narration_sep</code></td>
<td><code>str</code></td>
<td>
<p>A string, a separator to use for splitting up the payee and
narration fields of a source field.</p>
</td>
<td><code>'; '</code></td>
</tr>
<tr>
<td><code>**kwds</code></td>
<td><code></code></td>
<td>
<p>Extra keyword arguments to provide to the base mixins.</p>
</td>
<td><code>{}</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/csv.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span>
             <span class="n">regexps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">skip_lines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
             <span class="n">last4_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">categorizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">institution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">csv_dialect</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">csv</span><span class="o">.</span><span class="n">Dialect</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'excel'</span><span class="p">,</span>
             <span class="n">dateutil_kwds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">narration_sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'; '</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">"""Constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">      config: A dict of Col enum types to the names or indexes of the columns.</span>
<span class="sd">      account: An account string, the account to post this to.</span>
<span class="sd">      currency: A currency string, the currency of this account.</span>
<span class="sd">      regexps: A list of regular expression strings.</span>
<span class="sd">      skip_lines: Skip first x (garbage) lines of file.</span>
<span class="sd">      last4_map: A dict that maps last 4 digits of the card to a friendly string.</span>
<span class="sd">      categorizer: A callable that attaches the other posting (usually expenses)</span>
<span class="sd">        to a transaction with only single posting.</span>
<span class="sd">      institution: An optional name of an institution to rename the files to.</span>
<span class="sd">      debug: Whether or not to print debug information</span>
<span class="sd">      csv_dialect: A `csv` dialect given either as string or as instance or</span>
<span class="sd">        subclass of `csv.Dialect`.</span>
<span class="sd">      dateutil_kwds: An optional dict defining the dateutil parser kwargs.</span>
<span class="sd">      narration_sep: A string, a separator to use for splitting up the payee and</span>
<span class="sd">        narration fields of a source field.</span>
<span class="sd">      **kwds: Extra keyword arguments to provide to the base mixins.</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s2">"Invalid type: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skip_lines</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">skip_lines</span> <span class="o">=</span> <span class="n">skip_lines</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last4_map</span> <span class="o">=</span> <span class="n">last4_map</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dateutil_kwds</span> <span class="o">=</span> <span class="n">dateutil_kwds</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">csv_dialect</span> <span class="o">=</span> <span class="n">csv_dialect</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">narration_sep</span> <span class="o">=</span> <span class="n">narration_sep</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">categorizer</span> <span class="o">=</span> <span class="n">categorizer</span>

    <span class="c1"># Prepare kwds for filing mixin.</span>
    <span class="n">kwds</span><span class="p">[</span><span class="s1">'filing'</span><span class="p">]</span> <span class="o">=</span> <span class="n">account</span>
    <span class="k">if</span> <span class="n">institution</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'prefix'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s1">'prefix'</span><span class="p">]</span> <span class="o">=</span> <span class="n">institution</span>

    <span class="c1"># Prepare kwds for identifier mixin.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">regexps</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">regexps</span> <span class="o">=</span> <span class="p">[</span><span class="n">regexps</span><span class="p">]</span>
    <span class="n">matchers</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">'matchers'</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">matchers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">'mime'</span><span class="p">,</span> <span class="s1">'text/csv'</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">regexps</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">regexp</span> <span class="ow">in</span> <span class="n">regexps</span><span class="p">:</span>
            <span class="n">matchers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">'content'</span><span class="p">,</span> <span class="n">regexp</span><span class="p">))</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.ingest.importers.csv.Importer.extract">
<code class="highlight language-python">
extract<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">existing_entries</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.csv.Importer.extract" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Extract transactions from a file.</p>
<p>If the importer would like to flag a returned transaction as a known
duplicate, it may opt to set the special flag "<strong>duplicate</strong>" to True,
and the transaction should be treated as a duplicate by the extraction
code. This is a way to let the importer use particular information about
previously imported transactions in order to flag them as duplicates.
For example, if an importer has a way to get a persistent unique id for
each of the imported transactions. (See this discussion for context:
https://groups.google.com/d/msg/beancount/0iV-ipBJb8g/-uk4wsH2AgAJ)</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>file</code></td>
<td><code></code></td>
<td>
<p>A cache.FileMemo instance.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>existing_entries</code></td>
<td><code></code></td>
<td>
<p>An optional list of existing directives loaded from
the ledger which is intended to contain the extracted entries. This
is only provided if the user provides them via a flag in the
extractor program.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new, imported directives (usually mostly Transactions)
extracted from the file.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/csv.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">existing_entries</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_account</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Normalize the configuration to fetch by index.</span>
    <span class="n">iconfig</span><span class="p">,</span> <span class="n">has_header</span> <span class="o">=</span> <span class="n">normalize_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_dialect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_lines</span><span class="p">)</span>

    <span class="n">reader</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">dialect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_dialect</span><span class="p">))</span>

    <span class="c1"># Skip garbage lines</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_lines</span><span class="p">):</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>

    <span class="c1"># Skip header, if one was detected.</span>
    <span class="k">if</span> <span class="n">has_header</span><span class="p">:</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">ftype</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">iconfig</span><span class="p">[</span><span class="n">ftype</span><span class="p">]]</span> <span class="k">if</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="n">iconfig</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># FIXME: this should not happen</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Parse all the transactions.</span>
    <span class="n">first_row</span> <span class="o">=</span> <span class="n">last_row</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'#'</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># If debugging, print out the rows.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">first_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">first_row</span> <span class="o">=</span> <span class="n">row</span>
        <span class="n">last_row</span> <span class="o">=</span> <span class="n">row</span>

        <span class="c1"># Extract the data we need from the row, based on the configuration.</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">Col</span><span class="o">.</span><span class="n">DATE</span><span class="p">)</span>
        <span class="n">txn_date</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">Col</span><span class="o">.</span><span class="n">TXN_DATE</span><span class="p">)</span>
        <span class="n">txn_time</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">Col</span><span class="o">.</span><span class="n">TXN_TIME</span><span class="p">)</span>

        <span class="n">payee</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">Col</span><span class="o">.</span><span class="n">PAYEE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">payee</span><span class="p">:</span>
            <span class="n">payee</span> <span class="o">=</span> <span class="n">payee</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Col</span><span class="o">.</span><span class="n">NARRATION1</span><span class="p">,</span>
                                             <span class="n">Col</span><span class="o">.</span><span class="n">NARRATION2</span><span class="p">,</span>
                                             <span class="n">Col</span><span class="o">.</span><span class="n">NARRATION3</span><span class="p">)])</span>
        <span class="n">narration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">narration_sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>

        <span class="n">tag</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">Col</span><span class="o">.</span><span class="n">TAG</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span><span class="p">}</span> <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span>

        <span class="n">last4</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">Col</span><span class="o">.</span><span class="n">LAST4</span><span class="p">)</span>

        <span class="n">balance</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">Col</span><span class="o">.</span><span class="n">BALANCE</span><span class="p">)</span>

        <span class="c1"># Create a transaction</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">txn_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_date_liberally</span><span class="p">(</span><span class="n">txn_date</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">dateutil_kwds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">txn_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">'time'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">txn_time</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">balance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">'balance'</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last4</span><span class="p">:</span>
            <span class="n">last4_friendly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last4_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">last4</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">'card'</span><span class="p">]</span> <span class="o">=</span> <span class="n">last4_friendly</span> <span class="k">if</span> <span class="n">last4_friendly</span> <span class="k">else</span> <span class="n">last4</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">parse_date_liberally</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dateutil_kwds</span><span class="p">)</span>
        <span class="n">txn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAG</span><span class="p">,</span> <span class="n">payee</span><span class="p">,</span> <span class="n">narration</span><span class="p">,</span>
                               <span class="n">tags</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># Attach one posting to the transaction</span>
        <span class="n">amount_debit</span><span class="p">,</span> <span class="n">amount_credit</span> <span class="o">=</span> <span class="n">get_amounts</span><span class="p">(</span><span class="n">iconfig</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

        <span class="c1"># Skip empty transactions</span>
        <span class="k">if</span> <span class="n">amount_debit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">amount_credit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">amount</span> <span class="ow">in</span> <span class="p">[</span><span class="n">amount_debit</span><span class="p">,</span> <span class="n">amount_credit</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">amount</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">Amount</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
            <span class="n">txn</span><span class="o">.</span><span class="n">postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="c1"># Attach the other posting(s) to the transaction.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categorizer</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span><span class="p">):</span>
            <span class="n">txn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">categorizer</span><span class="p">(</span><span class="n">txn</span><span class="p">)</span>

        <span class="c1"># Add the transaction to the output list</span>
        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">txn</span><span class="p">)</span>

    <span class="c1"># Figure out if the file is in ascending or descending order.</span>
    <span class="n">first_date</span> <span class="o">=</span> <span class="n">parse_date_liberally</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">first_row</span><span class="p">,</span> <span class="n">Col</span><span class="o">.</span><span class="n">DATE</span><span class="p">),</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">dateutil_kwds</span><span class="p">)</span>
    <span class="n">last_date</span> <span class="o">=</span> <span class="n">parse_date_liberally</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">last_row</span><span class="p">,</span> <span class="n">Col</span><span class="o">.</span><span class="n">DATE</span><span class="p">),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">dateutil_kwds</span><span class="p">)</span>
    <span class="n">is_ascending</span> <span class="o">=</span> <span class="n">first_date</span> <span class="o">&lt;</span> <span class="n">last_date</span>

    <span class="c1"># Reverse the list if the file is in descending order</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ascending</span><span class="p">:</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">entries</span><span class="p">))</span>

    <span class="c1"># Add a balance entry if possible</span>
    <span class="k">if</span> <span class="n">Col</span><span class="o">.</span><span class="n">BALANCE</span> <span class="ow">in</span> <span class="n">iconfig</span> <span class="ow">and</span> <span class="n">entries</span><span class="p">:</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'balance'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">balance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">Balance</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span>
                             <span class="n">account</span><span class="p">,</span> <span class="n">Amount</span><span class="p">(</span><span class="n">balance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">),</span>
                             <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="c1"># Remove the 'balance' metadata.</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'balance'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entries</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.ingest.importers.csv.Importer.file_date">
<code class="highlight language-python">
file_date<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.csv.Importer.file_date" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Get the maximum date from the file.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/csv.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">file_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="s2">"Get the maximum date from the file."</span>
    <span class="n">iconfig</span><span class="p">,</span> <span class="n">has_header</span> <span class="o">=</span> <span class="n">normalize_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_dialect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_lines</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Col</span><span class="o">.</span><span class="n">DATE</span> <span class="ow">in</span> <span class="n">iconfig</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">dialect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_dialect</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_lines</span><span class="p">):</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_header</span><span class="p">:</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="n">max_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'#'</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">date_str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">iconfig</span><span class="p">[</span><span class="n">Col</span><span class="o">.</span><span class="n">DATE</span><span class="p">]]</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">parse_date_liberally</span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dateutil_kwds</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">date</span> <span class="o">&gt;</span> <span class="n">max_date</span><span class="p">:</span>
                <span class="n">max_date</span> <span class="o">=</span> <span class="n">date</span>
        <span class="k">return</span> <span class="n">max_date</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.ingest.importers.csv.get_amounts">
<code class="highlight language-python">
get_amounts<span class="p">(</span><span class="n">iconfig</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">allow_zero_amounts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.csv.get_amounts" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Get the amount columns of a row.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>iconfig</code></td>
<td><code></code></td>
<td>
<p>A dict of Col to row index.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>row</code></td>
<td><code></code></td>
<td>
<p>A row array containing the values of the given row.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>allow_zero_amounts</code></td>
<td><code></code></td>
<td>
<p>Is a transaction with amount D('0.00') okay? If not,
return (None, None).</p>
</td>
<td><code>False</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A pair of (debit-amount, credit-amount), both of which are either an
instance of Decimal or None, or not available.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/csv.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_amounts</span><span class="p">(</span><span class="n">iconfig</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">allow_zero_amounts</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Get the amount columns of a row.</span>

<span class="sd">    Args:</span>
<span class="sd">      iconfig: A dict of Col to row index.</span>
<span class="sd">      row: A row array containing the values of the given row.</span>
<span class="sd">      allow_zero_amounts: Is a transaction with amount D('0.00') okay? If not,</span>
<span class="sd">        return (None, None).</span>
<span class="sd">    Returns:</span>
<span class="sd">      A pair of (debit-amount, credit-amount), both of which are either an</span>
<span class="sd">      instance of Decimal or None, or not available.</span>
<span class="sd">    """</span>
    <span class="n">debit</span><span class="p">,</span> <span class="n">credit</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">Col</span><span class="o">.</span><span class="n">AMOUNT</span> <span class="ow">in</span> <span class="n">iconfig</span><span class="p">:</span>
        <span class="n">credit</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">iconfig</span><span class="p">[</span><span class="n">Col</span><span class="o">.</span><span class="n">AMOUNT</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">debit</span><span class="p">,</span> <span class="n">credit</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">iconfig</span><span class="p">[</span><span class="n">col</span><span class="p">]]</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">iconfig</span> <span class="k">else</span> <span class="kc">None</span>
                         <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Col</span><span class="o">.</span><span class="n">AMOUNT_DEBIT</span><span class="p">,</span> <span class="n">Col</span><span class="o">.</span><span class="n">AMOUNT_CREDIT</span><span class="p">]]</span>

    <span class="c1"># If zero amounts aren't allowed, return null value.</span>
    <span class="n">is_zero_amount</span> <span class="o">=</span> <span class="p">((</span><span class="n">credit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">D</span><span class="p">(</span><span class="n">credit</span><span class="p">)</span> <span class="o">==</span> <span class="n">ZERO</span><span class="p">)</span> <span class="ow">and</span>
                      <span class="p">(</span><span class="n">debit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">D</span><span class="p">(</span><span class="n">debit</span><span class="p">)</span> <span class="o">==</span> <span class="n">ZERO</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_zero_amounts</span> <span class="ow">and</span> <span class="n">is_zero_amount</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">D</span><span class="p">(</span><span class="n">debit</span><span class="p">)</span> <span class="k">if</span> <span class="n">debit</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">D</span><span class="p">(</span><span class="n">credit</span><span class="p">)</span> <span class="k">if</span> <span class="n">credit</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.ingest.importers.csv.normalize_config">
<code class="highlight language-python">
normalize_config<span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">'excel'</span><span class="p">,</span> <span class="n">skip_lines</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.csv.normalize_config" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Using the header line, convert the configuration field name lookups to int indexes.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>config</code></td>
<td><code></code></td>
<td>
<p>A dict of Col types to string or indexes.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>head</code></td>
<td><code></code></td>
<td>
<p>A string, some decent number of bytes of the head of the file.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>dialect</code></td>
<td><code></code></td>
<td>
<p>A dialect definition to parse the header</p>
</td>
<td><code>'excel'</code></td>
</tr>
<tr>
<td><code>skip_lines</code></td>
<td><code>int</code></td>
<td>
<p>Skip first x (garbage) lines of file.</p>
</td>
<td><code>0</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A pair of
  A dict of Col types to integer indexes of the fields, and
  a boolean, true if the file has a header.</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ValueError</code></td>
<td>
<p>If there is no header and the configuration does not consist
entirely of integer indexes.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/csv.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">normalize_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">'excel'</span><span class="p">,</span> <span class="n">skip_lines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="sd">"""Using the header line, convert the configuration field name lookups to int indexes.</span>

<span class="sd">    Args:</span>
<span class="sd">      config: A dict of Col types to string or indexes.</span>
<span class="sd">      head: A string, some decent number of bytes of the head of the file.</span>
<span class="sd">      dialect: A dialect definition to parse the header</span>
<span class="sd">      skip_lines: Skip first x (garbage) lines of file.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A pair of</span>
<span class="sd">        A dict of Col types to integer indexes of the fields, and</span>
<span class="sd">        a boolean, true if the file has a header.</span>
<span class="sd">    Raises:</span>
<span class="sd">      ValueError: If there is no header and the configuration does not consist</span>
<span class="sd">        entirely of integer indexes.</span>
<span class="sd">    """</span>
    <span class="c1"># Skip garbage lines before sniffing the header</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skip_lines</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">skip_lines</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">skip_lines</span><span class="p">):</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="n">head</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">has_header</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">Sniffer</span><span class="p">()</span><span class="o">.</span><span class="n">has_header</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_header</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">head</span><span class="p">),</span> <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">))</span>
        <span class="n">field_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">field_name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="n">index</span>
                     <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">header</span><span class="p">)}</span>
        <span class="n">index_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field_type</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">field_map</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="n">index_config</span><span class="p">[</span><span class="n">field_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">field_type</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"CSV config without header has non-index fields: "</span>
                             <span class="s2">"</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
        <span class="n">index_config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="k">return</span> <span class="n">index_config</span><span class="p">,</span> <span class="n">has_header</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.ingest.importers.fileonly">
<code>fileonly</code>
<a class="headerlink" href="#beancount.ingest.importers.fileonly" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>A simplistic importer that can be used just to file away some download.</p>
<p>Sometimes you just want to save and accumulate data</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.ingest.importers.fileonly.Importer">
<code>Importer</code>
<a class="headerlink" href="#beancount.ingest.importers.fileonly.Importer" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>An importer that supports only matching (identification) and filing.</p>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.ingest.importers.mixins">
<code>mixins</code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ingest.importers.mixins" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-module">
<h4 class="doc doc-heading" id="beancount.ingest.importers.mixins.config">
<code>config</code>
<a class="headerlink" href="#beancount.ingest.importers.mixins.config" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Base class that implements configuration and a filing account.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h5 class="doc doc-heading" id="beancount.ingest.importers.mixins.config.ConfigMixin">
<code>ConfigMixin</code>
<a class="headerlink" href="#beancount.ingest.importers.mixins.config.ConfigMixin" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="beancount.ingest.importers.mixins.config.ConfigMixin.__init__">
<code class="highlight language-python">
__init__<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ingest.importers.mixins.config.ConfigMixin.__init__" title="Permanent link"></a></h6>
<div class="doc doc-contents">
<p>Pull 'config' from kwds.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/mixins/config.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>48
49
50
51
52
53
54
55
56
57
58
59
60</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">"""Pull 'config' from kwds."""</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">REQUIRED_CONFIG</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">schema</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">validate_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="beancount.ingest.importers.mixins.config.validate_config">
<code class="highlight language-python">
validate_config<span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">importer</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.mixins.config.validate_config" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Check the configuration account provided by the user against the accounts
required by the source importer.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>config</code></td>
<td><code></code></td>
<td>
<p>A config dict of actual values on an importer.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>schema</code></td>
<td><code></code></td>
<td>
<p>A dict of declarations of required values.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ValueError</code></td>
<td>
<p>If the configuration is invalid.</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A validated configuration dict.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/mixins/config.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">importer</span><span class="p">):</span>
    <span class="sd">"""Check the configuration account provided by the user against the accounts</span>
<span class="sd">    required by the source importer.</span>

<span class="sd">    Args:</span>
<span class="sd">      config: A config dict of actual values on an importer.</span>
<span class="sd">      schema: A dict of declarations of required values.</span>
<span class="sd">    Raises:</span>
<span class="sd">      ValueError: If the configuration is invalid.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A validated configuration dict.</span>
<span class="sd">    """</span>
    <span class="n">provided_options</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">required_options</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">(</span><span class="n">required_options</span> <span class="o">-</span> <span class="n">provided_options</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Missing value from user configuration for importer </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">importer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">option</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">(</span><span class="n">provided_options</span> <span class="o">-</span> <span class="n">required_options</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unknown value in user configuration for importer </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">importer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">option</span><span class="p">))</span>

    <span class="c1"># FIXME: Validate types as well, including account type as a default.</span>

    <span class="c1"># FIXME: Here we could validate account names by looking them up from the</span>
    <span class="c1"># existing ledger.</span>

    <span class="k">return</span> <span class="n">config</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h4 class="doc doc-heading" id="beancount.ingest.importers.mixins.filing">
<code>filing</code>
<a class="headerlink" href="#beancount.ingest.importers.mixins.filing" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Base class that implements filing account.</p>
<p>It also sports an optional prefix to prepend to the renamed filename. Typically
you can put the name of the institution there, so you get a renamed filename
like this:</p>
<p>YYYY-MM-DD.institution.Original_File_Name.pdf</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h5 class="doc doc-heading" id="beancount.ingest.importers.mixins.filing.FilingMixin">
<code>FilingMixin</code>
<a class="headerlink" href="#beancount.ingest.importers.mixins.filing.FilingMixin" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="beancount.ingest.importers.mixins.filing.FilingMixin.__init__">
<code class="highlight language-python">
__init__<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ingest.importers.mixins.filing.FilingMixin.__init__" title="Permanent link"></a></h6>
<div class="doc doc-contents">
<p>Pull 'filing' and 'prefix' from kwds.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/mixins/filing.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>20
21
22
23
24
25
26
27
28
29</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">"""Pull 'filing' and 'prefix' from kwds."""</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">filing_account</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'filing'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">account</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filing_account</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'prefix'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">account</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filing_account</span><span class="p">)</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="beancount.ingest.importers.mixins.filing.FilingMixin.file_account">
<code class="highlight language-python">
file_account<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.mixins.filing.FilingMixin.file_account" title="Permanent link"></a></h6>
<div class="doc doc-contents">
<p>Return an account associated with the given file.</p>
<p>Note: If you don't implement this method you won't be able to move the
files into its preservation hierarchy; the bean-file command won't
work.</p>
<p>Also, normally the returned account is not a function of the input
file--just of the importer--but it is provided anyhow.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>file</code></td>
<td><code></code></td>
<td>
<p>A cache.FileMemo instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>The name of the account that corresponds to this importer.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/mixins/filing.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>35
36</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">file_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filing_account</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="beancount.ingest.importers.mixins.filing.FilingMixin.file_name">
<code class="highlight language-python">
file_name<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.mixins.filing.FilingMixin.file_name" title="Permanent link"></a></h6>
<div class="doc doc-contents">
<p>Return the optional renamed account filename.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/mixins/filing.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>38
39
40
41
42
43
44
45</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="sd">"""Return the optional renamed account filename."""</span>
    <span class="n">supername</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">supername</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
                                      <span class="n">supername</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)]))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="beancount.ingest.importers.mixins.filing.FilingMixin.name">
<code class="highlight language-python">
name<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.mixins.filing.FilingMixin.name" title="Permanent link"></a></h6>
<div class="doc doc-contents">
<p>Include the filing account in the name.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/mixins/filing.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>31
32
33</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Include the filing account in the name."""</span>
    <span class="k">return</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">: "</span><span class="si">{}</span><span class="s1">"'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">filing_account</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h4 class="doc doc-heading" id="beancount.ingest.importers.mixins.identifier">
<code>identifier</code>
<a class="headerlink" href="#beancount.ingest.importers.mixins.identifier" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Base class that implements identification using regular expressions.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h5 class="doc doc-heading" id="beancount.ingest.importers.mixins.identifier.IdentifyMixin">
<code>IdentifyMixin</code>
<a class="headerlink" href="#beancount.ingest.importers.mixins.identifier.IdentifyMixin" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="beancount.ingest.importers.mixins.identifier.IdentifyMixin.__init__">
<code class="highlight language-python">
__init__<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ingest.importers.mixins.identifier.IdentifyMixin.__init__" title="Permanent link"></a></h6>
<div class="doc doc-contents">
<p>Pull 'matchers' and 'converter' from kwds.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/mixins/identifier.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">"""Pull 'matchers' and 'converter' from kwds."""</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">remap</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">matchers</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'matchers'</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">cls_matchers</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'matchers'</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matchers</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cls_matchers</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">part</span><span class="p">,</span> <span class="n">regexp</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">matchers</span><span class="p">,</span> <span class="n">cls_matchers</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">_PARTS</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">regexp</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">regexp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remap</span><span class="p">[</span><span class="n">part</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regexp</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'converter'</span><span class="p">,</span>
                              <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'converter'</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="beancount.ingest.importers.mixins.identifier.IdentifyMixin.identify">
<code class="highlight language-python">
identify<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.mixins.identifier.IdentifyMixin.identify" title="Permanent link"></a></h6>
<div class="doc doc-contents">
<p>Return true if this importer matches the given file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>file</code></td>
<td><code></code></td>
<td>
<p>A cache.FileMemo instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A boolean, true if this importer can handle this file.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/mixins/identifier.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>67
68</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">identify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">identify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="beancount.ingest.importers.mixins.identifier.identify">
<code class="highlight language-python">
identify<span class="p">(</span><span class="n">remap</span><span class="p">,</span> <span class="n">converter</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.mixins.identifier.identify" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Identify the contents of a file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>remap</code></td>
<td><code></code></td>
<td>
<p>A dict of 'part' to list-of-compiled-regexp objects, where each item is
a specification to match against its part. The 'part' can be one of 'mime',
'filename' or 'content'.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A boolean, true if the file is not rejected by the constraints.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/mixins/identifier.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">identify</span><span class="p">(</span><span class="n">remap</span><span class="p">,</span> <span class="n">converter</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="sd">"""Identify the contents of a file.</span>

<span class="sd">    Args:</span>
<span class="sd">      remap: A dict of 'part' to list-of-compiled-regexp objects, where each item is</span>
<span class="sd">        a specification to match against its part. The 'part' can be one of 'mime',</span>
<span class="sd">        'filename' or 'content'.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A boolean, true if the file is not rejected by the constraints.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">remap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'mime'</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">mimetype</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">mimetype</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">regexp</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">mimetype</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">regexp</span> <span class="ow">in</span> <span class="n">remap</span><span class="p">[</span><span class="s1">'mime'</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">remap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'filename'</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">regexp</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">regexp</span> <span class="ow">in</span> <span class="n">remap</span><span class="p">[</span><span class="s1">'filename'</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">remap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'content'</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># If this is a text file, read the whole thing in memory.</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">converter</span> <span class="ow">or</span> <span class="n">cache</span><span class="o">.</span><span class="n">contents</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">regexp</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">regexp</span> <span class="ow">in</span> <span class="n">remap</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.ingest.importers.ofx">
<code>ofx</code>
<a class="headerlink" href="#beancount.ingest.importers.ofx" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>OFX file format importer for bank and credit card statements.</p>
<p>https://en.wikipedia.org/wiki/Open_Financial_Exchange</p>
<p>This importer will parse a single account in the OFX file. Instantiate it
multiple times with different accounts if it has many accounts. It makes more
sense to do it this way so that you can define your importer configuration
account by account.</p>
<p>Note that this importer is provided as an example and with no guarantees. It's
not really super great. On the other hand, I've been using it for more than five
years over multiple accounts, so it has been useful to me (it works, by some
measure of "works"). If you need a more powerful or compliant OFX importer
please consider either writing one or contributing changes. Also, this importer
does its own very basic parsing; a better one would probably use (and depend on)
the ofxparse module (see https://sites.google.com/site/ofxparse/).</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.ingest.importers.ofx.BalanceType">
<code>BalanceType</code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.BalanceType" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Type of Balance directive to be inserted.</p>
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.ingest.importers.ofx.Importer">
<code>Importer</code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.Importer" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>An importer for Open Financial Exchange files.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.ingest.importers.ofx.Importer.__init__">
<code class="highlight language-python">
__init__<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acctid_regexp</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">basename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">balance_type</span><span class="o">=&lt;</span><span class="n">BalanceType</span><span class="o">.</span><span class="n">DECLARED</span><span class="p">:</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ingest.importers.ofx.Importer.__init__" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Create a new importer posting to the given account.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>account</code></td>
<td><code></code></td>
<td>
<p>An account string, the account onto which to post all the
amounts parsed.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>acctid_regexp</code></td>
<td><code></code></td>
<td>
<p>A regexp, to match against the &lt;ACCTID&gt; tag of the OFX file.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>basename</code></td>
<td><code></code></td>
<td>
<p>An optional string, the name of the new files.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>balance_type</code></td>
<td><code></code></td>
<td>
<p>An enum of type BalanceType.</p>
</td>
<td><code>&lt;BalanceType.DECLARED: 1&gt;</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acctid_regexp</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">basename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">balance_type</span><span class="o">=</span><span class="n">BalanceType</span><span class="o">.</span><span class="n">DECLARED</span><span class="p">):</span>
    <span class="sd">"""Create a new importer posting to the given account.</span>

<span class="sd">    Args:</span>
<span class="sd">      account: An account string, the account onto which to post all the</span>
<span class="sd">        amounts parsed.</span>
<span class="sd">      acctid_regexp: A regexp, to match against the &lt;ACCTID&gt; tag of the OFX file.</span>
<span class="sd">      basename: An optional string, the name of the new files.</span>
<span class="sd">      balance_type: An enum of type BalanceType.</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">acctid_regexp</span> <span class="o">=</span> <span class="n">acctid_regexp</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">account</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">basename</span> <span class="o">=</span> <span class="n">basename</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">balance_type</span> <span class="o">=</span> <span class="n">balance_type</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.ingest.importers.ofx.Importer.extract">
<code class="highlight language-python">
extract<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">existing_entries</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.Importer.extract" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Extract a list of partially complete transactions from the file.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>91
92
93
94
95</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">existing_entries</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Extract a list of partially complete transactions from the file."""</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">bs4</span><span class="o">.</span><span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">contents</span><span class="p">(),</span> <span class="s1">'lxml'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">extract</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acctid_regexp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FLAG</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">balance_type</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.ingest.importers.ofx.Importer.file_account">
<code class="highlight language-python">
file_account<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.Importer.file_account" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Return the account against which we post transactions.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>78
79
80</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">file_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
    <span class="sd">"""Return the account against which we post transactions."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.ingest.importers.ofx.Importer.file_date">
<code class="highlight language-python">
file_date<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.Importer.file_date" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Return the optional renamed account filename.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>87
88
89</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">file_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="sd">"""Return the optional renamed account filename."""</span>
    <span class="k">return</span> <span class="n">find_max_date</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">contents</span><span class="p">())</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.ingest.importers.ofx.Importer.file_name">
<code class="highlight language-python">
file_name<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.Importer.file_name" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Return the optional renamed account filename.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>82
83
84
85</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="sd">"""Return the optional renamed account filename."""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.ingest.importers.ofx.Importer.identify">
<code class="highlight language-python">
identify<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.Importer.identify" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Return true if this importer matches the given file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>file</code></td>
<td><code></code></td>
<td>
<p>A cache.FileMemo instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A boolean, true if this importer can handle this file.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>67
68
69
70
71
72
73
74
75
76</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">identify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="c1"># Match for a compatible MIME type.</span>
    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">mimetype</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">'application/x-ofx'</span><span class="p">,</span>
                               <span class="s1">'application/vnd.intu.qbo'</span><span class="p">,</span>
                               <span class="s1">'application/vnd.intu.qfx'</span><span class="p">}:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Match the account id.</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acctid_regexp</span><span class="p">,</span> <span class="n">acctid</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">acctid</span> <span class="ow">in</span> <span class="n">find_acctids</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">contents</span><span class="p">()))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.ingest.importers.ofx.Importer.name">
<code class="highlight language-python">
name<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.Importer.name" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Include the filing account in the name.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>63
64
65</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Include the filing account in the name."""</span>
    <span class="k">return</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">: "</span><span class="si">{}</span><span class="s1">"'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_account</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.ingest.importers.ofx.build_transaction">
<code class="highlight language-python">
build_transaction<span class="p">(</span><span class="n">stmttrn</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.build_transaction" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Build a single transaction.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>stmttrn</code></td>
<td><code></code></td>
<td>
<p>A &lt;STMTTRN&gt; bs4.element.Tag.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>flag</code></td>
<td><code></code></td>
<td>
<p>A single-character string.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account</code></td>
<td><code></code></td>
<td>
<p>An account string, the account to insert.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>currency</code></td>
<td><code></code></td>
<td>
<p>A currency string.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A Transaction instance.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">build_transaction</span><span class="p">(</span><span class="n">stmttrn</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
    <span class="sd">"""Build a single transaction.</span>

<span class="sd">    Args:</span>
<span class="sd">      stmttrn: A &lt;STMTTRN&gt; bs4.element.Tag.</span>
<span class="sd">      flag: A single-character string.</span>
<span class="sd">      account: An account string, the account to insert.</span>
<span class="sd">      currency: A currency string.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A Transaction instance.</span>
<span class="sd">    """</span>
    <span class="c1"># Find the date.</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">parse_ofx_time</span><span class="p">(</span><span class="n">find_child</span><span class="p">(</span><span class="n">stmttrn</span><span class="p">,</span> <span class="s1">'dtposted'</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="c1"># There's no distinct payee.</span>
    <span class="n">payee</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Construct a description that represents all the text content in the node.</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">find_child</span><span class="p">(</span><span class="n">stmttrn</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">,</span> <span class="n">saxutils</span><span class="o">.</span><span class="n">unescape</span><span class="p">)</span>
    <span class="n">memo</span> <span class="o">=</span> <span class="n">find_child</span><span class="p">(</span><span class="n">stmttrn</span><span class="p">,</span> <span class="s1">'memo'</span><span class="p">,</span> <span class="n">saxutils</span><span class="o">.</span><span class="n">unescape</span><span class="p">)</span>

    <span class="c1"># Remove memos duplicated from the name.</span>
    <span class="k">if</span> <span class="n">memo</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">memo</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Add the transaction type to the description, unless it's not useful.</span>
    <span class="n">trntype</span> <span class="o">=</span> <span class="n">find_child</span><span class="p">(</span><span class="n">stmttrn</span><span class="p">,</span> <span class="s1">'trntype'</span><span class="p">,</span> <span class="n">saxutils</span><span class="o">.</span><span class="n">unescape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">trntype</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'DEBIT'</span><span class="p">,</span> <span class="s1">'CREDIT'</span><span class="p">):</span>
        <span class="n">trntype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">narration</span> <span class="o">=</span> <span class="s1">' / '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">memo</span><span class="p">,</span> <span class="n">trntype</span><span class="p">]))</span>

    <span class="c1"># Create a single posting for it; the user will have to manually categorize</span>
    <span class="c1"># the other side.</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">find_child</span><span class="p">(</span><span class="n">stmttrn</span><span class="p">,</span> <span class="s1">'trnamt'</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
    <span class="n">posting</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Build the transaction with a single leg.</span>
    <span class="n">fileloc</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;build_transaction&gt;'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">(</span><span class="n">fileloc</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">payee</span><span class="p">,</span> <span class="n">narration</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="p">[</span><span class="n">posting</span><span class="p">])</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.ingest.importers.ofx.extract">
<code class="highlight language-python">
extract<span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">acctid_regexp</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">balance_type</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.extract" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Extract transactions from an OFX file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>soup</code></td>
<td><code></code></td>
<td>
<p>A BeautifulSoup root node.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>acctid_regexp</code></td>
<td><code></code></td>
<td>
<p>A regular expression string matching the account we're interested in.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account</code></td>
<td><code></code></td>
<td>
<p>An account string onto which to post the amounts found in the file.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>flag</code></td>
<td><code></code></td>
<td>
<p>A single-character string.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>balance_type</code></td>
<td><code></code></td>
<td>
<p>An enum of type BalanceType.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A sorted list of entries.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">acctid_regexp</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">balance_type</span><span class="p">):</span>
    <span class="sd">"""Extract transactions from an OFX file.</span>

<span class="sd">    Args:</span>
<span class="sd">      soup: A BeautifulSoup root node.</span>
<span class="sd">      acctid_regexp: A regular expression string matching the account we're interested in.</span>
<span class="sd">      account: An account string onto which to post the amounts found in the file.</span>
<span class="sd">      flag: A single-character string.</span>
<span class="sd">      balance_type: An enum of type BalanceType.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A sorted list of entries.</span>
<span class="sd">    """</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">acctid</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">balance</span> <span class="ow">in</span> <span class="n">find_statement_transactions</span><span class="p">(</span><span class="n">soup</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">acctid_regexp</span><span class="p">,</span> <span class="n">acctid</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Create Transaction directives.</span>
        <span class="n">stmt_entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">stmttrn</span> <span class="ow">in</span> <span class="n">transactions</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">build_transaction</span><span class="p">(</span><span class="n">stmttrn</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">counter</span><span class="p">)))</span>
            <span class="n">stmt_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="n">stmt_entries</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">stmt_entries</span><span class="p">)</span>
        <span class="n">new_entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">stmt_entries</span><span class="p">)</span>

        <span class="c1"># Create a Balance directive.</span>
        <span class="k">if</span> <span class="n">balance</span> <span class="ow">and</span> <span class="n">balance_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">BalanceType</span><span class="o">.</span><span class="n">NONE</span><span class="p">:</span>
            <span class="n">date</span><span class="p">,</span> <span class="n">number</span> <span class="o">=</span> <span class="n">balance</span>
            <span class="k">if</span> <span class="n">balance_type</span> <span class="ow">is</span> <span class="n">BalanceType</span><span class="o">.</span><span class="n">LAST</span> <span class="ow">and</span> <span class="n">stmt_entries</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">stmt_entries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span>

            <span class="c1"># The Balance assertion occurs at the beginning of the date, so move</span>
            <span class="c1"># it to the following day.</span>
            <span class="n">date</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">counter</span><span class="p">))</span>
            <span class="n">balance_entry</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Balance</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span>
                                         <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">currency</span><span class="p">),</span>
                                         <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">balance_entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">new_entries</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.ingest.importers.ofx.find_acctids">
<code class="highlight language-python">
find_acctids<span class="p">(</span><span class="n">contents</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.find_acctids" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Find the list of &lt;ACCTID&gt; tags.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>contents</code></td>
<td><code></code></td>
<td>
<p>A string, the contents of the OFX file.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of strings, the contents of the &lt;ACCTID&gt; tags.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>158
159
160
161
162
163
164
165
166
167
168
169</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_acctids</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
    <span class="sd">"""Find the list of &lt;ACCTID&gt; tags.</span>

<span class="sd">    Args:</span>
<span class="sd">      contents: A string, the contents of the OFX file.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of strings, the contents of the &lt;ACCTID&gt; tags.</span>
<span class="sd">    """</span>
    <span class="c1"># Match the account id. Don't bother parsing the entire thing as XML, just</span>
    <span class="c1"># match the tag for this purpose. This'll work fine enough.</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">'&lt;ACCTID&gt;([^&lt;]*)'</span><span class="p">,</span> <span class="n">contents</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.ingest.importers.ofx.find_child">
<code class="highlight language-python">
find_child<span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">conversion</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.find_child" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Find a child under the given node and return its value.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>node</code></td>
<td><code></code></td>
<td>
<p>A &lt;STMTTRN&gt; bs4.element.Tag.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>name</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the child node.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>conversion</code></td>
<td><code></code></td>
<td>
<p>A callable object used to convert the value to a new data type.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A string, or None.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_child</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">conversion</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Find a child under the given node and return its value.</span>

<span class="sd">    Args:</span>
<span class="sd">      node: A &lt;STMTTRN&gt; bs4.element.Tag.</span>
<span class="sd">      name: A string, the name of the child node.</span>
<span class="sd">      conversion: A callable object used to convert the value to a new data type.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A string, or None.</span>
<span class="sd">    """</span>
    <span class="n">child</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">conversion</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">conversion</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.ingest.importers.ofx.find_currency">
<code class="highlight language-python">
find_currency<span class="p">(</span><span class="n">soup</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.find_currency" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Find the first currency in the XML tree.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>soup</code></td>
<td><code></code></td>
<td>
<p>A BeautifulSoup root node.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A string, the first currency found in the file. Returns None if no currency
is found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>183
184
185
186
187
188
189
190
191
192
193
194
195
196</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_currency</span><span class="p">(</span><span class="n">soup</span><span class="p">):</span>
    <span class="sd">"""Find the first currency in the XML tree.</span>

<span class="sd">    Args:</span>
<span class="sd">      soup: A BeautifulSoup root node.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A string, the first currency found in the file. Returns None if no currency</span>
<span class="sd">      is found.</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">stmtrs</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">'.*stmtrs$'</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">currency_node</span> <span class="ow">in</span> <span class="n">stmtrs</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">'curdef'</span><span class="p">):</span>
            <span class="n">currency</span> <span class="o">=</span> <span class="n">currency_node</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">currency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">currency</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.ingest.importers.ofx.find_max_date">
<code class="highlight language-python">
find_max_date<span class="p">(</span><span class="n">contents</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.find_max_date" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Extract the report date from the file.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>172
173
174
175
176
177
178
179
180</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_max_date</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
    <span class="sd">"""Extract the report date from the file."""</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">bs4</span><span class="o">.</span><span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="s1">'lxml'</span><span class="p">)</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ledgerbal</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">'ledgerbal'</span><span class="p">):</span>
        <span class="n">dtasof</span> <span class="o">=</span> <span class="n">ledgerbal</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'dtasof'</span><span class="p">)</span>
        <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_ofx_time</span><span class="p">(</span><span class="n">dtasof</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">dates</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.ingest.importers.ofx.find_statement_transactions">
<code class="highlight language-python">
find_statement_transactions<span class="p">(</span><span class="n">soup</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.find_statement_transactions" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Find the statement transaction sections in the file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>soup</code></td>
<td><code></code></td>
<td>
<p>A BeautifulSoup root node.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p>Yields:
  A trip of
    An account id string,
    A currency string,
    A list of transaction nodes (&lt;STMTTRN&gt; BeautifulSoup tags), and
    A (date, balanace amount) for the &lt;LEDGERBAL&gt;.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_statement_transactions</span><span class="p">(</span><span class="n">soup</span><span class="p">):</span>
    <span class="sd">"""Find the statement transaction sections in the file.</span>

<span class="sd">    Args:</span>
<span class="sd">      soup: A BeautifulSoup root node.</span>
<span class="sd">    Yields:</span>
<span class="sd">      A trip of</span>
<span class="sd">        An account id string,</span>
<span class="sd">        A currency string,</span>
<span class="sd">        A list of transaction nodes (&lt;STMTTRN&gt; BeautifulSoup tags), and</span>
<span class="sd">        A (date, balanace amount) for the &lt;LEDGERBAL&gt;.</span>
<span class="sd">    """</span>
    <span class="c1"># Process STMTTRNRS and CCSTMTTRNRS tags.</span>
    <span class="k">for</span> <span class="n">stmtrs</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">'.*stmtrs$'</span><span class="p">)):</span>
        <span class="c1"># For each CURDEF tag.</span>
        <span class="k">for</span> <span class="n">currency_node</span> <span class="ow">in</span> <span class="n">stmtrs</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">'curdef'</span><span class="p">):</span>
            <span class="n">currency</span> <span class="o">=</span> <span class="n">currency_node</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># Extract ACCTID account information.</span>
            <span class="n">acctid_node</span> <span class="o">=</span> <span class="n">stmtrs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'acctid'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acctid_node</span><span class="p">:</span>
                <span class="n">acctid</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">acctid_node</span><span class="o">.</span><span class="n">children</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">acctid</span> <span class="o">=</span> <span class="s1">''</span>

            <span class="c1"># Get the LEDGERBAL node. There appears to be a single one for all</span>
            <span class="c1"># transaction lists.</span>
            <span class="n">ledgerbal</span> <span class="o">=</span> <span class="n">stmtrs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'ledgerbal'</span><span class="p">)</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">ledgerbal</span><span class="p">:</span>
                <span class="n">dtasof</span> <span class="o">=</span> <span class="n">find_child</span><span class="p">(</span><span class="n">ledgerbal</span><span class="p">,</span> <span class="s1">'dtasof'</span><span class="p">,</span> <span class="n">parse_ofx_time</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="n">balamt</span> <span class="o">=</span> <span class="n">find_child</span><span class="p">(</span><span class="n">ledgerbal</span><span class="p">,</span> <span class="s1">'balamt'</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
                <span class="n">balance</span> <span class="o">=</span> <span class="p">(</span><span class="n">dtasof</span><span class="p">,</span> <span class="n">balamt</span><span class="p">)</span>

            <span class="c1"># Process transaction lists (regular or credit-card).</span>
            <span class="k">for</span> <span class="n">tranlist</span> <span class="ow">in</span> <span class="n">stmtrs</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">'(|bank|cc)tranlist'</span><span class="p">)):</span>
                <span class="k">yield</span> <span class="n">acctid</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">tranlist</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">'stmttrn'</span><span class="p">),</span> <span class="n">balance</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.ingest.importers.ofx.parse_ofx_time">
<code class="highlight language-python">
parse_ofx_time<span class="p">(</span><span class="n">date_str</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx.parse_ofx_time" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Parse an OFX time string and return a datetime object.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>date_str</code></td>
<td><code></code></td>
<td>
<p>A string, the date to be parsed.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A datetime.datetime instance.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>144
145
146
147
148
149
150
151
152
153
154
155</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">parse_ofx_time</span><span class="p">(</span><span class="n">date_str</span><span class="p">):</span>
    <span class="sd">"""Parse an OFX time string and return a datetime object.</span>

<span class="sd">    Args:</span>
<span class="sd">      date_str: A string, the date to be parsed.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A datetime.datetime instance.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_str</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="s1">'%Y%m</span><span class="si">%d</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_str</span><span class="p">[:</span><span class="mi">14</span><span class="p">],</span> <span class="s1">'%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S'</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.ingest.importers.ofx_test">
<code>ofx_test</code>
<a class="headerlink" href="#beancount.ingest.importers.ofx_test" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.ingest.importers.ofx_test.clean_xml">
<code class="highlight language-python">
clean_xml<span class="p">(</span><span class="n">string</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.importers.ofx_test.clean_xml" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Compress some formatted XML as it might appear in a real file.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/importers/ofx_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>15
16
17
18</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">clean_xml</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">"""Compress some formatted XML as it might appear in a real file."""</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">"(^[ \t\n]+|[ \t\n]+$)"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span>
                  <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.regression">
<code>regression</code>
<a class="headerlink" href="#beancount.ingest.regression" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Support for implementing regression tests on sample files using nose.</p>
<p>NOTE: This itself is not a regression test. It's a library used to create
regression tests for your importers. Use it like this in your own importer code:</p>
<p>def test():
       importer = Importer([], {
           'FILE'  : 'Assets:US:MyBank:Main',
       })
       yield from regression.compare_sample_files(importer, <strong>file</strong>)</p>
<p>WARNING: This is deprecated. Nose itself has been deprecated for a while and
Beancount is now using only pytest. Ignore this and use
beancount.ingest.regression_ptest instead.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ingest.regression.ImportFileTestCase">
<code>ImportFileTestCase</code>
<a class="headerlink" href="#beancount.ingest.regression.ImportFileTestCase" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Base class for importer tests that compare output to an expected output
    text.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.regression.ImportFileTestCase.test_expect_extract">
<code class="highlight language-python">
test_expect_extract<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression.ImportFileTestCase.test_expect_extract" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Extract entries from a test file and compare against expected output.</p>
<p>If an expected file (as &lt;filename&gt;.extract) is not present, we issue a
warning. Missing expected files can be written out by removing them
before running the tests.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>filename</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the file to import using self.importer.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AssertionError</code></td>
<td>
<p>If the contents differ from the expected file.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="nd">@test_utils</span><span class="o">.</span><span class="n">skipIfRaises</span><span class="p">(</span><span class="n">ToolNotInstalled</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_expect_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="sd">"""Extract entries from a test file and compare against expected output.</span>

<span class="sd">    If an expected file (as &lt;filename&gt;.extract) is not present, we issue a</span>
<span class="sd">    warning. Missing expected files can be written out by removing them</span>
<span class="sd">    before running the tests.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename: A string, the name of the file to import using self.importer.</span>
<span class="sd">    Raises:</span>
<span class="sd">      AssertionError: If the contents differ from the expected file.</span>

<span class="sd">    """</span>
    <span class="c1"># Import the file.</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">extract</span><span class="o">.</span><span class="n">extract_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Render the entries to a string.</span>
    <span class="n">oss</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">printer</span><span class="o">.</span><span class="n">print_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">oss</span><span class="p">)</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">oss</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

    <span class="n">expect_filename</span> <span class="o">=</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">.extract'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">expect_filename</span><span class="p">):</span>
        <span class="n">expect_string</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">expect_filename</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expect_string</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Write out the expected file for review.</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">expect_filename</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s2">"Expected file not present; generating '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">expect_filename</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.regression.ImportFileTestCase.test_expect_file_date">
<code class="highlight language-python">
test_expect_file_date<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression.ImportFileTestCase.test_expect_file_date" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Compute the imported file date and compare to an expected output.</p>
<p>If an expected file (as &lt;filename&gt;.file_date) is not present, we issue a
warning. Missing expected files can be written out by removing them
before running the tests.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>filename</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the file to import using self.importer.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AssertionError</code></td>
<td>
<p>If the contents differ from the expected file.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="nd">@test_utils</span><span class="o">.</span><span class="n">skipIfRaises</span><span class="p">(</span><span class="n">ToolNotInstalled</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_expect_file_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="sd">"""Compute the imported file date and compare to an expected output.</span>

<span class="sd">    If an expected file (as &lt;filename&gt;.file_date) is not present, we issue a</span>
<span class="sd">    warning. Missing expected files can be written out by removing them</span>
<span class="sd">    before running the tests.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename: A string, the name of the file to import using self.importer.</span>
<span class="sd">    Raises:</span>
<span class="sd">      AssertionError: If the contents differ from the expected file.</span>
<span class="sd">    """</span>
    <span class="c1"># Import the date.</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">file_date</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">"No date produced from </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="n">expect_filename</span> <span class="o">=</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">.file_date'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">expect_filename</span><span class="p">)</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">expect_filename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">expect_date_str</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">expect_filename</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">expect_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">expect_date_str</span><span class="p">,</span> <span class="s1">'%Y-%m-</span><span class="si">%d</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expect_date</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Write out the expected file for review.</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">expect_filename</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y-%m-</span><span class="si">%d</span><span class="s1">'</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">outfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s2">"Expected file not present; generating '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">expect_filename</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.regression.ImportFileTestCase.test_expect_file_name">
<code class="highlight language-python">
test_expect_file_name<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression.ImportFileTestCase.test_expect_file_name" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Compute the imported file name and compare to an expected output.</p>
<p>If an expected file (as &lt;filename&gt;.file_name) is not present, we issue a
warning. Missing expected files can be written out by removing them
before running the tests.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>filename</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the file to import using self.importer.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AssertionError</code></td>
<td>
<p>If the contents differ from the expected file.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="nd">@test_utils</span><span class="o">.</span><span class="n">skipIfRaises</span><span class="p">(</span><span class="n">ToolNotInstalled</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_expect_file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="sd">"""Compute the imported file name and compare to an expected output.</span>

<span class="sd">    If an expected file (as &lt;filename&gt;.file_name) is not present, we issue a</span>
<span class="sd">    warning. Missing expected files can be written out by removing them</span>
<span class="sd">    before running the tests.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename: A string, the name of the file to import using self.importer.</span>
<span class="sd">    Raises:</span>
<span class="sd">      AssertionError: If the contents differ from the expected file.</span>
<span class="sd">    """</span>
    <span class="c1"># Import the date.</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">generated_basename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">generated_basename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">"No filename produced from </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

    <span class="c1"># Check that we're getting a non-null relative simple filename.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">generated_basename</span><span class="p">),</span> <span class="n">generated_basename</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotRegex</span><span class="p">(</span><span class="n">generated_basename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

    <span class="n">expect_filename</span> <span class="o">=</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">.file_name'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">expect_filename</span><span class="p">)</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">expect_filename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">expect_filename</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">expect_filename</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expect_filename</span><span class="p">,</span> <span class="n">generated_basename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Write out the expected file for review.</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">expect_filename</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">generated_basename</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s2">"Expected file not present; generating '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">expect_filename</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.regression.ImportFileTestCase.test_expect_identify">
<code class="highlight language-python">
test_expect_identify<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression.ImportFileTestCase.test_expect_identify" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Attempt to identify a file and expect results to be true.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>filename</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the file to import using self.importer.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AssertionError</code></td>
<td>
<p>If the contents differ from the expected file.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>56
57
58
59
60
61
62
63
64
65
66
67</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="nd">@test_utils</span><span class="o">.</span><span class="n">skipIfRaises</span><span class="p">(</span><span class="n">ToolNotInstalled</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_expect_identify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="sd">"""Attempt to identify a file and expect results to be true.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename: A string, the name of the file to import using self.importer.</span>
<span class="sd">    Raises:</span>
<span class="sd">      AssertionError: If the contents differ from the expected file.</span>
<span class="sd">    """</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">identify</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ingest.regression.ToolNotInstalled">
<code>ToolNotInstalled</code>
<a class="headerlink" href="#beancount.ingest.regression.ToolNotInstalled" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>An error to be used by converters when necessary software isn't there.</p>
<pre><code>Raising this exception from your converter code when the tool is not
installed will make the tests defined in this file skipped instead of
failing. This will happen when you test your converters on different
computers and/or platforms.
</code></pre>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.regression.compare_sample_files">
<code class="highlight language-python">
compare_sample_files<span class="p">(</span><span class="n">importer</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression.compare_sample_files" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Compare the sample files under a directory.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>importer</code></td>
<td><code></code></td>
<td>
<p>An instance of an Importer.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>directory</code></td>
<td><code></code></td>
<td>
<p>A string, the directory to scour for sample files or a filename
  in that directory. If a directory is not provided, the directory of
  the file from which the importer class is defined is used.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>ignore_cls</code></td>
<td><code></code></td>
<td>
<p>An optional base class of the importer whose methods should
not trigger the addition of a test. For example, if you are deriving
from a base class which is already well-tested, you may not want to have
a regression test case generated for those methods. This was used to
ignore methods provided from a common backwards compatibility support
class.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p>Yields:
  Generated tests as per nose's requirements (a callable and arguments for
  it).</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="nd">@deprecated</span><span class="p">(</span><span class="s2">"Use beancount.ingest.regression_pytest instead"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compare_sample_files</span><span class="p">(</span><span class="n">importer</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Compare the sample files under a directory.</span>

<span class="sd">    Args:</span>
<span class="sd">      importer: An instance of an Importer.</span>
<span class="sd">      directory: A string, the directory to scour for sample files or a filename</span>
<span class="sd">          in that directory. If a directory is not provided, the directory of</span>
<span class="sd">          the file from which the importer class is defined is used.</span>
<span class="sd">      ignore_cls: An optional base class of the importer whose methods should</span>
<span class="sd">        not trigger the addition of a test. For example, if you are deriving</span>
<span class="sd">        from a base class which is already well-tested, you may not want to have</span>
<span class="sd">        a regression test case generated for those methods. This was used to</span>
<span class="sd">        ignore methods provided from a common backwards compatibility support</span>
<span class="sd">        class.</span>
<span class="sd">    Yields:</span>
<span class="sd">      Generated tests as per nose's requirements (a callable and arguments for</span>
<span class="sd">      it).</span>
<span class="sd">    """</span>
    <span class="c1"># If the directory is not specified, use the directory where the importer</span>
    <span class="c1"># class was defined.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">directory</span><span class="p">:</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">importer</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span><span class="o">.</span><span class="vm">__file__</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">find_input_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="c1"># For each of the methods to be tested, check if there is an actual</span>
        <span class="c1"># implementation and if so, run a comparison with an expected file.</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'identify'</span><span class="p">,</span>
                     <span class="s1">'extract'</span><span class="p">,</span>
                     <span class="s1">'file_date'</span><span class="p">,</span>
                     <span class="s1">'file_name'</span><span class="p">]:</span>
            <span class="c1"># Check if the method has been overridden from the protocol</span>
            <span class="c1"># interface. If so, even if it's provided by concretely inherited</span>
            <span class="c1"># method, we want to require a test against that method.</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">importer</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="vm">__func__</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ImporterProtocol</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">ignore_cls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ignore_cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))):</span>
                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ImportFileTestCase</span><span class="p">(</span><span class="n">importer</span><span class="p">),</span>
                                 <span class="s1">'test_expect_</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.regression.find_input_files">
<code class="highlight language-python">
find_input_files<span class="p">(</span><span class="n">directory</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression.find_input_files" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Find the input files in the module where the class is defined.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>directory</code></td>
<td><code></code></td>
<td>
<p>A string, the path to a root directory to check for.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p>Yields:
  Strings, the absolute filenames of sample input and expected files.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>167
168
169
170
171
172
173
174
175
176
177
178
179</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_input_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="sd">"""Find the input files in the module where the class is defined.</span>

<span class="sd">    Args:</span>
<span class="sd">      directory: A string, the path to a root directory to check for.</span>
<span class="sd">    Yields:</span>
<span class="sd">      Strings, the absolute filenames of sample input and expected files.</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">sroot</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">'.*\.(extract|file_date|file_name|py|pyc|DS_Store)$'</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sroot</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.regression_pytest">
<code>regression_pytest</code>
<a class="headerlink" href="#beancount.ingest.regression_pytest" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Support for implementing regression tests on sample files using pytest.</p>
<p>This module provides definitions for testing a custom importer against a set of
existing downloaded files, running the various importer interface methods on it,
and comparing the output to an expected text file. (Expected test files can be
auto-generated using the --generate option). You use it like this:</p>
<p>from beancount.ingest import regression_pytest
  ...
  import mymodule
  ...</p>
<p># Create your importer instance used for testing.
  importer = mymodule.Importer(...)</p>
<p># Select a directory where your test files are to be located.
  directory = ...</p>
<p># Create a test case using the base in this class.</p>
<p>@regression_pytest.with_importer(importer)
  @regression_pytest.with_testdir(directory)
  class TestImporter(regtest.ImporterTestBase):
      pass</p>
<p>Also, to add the --generate option to 'pytest', you must create a conftest.py
somewhere in one of the roots above your importers with this module as a plugin:</p>
<p>pytest_plugins = "beancount.ingest.regression_pytest"</p>
<p>See beancount/example/ingest for a full working example.</p>
<p>How to invoke the tests:</p>
<p>Via pytest. First run your test with the --generate option to generate all the
expected files. Then inspect them visually for correctness. Finally, check them
in to preserve them. You should be able to regress against those correct outputs
in the future. Use version control to your advantage to visualize the
differences.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ingest.regression_pytest.ImporterTestBase">
<code>ImporterTestBase</code>
<a class="headerlink" href="#beancount.ingest.regression_pytest.ImporterTestBase" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.regression_pytest.ImporterTestBase.test_extract">
<code class="highlight language-python">
test_extract<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pytestconfig</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression_pytest.ImporterTestBase.test_extract" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Extract entries from a test file and compare against expected output.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression_pytest.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>125
126
127
128
129
130
131
132</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">test_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pytestconfig</span><span class="p">):</span>
    <span class="sd">"""Extract entries from a test file and compare against expected output."""</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">extract</span><span class="o">.</span><span class="n">extract_from_file</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">oss</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">printer</span><span class="o">.</span><span class="n">print_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">oss</span><span class="p">)</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">oss</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">compare_contents_or_generate</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">.extract'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                                 <span class="n">pytestconfig</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">"generate"</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.regression_pytest.ImporterTestBase.test_file_account">
<code class="highlight language-python">
test_file_account<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pytestconfig</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression_pytest.ImporterTestBase.test_file_account" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Compute the selected filing account and compare to an expected output.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression_pytest.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>147
148
149
150
151</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">test_file_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pytestconfig</span><span class="p">):</span>
    <span class="sd">"""Compute the selected filing account and compare to an expected output."""</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">file_account</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">''</span>
    <span class="n">compare_contents_or_generate</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">.file_account'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                                 <span class="n">pytestconfig</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">"generate"</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.regression_pytest.ImporterTestBase.test_file_date">
<code class="highlight language-python">
test_file_date<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pytestconfig</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression_pytest.ImporterTestBase.test_file_date" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Compute the imported file date and compare to an expected output.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression_pytest.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>134
135
136
137
138
139</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">test_file_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pytestconfig</span><span class="p">):</span>
    <span class="sd">"""Compute the imported file date and compare to an expected output."""</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">file_date</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">date</span> <span class="k">else</span> <span class="s1">''</span>
    <span class="n">compare_contents_or_generate</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">.file_date'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                                 <span class="n">pytestconfig</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">"generate"</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.regression_pytest.ImporterTestBase.test_file_name">
<code class="highlight language-python">
test_file_name<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pytestconfig</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression_pytest.ImporterTestBase.test_file_name" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Compute the imported file name and compare to an expected output.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression_pytest.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>141
142
143
144
145</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">test_file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pytestconfig</span><span class="p">):</span>
    <span class="sd">"""Compute the imported file name and compare to an expected output."""</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">''</span>
    <span class="n">compare_contents_or_generate</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">.file_name'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                                 <span class="n">pytestconfig</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">"generate"</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.regression_pytest.ImporterTestBase.test_identify">
<code class="highlight language-python">
test_identify<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression_pytest.ImporterTestBase.test_identify" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Attempt to identify a file and expect results to be true.</p>
<p>This method does not need to check against an existing expect file. It
is just assumed it should return True if your test is setup well (the
importer should always identify the test file).</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression_pytest.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>116
117
118
119
120
121
122
123</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">test_identify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="sd">"""Attempt to identify a file and expect results to be true.</span>

<span class="sd">    This method does not need to check against an existing expect file. It</span>
<span class="sd">    is just assumed it should return True if your test is setup well (the</span>
<span class="sd">    importer should always identify the test file).</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="n">importer</span><span class="o">.</span><span class="n">identify</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.regression_pytest.compare_contents_or_generate">
<code class="highlight language-python">
compare_contents_or_generate<span class="p">(</span><span class="n">actual_string</span><span class="p">,</span> <span class="n">expect_fn</span><span class="p">,</span> <span class="n">generate</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression_pytest.compare_contents_or_generate" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Compare a string to the contents of an expect file.</p>
<p>Assert if different; auto-generate otherwise.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>actual_string</code></td>
<td><code></code></td>
<td>
<p>The expected string contents.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>expect_fn</code></td>
<td><code></code></td>
<td>
<p>The filename whose contents to read and compare against.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>generate</code></td>
<td><code></code></td>
<td>
<p>A boolean, true if we are to generate the tests.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression_pytest.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">compare_contents_or_generate</span><span class="p">(</span><span class="n">actual_string</span><span class="p">,</span> <span class="n">expect_fn</span><span class="p">,</span> <span class="n">generate</span><span class="p">):</span>
    <span class="sd">"""Compare a string to the contents of an expect file.</span>

<span class="sd">    Assert if different; auto-generate otherwise.</span>

<span class="sd">    Args:</span>
<span class="sd">      actual_string: The expected string contents.</span>
<span class="sd">      expect_fn: The filename whose contents to read and compare against.</span>
<span class="sd">      generate: A boolean, true if we are to generate the tests.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">generate</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">expect_fn</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">expect_file</span><span class="p">:</span>
            <span class="n">expect_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">actual_string</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">actual_string</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">actual_string</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">):</span>
                <span class="n">expect_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">"Generated '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expect_fn</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Run the test on an existing expected file.</span>
        <span class="k">assert</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">expect_fn</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">"Expected file '</span><span class="si">{}</span><span class="s2">' is missing. Generate it?"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expect_fn</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">expect_fn</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
            <span class="n">expect_string</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">expect_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">actual_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.regression_pytest.find_input_files">
<code class="highlight language-python">
find_input_files<span class="p">(</span><span class="n">directory</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression_pytest.find_input_files" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Find the input files in the module where the class is defined.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>directory</code></td>
<td><code></code></td>
<td>
<p>A string, the path to a root directory to check for.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p>Yields:
  Strings, the absolute filenames of sample input and expected files.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression_pytest.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>73
74
75
76
77
78
79
80
81
82
83
84
85
86</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_input_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="sd">"""Find the input files in the module where the class is defined.</span>

<span class="sd">    Args:</span>
<span class="sd">      directory: A string, the path to a root directory to check for.</span>
<span class="sd">    Yields:</span>
<span class="sd">      Strings, the absolute filenames of sample input and expected files.</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">sroot</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">'.*\.(extract|file_date|file_name|file_account|py|pyc|DS_Store)$'</span><span class="p">,</span>
                        <span class="n">filename</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sroot</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.regression_pytest.pytest_addoption">
<code class="highlight language-python">
pytest_addoption<span class="p">(</span><span class="n">parser</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression_pytest.pytest_addoption" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Add an option to generate the expected files for the tests.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression_pytest.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>55
56
57
58
59</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">pytest_addoption</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="sd">"""Add an option to generate the expected files for the tests."""</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getgroup</span><span class="p">(</span><span class="s2">"beancount"</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">"--generate"</span><span class="p">,</span> <span class="s2">"--gen"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">"store_true"</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">"Don't test; rather, generate the expected files"</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.regression_pytest.with_importer">
<code class="highlight language-python">
with_importer<span class="p">(</span><span class="n">importer</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression_pytest.with_importer" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Parametrizing fixture that provides the importer to test.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression_pytest.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>62
63
64</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">with_importer</span><span class="p">(</span><span class="n">importer</span><span class="p">):</span>
    <span class="sd">"""Parametrizing fixture that provides the importer to test."""</span>
    <span class="k">return</span> <span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">"importer"</span><span class="p">,</span> <span class="p">[</span><span class="n">importer</span><span class="p">])</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.regression_pytest.with_testdir">
<code class="highlight language-python">
with_testdir<span class="p">(</span><span class="n">directory</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.regression_pytest.with_testdir" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Parametrizing fixture that provides files from a directory.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/regression_pytest.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>67
68
69
70</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">with_testdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="sd">"""Parametrizing fixture that provides files from a directory."""</span>
    <span class="k">return</span> <span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
        <span class="s2">"file"</span><span class="p">,</span> <span class="p">[</span><span class="n">cache</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">find_input_files</span><span class="p">(</span><span class="n">directory</span><span class="p">)])</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.regression_test">
<code>regression_test</code>
<a class="headerlink" href="#beancount.ingest.regression_test" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>TD Ameritrade PDF statement importer.</p>
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.scripts_utils">
<code>scripts_utils</code>
<a class="headerlink" href="#beancount.ingest.scripts_utils" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Common front-end to all ingestion tools.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ingest.scripts_utils.TestScriptsBase">
<code>TestScriptsBase</code>
<a class="headerlink" href="#beancount.ingest.scripts_utils.TestScriptsBase" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.scripts_utils.TestScriptsBase.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.scripts_utils.TestScriptsBase.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/scripts_utils.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>306
307
308
309
310
311
312
313
314</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">contents</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">absname</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">absname</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">absname</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.py'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.sh'</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">absname</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span><span class="o">|</span><span class="n">stat</span><span class="o">.</span><span class="n">S_IXUSR</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.scripts_utils.create_legacy_arguments_parser">
<code class="highlight language-python">
create_legacy_arguments_parser<span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">run_func</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.scripts_utils.create_legacy_arguments_parser" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Create an arguments parser for all the ingestion bean-tools.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>description</code></td>
<td><code>str</code></td>
<td>
<p>The program description string.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>func</code></td>
<td><code></code></td>
<td>
<p>A callable function to run the particular command.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>An argparse.Namespace instance with the rest of arguments in 'rest'.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/scripts_utils.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">create_legacy_arguments_parser</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_func</span><span class="p">:</span> <span class="n">callable</span><span class="p">):</span>
    <span class="sd">"""Create an arguments parser for all the ingestion bean-tools.</span>

<span class="sd">    Args:</span>
<span class="sd">      description: The program description string.</span>
<span class="sd">      func: A callable function to run the particular command.</span>
<span class="sd">    Returns:</span>
<span class="sd">      An argparse.Namespace instance with the rest of arguments in 'rest'.</span>
<span class="sd">    """</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">'CONFIG_FILENAME'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">'Importer configuration file. '</span>
                              <span class="s1">'This is a Python file with a data structure that '</span>
                              <span class="s1">'is specific to your accounts'</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'downloads'</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">'+'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">'DIR-OR-FILE'</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'Filenames or directories to search for files to import'</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">run_func</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.scripts_utils.ingest">
<code class="highlight language-python">
ingest<span class="p">(</span><span class="n">importers_list</span><span class="p">,</span> <span class="n">detect_duplicates_func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.scripts_utils.ingest" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Driver function that calls all the ingestion tools.</p>
<p>Put a call to this function at the end of your importer configuration to
make your import script; this should be its main function, like this:</p>
<p>from beancount.ingest.scripts_utils import ingest
  my_importers = [ ... ]
  ingest(my_importers)</p>
<p>This more explicit way of invoking the ingestion is now the preferred way to
invoke the various tools, and replaces calling the bean-identify,
bean-extract, bean-file tools with a --config argument. When you call the
import script itself (as as program) it will parse the arguments, expecting
a subcommand ('identify', 'extract' or 'file') and corresponding
subcommand-specific arguments.</p>
<p>Here you can override some importer values, such as installing a custom
duplicate finding hook, and eventually more. Note that this newer invocation
method is optional and if it is not present, a call to ingest() is generated
implicitly, and it functions as it used to. Future configurable
customization of the ingestion process will be implemented by inserting new
arguments to this function, this is the motivation behind doing this.</p>
<p>Note that invocation by the three bean-* ingestion tools is still supported,
and calling ingest() explicitly from your import configuration file will not
break these tools either, if you invoke them on it; the values you provide
to this function will be used by those tools.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>importers_list</code></td>
<td><code></code></td>
<td>
<p>A list of importer instances. This is used as a
chain-of-responsibility, called on each file.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>detect_duplicates_func</code></td>
<td><code></code></td>
<td>
<p>An optional function which accepts a list of
lists of imported entries and a list of entries already existing in
the user's ledger. See function find_duplicate_entries(), which is the
default implementation for this.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/scripts_utils.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">ingest</span><span class="p">(</span><span class="n">importers_list</span><span class="p">,</span> <span class="n">detect_duplicates_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Driver function that calls all the ingestion tools.</span>

<span class="sd">    Put a call to this function at the end of your importer configuration to</span>
<span class="sd">    make your import script; this should be its main function, like this:</span>

<span class="sd">      from beancount.ingest.scripts_utils import ingest</span>
<span class="sd">      my_importers = [ ... ]</span>
<span class="sd">      ingest(my_importers)</span>

<span class="sd">    This more explicit way of invoking the ingestion is now the preferred way to</span>
<span class="sd">    invoke the various tools, and replaces calling the bean-identify,</span>
<span class="sd">    bean-extract, bean-file tools with a --config argument. When you call the</span>
<span class="sd">    import script itself (as as program) it will parse the arguments, expecting</span>
<span class="sd">    a subcommand ('identify', 'extract' or 'file') and corresponding</span>
<span class="sd">    subcommand-specific arguments.</span>

<span class="sd">    Here you can override some importer values, such as installing a custom</span>
<span class="sd">    duplicate finding hook, and eventually more. Note that this newer invocation</span>
<span class="sd">    method is optional and if it is not present, a call to ingest() is generated</span>
<span class="sd">    implicitly, and it functions as it used to. Future configurable</span>
<span class="sd">    customization of the ingestion process will be implemented by inserting new</span>
<span class="sd">    arguments to this function, this is the motivation behind doing this.</span>

<span class="sd">    Note that invocation by the three bean-* ingestion tools is still supported,</span>
<span class="sd">    and calling ingest() explicitly from your import configuration file will not</span>
<span class="sd">    break these tools either, if you invoke them on it; the values you provide</span>
<span class="sd">    to this function will be used by those tools.</span>

<span class="sd">    Args:</span>
<span class="sd">      importers_list: A list of importer instances. This is used as a</span>
<span class="sd">        chain-of-responsibility, called on each file.</span>
<span class="sd">      detect_duplicates_func: An optional function which accepts a list of</span>
<span class="sd">        lists of imported entries and a list of entries already existing in</span>
<span class="sd">        the user's ledger. See function find_duplicate_entries(), which is the</span>
<span class="sd">        default implementation for this.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">ingest</span><span class="o">.</span><span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># The script has been called from one of the bean-* ingestion tools.</span>
        <span class="c1"># 'ingest.args' is only set when we're being invoked from one of the</span>
        <span class="c1"># bean-xxx tools (see below).</span>

        <span class="c1"># Mark this function as called, so that if it is called from an import</span>
        <span class="c1"># triggered by one of the ingestion tools, it won't be called again</span>
        <span class="c1"># afterwards.</span>
        <span class="n">ingest</span><span class="o">.</span><span class="n">was_called</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Use those args rather than to try to parse the command-line arguments</span>
        <span class="c1"># from a naked ingest() call as a script. {39c7af4f6af5}</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">ingest</span><span class="o">.</span><span class="n">args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># The script is called directly. This is the main program of the import</span>
        <span class="c1"># script itself. This is the new invocation method.</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">DESCRIPTION</span><span class="p">)</span>

        <span class="c1"># Use required on subparsers.</span>
        <span class="c1"># FIXME: Remove this when we require version 3.7 or above.</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">'required'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">subparsers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">dest</span><span class="o">=</span><span class="s1">'command'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--downloads'</span><span class="p">,</span> <span class="s1">'-d'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">'DIR-OR-FILE'</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s1">'append'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">'Filenames or directories to search for files to import'</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cmdname</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">'identify'</span><span class="p">,</span> <span class="n">identify</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">'extract'</span><span class="p">,</span> <span class="n">extract</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">'file'</span><span class="p">,</span> <span class="n">file</span><span class="p">)]:</span>
            <span class="n">parser_cmd</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="n">cmdname</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">module</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">)</span>
            <span class="n">parser_cmd</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">module</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
            <span class="n">module</span><span class="o">.</span><span class="n">add_arguments</span><span class="p">(</span><span class="n">parser_cmd</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">downloads</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">downloads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

        <span class="c1"># Implement required ourselves.</span>
        <span class="c1"># FIXME: Remove this when we require version 3.7 or above.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">'command'</span><span class="p">):</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Subcommand is required."</span><span class="p">)</span>

    <span class="n">abs_downloads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">downloads</span><span class="p">))</span>
    <span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">importers_list</span><span class="p">,</span> <span class="n">abs_downloads</span><span class="p">,</span>
                 <span class="n">detect_duplicates_func</span><span class="o">=</span><span class="n">detect_duplicates_func</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.scripts_utils.run_import_script_and_ingest">
<code class="highlight language-python">
run_import_script_and_ingest<span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">argv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">importers_attr_name</span><span class="o">=</span><span class="s1">'CONFIG'</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.scripts_utils.run_import_script_and_ingest" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Run the import script and optionally call ingest().</p>
<p>This path is only called when trampolined by one of the bean-* ingestion
tools.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>parser</code></td>
<td><code></code></td>
<td>
<p>The parser instance, used only to report errors.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>importers_attr_name</code></td>
<td><code></code></td>
<td>
<p>The name of the special attribute in the module which
defines the importers list.</p>
</td>
<td><code>'CONFIG'</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>An execution return code.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/scripts_utils.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">run_import_script_and_ingest</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">argv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">importers_attr_name</span><span class="o">=</span><span class="s1">'CONFIG'</span><span class="p">):</span>
    <span class="sd">"""Run the import script and optionally call ingest().</span>

<span class="sd">    This path is only called when trampolined by one of the bean-* ingestion</span>
<span class="sd">    tools.</span>

<span class="sd">    Args:</span>
<span class="sd">      parser: The parser instance, used only to report errors.</span>
<span class="sd">      importers_attr_name: The name of the special attribute in the module which</span>
<span class="sd">        defines the importers list.</span>
<span class="sd">    Returns:</span>
<span class="sd">      An execution return code.</span>
<span class="sd">    """</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">argv</span><span class="p">)</span>

    <span class="c1"># Check the existence of the config.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"File does not exist: '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>

    <span class="c1"># Check the existence of all specified files.</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">downloads</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"File does not exist: '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

    <span class="c1"># Reset the state of ingest() being called (for unit tests, which use the</span>
    <span class="c1"># same runtime with run_with_args).</span>
    <span class="n">ingest</span><span class="o">.</span><span class="n">was_called</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Save the arguments parsed from the command-line as default for</span>
    <span class="c1"># {39c7af4f6af5}.</span>
    <span class="n">ingest</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">,</span> <span class="n">parser</span>

    <span class="c1"># Evaluate the importer script/module.</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">runpy</span><span class="o">.</span><span class="n">run_path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># If the importer script has already called ingest() within itself, don't</span>
    <span class="c1"># call it again. We're done. This allows the use to insert an explicit call</span>
    <span class="c1"># to ingest() while still running the bean-* ingestion tools on the file.</span>
    <span class="k">if</span> <span class="n">ingest</span><span class="o">.</span><span class="n">was_called</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># ingest() hasn't been called by the script so we assume it isn't</span>
    <span class="c1"># present in it. So we now run the ingestion by ourselves here, without</span>
    <span class="c1"># specifying any of the newer optional arguments.</span>
    <span class="n">importers_list</span> <span class="o">=</span> <span class="n">mod</span><span class="p">[</span><span class="n">importers_attr_name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ingest</span><span class="p">(</span><span class="n">importers_list</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.scripts_utils.trampoline_to_ingest">
<code class="highlight language-python">
trampoline_to_ingest<span class="p">(</span><span class="n">module</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.scripts_utils.trampoline_to_ingest" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Parse arguments for bean tool, import config script and ingest.</p>
<p>This function is called by the three bean-* tools to support the older
import files, which only required a CONFIG object to be defined in them.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>module</code></td>
<td><code></code></td>
<td>
<p>One of the identify, extract or file module objects.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>An execution return code.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/scripts_utils.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">trampoline_to_ingest</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
    <span class="sd">"""Parse arguments for bean tool, import config script and ingest.</span>

<span class="sd">    This function is called by the three bean-* tools to support the older</span>
<span class="sd">    import files, which only required a CONFIG object to be defined in them.</span>

<span class="sd">    Args:</span>
<span class="sd">      module: One of the identify, extract or file module objects.</span>
<span class="sd">    Returns:</span>
<span class="sd">      An execution return code.</span>
<span class="sd">    """</span>
    <span class="c1"># Disable debugging logging which is turned on by default in chardet.</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">'chardet.charsetprober'</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">'chardet.universaldetector'</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">create_legacy_arguments_parser</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
    <span class="n">module</span><span class="o">.</span><span class="n">add_arguments</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">run_import_script_and_ingest</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.similar">
<code>similar</code>
<a class="headerlink" href="#beancount.ingest.similar" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Identify similar entries.</p>
<p>This can be used during import in order to identify and flag duplicate entries.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ingest.similar.SimilarityComparator">
<code>SimilarityComparator</code>
<a class="headerlink" href="#beancount.ingest.similar.SimilarityComparator" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Similarity comparator of transactions.</p>
<pre><code>This comparator needs to be able to handle Transaction instances which are
incomplete on one side, which have slightly different dates, or potentially
slightly different numbers.
</code></pre>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.similar.SimilarityComparator.__call__">
<code class="highlight language-python">
__call__<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry1</span><span class="p">,</span> <span class="n">entry2</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ingest.similar.SimilarityComparator.__call__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Compare two entries, return true if they are deemed similar.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entry1</code></td>
<td><code></code></td>
<td>
<p>A first Transaction directive.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>entry2</code></td>
<td><code></code></td>
<td>
<p>A second Transaction directive.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A boolean.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/similar.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry1</span><span class="p">,</span> <span class="n">entry2</span><span class="p">):</span>
    <span class="sd">"""Compare two entries, return true if they are deemed similar.</span>

<span class="sd">    Args:</span>
<span class="sd">      entry1: A first Transaction directive.</span>
<span class="sd">      entry2: A second Transaction directive.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A boolean.</span>
<span class="sd">    """</span>
    <span class="c1"># Check the date difference.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_date_delta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">((</span><span class="n">entry1</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">entry2</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
                 <span class="k">if</span> <span class="n">entry1</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="n">entry2</span><span class="o">.</span><span class="n">date</span> <span class="k">else</span>
                 <span class="p">(</span><span class="n">entry2</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">entry1</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_date_delta</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">amounts1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">entry1</span><span class="p">)]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">amounts1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">entry1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">amounts_map</span><span class="p">(</span><span class="n">entry1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">amounts2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">entry2</span><span class="p">)]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">amounts2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">entry2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">amounts_map</span><span class="p">(</span><span class="n">entry2</span><span class="p">)</span>

    <span class="c1"># Look for amounts on common accounts.</span>
    <span class="n">common_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">amounts1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">amounts2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">common_keys</span><span class="p">):</span>
        <span class="c1"># Compare the amounts.</span>
        <span class="n">number1</span> <span class="o">=</span> <span class="n">amounts1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">number2</span> <span class="o">=</span> <span class="n">amounts2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">number1</span> <span class="o">==</span> <span class="n">ZERO</span> <span class="ow">and</span> <span class="n">number2</span> <span class="o">==</span> <span class="n">ZERO</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">number1</span> <span class="o">/</span> <span class="n">number2</span><span class="p">)</span>
                   <span class="k">if</span> <span class="n">number2</span> <span class="o">!=</span> <span class="n">ZERO</span>
                   <span class="k">else</span> <span class="p">(</span><span class="n">number2</span> <span class="o">/</span> <span class="n">number1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">==</span> <span class="n">ZERO</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">ONE</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">ONE</span><span class="o">/</span><span class="n">diff</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">-</span> <span class="n">ONE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">EPSILON</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Here, we have found at least one common account with a close</span>
    <span class="c1"># amount. Now, we require that the set of accounts are equal or that</span>
    <span class="c1"># one be a subset of the other.</span>
    <span class="n">accounts1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span> <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry1</span><span class="o">.</span><span class="n">postings</span><span class="p">)</span>
    <span class="n">accounts2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span> <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry2</span><span class="o">.</span><span class="n">postings</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">accounts1</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">accounts2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">accounts2</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">accounts1</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.similar.SimilarityComparator.__init__">
<code class="highlight language-python">
__init__<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_date_delta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ingest.similar.SimilarityComparator.__init__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Constructor a comparator of entries.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>max_date_delta</code></td>
<td><code></code></td>
<td>
<p>A datetime.timedelta instance of the max tolerated
distance between dates.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/similar.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>71
72
73
74
75
76
77
78</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_date_delta</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Constructor a comparator of entries.</span>
<span class="sd">    Args:</span>
<span class="sd">      max_date_delta: A datetime.timedelta instance of the max tolerated</span>
<span class="sd">        distance between dates.</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_date_delta</span> <span class="o">=</span> <span class="n">max_date_delta</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.similar.amounts_map">
<code class="highlight language-python">
amounts_map<span class="p">(</span><span class="n">entry</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.similar.amounts_map" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Compute a mapping of (account, currency) -&gt; Decimal balances.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entry</code></td>
<td><code></code></td>
<td>
<p>A Transaction instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A dict of account -&gt; Amount balance.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/similar.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">amounts_map</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
    <span class="sd">"""Compute a mapping of (account, currency) -&gt; Decimal balances.</span>

<span class="sd">    Args:</span>
<span class="sd">      entry: A Transaction instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A dict of account -&gt; Amount balance.</span>
<span class="sd">    """</span>
    <span class="n">amounts</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
        <span class="c1"># Skip interpolated postings.</span>
        <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">meta</span> <span class="ow">and</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">AUTOMATIC_META</span> <span class="ow">in</span> <span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">currency</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">)</span> <span class="ow">and</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
            <span class="n">amounts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span>
    <span class="k">return</span> <span class="n">amounts</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ingest.similar.find_similar_entries">
<code class="highlight language-python">
find_similar_entries<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">source_entries</span><span class="p">,</span> <span class="n">comparator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window_days</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.similar.find_similar_entries" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Find which entries from a list are potential duplicates of a set.</p>
<p>Note: If there are multiple entries from 'source_entries' matching an entry
in 'entries', only the first match is returned. Note that this function
could in theory decide to merge some of the imported entries with each
other.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>The list of entries to classify as duplicate or note.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>source_entries</code></td>
<td><code></code></td>
<td>
<p>The list of entries against which to match. This is the
previous, or existing set of entries to compare against. This may be null
or empty.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>comparator</code></td>
<td><code></code></td>
<td>
<p>A functor used to establish the similarity of two entries.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>window_days</code></td>
<td><code></code></td>
<td>
<p>The number of days (inclusive) before or after to scan the
entries to classify against.</p>
</td>
<td><code>2</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of pairs of entries (entry, source_entry) where entry is from
'entries' and is deemed to be a duplicate of source_entry, from
'source_entries'.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ingest/similar.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_similar_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">source_entries</span><span class="p">,</span> <span class="n">comparator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window_days</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">"""Find which entries from a list are potential duplicates of a set.</span>

<span class="sd">    Note: If there are multiple entries from 'source_entries' matching an entry</span>
<span class="sd">    in 'entries', only the first match is returned. Note that this function</span>
<span class="sd">    could in theory decide to merge some of the imported entries with each</span>
<span class="sd">    other.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: The list of entries to classify as duplicate or note.</span>
<span class="sd">      source_entries: The list of entries against which to match. This is the</span>
<span class="sd">        previous, or existing set of entries to compare against. This may be null</span>
<span class="sd">        or empty.</span>
<span class="sd">      comparator: A functor used to establish the similarity of two entries.</span>
<span class="sd">      window_days: The number of days (inclusive) before or after to scan the</span>
<span class="sd">        entries to classify against.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of pairs of entries (entry, source_entry) where entry is from</span>
<span class="sd">      'entries' and is deemed to be a duplicate of source_entry, from</span>
<span class="sd">      'source_entries'.</span>
<span class="sd">    """</span>
    <span class="n">window_head</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">window_days</span><span class="p">)</span>
    <span class="n">window_tail</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">window_days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">comparator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">comparator</span> <span class="o">=</span> <span class="n">SimilarityComparator</span><span class="p">()</span>

    <span class="c1"># For each of the new entries, look at existing entries at a nearby date.</span>
    <span class="n">duplicates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">source_entries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">filter_txns</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">source_entry</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">filter_txns</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">iter_entry_dates</span><span class="p">(</span><span class="n">source_entries</span><span class="p">,</span>
                                          <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">-</span> <span class="n">window_head</span><span class="p">,</span>
                                          <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">window_tail</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">comparator</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">source_entry</span><span class="p">):</span>
                    <span class="n">duplicates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">entry</span><span class="p">,</span> <span class="n">source_entry</span><span class="p">))</span>
                    <span class="k">break</span>
    <span class="k">return</span> <span class="n">duplicates</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ingest.similar_test">
<code>similar_test</code>
<a class="headerlink" href="#beancount.ingest.similar_test" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ingest.similar_test.TestSimilarityComparator">
<code>TestSimilarityComparator</code>
<a class="headerlink" href="#beancount.ingest.similar_test.TestSimilarityComparator" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ingest.similar_test.TestSimilarityComparator.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ingest.similar_test.TestSimilarityComparator.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/ingest/similar_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>130
131</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">comparator</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">SimilarityComparator</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<footer>
<div aria-label="footer navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-right" href="beancount.loader.html" title="beancount.loader">Next <span class="icon icon-circle-arrow-right"></span></a>
<a class="btn btn-neutral" href="beancount.core.html" title="beancount.core"><span class="icon icon-circle-arrow-left"></span> Previous</a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<a class="fa fa-github" href="https://github.com/xuhcc/beancount-docs/" style="float: left; color: #fcfcfc"> GitHub</a>
<span><a href="beancount.core.html" style="color: #fcfcfc;">« Previous</a></span>
<span style="margin-left: 15px"><a href="beancount.loader.html" style="color: #fcfcfc">Next »</a></span>
</span>
</div>
<script>var base_url = '..';</script>
<script defer="" src="../js/theme.js"></script>
<script defer="" src="../js/extra.js"></script>
<script defer="">
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>
</body>
</html>
