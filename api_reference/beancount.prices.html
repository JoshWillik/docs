<!DOCTYPE html>

<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://xuhcc.github.io/beancount-docs/api_reference/beancount.prices.html" rel="canonical"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>beancount.prices - Beancount Documentation</title>
<link href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet">
<link href="../css/theme.css" rel="stylesheet">
<link href="../css/theme_extra.css" rel="stylesheet"/>
<link href="../css/custom.css" rel="stylesheet"/>
<script>
    // Current page data
    var mkdocs_page_name = "beancount.prices";
    var mkdocs_page_input_path = "api_reference/beancount.prices.md";
    var mkdocs_page_url = "/beancount-docs/api_reference/beancount.prices.html";
  </script>
<script defer="" src="../js/jquery-2.1.1.min.js"></script>
<script defer="" src="../js/modernizr-2.8.3.min.js"></script>
</link></link></head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href=".."> Beancount Documentation</a>
</div>
<div aria-label="main navigation" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Index</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Outline</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="#">Documentation for Users</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../01_command_line_accounting_in_context.html">Command Line Accounting in Context</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../02_the_double_entry_counting_method.html">The Double Entry Counting Method</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../03_installing_beancount.html">Installing Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../04_running_beancount_and_generating_reports.html">Running Beancount and Generating Reports</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../05_getting_started_with_beancount.html">Getting Started with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../06_beancount_language_syntax.html">Beancount Language Syntax</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../07_beancount_options_reference.html">Beancount Options Reference</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../08_precision_tolerances.html">Precision Tolerances</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../09_beancount_query_language.html">Beancount Query Language</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../10_beancount_cheat_sheet.html">Beancount Cheat Sheet</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../11_how_inventories_work.html">How Inventories Work</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../12_exporting_your_portfolio.html">Exporting Your Portfolio</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../13_tutorial_example.html">Tutorial &amp; Example</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../14_beancount_history_and_credits.html">Beancount History and Credits</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../15_a_comparison_of_beancount_and_ledger_hledger.html">A Comparison of Beancount and Ledger Hledger</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../16_fetching_prices_in_beancount.html">Fetching Prices in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../17_importing_external_data.html">Importing External Data</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Cookbooks &amp; Examples</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../18_command_line_accounting_cookbook.html">Command Line Accounting Cookbook</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../19_trading_with_beancount.html">Trading with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../20_stock_vesting_in_beancount.html">Stock Vesting in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../21_sharing_expenses_with_beancount.html">Sharing Expenses with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../22_how_we_share_expenses.html">How We Share Expenses</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Documentation for Developers</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../23_beancount_scripting_plugins.html">Beancount Scripting Plugins</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../24_beancount_design_doc.html">Beancount Design Doc</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../25_ledgerhub_design_doc.html">Ledgerhub Design Doc</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../26_external_contributions.html">External Contributions</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Enhancement Proposals &amp; Discussions</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../27_a_proposal_for_an_improvement_on_inventory_booking.html">A Proposal for an Improvement on Inventory Booking</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../28_settlement_dates_in_beancount.html">Settlement Dates in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../29_balance_assertions_in_beancount.html">Balance Assertions in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../30_fund_accounting_with_beancount.html">Fund Accounting with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../31_rounding_precision_in_beancount.html">Rounding Precision in Beancount</a>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">beancount</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.core.html">beancount.core</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.ingest.html">beancount.ingest</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.loader.html">beancount.loader</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.ops.html">beancount.ops</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.parser.html">beancount.parser</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.plugins.html">beancount.plugins</a>
</li>
<li class="toctree-l1 current"><a class="reference internal current" href="beancount.prices.html">beancount.prices</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices">beancount.prices</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#date">Date</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#inverse">Inverse</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#swap-inverted">Swap Inverted</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#prices-needed-for-a-beancount-file">Prices Needed for a Beancount File</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#caching">Caching</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#about-sources-and-data-availability">About Sources and Data Availability</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices.find_prices">find_prices</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.DatedPrice">DatedPrice</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices.DatedPrice.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices.DatedPrice.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices.DatedPrice.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.PriceSource">PriceSource</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices.PriceSource.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices.PriceSource.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices.PriceSource.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.find_balance_currencies">find_balance_currencies()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.find_currencies_at_cost">find_currencies_at_cost()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.find_currencies_converted">find_currencies_converted()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.find_currencies_declared">find_currencies_declared()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.find_currencies_priced">find_currencies_priced()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.format_dated_price_str">format_dated_price_str()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.get_price_jobs_at_date">get_price_jobs_at_date()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.import_source">import_source()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.log_currency_list">log_currency_list()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.parse_single_source">parse_single_source()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.parse_source_map">parse_source_map()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices.find_prices_test">find_prices_test</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices_test.TestFromFile">TestFromFile</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices_test.TestFromFile.setUp">setUp()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices.price">price</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.fetch_cached_price">fetch_cached_price()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.fetch_price">fetch_price()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.filter_redundant_prices">filter_redundant_prices()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.now">now()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.process_args">process_args()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.reset_cache">reset_cache()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.setup_cache">setup_cache()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices.price_test">price_test</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price_test.TestClobber">TestClobber</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.price_test.TestClobber.setUp">setUp()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price_test.TestInverted">TestInverted</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.price_test.TestInverted.setUp">setUp()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices.source">source</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.source.Source">Source</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.source.Source.get_historical_price">get_historical_price()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.source.Source.get_latest_price">get_latest_price()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.source.SourcePrice">SourcePrice</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.source.SourcePrice.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.source.SourcePrice.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.source.SourcePrice.__repr__">__repr__()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices.sources">sources</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.iex">iex</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.iex.IEXError">IEXError</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.iex.Source">Source</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.iex.fetch_quote">fetch_quote()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.iex_test">iex_test</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.iex_test.response">response()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.oanda">oanda</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.oanda.Source">Source</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.oanda_test">oanda_test</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.oanda_test.TestOandaGetHistorical">TestOandaGetHistorical</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.oanda_test.TestOandaGetLatest">TestOandaGetLatest</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.quandl">quandl</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.quandl.QuandlError">QuandlError</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.quandl.Source">Source</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.quandl.fetch_time_series">fetch_time_series()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.quandl.parse_ticker">parse_ticker()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.quandl_test">quandl_test</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.quandl_test.response">response()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.yahoo">yahoo</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.yahoo.Source">Source</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.yahoo.YahooError">YahooError</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.yahoo.parse_currency">parse_currency()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.yahoo.parse_response">parse_response()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.yahoo_test">yahoo_test</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.yahoo_test.MockResponse">MockResponse</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.query.html">beancount.query</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.reports.html">beancount.reports</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.scripts.html">beancount.scripts</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.utils.html">beancount.utils</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.web.html">beancount.web</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="top navigation" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="..">Beancount Documentation</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a href="..">Docs</a> »</li>
<li>API reference »</li>
<li>beancount.prices</li>
<li class="wy-breadcrumbs-aside">
<a class="icon icon-github" href="https://github.com/xuhcc/beancount-docs/edit/master/docs/api_reference/beancount.prices.md"> Edit on GitHub</a>
</li>
</ul>
<hr/>
</div>
<div role="main">
<div class="section">
<h1 id="beancountprices">beancount.prices<a class="headerlink" href="#beancountprices" title="Permanent link"></a></h1>
<div class="doc doc-object doc-module">
<h2 class="hidden-toc" href="#beancount.prices" id="beancount.prices" style="visibility: hidden; width: 0; height: 0;">
<a class="headerlink" href="#beancount.prices" title="Permanent link"></a></h2>
<div class="doc doc-contents first">
<p>Fetch prices from the internet and output them as Beancount price directives.</p>
<p>This script accepts a list of Beancount input filenames, and fetches prices
required to compute market values for current positions:</p>
<p>bean-price /home/joe/finances/joe.beancount</p>
<p>The list of fetching jobs to carry out is derived automatically from the input
file (see section below for full details). It is also possible to provide a list
of specific price fetching jobs to run, e.g.,</p>
<p>bean-price -e google/TSE:XUS yahoo/AAPL mysources.morningstar/RBF1005</p>
<p>The general format of each of these "source strings" is</p>
<p>&lt;module&gt;/[^]&lt;ticker&gt;</p>
<p>The "module" is the name of a Python module that contains a Source class which
can be instantiated and connect to a data source to extract price data. These
modules are automatically imported by name and instantiated in order to pull the
price from a particular data source. This allows you to write your own
supplementary fetcher codes without having to modify this script.</p>
<p>Default implementations are provided to provide access to prices from Yahoo!
Finance or Google Finance, which cover a large universe of common public
investment types (e.g. stock tickers). As a convenience, the module name is
always first searched under the "beancount.prices.sources" package, where those
default source implementations live. This is how, for example, in order to use
the provided Google Finance data fetcher you don't have to write
"beancount.prices.sources.yahoo/AAPL" but simply "yahoo/AAPL".</p>
<h2 id="date">Date<a class="headerlink" href="#date" title="Permanent link"></a></h2>
<p>By default, this script will fetch prices at the latest available date &amp; time.
You can use an option to fetch historical prices for a desired date instead:</p>
<p>bean-price --date=2015-02-03</p>
<h2 id="inverse">Inverse<a class="headerlink" href="#inverse" title="Permanent link"></a></h2>
<p>Sometimes, prices are available for the inverse of an instrument. This is often
the case for currencies. For example, the price of "CAD" in USD" is provided by
the USD/CAD market, which gives the price of a US dollar in Canadian dollars. In
order specify this, you can prepend "^" to the instrument to instruct the driver
to compute the inverse of the given price:</p>
<p>bean-price -e USD:google/^CURRENCY:USDCAD</p>
<p>If a source price is to be inverted, like this, the precision could be different
than what is fetched. For instance, if the price of USD/CAD is 1.32759, it would
output be this from the above directive:</p>
<p>2015-10-28 price CAD  0.753244601119 USD</p>
<p>By default, inverted rates will be rounded similarly to how other Price
directives were rounding those numbers.</p>
<h2 id="swap-inverted">Swap Inverted<a class="headerlink" href="#swap-inverted" title="Permanent link"></a></h2>
<p>If you prefer to have the output Price entries with swapped currencies instead
of inverting the rate itself, you can use the --swap-inverted option. In the
previous example for the price of CAD, it would output this:</p>
<p>2015-10-28 price USD   1.32759 CAD</p>
<p>This works since the Beancount price database computes and interpolates the
reciprocals automatically for all pairs of commodities in its database.</p>
<h2 id="prices-needed-for-a-beancount-file">Prices Needed for a Beancount File<a class="headerlink" href="#prices-needed-for-a-beancount-file" title="Permanent link"></a></h2>
<p>You can also provide a filename to extract the list of tickers to fetch from a
Beancount input file, e.g.:</p>
<p>bean-price /home/joe/finances/joe.beancount</p>
<p>There are many ways to extract a list of commodities with needed prices from a
Baancount input file:</p>
<ul>
<li>
<p>Prices for all the holdings that were seen held-at-cost at a particular date.</p>
</li>
<li>
<p>Prices for holdings held at a particular date which were price converted from
  some other commodity in the past (i.e., for currencies).</p>
</li>
<li>
<p>The list of all Commodity directives present in the file. For each of those
  holdings, the corresponding Commodity directive is consulted and its "ticker"
  metadata field is used to specify where to attempt to fetch prices. You should
  have directives like this in your input file:</p>
<p>2007-07-20 commodity VEA
  price: "google/NYSEARCA:VEA"</p>
</li>
</ul>
<p>The "price" metadata can be a comma-separated list of sources to try out, in
  which case each of the sources will be looked at :</p>
<pre><code>2007-07-20 commodity VEA
  price: "google/CURRENCY:USDCAD,yahoo/USDCAD"
</code></pre>
<ul>
<li>Existing price directives for the same data are excluded by default, since the
  price is already in the file.</li>
</ul>
<p>By default, the list of tickers to be fetched includes only the intersection of
these lists. The general intent of the user of this script is to fetch missing
prices, and only needed ones, for a particular date.</p>
<ul>
<li>Use the --date option to change the applied date.</li>
<li>Use the --all option to fetch the entire set of prices, regardless
  of holdings and date.</li>
<li>Use --clobber to ignore existing price directives.</li>
</ul>
<p>You can also print the list of prices to be fetched with the --dry-run option,
which stops short of actually fetching the missing prices (it just prints the
list of fetches it would otherwise attempt).</p>
<h2 id="caching">Caching<a class="headerlink" href="#caching" title="Permanent link"></a></h2>
<p>Prices are automatically cached. You can disable the cache with an option:</p>
<p>bean-price --no-cache</p>
<p>You can also instruct the script to clear the cache before fetching its prices:</p>
<p>bean-price --clear-cache</p>
<h2 id="about-sources-and-data-availability">About Sources and Data Availability<a class="headerlink" href="#about-sources-and-data-availability" title="Permanent link"></a></h2>
<p>IMPORTANT: Note that each source may support a different routine for getting its
latest data and for fetching historical/dated data, and that each of these may
differ in their support. For example, Google Finance does not support fetching
historical data for its CURRENCY:* instruments.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.prices.find_prices">
<code>find_prices</code>
<a class="headerlink" href="#beancount.prices.find_prices" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>A library of codes create price fetching jobs from strings and files.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.DatedPrice">
<code>DatedPrice</code>
<a class="headerlink" href="#beancount.prices.find_prices.DatedPrice" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>DatedPrice(base, quote, date, sources)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices.DatedPrice.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.find_prices.DatedPrice.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices.DatedPrice.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">sources</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.prices.find_prices.DatedPrice.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of DatedPrice(base, quote, date, sources)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices.DatedPrice.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.find_prices.DatedPrice.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.PriceSource">
<code>PriceSource</code>
<a class="headerlink" href="#beancount.prices.find_prices.PriceSource" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>PriceSource(module, symbol, invert)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices.PriceSource.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.find_prices.PriceSource.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices.PriceSource.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">invert</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.prices.find_prices.PriceSource.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of PriceSource(module, symbol, invert)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices.PriceSource.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.find_prices.PriceSource.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.find_balance_currencies">
<code class="highlight language-python">
find_balance_currencies<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.find_prices.find_balance_currencies" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return currencies relevant for the given date.</p>
<p>This computes the account balances as of the date, and returns the union of:
a) The currencies held at cost, and
b) Currency pairs from previous conversions, but only for currencies with
   non-zero balances.</p>
<p>This is intended to produce the list of currencies whose prices are relevant
at a particular date, based on previous history.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A set of (base, quote) currencies.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_balance_currencies</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Return currencies relevant for the given date.</span>

<span class="sd">    This computes the account balances as of the date, and returns the union of:</span>
<span class="sd">    a) The currencies held at cost, and</span>
<span class="sd">    b) Currency pairs from previous conversions, but only for currencies with</span>
<span class="sd">       non-zero balances.</span>

<span class="sd">    This is intended to produce the list of currencies whose prices are relevant</span>
<span class="sd">    at a particular date, based on previous history.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A set of (base, quote) currencies.</span>
<span class="sd">    """</span>
    <span class="c1"># Compute the balances.</span>
    <span class="n">currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">currencies_on_books</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">balances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">summarize</span><span class="o">.</span><span class="n">balance_by_account</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">balance</span> <span class="ow">in</span> <span class="n">balances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">balance</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Add currencies held at cost.</span>
                <span class="n">currencies</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add regular currencies.</span>
                <span class="n">currencies_on_books</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>

    <span class="c1"># Create currency pairs from the currencies which are on account balances.</span>
    <span class="c1"># In order to figure out the the quote currencies, we use the list of price</span>
    <span class="c1"># conversions until this date.</span>
    <span class="n">converted</span> <span class="o">=</span> <span class="p">(</span><span class="n">find_currencies_converted</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="o">|</span>
                 <span class="n">find_currencies_priced</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">cbase</span> <span class="ow">in</span> <span class="n">currencies_on_books</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">base_quote</span> <span class="ow">in</span> <span class="n">converted</span><span class="p">:</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">base_quote</span>
            <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="n">cbase</span><span class="p">:</span>
                <span class="n">currencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base_quote</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">currencies</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.find_currencies_at_cost">
<code class="highlight language-python">
find_currencies_at_cost<span class="p">(</span><span class="n">entries</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.find_prices.find_currencies_at_cost" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return all currencies that were held at cost at some point.</p>
<p>This returns all of them, even if not on the books at a particular point in
time. This code does not look at account balances.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of (base, quote) currencies.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_currencies_at_cost</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
    <span class="sd">"""Return all currencies that were held at cost at some point.</span>

<span class="sd">    This returns all of them, even if not on the books at a particular point in</span>
<span class="sd">    time. This code does not look at account balances.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of (base, quote) currencies.</span>
<span class="sd">    """</span>
    <span class="n">currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">currencies</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">currencies</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.find_currencies_converted">
<code class="highlight language-python">
find_currencies_converted<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.find_prices.find_currencies_converted" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return currencies from price conversions.</p>
<p>This function looks at all price conversions that occurred until some date
and produces a list of them. Note: This does not include Price directives,
only postings with price conversions.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of (base, quote) currencies.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_currencies_converted</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Return currencies from price conversions.</span>

<span class="sd">    This function looks at all price conversions that occurred until some date</span>
<span class="sd">    and produces a list of them. Note: This does not include Price directives,</span>
<span class="sd">    only postings with price conversions.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of (base, quote) currencies.</span>
<span class="sd">    """</span>
    <span class="n">currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span>
            <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">currencies</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">price</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">currencies</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.find_currencies_declared">
<code class="highlight language-python">
find_currencies_declared<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.find_prices.find_currencies_declared" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return currencies declared in Commodity directives.</p>
<p>If a 'price' metadata field is provided, include all the quote currencies
there-in. Otherwise, the Commodity directive is ignored.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of (base, quote, list of PriceSource) currencies. The list of
(base, quote) pairs is guaranteed to be unique.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_currencies_declared</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Return currencies declared in Commodity directives.</span>

<span class="sd">    If a 'price' metadata field is provided, include all the quote currencies</span>
<span class="sd">    there-in. Otherwise, the Commodity directive is ignored.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of (base, quote, list of PriceSource) currencies. The list of</span>
<span class="sd">      (base, quote) pairs is guaranteed to be unique.</span>
<span class="sd">    """</span>
    <span class="n">currencies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Commodity</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># Here we have to infer which quote currencies the commodity is for</span>
        <span class="c1"># (maybe down the road this should be better handled by providing a list</span>
        <span class="c1"># of quote currencies in the Commodity directive itself).</span>
        <span class="c1">#</span>
        <span class="c1"># First, we look for a "price" metadata field, which defines conversions</span>
        <span class="c1"># for various currencies. Each of these quote currencies generates a</span>
        <span class="c1"># pair in the output.</span>
        <span class="n">source_str</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'price'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">source_str</span> <span class="o">==</span> <span class="s2">""</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"Skipping ignored currency (with empty price): </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span>
                              <span class="n">entry</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">source_map</span> <span class="o">=</span> <span class="n">parse_source_map</span><span class="p">(</span><span class="n">source_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Ignoring currency with invalid 'price' source: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span>
                                <span class="n">entry</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">quote</span><span class="p">,</span> <span class="n">psources</span> <span class="ow">in</span> <span class="n">source_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">currencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">entry</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="n">psources</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise we simply ignore the declaration. That is, a Commodity</span>
            <span class="c1"># directive without any "price" metadata would not register as a</span>
            <span class="c1"># declared currency.</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"Ignoring currency with no metadata: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">currencies</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.find_currencies_priced">
<code class="highlight language-python">
find_currencies_priced<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.find_prices.find_currencies_priced" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return currencies seen in Price directives.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of (base, quote) currencies.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_currencies_priced</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Return currencies seen in Price directives.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of (base, quote) currencies.</span>
<span class="sd">    """</span>
    <span class="n">currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Price</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">currencies</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">entry</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">currencies</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.format_dated_price_str">
<code class="highlight language-python">
format_dated_price_str<span class="p">(</span><span class="n">dprice</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.find_prices.format_dated_price_str" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Convert a dated price to a one-line printable string.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dprice</code></td>
<td><code></code></td>
<td>
<p>A DatedPrice instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>The string for a DatedPrice instance.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">format_dated_price_str</span><span class="p">(</span><span class="n">dprice</span><span class="p">):</span>
    <span class="sd">"""Convert a dated price to a one-line printable string.</span>

<span class="sd">    Args:</span>
<span class="sd">      dprice: A DatedPrice instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      The string for a DatedPrice instance.</span>
<span class="sd">    """</span>
    <span class="n">psstrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'</span><span class="si">{}</span><span class="s1">(</span><span class="si">{}{}</span><span class="s1">)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">psource</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                <span class="s1">'1/'</span> <span class="k">if</span> <span class="n">psource</span><span class="o">.</span><span class="n">invert</span> <span class="k">else</span> <span class="s1">''</span><span class="p">,</span>
                                <span class="n">psource</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">psource</span> <span class="ow">in</span> <span class="n">dprice</span><span class="o">.</span><span class="n">sources</span><span class="p">]</span>
    <span class="n">base_quote</span> <span class="o">=</span> <span class="s1">'</span><span class="si">{}</span><span class="s1"> /</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dprice</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">dprice</span><span class="o">.</span><span class="n">quote</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">'</span><span class="si">{:&lt;32}</span><span class="s1"> @ </span><span class="si">{:10}</span><span class="s1"> [ </span><span class="si">{}</span><span class="s1"> ]'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">base_quote</span><span class="p">,</span>
        <span class="n">dprice</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">dprice</span><span class="o">.</span><span class="n">date</span> <span class="k">else</span> <span class="s1">'latest'</span><span class="p">,</span>
        <span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">psstrs</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.get_price_jobs_at_date">
<code class="highlight language-python">
get_price_jobs_at_date<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">undeclared_source</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.find_prices.get_price_jobs_at_date" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Get a list of prices to fetch from a stream of entries.</p>
<p>The active holdings held on the given date are included.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>filename</code></td>
<td><code></code></td>
<td>
<p>A string, the name of a file to process.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>inactive</code></td>
<td><code></code></td>
<td>
<p>Include currencies with no balance at the given date. The default
is to only include those currencies which have a non-zero balance.</p>
</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>undeclared_source</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the default source module to use to
pull prices for commodities without a price source metadata on their
Commodity directive declaration.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of DatedPrice instances.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_price_jobs_at_date</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">undeclared_source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Get a list of prices to fetch from a stream of entries.</span>

<span class="sd">    The active holdings held on the given date are included.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename: A string, the name of a file to process.</span>
<span class="sd">      date: A datetime.date instance.</span>
<span class="sd">      inactive: Include currencies with no balance at the given date. The default</span>
<span class="sd">        is to only include those currencies which have a non-zero balance.</span>
<span class="sd">      undeclared_source: A string, the name of the default source module to use to</span>
<span class="sd">        pull prices for commodities without a price source metadata on their</span>
<span class="sd">        Commodity directive declaration.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of DatedPrice instances.</span>

<span class="sd">    """</span>
    <span class="c1"># Find the list of declared currencies, and from it build a mapping for</span>
    <span class="c1"># tickers for each (base, quote) pair. This is the only place tickers</span>
    <span class="c1"># appear.</span>
    <span class="n">declared_triples</span> <span class="o">=</span> <span class="n">find_currencies_declared</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
    <span class="n">currency_map</span> <span class="o">=</span> <span class="p">{(</span><span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">):</span> <span class="n">psources</span>
                    <span class="k">for</span> <span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="n">psources</span> <span class="ow">in</span> <span class="n">declared_triples</span><span class="p">}</span>

    <span class="c1"># Compute the initial list of currencies to consider.</span>
    <span class="k">if</span> <span class="n">undeclared_source</span><span class="p">:</span>
        <span class="c1"># Use the full set of possible currencies.</span>
        <span class="n">cur_at_cost</span> <span class="o">=</span> <span class="n">find_currencies_at_cost</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="n">cur_converted</span> <span class="o">=</span> <span class="n">find_currencies_converted</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">cur_priced</span> <span class="o">=</span> <span class="n">find_currencies_priced</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">currencies</span> <span class="o">=</span> <span class="n">cur_at_cost</span> <span class="o">|</span> <span class="n">cur_converted</span> <span class="o">|</span> <span class="n">cur_priced</span>
        <span class="n">log_currency_list</span><span class="p">(</span><span class="s2">"Currency held at cost"</span><span class="p">,</span> <span class="n">cur_at_cost</span><span class="p">)</span>
        <span class="n">log_currency_list</span><span class="p">(</span><span class="s2">"Currency converted"</span><span class="p">,</span> <span class="n">cur_converted</span><span class="p">)</span>
        <span class="n">log_currency_list</span><span class="p">(</span><span class="s2">"Currency priced"</span><span class="p">,</span> <span class="n">cur_priced</span><span class="p">)</span>
        <span class="n">default_source</span> <span class="o">=</span> <span class="n">import_source</span><span class="p">(</span><span class="n">undeclared_source</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use the currencies from the Commodity directives.</span>
        <span class="n">currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">currency_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">default_source</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">log_currency_list</span><span class="p">(</span><span class="s2">"Currencies in primary list"</span><span class="p">,</span> <span class="n">currencies</span><span class="p">)</span>

    <span class="c1"># By default, restrict to only the currencies with non-zero balances at the</span>
    <span class="c1"># given date.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inactive</span><span class="p">:</span>
        <span class="n">balance_currencies</span> <span class="o">=</span> <span class="n">find_balance_currencies</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">log_currency_list</span><span class="p">(</span><span class="s2">"Currencies held in assets"</span><span class="p">,</span> <span class="n">balance_currencies</span><span class="p">)</span>
        <span class="n">currencies</span> <span class="o">=</span> <span class="n">currencies</span> <span class="o">&amp;</span> <span class="n">balance_currencies</span>

    <span class="n">log_currency_list</span><span class="p">(</span><span class="s2">"Currencies to fetch"</span><span class="p">,</span> <span class="n">currencies</span><span class="p">)</span>

    <span class="c1"># Build up the list of jobs to fetch prices for.</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">base_quote</span> <span class="ow">in</span> <span class="n">currencies</span><span class="p">:</span>
        <span class="n">psources</span> <span class="o">=</span> <span class="n">currency_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_quote</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">base_quote</span>

        <span class="c1"># If there are no sources, create a default one.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">psources</span><span class="p">:</span>
            <span class="n">psources</span> <span class="o">=</span> <span class="p">[</span><span class="n">PriceSource</span><span class="p">(</span><span class="n">default_source</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]</span>

        <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DatedPrice</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">psources</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.import_source">
<code class="highlight language-python">
import_source<span class="p">(</span><span class="n">module_name</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.find_prices.import_source" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Import the source module defined by the given name.</p>
<p>The default location is handled here.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>short_module_name</code></td>
<td><code></code></td>
<td>
<p>A string, the name of a Python module, which may
be within the default package or a full name.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A corresponding Python module object.</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ImportError</code></td>
<td>
<p>If the module cannot be imported.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">import_source</span><span class="p">(</span><span class="n">module_name</span><span class="p">):</span>
    <span class="sd">"""Import the source module defined by the given name.</span>

<span class="sd">    The default location is handled here.</span>

<span class="sd">    Args:</span>
<span class="sd">      short_module_name: A string, the name of a Python module, which may</span>
<span class="sd">        be within the default package or a full name.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A corresponding Python module object.</span>
<span class="sd">    Raises:</span>
<span class="sd">      ImportError: If the module cannot be imported.</span>
<span class="sd">    """</span>
    <span class="n">default_name</span> <span class="o">=</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DEFAULT_PACKAGE</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">__import__</span><span class="p">(</span><span class="n">default_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">default_name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">'Could not find price source module "</span><span class="si">{}</span><span class="s1">": </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">module_name</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.log_currency_list">
<code class="highlight language-python">
log_currency_list<span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">currencies</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.find_prices.log_currency_list" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Log a list of currencies to debug output.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>message</code></td>
<td><code></code></td>
<td>
<p>A message string to prepend.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>currencies</code></td>
<td><code></code></td>
<td>
<p>A list of (base, quote) currency pair.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>320
321
322
323
324
325
326
327
328
329</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">log_currency_list</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">currencies</span><span class="p">):</span>
    <span class="sd">"""Log a list of currencies to debug output.</span>

<span class="sd">    Args:</span>
<span class="sd">      message: A message string to prepend.</span>
<span class="sd">      currencies: A list of (base, quote) currency pair.</span>
<span class="sd">    """</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"-------- </span><span class="si">{}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="ow">in</span> <span class="n">currencies</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"  </span><span class="si">{:&gt;32}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">'</span><span class="si">{}</span><span class="s1"> /</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">)))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.parse_single_source">
<code class="highlight language-python">
parse_single_source<span class="p">(</span><span class="n">source</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.find_prices.parse_single_source" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Parse a single source string.</p>
<p>Source specifications follow the syntax:</p>
<p>&lt;module&gt;/[^]&lt;ticker&gt;</p>
<p>The &lt;module&gt; is resolved against the Python path, but first looked up
under the package where the default price extractors lie.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>source</code></td>
<td><code></code></td>
<td>
<p>A single source string specification.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A PriceSource tuple, or</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ValueError</code></td>
<td>
<p>If invalid.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">parse_single_source</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="sd">"""Parse a single source string.</span>

<span class="sd">    Source specifications follow the syntax:</span>

<span class="sd">      &lt;module&gt;/[^]&lt;ticker&gt;</span>

<span class="sd">    The &lt;module&gt; is resolved against the Python path, but first looked up</span>
<span class="sd">    under the package where the default price extractors lie.</span>

<span class="sd">    Args:</span>
<span class="sd">      source: A single source string specification.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A PriceSource tuple, or</span>
<span class="sd">    Raises:</span>
<span class="sd">      ValueError: If invalid.</span>
<span class="sd">    """</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">'([a-zA-Z]+[a-zA-Z0-9\._]+)/(\^?)([a-zA-Z0-9:=_\-\.]+)$'</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'Invalid source name: "</span><span class="si">{}</span><span class="s1">"'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
    <span class="n">short_module_name</span><span class="p">,</span> <span class="n">invert</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">import_source</span><span class="p">(</span><span class="n">short_module_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PriceSource</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">invert</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.parse_source_map">
<code class="highlight language-python">
parse_source_map<span class="p">(</span><span class="n">source_map_spec</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.find_prices.parse_source_map" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Parse a source map specification string.</p>
<p>Source map specifications allow the speification of multiple sources for
multiple quote currencies and follow the following syntax:</p>
<p>&lt;currency1&gt;:&lt;source1&gt;,&lt;source2&gt;,... &lt;currency2&gt;:&lt;source1&gt;,...</p>
<p>Where a &lt;source&gt; itself follows:</p>
<p>&lt;module&gt;/[^]&lt;ticker&gt;</p>
<p>The &lt;module&gt; is resolved against the Python path, but first looked up under
the package where the default price extractors lie. The presence of a '^'
character indicates that twe should use the inverse of the rate pull from
this source.</p>
<p>For example, for prices of AAPL in USD:</p>
<p>USD:google/NASDAQ:AAPL,yahoo/AAPL</p>
<p>Or for the exchange rate of a currency, such as INR in USD or in CAD:</p>
<p>USD:google/^CURRENCY:USDINR CAD:google/^CURRENCY:CADINR</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>source_map_spec</code></td>
<td><code></code></td>
<td>
<p>A string, a full source map specification to be parsed.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FIXME</code></td>
<td>
<p>TODO</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ValueError</code></td>
<td>
<p>If an invalid pattern has been specified.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">parse_source_map</span><span class="p">(</span><span class="n">source_map_spec</span><span class="p">):</span>
    <span class="sd">"""Parse a source map specification string.</span>

<span class="sd">    Source map specifications allow the speification of multiple sources for</span>
<span class="sd">    multiple quote currencies and follow the following syntax:</span>

<span class="sd">       &lt;currency1&gt;:&lt;source1&gt;,&lt;source2&gt;,... &lt;currency2&gt;:&lt;source1&gt;,...</span>

<span class="sd">    Where a &lt;source&gt; itself follows:</span>

<span class="sd">       &lt;module&gt;/[^]&lt;ticker&gt;</span>

<span class="sd">    The &lt;module&gt; is resolved against the Python path, but first looked up under</span>
<span class="sd">    the package where the default price extractors lie. The presence of a '^'</span>
<span class="sd">    character indicates that twe should use the inverse of the rate pull from</span>
<span class="sd">    this source.</span>

<span class="sd">    For example, for prices of AAPL in USD:</span>

<span class="sd">       USD:google/NASDAQ:AAPL,yahoo/AAPL</span>

<span class="sd">    Or for the exchange rate of a currency, such as INR in USD or in CAD:</span>

<span class="sd">       USD:google/^CURRENCY:USDINR CAD:google/^CURRENCY:CADINR</span>

<span class="sd">    Args:</span>
<span class="sd">      source_map_spec: A string, a full source map specification to be parsed.</span>
<span class="sd">    Returns:</span>
<span class="sd">      FIXME: TODO</span>
<span class="sd">    Raises:</span>
<span class="sd">      ValueError: If an invalid pattern has been specified.</span>
<span class="sd">    """</span>
    <span class="n">source_map</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">source_list_spec</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'[ ;]'</span><span class="p">,</span> <span class="n">source_map_spec</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">'(</span><span class="si">{}</span><span class="s1">):(.*)$'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">amount</span><span class="o">.</span><span class="n">CURRENCY_RE</span><span class="p">),</span>
                         <span class="n">source_list_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'Invalid source map pattern: "</span><span class="si">{}</span><span class="s1">"'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_list_spec</span><span class="p">))</span>

        <span class="n">currency</span><span class="p">,</span> <span class="n">source_strs</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="n">source_map</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">parse_single_source</span><span class="p">(</span><span class="n">source_str</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">source_str</span> <span class="ow">in</span> <span class="n">source_strs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">source_map</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.prices.find_prices_test">
<code>find_prices_test</code>
<a class="headerlink" href="#beancount.prices.find_prices_test" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Tests for price finding routines.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.find_prices_test.TestFromFile">
<code>TestFromFile</code>
<a class="headerlink" href="#beancount.prices.find_prices_test.TestFromFile" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices_test.TestFromFile.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.find_prices_test.TestFromFile.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="nd">@loader</span><span class="o">.</span><span class="n">load_doc</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    2000-01-10 open Assets:US:Investments:QQQ</span>
<span class="sd">    2000-01-10 open Assets:CA:Investments:XSP</span>
<span class="sd">    2000-01-10 open Assets:Cash</span>
<span class="sd">    2000-01-10 open Assets:External</span>
<span class="sd">    2000-01-10 open Expenses:Foreign</span>

<span class="sd">    2010-01-01 commodity USD</span>

<span class="sd">    2010-01-01 commodity QQQ</span>
<span class="sd">      name: "PowerShares QQQ Trust, Series 1 (ETF)"</span>
<span class="sd">      price: "USD:yahoo/NASDAQ:QQQ"</span>

<span class="sd">    2010-01-01 commodity XSP</span>
<span class="sd">      name: "iShares S&amp;P 500 Index Fund (CAD Hedged)"</span>
<span class="sd">      quote: CAD</span>

<span class="sd">    2010-01-01 commodity AMTKPTS</span>
<span class="sd">      quote: USD</span>
<span class="sd">      price: ""</span>

<span class="sd">    2015-02-06 *</span>
<span class="sd">      Assets:Cash                     1505.00 USD</span>
<span class="sd">      Assets:External                -1000.00 GBP @ 1.5050 USD</span>

<span class="sd">    2015-02-08 price GBP  1.5050 USD</span>
<span class="sd">    2015-02-08 price GBP  1.8301 CAD</span>

<span class="sd">    2015-04-13 *</span>
<span class="sd">      Assets:US:Investments:QQQ             3 QQQ {107.48 USD}</span>
<span class="sd">      Assets:Cash</span>

<span class="sd">    2015-05-22 *</span>
<span class="sd">      Assets:Cash                     1000.00 USD @ 1.2283 CAD</span>
<span class="sd">      Assets:External                -1228.30 CAD</span>

<span class="sd">    2015-09-04 *</span>
<span class="sd">      Assets:US:Investments:QQQ             2 QQQ {101.16 USD}</span>
<span class="sd">      Assets:Cash</span>

<span class="sd">    2015-11-07 *</span>
<span class="sd">      Assets:CA:Investments:XSP             2 XSP {24.28 CAD}</span>
<span class="sd">      Assets:Cash</span>

<span class="sd">    2015-12-02 *</span>
<span class="sd">      Assets:CA:Investments:XSP            -2 XSP {24.28 CAD} @ 27.00 CAD</span>
<span class="sd">      Assets:Cash</span>

<span class="sd">    2015-12-03 price XSP   27.32 USD</span>

<span class="sd">    ;; Because neither of these currencies remain, they should not be there.</span>
<span class="sd">    2015-06-22 *</span>
<span class="sd">      Assets:Cash                         1000.00 EUR @ 140.004 JPY</span>
<span class="sd">      Expenses:Foreign                    -140004 JPY</span>

<span class="sd">    2015-10-13 *</span>
<span class="sd">      Assets:Cash                        -1000.00 EUR @ 140.004 JPY</span>
<span class="sd">      Expenses:Foreign                     140004 JPY</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.prices.price">
<code>price</code>
<a class="headerlink" href="#beancount.prices.price" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Driver code for the price script.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.fetch_cached_price">
<code class="highlight language-python">
fetch_cached_price<span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.price.fetch_cached_price" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Call Source to fetch a price, but look and/or update the cache first.</p>
<p>This function entirely deals with caching and correct expiration. It keeps
old prices if they were fetched in the past, and it quickly expires
intra-day prices if they are fetched on the same day.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>source</code></td>
<td><code></code></td>
<td>
<p>A Python module object.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>symbol</code></td>
<td><code></code></td>
<td>
<p>A string, the ticker to fetch.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance, None if we're to fetch the latest date.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A SourcePrice instance.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">fetch_cached_price</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
    <span class="sd">"""Call Source to fetch a price, but look and/or update the cache first.</span>

<span class="sd">    This function entirely deals with caching and correct expiration. It keeps</span>
<span class="sd">    old prices if they were fetched in the past, and it quickly expires</span>
<span class="sd">    intra-day prices if they are fetched on the same day.</span>

<span class="sd">    Args:</span>
<span class="sd">      source: A Python module object.</span>
<span class="sd">      symbol: A string, the ticker to fetch.</span>
<span class="sd">      date: A datetime.date instance, None if we're to fetch the latest date.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A SourcePrice instance.</span>
<span class="sd">    """</span>
    <span class="c1"># Compute a suitable timestamp from the date, if specified.</span>
    <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># We query as for 4pm for the given date of the current timezone, if</span>
        <span class="c1"># specified.</span>
        <span class="n">query_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">time_local</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">query_time</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">tz</span><span class="o">.</span><span class="n">tzlocal</span><span class="p">())</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time_local</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz</span><span class="o">.</span><span class="n">tzutc</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">_CACHE</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># The cache is disabled; just call and return.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">get_latest_price</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                  <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
                  <span class="n">source</span><span class="o">.</span><span class="n">get_historical_price</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># The cache is enabled and we have to compute the current/latest price.</span>
        <span class="c1"># Try to fetch from the cache but miss if the price is too old.</span>
        <span class="n">md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        <span class="n">md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">md5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">timestamp_now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp_created</span><span class="p">,</span> <span class="n">result_naive</span> <span class="o">=</span> <span class="n">_CACHE</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="c1"># Convert naive timezone to UTC, which is what the cache is always</span>
            <span class="c1"># assumed to store. (The reason for this is that timezones from</span>
            <span class="c1"># aware datetime objects cannot be serialized properly due to bug.)</span>
            <span class="k">if</span> <span class="n">result_naive</span><span class="o">.</span><span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result_naive</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">result_naive</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">tz</span><span class="o">.</span><span class="n">tzutc</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result_naive</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">timestamp_now</span> <span class="o">-</span> <span class="n">timestamp_created</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_CACHE</span><span class="o">.</span><span class="n">expiration</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">KeyError</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Fetching: </span><span class="si">%s</span><span class="s2"> (time: </span><span class="si">%s</span><span class="s2">)"</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">get_latest_price</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                          <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
                          <span class="n">source</span><span class="o">.</span><span class="n">get_historical_price</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Error fetching </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Make sure the timezone is UTC and make naive before serialization.</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">time_utc</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz</span><span class="o">.</span><span class="n">tzutc</span><span class="p">())</span>
                <span class="n">time_naive</span> <span class="o">=</span> <span class="n">time_utc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">result_naive</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time_naive</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result_naive</span> <span class="o">=</span> <span class="n">result</span>

            <span class="k">if</span> <span class="n">result_naive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_CACHE</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">timestamp_now</span><span class="p">,</span> <span class="n">result_naive</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.fetch_price">
<code class="highlight language-python">
fetch_price<span class="p">(</span><span class="n">dprice</span><span class="p">,</span> <span class="n">swap_inverted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.price.fetch_price" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Fetch a price for the DatePrice job.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dprice</code></td>
<td><code></code></td>
<td>
<p>A DatedPrice instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>swap_inverted</code></td>
<td><code></code></td>
<td>
<p>A boolean, true if we should invert currencies instead of
rate for an inverted price source.</p>
</td>
<td><code>False</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A Price entry corresponding to the output of the jobs processed.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">fetch_price</span><span class="p">(</span><span class="n">dprice</span><span class="p">,</span> <span class="n">swap_inverted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Fetch a price for the DatePrice job.</span>

<span class="sd">    Args:</span>
<span class="sd">      dprice: A DatedPrice instances.</span>
<span class="sd">      swap_inverted: A boolean, true if we should invert currencies instead of</span>
<span class="sd">        rate for an inverted price source.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A Price entry corresponding to the output of the jobs processed.</span>

<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">psource</span> <span class="ow">in</span> <span class="n">dprice</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">psource</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Source</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">srcprice</span> <span class="o">=</span> <span class="n">fetch_cached_price</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">psource</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">dprice</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">srcprice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dprice</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Could not fetch for job: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">dprice</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">base</span> <span class="o">=</span> <span class="n">dprice</span><span class="o">.</span><span class="n">base</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="n">dprice</span><span class="o">.</span><span class="n">quote</span> <span class="ow">or</span> <span class="n">srcprice</span><span class="o">.</span><span class="n">quote_currency</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">srcprice</span><span class="o">.</span><span class="n">price</span>

    <span class="c1"># Invert the rate if requested.</span>
    <span class="k">if</span> <span class="n">psource</span><span class="o">.</span><span class="n">invert</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">swap_inverted</span><span class="p">:</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">quote</span><span class="p">,</span> <span class="n">base</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">ONE</span><span class="o">/</span><span class="n">price</span>

    <span class="k">assert</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">fileloc</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;</span><span class="si">{}</span><span class="s1">&gt;'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">psource</span><span class="o">.</span><span class="n">module</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># The datetime instance is required to be aware. We always convert to the</span>
    <span class="c1"># user's timezone before extracting the date. This means that if the market</span>
    <span class="c1"># returns a timestamp for a particular date, once we convert to the user's</span>
    <span class="c1"># timezone the returned date may be different by a day. The intent is that</span>
    <span class="c1"># whatever we print is assumed coherent with the user's timezone. See</span>
    <span class="c1"># discussion at</span>
    <span class="c1"># https://groups.google.com/d/msg/beancount/9j1E_HLEMBQ/fYRuCQK_BwAJ</span>
    <span class="n">srctime</span> <span class="o">=</span> <span class="n">srcprice</span><span class="o">.</span><span class="n">time</span>
    <span class="k">if</span> <span class="n">srctime</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Time returned by the price source is not timezone aware."</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">srctime</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz</span><span class="o">.</span><span class="n">tzlocal</span><span class="p">())</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">Price</span><span class="p">(</span><span class="n">fileloc</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span>
                      <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">quote</span> <span class="ow">or</span> <span class="n">UNKNOWN_CURRENCY</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.filter_redundant_prices">
<code class="highlight language-python">
filter_redundant_prices<span class="p">(</span><span class="n">price_entries</span><span class="p">,</span> <span class="n">existing_entries</span><span class="p">,</span> <span class="n">diffs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.price.filter_redundant_prices" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Filter out new entries that are redundant from an existing set.</p>
<p>If the price differs, we override it with the new entry only on demand. This
is because this would create conflict with existing price entries when
parsing, if the new entries are simply inserted into the input.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>price_entries</code></td>
<td><code></code></td>
<td>
<p>A list of newly created, proposed to be added Price directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>existing_entries</code></td>
<td><code></code></td>
<td>
<p>A list of existing entries we are proposing to add to.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>diffs</code></td>
<td><code></code></td>
<td>
<p>A boolean, true if we should output differing price entries
at the same date.</p>
</td>
<td><code>False</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A filtered list of remaining entries, and a list of ignored entries.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">filter_redundant_prices</span><span class="p">(</span><span class="n">price_entries</span><span class="p">,</span> <span class="n">existing_entries</span><span class="p">,</span> <span class="n">diffs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Filter out new entries that are redundant from an existing set.</span>

<span class="sd">    If the price differs, we override it with the new entry only on demand. This</span>
<span class="sd">    is because this would create conflict with existing price entries when</span>
<span class="sd">    parsing, if the new entries are simply inserted into the input.</span>

<span class="sd">    Args:</span>
<span class="sd">      price_entries: A list of newly created, proposed to be added Price directives.</span>
<span class="sd">      existing_entries: A list of existing entries we are proposing to add to.</span>
<span class="sd">      diffs: A boolean, true if we should output differing price entries</span>
<span class="sd">        at the same date.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A filtered list of remaining entries, and a list of ignored entries.</span>
<span class="sd">    """</span>
    <span class="c1"># Note: We have to be careful with the dates, because requesting the latest</span>
    <span class="c1"># price for a date may yield the price at a previous date. Clobber needs to</span>
    <span class="c1"># take this into account. See {1cfa25e37fc1}.</span>
    <span class="n">existing_prices</span> <span class="o">=</span> <span class="p">{(</span><span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">currency</span><span class="p">):</span> <span class="n">entry</span>
                       <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">existing_entries</span>
                       <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Price</span><span class="p">)}</span>
    <span class="n">filtered_prices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ignored_prices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">price_entries</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">existing_prices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">diffs</span><span class="p">:</span>
                <span class="n">existing_entry</span> <span class="o">=</span> <span class="n">existing_prices</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">existing_entry</span><span class="o">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">entry</span><span class="o">.</span><span class="n">amount</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">ignored_prices</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">ignored_prices</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">filtered_prices</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_prices</span><span class="p">,</span> <span class="n">ignored_prices</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.now">
<code class="highlight language-python">
now<span class="p">()</span> </code>
<a class="headerlink" href="#beancount.prices.price.now" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Indirection in order to be able to mock it out in the tests.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>45
46
47</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">now</span><span class="p">():</span>
    <span class="s2">"Indirection in order to be able to mock it out in the tests."</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.process_args">
<code class="highlight language-python">
process_args<span class="p">()</span> </code>
<a class="headerlink" href="#beancount.prices.price.process_args" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Process the arguments. This also initializes the logging module.</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>A tuple of</code></td>
<td>
<p>args: The argparse receiver of command-line arguments.
  jobs: A list of DatedPrice job objects.
  entries: A list of all the parsed entries.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">process_args</span><span class="p">():</span>
    <span class="sd">"""Process the arguments. This also initializes the logging module.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A tuple of:</span>
<span class="sd">        args: The argparse receiver of command-line arguments.</span>
<span class="sd">        jobs: A list of DatedPrice job objects.</span>
<span class="sd">        entries: A list of all the parsed entries.</span>
<span class="sd">    """</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">beancount</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Input sources or filenames.</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'sources'</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">'+'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">'A list of filenames (or source "module/symbol", if -e is '</span>
        <span class="s1">'specified) from which to create a list of jobs.'</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-e'</span><span class="p">,</span> <span class="s1">'--expressions'</span><span class="p">,</span> <span class="s1">'--expression'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">'Interpret the arguments as "module/symbol" source strings.'</span><span class="p">))</span>

    <span class="c1"># Regular options.</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-v'</span><span class="p">,</span> <span class="s1">'--verbose'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'count'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">"Print out progress log. Specify twice for debugging info."</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-d'</span><span class="p">,</span> <span class="s1">'--date'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store'</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">date_utils</span><span class="o">.</span><span class="n">parse_date_liberally</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">"Specify the date for which to fetch the prices."</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-i'</span><span class="p">,</span> <span class="s1">'--inactive'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">"Select all commodities from input files, not just the ones active on the date"</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-u'</span><span class="p">,</span> <span class="s1">'--undeclared'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">"Include commodities viewed in the file even without a "</span>
        <span class="s2">"corresponding Commodity directive, from this default source. "</span>
        <span class="s2">"The currency name itself is used as the lookup symbol in this default source."</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-c'</span><span class="p">,</span> <span class="s1">'--clobber'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">"Do not skip prices which are already present in input files; fetch them anyway."</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-a'</span><span class="p">,</span> <span class="s1">'--all'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">"A shorthand for --inactive, --undeclared, --clobber."</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-s'</span><span class="p">,</span> <span class="s1">'--swap-inverted'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">"For inverted sources, swap currencies instead of inverting the rate. "</span>
        <span class="s2">"For example, if fetching the rate for CAD from 'USD:google/^CURRENCY:USDCAD' "</span>
        <span class="s2">"results in 1.25, by default we would output </span><span class="se">\"</span><span class="s2">price CAD  0.8000 USD</span><span class="se">\"</span><span class="s2">. "</span>
        <span class="s2">"Using this option we would instead output </span><span class="se">\"</span><span class="s2"> price USD   1.2500 CAD</span><span class="se">\"</span><span class="s2">."</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-n'</span><span class="p">,</span> <span class="s1">'--dry-run'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">"Don't actually fetch the prices, just print the list of the ones to be fetched."</span><span class="p">))</span>

    <span class="c1"># Caching options.</span>
    <span class="n">cache_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">'cache'</span><span class="p">)</span>
    <span class="n">cache_filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span>
                               <span class="s2">"</span><span class="si">{}</span><span class="s2">.cache"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">cache_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--cache'</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">'cache_filename'</span><span class="p">,</span>
                             <span class="n">action</span><span class="o">=</span><span class="s1">'store'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">cache_filename</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s2">"Enable the cache and with the given cache name."</span><span class="p">)</span>
    <span class="n">cache_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--no-cache'</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">'cache_filename'</span><span class="p">,</span>
                             <span class="n">action</span><span class="o">=</span><span class="s1">'store_const'</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s2">"Disable the price cache."</span><span class="p">)</span>

    <span class="n">cache_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--clear-cache'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s2">"Clear the cache prior to startup"</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">verbose_levels</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">,</span>
                      <span class="mi">0</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">,</span>
                      <span class="mi">1</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                      <span class="mi">2</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">}</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">verbose_levels</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">],</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s1">'</span><span class="si">%(levelname)-8s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">inactive</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">clobber</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">args</span><span class="o">.</span><span class="n">undeclared</span> <span class="o">=</span> <span class="n">DEFAULT_SOURCE</span>

    <span class="c1"># Setup for processing.</span>
    <span class="n">setup_cache</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">cache_filename</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">)</span>

    <span class="c1"># Get the list of DatedPrice jobs to get from the arguments.</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Processing at date: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">date</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dcontext</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">expressions</span><span class="p">:</span>
        <span class="c1"># Interpret the arguments as price sources.</span>
        <span class="k">for</span> <span class="n">source_str</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="n">psources</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">psource_map</span> <span class="o">=</span> <span class="n">find_prices</span><span class="o">.</span><span class="n">parse_source_map</span><span class="p">(</span><span class="n">source_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="s2">"; did you provide a filename?"</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source_str</span><span class="p">)</span> <span class="k">else</span> <span class="s1">''</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'Invalid source "{{}}"</span><span class="si">{}</span><span class="s1">. '</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s1">'Supported format is "CCY:module/SYMBOL"'</span><span class="p">)</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_str</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">psources</span> <span class="ow">in</span> <span class="n">psource_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">find_prices</span><span class="o">.</span><span class="n">DatedPrice</span><span class="p">(</span>
                        <span class="n">psources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">psources</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Interpret the arguments as Beancount input filenames.</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">'File does not exist: "</span><span class="si">{}</span><span class="s1">"; '</span>
                             <span class="s1">'did you mean to use -e?'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Loading "</span><span class="si">%s</span><span class="s1">"'</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">options_map</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">log_errors</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dcontext</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dcontext</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s1">'dcontext'</span><span class="p">]</span>
            <span class="n">jobs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">find_prices</span><span class="o">.</span><span class="n">get_price_jobs_at_date</span><span class="p">(</span>
                    <span class="n">entries</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">inactive</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">undeclared</span><span class="p">))</span>
            <span class="n">all_entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">jobs</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">all_entries</span><span class="p">),</span> <span class="n">dcontext</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.reset_cache">
<code class="highlight language-python">
reset_cache<span class="p">()</span> </code>
<a class="headerlink" href="#beancount.prices.price.reset_cache" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Reset the cache to its uninitialized state.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>144
145
146
147
148
149</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">reset_cache</span><span class="p">():</span>
    <span class="sd">"""Reset the cache to its uninitialized state."""</span>
    <span class="k">global</span> <span class="n">_CACHE</span>
    <span class="k">if</span> <span class="n">_CACHE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_CACHE</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">_CACHE</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.setup_cache">
<code class="highlight language-python">
setup_cache<span class="p">(</span><span class="n">cache_filename</span><span class="p">,</span> <span class="n">clear_cache</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.price.setup_cache" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Setup the results cache.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cache_filename</code></td>
<td><code></code></td>
<td>
<p>A string or None, the filename for the cache.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>clear_cache</code></td>
<td><code></code></td>
<td>
<p>A boolean, if true, delete the cache before beginning.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">setup_cache</span><span class="p">(</span><span class="n">cache_filename</span><span class="p">,</span> <span class="n">clear_cache</span><span class="p">):</span>
    <span class="sd">"""Setup the results cache.</span>

<span class="sd">    Args:</span>
<span class="sd">      cache_filename: A string or None, the filename for the cache.</span>
<span class="sd">      clear_cache: A boolean, if true, delete the cache before beginning.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">clear_cache</span> <span class="ow">and</span> <span class="n">cache_filename</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_filename</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Clearing cache </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">cache_filename</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cache_filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cache_filename</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Using price cache at "</span><span class="si">%s</span><span class="s1">" (with indefinite expiration)'</span><span class="p">,</span>
                     <span class="n">cache_filename</span><span class="p">)</span>

        <span class="k">global</span> <span class="n">_CACHE</span>
        <span class="n">_CACHE</span> <span class="o">=</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cache_filename</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">)</span>
        <span class="n">_CACHE</span><span class="o">.</span><span class="n">expiration</span> <span class="o">=</span> <span class="n">DEFAULT_EXPIRATION</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.prices.price_test">
<code>price_test</code>
<a class="headerlink" href="#beancount.prices.price_test" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Tests for main driver for price fetching.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.price_test.TestClobber">
<code>TestClobber</code>
<a class="headerlink" href="#beancount.prices.price_test.TestClobber" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.price_test.TestClobber.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.price_test.TestClobber.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/price_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="nd">@loader</span><span class="o">.</span><span class="n">load_doc</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">      ;; Existing file.</span>
<span class="sd">      2015-01-05 price HDV                                 75.56 USD</span>
<span class="sd">      2015-01-23 price HDV                                 77.34 USD</span>
<span class="sd">      2015-02-06 price HDV                                 77.16 USD</span>
<span class="sd">      2015-02-12 price HDV                                 78.17 USD</span>
<span class="sd">      2015-05-01 price HDV                                 77.48 USD</span>
<span class="sd">      2015-06-02 price HDV                                 76.33 USD</span>
<span class="sd">      2015-06-29 price HDV                                 73.74 USD</span>
<span class="sd">      2015-07-06 price HDV                                 73.79 USD</span>
<span class="sd">      2015-08-11 price HDV                                 74.19 USD</span>
<span class="sd">      2015-09-04 price HDV                                 68.98 USD</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span>

    <span class="c1"># New entries.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">price_entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_string</span><span class="p">(</span><span class="s2">"""</span>
<span class="s2">      2015-01-27 price HDV                                 76.83 USD</span>
<span class="s2">      2015-02-06 price HDV                                 77.16 USD</span>
<span class="s2">      2015-02-19 price HDV                                  77.5 USD</span>
<span class="s2">      2015-06-02 price HDV                                 76.33 USD</span>
<span class="s2">      2015-06-19 price HDV                                    76 USD</span>
<span class="s2">      2015-07-06 price HDV                                 73.79 USD</span>
<span class="s2">      2015-07-31 price HDV                                 74.64 USD</span>
<span class="s2">      2015-08-11 price HDV                                 74.20 USD ;; Different</span>
<span class="s2">    """</span><span class="p">,</span> <span class="n">dedent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.price_test.TestInverted">
<code>TestInverted</code>
<a class="headerlink" href="#beancount.prices.price_test.TestInverted" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.price_test.TestInverted.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.price_test.TestInverted.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/price_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>266
267
268
269
270
271
272
273</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">fetch_cached</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'beancount.prices.price.fetch_cached_price'</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">fetch_cached</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">SourcePrice</span><span class="p">(</span>
        <span class="n">D</span><span class="p">(</span><span class="s1">'125.00'</span><span class="p">),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">tz</span><span class="o">.</span><span class="n">tzlocal</span><span class="p">()),</span>
        <span class="s1">'JPY'</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dprice</span> <span class="o">=</span> <span class="n">find_prices</span><span class="o">.</span><span class="n">DatedPrice</span><span class="p">(</span><span class="s1">'JPY'</span><span class="p">,</span> <span class="s1">'USD'</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span>
                                         <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">stopall</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.prices.source">
<code>source</code>
<a class="headerlink" href="#beancount.prices.source" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Interface definition for all price sources.</p>
<p>This module describes the contract to be fulfilled by all implementations of
price sources.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.source.Source">
<code>Source</code>
<a class="headerlink" href="#beancount.prices.source.Source" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Interface to be implemented by all price sources.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.source.Source.get_historical_price">
<code class="highlight language-python">
get_historical_price<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.source.Source.get_historical_price" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return the historical price found for the symbol at the given date.</p>
<p>This could be the price of the close of the day, for instance. We assume
that there is some single price representative of the day.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ticker</code></td>
<td><code></code></td>
<td>
<p>A string, the ticker to be fetched by the source. This ticker
may include structure, such as the exchange code. Also note that
this ticker is source-specified, and is not necessarily the same
value as the commodity symbol used in the Beancount file.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>time</code></td>
<td><code></code></td>
<td>
<p>The timestamp at which to query for the price. This is a
timezone-aware timestamp you can convert to any timezone. For past
dates we query for a time that is equivalent to 4pm in the user's
timezone.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A SourcePrice instance. If the price could not be fetched, None is
returned and another source should be consulted. There is never any
guarantee that a price source will be able to fetch its value; client
code must be able to handle this. Also note that the price's returned
time must be timezone-aware.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/source.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_historical_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
    <span class="sd">"""Return the historical price found for the symbol at the given date.</span>

<span class="sd">    This could be the price of the close of the day, for instance. We assume</span>
<span class="sd">    that there is some single price representative of the day.</span>

<span class="sd">    Args:</span>
<span class="sd">      ticker: A string, the ticker to be fetched by the source. This ticker</span>
<span class="sd">        may include structure, such as the exchange code. Also note that</span>
<span class="sd">        this ticker is source-specified, and is not necessarily the same</span>
<span class="sd">        value as the commodity symbol used in the Beancount file.</span>
<span class="sd">      time: The timestamp at which to query for the price. This is a</span>
<span class="sd">        timezone-aware timestamp you can convert to any timezone. For past</span>
<span class="sd">        dates we query for a time that is equivalent to 4pm in the user's</span>
<span class="sd">        timezone.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A SourcePrice instance. If the price could not be fetched, None is</span>
<span class="sd">      returned and another source should be consulted. There is never any</span>
<span class="sd">      guarantee that a price source will be able to fetch its value; client</span>
<span class="sd">      code must be able to handle this. Also note that the price's returned</span>
<span class="sd">      time must be timezone-aware.</span>
<span class="sd">    """</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.source.Source.get_latest_price">
<code class="highlight language-python">
get_latest_price<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.source.Source.get_latest_price" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Fetch the current latest price. The date may differ.</p>
<p>This routine attempts to fetch the most recent available price, and
returns the actual date of the quoted price, which may differ from the
date this call is made at. {1cfa25e37fc1}</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ticker</code></td>
<td><code></code></td>
<td>
<p>A string, the ticker to be fetched by the source. This ticker
may include structure, such as the exchange code. Also note that
this ticker is source-specified, and is not necessarily the same
value as the commodity symbol used in the Beancount file.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A SourcePrice instance. If the price could not be fetched, None is
returned and another source should be consulted. There is never any
guarantee that a price source will be able to fetch its value; client
code must be able to handle this. Also note that the price's returned
time must be timezone-aware.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/source.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_latest_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">):</span>
    <span class="sd">"""Fetch the current latest price. The date may differ.</span>

<span class="sd">    This routine attempts to fetch the most recent available price, and</span>
<span class="sd">    returns the actual date of the quoted price, which may differ from the</span>
<span class="sd">    date this call is made at. {1cfa25e37fc1}</span>

<span class="sd">    Args:</span>
<span class="sd">      ticker: A string, the ticker to be fetched by the source. This ticker</span>
<span class="sd">        may include structure, such as the exchange code. Also note that</span>
<span class="sd">        this ticker is source-specified, and is not necessarily the same</span>
<span class="sd">        value as the commodity symbol used in the Beancount file.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A SourcePrice instance. If the price could not be fetched, None is</span>
<span class="sd">      returned and another source should be consulted. There is never any</span>
<span class="sd">      guarantee that a price source will be able to fetch its value; client</span>
<span class="sd">      code must be able to handle this. Also note that the price's returned</span>
<span class="sd">      time must be timezone-aware.</span>
<span class="sd">    """</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.source.SourcePrice">
<code>SourcePrice</code>
<a class="headerlink" href="#beancount.prices.source.SourcePrice" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>SourcePrice(price, time, quote_currency)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.source.SourcePrice.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.source.SourcePrice.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/source.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.source.SourcePrice.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">quote_currency</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.prices.source.SourcePrice.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of SourcePrice(price, time, quote_currency)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.source.SourcePrice.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.source.SourcePrice.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/source.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.prices.sources">
<code>sources</code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.sources" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Implementation of various price extractors.</p>
<p>This package is looked up by the driver script to figure out which extractor to
use.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.iex">
<code>iex</code>
<a class="headerlink" href="#beancount.prices.sources.iex" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Fetch prices from the IEX 1.0 public API.</p>
<p>This is a really fantastic exchange API with a lot of relevant information.</p>
<p>Timezone information: There is currency no support for historical prices. The
output datetime is provided as a UNIX timestamp.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.iex.IEXError">
<code>IEXError</code>
<a class="headerlink" href="#beancount.prices.sources.iex.IEXError" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>An error from the IEX API.</p>
</div>
</div>
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.iex.Source">
<code>Source</code>
<a class="headerlink" href="#beancount.prices.sources.iex.Source" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>IEX API price extractor.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.iex.Source.get_historical_price">
<code class="highlight language-python">
get_historical_price<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.iex.Source.get_historical_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/iex.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>51
52
53
54
55
56</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_historical_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
    <span class="sd">"""See contract in beancount.prices.source.Source."""</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s2">"As of April 2018, historical prices are not supported on IEX. "</span>
        <span class="s2">"Please check the API to see if this has changed: "</span>
        <span class="s2">"https://iextrading.com/developer/docs"</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.iex.Source.get_latest_price">
<code class="highlight language-python">
get_latest_price<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.iex.Source.get_latest_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/iex.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>47
48
49</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_latest_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">):</span>
    <span class="sd">"""See contract in beancount.prices.source.Source."""</span>
    <span class="k">return</span> <span class="n">fetch_quote</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.iex.fetch_quote">
<code class="highlight language-python">
fetch_quote<span class="p">(</span><span class="n">ticker</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.iex.fetch_quote" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Fetch</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/iex.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">fetch_quote</span><span class="p">(</span><span class="n">ticker</span><span class="p">):</span>
    <span class="sd">"""Fetch"""</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"https://api.iextrading.com/1.0/stock/</span><span class="si">{}</span><span class="s2">/quote"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">IEXError</span><span class="p">(</span><span class="s2">"Invalid response (</span><span class="si">{}</span><span class="s2">): </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                                                          <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="n">price</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">'latestPrice'</span><span class="p">])</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="s1">'0.01'</span><span class="p">))</span>

    <span class="c1"># IEX is American markets.</span>
    <span class="n">us_timezone</span> <span class="o">=</span> <span class="n">tz</span><span class="o">.</span><span class="n">gettz</span><span class="p">(</span><span class="s2">"America/New_York"</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">'latestUpdate'</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">us_timezone</span><span class="p">)</span>

    <span class="c1"># As far as can tell, all the instruments on IEX are priced in USD.</span>
    <span class="k">return</span> <span class="n">source</span><span class="o">.</span><span class="n">SourcePrice</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="s1">'USD'</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.iex_test">
<code>iex_test</code>
<a class="headerlink" href="#beancount.prices.sources.iex_test" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.iex_test.response">
<code class="highlight language-python">
response<span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.iex_test.response" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Produce a context manager to patch a JSON response.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/iex_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>17
18
19
20
21
22
23</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">):</span>
    <span class="sd">"""Produce a context manager to patch a JSON response."""</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">contents</span>
    <span class="k">return</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'requests.get'</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.oanda">
<code>oanda</code>
<a class="headerlink" href="#beancount.prices.sources.oanda" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>A source fetching currency prices from OANDA.</p>
<p>Valid tickers are in the form "XXX_YYY", such as "EUR_USD".</p>
<p>Here is the API documentation:
https://developer.oanda.com/rest-live/rates/</p>
<p>For example:
https://api-fxtrade.oanda.com/v1/candles?instrument=EUR_USD&amp;granularity=D&amp;start=2016-03-27T00%3A00%3A00Z&amp;end=2016-04-04T00%3A00%3A00Z&amp;candleFormat=midpoint</p>
<p>Timezone information: Input and output datetimes are specified via UTC
timestamps.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.oanda.Source">
<code>Source</code>
<a class="headerlink" href="#beancount.prices.sources.oanda.Source" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>OANDA price source extractor.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.oanda.Source.get_historical_price">
<code class="highlight language-python">
get_historical_price<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.oanda.Source.get_historical_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/oanda.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>121
122
123
124
125
126
127
128
129
130
131
132
133</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_historical_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
    <span class="sd">"""See contract in beancount.prices.source.Source."""</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz</span><span class="o">.</span><span class="n">tzutc</span><span class="p">())</span>
    <span class="n">query_interval_begin</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">query_interval_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'instrument'</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span>
        <span class="s1">'granularity'</span><span class="p">:</span> <span class="s1">'H2'</span><span class="p">,</span>  <span class="c1"># Every two hours.</span>
        <span class="s1">'candleFormat'</span><span class="p">:</span> <span class="s1">'midpoint'</span><span class="p">,</span>
        <span class="s1">'start'</span><span class="p">:</span> <span class="n">query_interval_begin</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s1">'T'</span><span class="p">),</span>
        <span class="s1">'end'</span><span class="p">:</span> <span class="n">query_interval_end</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s1">'T'</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_fetch_price</span><span class="p">(</span><span class="n">params_dict</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.oanda.Source.get_latest_price">
<code class="highlight language-python">
get_latest_price<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.oanda.Source.get_latest_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/oanda.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>110
111
112
113
114
115
116
117
118
119</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_latest_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">):</span>
    <span class="sd">"""See contract in beancount.prices.source.Source."""</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">.</span><span class="n">tzutc</span><span class="p">())</span>
    <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'instrument'</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span>
        <span class="s1">'granularity'</span><span class="p">:</span> <span class="s1">'S5'</span><span class="p">,</span>  <span class="c1"># Every two hours.</span>
        <span class="s1">'count'</span><span class="p">:</span> <span class="s1">'10'</span><span class="p">,</span>
        <span class="s1">'candleFormat'</span><span class="p">:</span> <span class="s1">'midpoint'</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_fetch_price</span><span class="p">(</span><span class="n">params_dict</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.oanda_test">
<code>oanda_test</code>
<a class="headerlink" href="#beancount.prices.sources.oanda_test" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Test for price extractor of OANDA.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.oanda_test.TestOandaGetHistorical">
<code>TestOandaGetHistorical</code>
<a class="headerlink" href="#beancount.prices.sources.oanda_test.TestOandaGetHistorical" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.oanda_test.TestOandaGetHistorical.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.oanda_test.TestOandaGetHistorical.setUp" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/oanda_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>138
139
140</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fetcher</span> <span class="o">=</span> <span class="n">oanda</span><span class="o">.</span><span class="n">Source</span><span class="p">()</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">TestOandaGetHistorical</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.oanda_test.TestOandaGetLatest">
<code>TestOandaGetLatest</code>
<a class="headerlink" href="#beancount.prices.sources.oanda_test.TestOandaGetLatest" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.oanda_test.TestOandaGetLatest.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.oanda_test.TestOandaGetLatest.setUp" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/oanda_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>106
107</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fetcher</span> <span class="o">=</span> <span class="n">oanda</span><span class="o">.</span><span class="n">Source</span><span class="p">()</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.quandl">
<code>quandl</code>
<a class="headerlink" href="#beancount.prices.sources.quandl" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Fetch prices from Quandl's simple URL-based API.</p>
<p>Quandl is a useful source of alternative data and it offers a simple REST API
that serves CSV and JSON and XML formats. There's also a Python client library,
but we specifically avoid using that here, in order to keep Beancount
dependency-free.</p>
<p>Many of the datasets are freely available, which is why this is included here.
You can get information about the available databases and associated lists of
symbols you can use here: https://www.quandl.com/search</p>
<p>If you have a paid account and would like to be able to access the premium
databases from the Quandl site, you can set QUANDL_API_KEY environment variable.</p>
<p>Use the "&lt;DATABASE_CODE&gt;:&lt;DATASET_CODE&gt;" format to refer to Quandl symbols.
Note that their symbols are usually identified by "&lt;DATABASE_CODE&gt;/&lt;DATASET_CODE&gt;".</p>
<p>(For now, this supports only the Time-Series API. There is also a Tables API,
which could easily get integrated. We would just have to encode the
'datatable_code' and 'format' and perhaps other fields in the ticker name.)</p>
<p>Timezone information: Input and output datetimes are limited to dates, and I
believe the dates are presumed to live in the timezone of each particular data
source. (It's unclear, not documented.)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.quandl.QuandlError">
<code>QuandlError</code>
<a class="headerlink" href="#beancount.prices.sources.quandl.QuandlError" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>An error from the Quandl API.</p>
</div>
</div>
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.quandl.Source">
<code>Source</code>
<a class="headerlink" href="#beancount.prices.sources.quandl.Source" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Quandl API price extractor.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.quandl.Source.get_historical_price">
<code class="highlight language-python">
get_historical_price<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.quandl.Source.get_historical_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/quandl.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>110
111
112</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_historical_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
    <span class="sd">"""See contract in beancount.prices.source.Source."""</span>
    <span class="k">return</span> <span class="n">fetch_time_series</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.quandl.Source.get_latest_price">
<code class="highlight language-python">
get_latest_price<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.quandl.Source.get_latest_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/quandl.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>106
107
108</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_latest_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">):</span>
    <span class="sd">"""See contract in beancount.prices.source.Source."""</span>
    <span class="k">return</span> <span class="n">fetch_time_series</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.quandl.fetch_time_series">
<code class="highlight language-python">
fetch_time_series<span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.quandl.fetch_time_series" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Fetch</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/quandl.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">fetch_time_series</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Fetch"""</span>
    <span class="c1"># Create request payload.</span>
    <span class="n">database</span><span class="p">,</span> <span class="n">dataset</span> <span class="o">=</span> <span class="n">parse_ticker</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"https://www.quandl.com/api/v3/datasets/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.json"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"limit"</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">payload</span><span class="p">[</span><span class="s2">"start_date"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">payload</span><span class="p">[</span><span class="s2">"end_date"</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

    <span class="c1"># Add API key, if it is set in the environment.</span>
    <span class="k">if</span> <span class="s1">'QUANDL_API_KEY'</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="s1">'api_key'</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'QUANDL_API_KEY'</span><span class="p">]</span>

    <span class="c1"># Fetch and process errors.</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">QuandlError</span><span class="p">(</span><span class="s2">"Invalid response (</span><span class="si">{}</span><span class="s2">): </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                                                             <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">'quandl_error'</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">QuandlError</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">'quandl_error'</span><span class="p">][</span><span class="s1">'message'</span><span class="p">])</span>

    <span class="c1"># Parse result container.</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'dataset'</span><span class="p">]</span>
    <span class="n">column_names</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">'column_names'</span><span class="p">]</span>
    <span class="n">date_index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">'Date'</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data_index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">'Adj. Close'</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">data_index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">'Close'</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">'data'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Gather time and assume it's in UTC timezone (Quandl does not provide the</span>
    <span class="c1"># market's timezone).</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">date_index</span><span class="p">],</span> <span class="s1">'%Y-%m-</span><span class="si">%d</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">tz</span><span class="o">.</span><span class="n">tzutc</span><span class="p">())</span>

    <span class="c1"># Gather price.</span>
    <span class="c1"># Quantize with the same precision default rendering of floats occur.</span>
    <span class="n">price_float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data_index</span><span class="p">]</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">price_float</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'(\..*)'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">price_float</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">price</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>

    <span class="c1"># Note: There is no currency information in the response (surprising).</span>
    <span class="k">return</span> <span class="n">source</span><span class="o">.</span><span class="n">SourcePrice</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.quandl.parse_ticker">
<code class="highlight language-python">
parse_ticker<span class="p">(</span><span class="n">ticker</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.quandl.parse_ticker" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Convert ticker to Quandl codes.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/quandl.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>45
46
47
48
49</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">parse_ticker</span><span class="p">(</span><span class="n">ticker</span><span class="p">):</span>
    <span class="sd">"""Convert ticker to Quandl codes."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">"[A-Z0-9]+:[A-Z0-9]+$"</span><span class="p">,</span> <span class="n">ticker</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'Invalid code. Use "&lt;DATABASE&gt;/&lt;DATASET&gt;" format.'</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.quandl_test">
<code>quandl_test</code>
<a class="headerlink" href="#beancount.prices.sources.quandl_test" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.quandl_test.response">
<code class="highlight language-python">
response<span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.quandl_test.response" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Produce a context manager to patch a JSON response.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/quandl_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>17
18
19
20
21
22
23</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">):</span>
    <span class="sd">"""Produce a context manager to patch a JSON response."""</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">contents</span>
    <span class="k">return</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'requests.get'</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.yahoo">
<code>yahoo</code>
<a class="headerlink" href="#beancount.prices.sources.yahoo" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Fetch prices from Yahoo Finance's CSV API.</p>
<p>As of lated 2017, the older Yahoo finance API deprecated. In particular, the
ichart endpoint is gone, and the download endpoint requires a cookie (which
could be gotten - here's some documentation for that
http://blog.bradlucas.com/posts/2017-06-02-new-yahoo-finance-quote-download-url/).</p>
<p>We're using both the v7 and v8 APIs here, both of which are, as far as I can
tell, undocumented:</p>
<p>https://query1.finance.yahoo.com/v7/finance/quote
https://query1.finance.yahoo.com/v8/finance/chart/SYMBOL</p>
<p>Timezone information: Input and output datetimes are specified via UNIX
timestamps, but the timezone of the particular market is included in the output.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.yahoo.Source">
<code>Source</code>
<a class="headerlink" href="#beancount.prices.sources.yahoo.Source" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Yahoo Finance CSV API price extractor.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.yahoo.Source.get_historical_price">
<code class="highlight language-python">
get_historical_price<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.yahoo.Source.get_historical_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/yahoo.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_historical_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
    <span class="sd">"""See contract in beancount.prices.source.Source."""</span>
    <span class="k">if</span> <span class="n">requests</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">YahooError</span><span class="p">(</span><span class="s2">"You must install the 'requests' library."</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"https://query1.finance.yahoo.com/v8/finance/chart/</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
    <span class="n">dt_start</span> <span class="o">=</span> <span class="n">time</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">dt_end</span> <span class="o">=</span> <span class="n">time</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'period1'</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">dt_start</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()),</span>
        <span class="s1">'period2'</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">dt_end</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()),</span>
        <span class="s1">'interval'</span><span class="p">:</span> <span class="s1">'1d'</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">payload</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_DEFAULT_PARAMS</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">parse_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="n">meta</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'meta'</span><span class="p">]</span>
    <span class="n">timezone</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="s1">'gmtoffset'</span><span class="p">]</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">),</span>
                                 <span class="n">meta</span><span class="p">[</span><span class="s1">'exchangeTimezoneName'</span><span class="p">])</span>

    <span class="n">timestamp_array</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'timestamp'</span><span class="p">]</span>
    <span class="n">close_array</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'indicators'</span><span class="p">][</span><span class="s1">'quote'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'close'</span><span class="p">]</span>
    <span class="n">series</span> <span class="o">=</span> <span class="p">[(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="p">),</span> <span class="n">D</span><span class="p">(</span><span class="n">price</span><span class="p">))</span>
              <span class="k">for</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">timestamp_array</span><span class="p">,</span> <span class="n">close_array</span><span class="p">)]</span>

    <span class="c1"># Get the latest data returned.</span>
    <span class="n">latest</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">data_dt</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data_dt</span> <span class="o">&gt;=</span> <span class="n">time</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">data_dt</span><span class="p">,</span> <span class="n">price</span>
    <span class="k">if</span> <span class="n">latest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">YahooError</span><span class="p">(</span><span class="s2">"Could not find price before </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">series</span><span class="p">))</span>

    <span class="n">currency</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'meta'</span><span class="p">][</span><span class="s1">'currency'</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">source</span><span class="o">.</span><span class="n">SourcePrice</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">data_dt</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.yahoo.Source.get_latest_price">
<code class="highlight language-python">
get_latest_price<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.yahoo.Source.get_latest_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/yahoo.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_latest_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">):</span>
    <span class="sd">"""See contract in beancount.prices.source.Source."""</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s2">"https://query1.finance.yahoo.com/v7/finance/quote"</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'symbol'</span><span class="p">,</span> <span class="s1">'regularMarketPrice'</span><span class="p">,</span> <span class="s1">'regularMarketTime'</span><span class="p">]</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'symbols'</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span>
        <span class="s1">'fields'</span><span class="p">:</span> <span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span>
        <span class="s1">'exchange'</span><span class="p">:</span> <span class="s1">'NYSE'</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">payload</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_DEFAULT_PARAMS</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">parse_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">'regularMarketPrice'</span><span class="p">])</span>

        <span class="n">timezone</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s1">'gmtOffSetMilliseconds'</span><span class="p">]</span> <span class="o">/</span> <span class="mi">3600000</span><span class="p">),</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">'exchangeTimezoneName'</span><span class="p">])</span>
        <span class="n">trade_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">'regularMarketTime'</span><span class="p">],</span>
                                                     <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">YahooError</span><span class="p">(</span><span class="s2">"Invalid response from Yahoo: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>

    <span class="n">currency</span> <span class="o">=</span> <span class="n">parse_currency</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">source</span><span class="o">.</span><span class="n">SourcePrice</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">trade_time</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.yahoo.YahooError">
<code>YahooError</code>
<a class="headerlink" href="#beancount.prices.sources.yahoo.YahooError" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>An error from the Yahoo API.</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.yahoo.parse_currency">
<code class="highlight language-python">
parse_currency<span class="p">(</span><span class="n">result</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.yahoo.parse_currency" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Infer the currency from the result.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/yahoo.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>58
59
60
61
62</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">parse_currency</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""Infer the currency from the result."""</span>
    <span class="k">if</span> <span class="s1">'market'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">_MARKETS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">'market'</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.yahoo.parse_response">
<code class="highlight language-python">
parse_response<span class="p">(</span><span class="n">response</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.prices.sources.yahoo.parse_response" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Process as response from Yahoo.</p>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>YahooError</code></td>
<td>
<p>If there is an error in the response.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/yahoo.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">parse_response</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Response</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">"""Process as response from Yahoo.</span>

<span class="sd">    Raises:</span>
<span class="sd">      YahooError: If there is an error in the response.</span>
<span class="sd">    """</span>
    <span class="n">json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="n">parse_float</span><span class="o">=</span><span class="n">D</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">YahooError</span><span class="p">(</span><span class="s2">"Status </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">content</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">json</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">YahooError</span><span class="p">(</span><span class="s2">"Invalid format in response from Yahoo; many keys: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">YahooError</span><span class="p">(</span><span class="s2">"Error fetching Yahoo data: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">content</span><span class="p">[</span><span class="s1">'result'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.yahoo_test">
<code>yahoo_test</code>
<a class="headerlink" href="#beancount.prices.sources.yahoo_test" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.yahoo_test.MockResponse">
<code>MockResponse</code>
<a class="headerlink" href="#beancount.prices.sources.yahoo_test.MockResponse" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>A mock requests.Models.Response object for testing.</p>
<div class="doc doc-children">
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<footer>
<div aria-label="footer navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-right" href="beancount.query.html" title="beancount.query">Next <span class="icon icon-circle-arrow-right"></span></a>
<a class="btn btn-neutral" href="beancount.plugins.html" title="beancount.plugins"><span class="icon icon-circle-arrow-left"></span> Previous</a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<a class="fa fa-github" href="https://github.com/xuhcc/beancount-docs/" style="float: left; color: #fcfcfc"> GitHub</a>
<span><a href="beancount.plugins.html" style="color: #fcfcfc;">« Previous</a></span>
<span style="margin-left: 15px"><a href="beancount.query.html" style="color: #fcfcfc">Next »</a></span>
</span>
</div>
<script>var base_url = '..';</script>
<script defer="" src="../js/theme.js"></script>
<script defer="" src="../js/extra.js"></script>
<script defer="">
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>
</body>
</html>
