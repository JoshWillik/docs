<!DOCTYPE html>

<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://beancount.github.io/docs/api_reference/beancount.prices.html" rel="canonical"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>beancount.prices - Beancount Documentation</title>
<link href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet">
<link href="../css/theme.css" rel="stylesheet">
<link href="../css/theme_extra.css" rel="stylesheet"/>
<link href="../css/custom.css" rel="stylesheet"/>
<script>
    // Current page data
    var mkdocs_page_name = "beancount.prices";
    var mkdocs_page_input_path = "api_reference/beancount.prices.md";
    var mkdocs_page_url = "/docs/api_reference/beancount.prices.html";
  </script>
<script defer="" src="../js/jquery-2.1.1.min.js"></script>
<script defer="" src="../js/modernizr-2.8.3.min.js"></script>
</link></link></head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href=".."> Beancount Documentation</a>
<div role="search">
<form action="../search.html" class="wy-form" id="rtd-search-form" method="get">
<input name="q" placeholder="Search docs" title="Type search term here" type="text"/>
</form>
</div>
</div>
<div aria-label="main navigation" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Index</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Outline</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="#">Documentation for Users</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../01_command_line_accounting_in_context.html">Command Line Accounting in Context</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../02_the_double_entry_counting_method.html">The Double Entry Counting Method</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../03_installing_beancount.html">Installing Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../04_running_beancount_and_generating_reports.html">Running Beancount and Generating Reports</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../05_getting_started_with_beancount.html">Getting Started with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../06_beancount_language_syntax.html">Beancount Language Syntax</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../07_beancount_options_reference.html">Beancount Options Reference</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../08_precision_tolerances.html">Precision Tolerances</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../09_beancount_query_language.html">Beancount Query Language</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../10_beancount_cheat_sheet.html">Beancount Cheat Sheet</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../11_how_inventories_work.html">How Inventories Work</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../12_exporting_your_portfolio.html">Exporting Your Portfolio</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../13_tutorial_example.html">Tutorial &amp; Example</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../14_beancount_history_and_credits.html">Beancount History and Credits</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../15_a_comparison_of_beancount_and_ledger_hledger.html">A Comparison of Beancount and Ledger Hledger</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../16_fetching_prices_in_beancount.html">Fetching Prices in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../17_importing_external_data.html">Importing External Data</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Cookbooks &amp; Examples</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../18_command_line_accounting_cookbook.html">Command Line Accounting Cookbook</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../19_trading_with_beancount.html">Trading with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../20_stock_vesting_in_beancount.html">Stock Vesting in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../21_sharing_expenses_with_beancount.html">Sharing Expenses with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../22_how_we_share_expenses.html">How We Share Expenses</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Documentation for Developers</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../23_beancount_scripting_plugins.html">Beancount Scripting Plugins</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../24_beancount_design_doc.html">Beancount Design Doc</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../25_ledgerhub_design_doc.html">Ledgerhub Design Doc</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../26_external_contributions.html">External Contributions</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Enhancement Proposals &amp; Discussions</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../27_a_proposal_for_an_improvement_on_inventory_booking.html">A Proposal for an Improvement on Inventory Booking</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../28_settlement_dates_in_beancount.html">Settlement Dates in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../29_balance_assertions_in_beancount.html">Balance Assertions in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../30_fund_accounting_with_beancount.html">Fund Accounting with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../31_rounding_precision_in_beancount.html">Rounding Precision in Beancount</a>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">beancount</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.core.html">beancount.core</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.ingest.html">beancount.ingest</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.loader.html">beancount.loader</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.ops.html">beancount.ops</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.parser.html">beancount.parser</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.plugins.html">beancount.plugins</a>
</li>
<li class="toctree-l1 current"><a class="reference internal current" href="beancount.prices.html">beancount.prices</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices">beancount.prices</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#date">Date</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#inverse">Inverse</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#swap-inverted">Swap Inverted</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#prices-needed-for-a-beancount-file">Prices Needed for a Beancount File</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#caching">Caching</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#about-sources-and-data-availability">About Sources and Data Availability</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices.find_prices">find_prices</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.DatedPrice">DatedPrice</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices.DatedPrice.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices.DatedPrice.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices.DatedPrice.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.PriceSource">PriceSource</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices.PriceSource.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices.PriceSource.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices.PriceSource.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.find_balance_currencies">find_balance_currencies()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.find_currencies_at_cost">find_currencies_at_cost()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.find_currencies_converted">find_currencies_converted()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.find_currencies_declared">find_currencies_declared()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.find_currencies_priced">find_currencies_priced()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.format_dated_price_str">format_dated_price_str()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.get_price_jobs_at_date">get_price_jobs_at_date()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.import_source">import_source()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.log_currency_list">log_currency_list()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.parse_single_source">parse_single_source()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices.parse_source_map">parse_source_map()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices.find_prices_test">find_prices_test</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices_test.TestFilters">TestFilters</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices_test.TestFilters.test_get_price_jobs__date">test_get_price_jobs__date()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices_test.TestFilters.test_get_price_jobs__default_source">test_get_price_jobs__default_source()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices_test.TestFilters.test_get_price_jobs__inactive">test_get_price_jobs__inactive()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices_test.TestFilters.test_get_price_jobs__undeclared">test_get_price_jobs__undeclared()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.find_prices_test.TestFromFile">TestFromFile</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.find_prices_test.TestFromFile.setUp">setUp()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices.price">price</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.fetch_cached_price">fetch_cached_price()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.fetch_price">fetch_price()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.filter_redundant_prices">filter_redundant_prices()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.now">now()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.process_args">process_args()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.reset_cache">reset_cache()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price.setup_cache">setup_cache()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices.price_test">price_test</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price_test.TestClobber">TestClobber</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.price_test.TestClobber.setUp">setUp()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price_test.TestInverted">TestInverted</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.price_test.TestInverted.setUp">setUp()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.price_test.TestProcessArguments">TestProcessArguments</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.price_test.TestProcessArguments.test_explicit_file__badcontents">test_explicit_file__badcontents()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices.source">source</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.source.Source">Source</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.source.Source.get_historical_price">get_historical_price()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.source.Source.get_latest_price">get_latest_price()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.source.SourcePrice">SourcePrice</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.source.SourcePrice.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.source.SourcePrice.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.source.SourcePrice.__repr__">__repr__()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.prices.sources">sources</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.coinbase">coinbase</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.coinbase.CoinbaseError">CoinbaseError</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.coinbase.Source">Source</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.coinbase.fetch_quote">fetch_quote()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.coinbase_test">coinbase_test</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.coinbase_test.response">response()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.iex">iex</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.iex.IEXError">IEXError</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.iex.Source">Source</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.iex.fetch_quote">fetch_quote()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.iex_test">iex_test</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.iex_test.response">response()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.oanda">oanda</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.oanda.Source">Source</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.oanda_test">oanda_test</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.oanda_test.TestOandaGetHistorical">TestOandaGetHistorical</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.oanda_test.TestOandaGetLatest">TestOandaGetLatest</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.quandl">quandl</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.quandl.QuandlError">QuandlError</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.quandl.Source">Source</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.quandl.fetch_time_series">fetch_time_series()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.quandl.parse_ticker">parse_ticker()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.quandl_test">quandl_test</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.quandl_test.response">response()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.yahoo">yahoo</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.yahoo.Source">Source</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.yahoo.YahooError">YahooError</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.yahoo.parse_currency">parse_currency()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.yahoo.parse_response">parse_response()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.prices.sources.yahoo_test">yahoo_test</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.prices.sources.yahoo_test.MockResponse">MockResponse</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.query.html">beancount.query</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.reports.html">beancount.reports</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.scripts.html">beancount.scripts</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.utils.html">beancount.utils</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.web.html">beancount.web</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="top navigation" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="..">Beancount Documentation</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a href="..">Docs</a> »</li>
<li>API reference »</li>
<li>beancount.prices</li>
<li class="wy-breadcrumbs-aside">
<a class="icon icon-github" href="https://github.com/beancount/docs/edit/master/docs/api_reference/beancount.prices.md"> Edit on GitHub</a>
</li>
</ul>
<hr/>
</div>
<div role="main">
<div class="section">
<h1 id="beancountprices">beancount.prices<a class="headerlink" href="#beancountprices" title="Permanent link"></a></h1>
<div class="doc doc-object doc-module">
<h2 class="hidden-toc" href="#beancount.prices" id="beancount.prices" style="visibility: hidden; width: 0; height: 0;">
<a class="headerlink" href="#beancount.prices" title="Permanent link"></a></h2>
<div class="doc doc-contents first">
<p>Fetch prices from the internet and output them as Beancount price directives.</p>
<p>This script accepts a list of Beancount input filenames, and fetches prices
required to compute market values for current positions:</p>
<p>bean-price /home/joe/finances/joe.beancount</p>
<p>The list of fetching jobs to carry out is derived automatically from the input
file (see section below for full details). It is also possible to provide a list
of specific price fetching jobs to run, e.g.,</p>
<p>bean-price -e google/TSE:XUS yahoo/AAPL mysources.morningstar/RBF1005</p>
<p>The general format of each of these "source strings" is</p>
<p>&lt;module&gt;/[^]&lt;ticker&gt;</p>
<p>The "module" is the name of a Python module that contains a Source class which
can be instantiated and connect to a data source to extract price data. These
modules are automatically imported by name and instantiated in order to pull the
price from a particular data source. This allows you to write your own
supplementary fetcher codes without having to modify this script.</p>
<p>Default implementations are provided to provide access to prices from Yahoo!
Finance or Google Finance, which cover a large universe of common public
investment types (e.g. stock tickers). As a convenience, the module name is
always first searched under the "beancount.prices.sources" package, where those
default source implementations live. This is how, for example, in order to use
the provided Google Finance data fetcher you don't have to write
"beancount.prices.sources.yahoo/AAPL" but simply "yahoo/AAPL".</p>
<h2 id="date">Date<a class="headerlink" href="#date" title="Permanent link"></a></h2>
<p>By default, this script will fetch prices at the latest available date &amp; time.
You can use an option to fetch historical prices for a desired date instead:</p>
<p>bean-price --date=2015-02-03</p>
<h2 id="inverse">Inverse<a class="headerlink" href="#inverse" title="Permanent link"></a></h2>
<p>Sometimes, prices are available for the inverse of an instrument. This is often
the case for currencies. For example, the price of "CAD" in USD" is provided by
the USD/CAD market, which gives the price of a US dollar in Canadian dollars. In
order specify this, you can prepend "^" to the instrument to instruct the driver
to compute the inverse of the given price:</p>
<p>bean-price -e USD:google/^CURRENCY:USDCAD</p>
<p>If a source price is to be inverted, like this, the precision could be different
than what is fetched. For instance, if the price of USD/CAD is 1.32759, it would
output be this from the above directive:</p>
<p>2015-10-28 price CAD  0.753244601119 USD</p>
<p>By default, inverted rates will be rounded similarly to how other Price
directives were rounding those numbers.</p>
<h2 id="swap-inverted">Swap Inverted<a class="headerlink" href="#swap-inverted" title="Permanent link"></a></h2>
<p>If you prefer to have the output Price entries with swapped currencies instead
of inverting the rate itself, you can use the --swap-inverted option. In the
previous example for the price of CAD, it would output this:</p>
<p>2015-10-28 price USD   1.32759 CAD</p>
<p>This works since the Beancount price database computes and interpolates the
reciprocals automatically for all pairs of commodities in its database.</p>
<h2 id="prices-needed-for-a-beancount-file">Prices Needed for a Beancount File<a class="headerlink" href="#prices-needed-for-a-beancount-file" title="Permanent link"></a></h2>
<p>You can also provide a filename to extract the list of tickers to fetch from a
Beancount input file, e.g.:</p>
<p>bean-price /home/joe/finances/joe.beancount</p>
<p>There are many ways to extract a list of commodities with needed prices from a
Beancount input file:</p>
<ul>
<li>
<p>Prices for all the holdings that were seen held-at-cost at a particular date.</p>
</li>
<li>
<p>Prices for holdings held at a particular date which were price converted from
  some other commodity in the past (i.e., for currencies).</p>
</li>
<li>
<p>The list of all Commodity directives present in the file. For each of those
  holdings, the corresponding Commodity directive is consulted and its "ticker"
  metadata field is used to specify where to attempt to fetch prices. You should
  have directives like this in your input file:</p>
<p>2007-07-20 commodity VEA
  price: "google/NYSEARCA:VEA"</p>
</li>
</ul>
<p>The "price" metadata can be a comma-separated list of sources to try out, in
  which case each of the sources will be looked at :</p>
<pre><code>2007-07-20 commodity VEA
  price: "google/CURRENCY:USDCAD,yahoo/USDCAD"
</code></pre>
<ul>
<li>Existing price directives for the same data are excluded by default, since the
  price is already in the file.</li>
</ul>
<p>By default, the list of tickers to be fetched includes only the intersection of
these lists. The general intent of the user of this script is to fetch missing
prices, and only needed ones, for a particular date.</p>
<ul>
<li>Use the --date option to change the applied date.</li>
<li>Use the --all option to fetch the entire set of prices, regardless
  of holdings and date.</li>
<li>Use --clobber to ignore existing price directives.</li>
</ul>
<p>You can also print the list of prices to be fetched with the --dry-run option,
which stops short of actually fetching the missing prices (it just prints the
list of fetches it would otherwise attempt).</p>
<h2 id="caching">Caching<a class="headerlink" href="#caching" title="Permanent link"></a></h2>
<p>Prices are automatically cached. You can disable the cache with an option:</p>
<p>bean-price --no-cache</p>
<p>You can also instruct the script to clear the cache before fetching its prices:</p>
<p>bean-price --clear-cache</p>
<h2 id="about-sources-and-data-availability">About Sources and Data Availability<a class="headerlink" href="#about-sources-and-data-availability" title="Permanent link"></a></h2>
<p>IMPORTANT: Note that each source may support a different routine for getting its
latest data and for fetching historical/dated data, and that each of these may
differ in their support. For example, Google Finance does not support fetching
historical data for its CURRENCY:* instruments.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.prices.find_prices">
<code>find_prices</code>
<a class="headerlink" href="#beancount.prices.find_prices" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>A library of codes create price fetching jobs from strings and files.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.DatedPrice">
<code>DatedPrice</code>
<a class="headerlink" href="#beancount.prices.find_prices.DatedPrice" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>DatedPrice(base, quote, date, sources)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices.DatedPrice.__getnewargs__">
<code class="highlight language-python">
__getnewargs__
(self)

        </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.find_prices.DatedPrice.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def __getnewargs__(self):
    'Return self as a plain tuple.  Used by copy and pickle.'
    return _tuple(self)
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices.DatedPrice.__new__">
<code class="highlight language-python">
__new__
(_cls, base, quote, date, sources)

        </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.prices.find_prices.DatedPrice.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of DatedPrice(base, quote, date, sources)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices.DatedPrice.__repr__">
<code class="highlight language-python">
__repr__
(self)

        </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.find_prices.DatedPrice.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def __repr__(self):
    'Return a nicely formatted representation string'
    return self.__class__.__name__ + repr_fmt % self
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.PriceSource">
<code>PriceSource</code>
<a class="headerlink" href="#beancount.prices.find_prices.PriceSource" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>PriceSource(module, symbol, invert)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices.PriceSource.__getnewargs__">
<code class="highlight language-python">
__getnewargs__
(self)

        </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.find_prices.PriceSource.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def __getnewargs__(self):
    'Return self as a plain tuple.  Used by copy and pickle.'
    return _tuple(self)
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices.PriceSource.__new__">
<code class="highlight language-python">
__new__
(_cls, module, symbol, invert)

        </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.prices.find_prices.PriceSource.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of PriceSource(module, symbol, invert)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices.PriceSource.__repr__">
<code class="highlight language-python">
__repr__
(self)

        </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.find_prices.PriceSource.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def __repr__(self):
    'Return a nicely formatted representation string'
    return self.__class__.__name__ + repr_fmt % self
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.find_balance_currencies">
<code class="highlight language-python">
find_balance_currencies
(entries, date=None)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices.find_balance_currencies" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return currencies relevant for the given date.</p>
<p>This computes the account balances as of the date, and returns the union of:
a) The currencies held at cost, and
b) Currency pairs from previous conversions, but only for currencies with
   non-zero balances.</p>
<p>This is intended to produce the list of currencies whose prices are relevant
at a particular date, based on previous history.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A set of (base, quote) currencies.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def find_balance_currencies(entries, date=None):
    """Return currencies relevant for the given date.

    This computes the account balances as of the date, and returns the union of:
    a) The currencies held at cost, and
    b) Currency pairs from previous conversions, but only for currencies with
       non-zero balances.

    This is intended to produce the list of currencies whose prices are relevant
    at a particular date, based on previous history.

    Args:
      entries: A list of directives.
      date: A datetime.date instance.
    Returns:
      A set of (base, quote) currencies.
    """
    # Compute the balances.
    currencies = set()
    currencies_on_books = set()
    balances, _ = summarize.balance_by_account(entries, date)
    for _, balance in balances.items():
        for pos in balance:
            if pos.cost is not None:
                # Add currencies held at cost.
                currencies.add((pos.units.currency, pos.cost.currency))
            else:
                # Add regular currencies.
                currencies_on_books.add(pos.units.currency)

    # Create currency pairs from the currencies which are on account balances.
    # In order to figure out the quote currencies, we use the list of price
    # conversions until this date.
    converted = (find_currencies_converted(entries, date) |
                 find_currencies_priced(entries, date))
    for cbase in currencies_on_books:
        for base_quote in converted:
            base, quote = base_quote
            if base == cbase:
                currencies.add(base_quote)

    return currencies
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.find_currencies_at_cost">
<code class="highlight language-python">
find_currencies_at_cost
(entries)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices.find_currencies_at_cost" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return all currencies that were held at cost at some point.</p>
<p>This returns all of them, even if not on the books at a particular point in
time. This code does not look at account balances.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of (base, quote) currencies.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def find_currencies_at_cost(entries):
    """Return all currencies that were held at cost at some point.

    This returns all of them, even if not on the books at a particular point in
    time. This code does not look at account balances.

    Args:
      entries: A list of directives.
      date: A datetime.date instance.
    Returns:
      A list of (base, quote) currencies.
    """
    currencies = set()
    for entry in entries:
        if not isinstance(entry, data.Transaction):
            continue
        for posting in entry.postings:
            if posting.cost is not None and posting.cost.number is not None:
                currencies.add((posting.units.currency, posting.cost.currency))
    return currencies
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.find_currencies_converted">
<code class="highlight language-python">
find_currencies_converted
(entries, date=None)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices.find_currencies_converted" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return currencies from price conversions.</p>
<p>This function looks at all price conversions that occurred until some date
and produces a list of them. Note: This does not include Price directives,
only postings with price conversions.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of (base, quote) currencies.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def find_currencies_converted(entries, date=None):
    """Return currencies from price conversions.

    This function looks at all price conversions that occurred until some date
    and produces a list of them. Note: This does not include Price directives,
    only postings with price conversions.

    Args:
      entries: A list of directives.
      date: A datetime.date instance.
    Returns:
      A list of (base, quote) currencies.
    """
    currencies = set()
    for entry in entries:
        if not isinstance(entry, data.Transaction):
            continue
        if date and entry.date &gt;= date:
            break
        for posting in entry.postings:
            price = posting.price
            if posting.cost is not None or price is None:
                continue
            currencies.add((posting.units.currency, price.currency))
    return currencies
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.find_currencies_declared">
<code class="highlight language-python">
find_currencies_declared
(entries, date=None)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices.find_currencies_declared" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return currencies declared in Commodity directives.</p>
<p>If a 'price' metadata field is provided, include all the quote currencies
there-in. Otherwise, the Commodity directive is ignored.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of (base, quote, list of PriceSource) currencies. The list of
(base, quote) pairs is guaranteed to be unique.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def find_currencies_declared(entries, date=None):
    """Return currencies declared in Commodity directives.

    If a 'price' metadata field is provided, include all the quote currencies
    there-in. Otherwise, the Commodity directive is ignored.

    Args:
      entries: A list of directives.
      date: A datetime.date instance.
    Returns:
      A list of (base, quote, list of PriceSource) currencies. The list of
      (base, quote) pairs is guaranteed to be unique.
    """
    currencies = []
    for entry in entries:
        if not isinstance(entry, data.Commodity):
            continue
        if date and entry.date &gt;= date:
            break

        # Here we have to infer which quote currencies the commodity is for
        # (maybe down the road this should be better handled by providing a list
        # of quote currencies in the Commodity directive itself).
        #
        # First, we look for a "price" metadata field, which defines conversions
        # for various currencies. Each of these quote currencies generates a
        # pair in the output.
        source_str = entry.meta.get('price', None)
        if source_str is not None:
            if source_str == "":
                logging.debug("Skipping ignored currency (with empty price): %s",
                              entry.currency)
                continue
            try:
                source_map = parse_source_map(source_str)
            except ValueError:
                logging.warning("Ignoring currency with invalid 'price' source: %s",
                                entry.currency)
            else:
                for quote, psources in source_map.items():
                    currencies.append((entry.currency, quote, psources))
        else:
            # Otherwise we simply ignore the declaration. That is, a Commodity
            # directive without any "price" metadata would not register as a
            # declared currency.
            logging.debug("Ignoring currency with no metadata: %s", entry.currency)

    return currencies
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.find_currencies_priced">
<code class="highlight language-python">
find_currencies_priced
(entries, date=None)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices.find_currencies_priced" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return currencies seen in Price directives.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of (base, quote) currencies.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def find_currencies_priced(entries, date=None):
    """Return currencies seen in Price directives.

    Args:
      entries: A list of directives.
      date: A datetime.date instance.
    Returns:
      A list of (base, quote) currencies.
    """
    currencies = set()
    for entry in entries:
        if not isinstance(entry, data.Price):
            continue
        if date and entry.date &gt;= date:
            break
        currencies.add((entry.currency, entry.amount.currency))
    return currencies
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.format_dated_price_str">
<code class="highlight language-python">
format_dated_price_str
(dprice)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices.format_dated_price_str" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Convert a dated price to a one-line printable string.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dprice</code></td>
<td><code></code></td>
<td>
<p>A DatedPrice instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>The string for a DatedPrice instance.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def format_dated_price_str(dprice):
    """Convert a dated price to a one-line printable string.

    Args:
      dprice: A DatedPrice instance.
    Returns:
      The string for a DatedPrice instance.
    """
    psstrs = ['{}({}{})'.format(psource.module.__name__,
                                '1/' if psource.invert else '',
                                psource.symbol)
              for psource in dprice.sources]
    base_quote = '{} /{}'.format(dprice.base, dprice.quote)
    return '{:&lt;32} @ {:10} [ {} ]'.format(
        base_quote,
        dprice.date.isoformat() if dprice.date else 'latest',
        ','.join(psstrs))
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.get_price_jobs_at_date">
<code class="highlight language-python">
get_price_jobs_at_date
(entries, date=None, inactive=False, undeclared_source=None)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices.get_price_jobs_at_date" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Get a list of prices to fetch from a stream of entries.</p>
<p>The active holdings held on the given date are included.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>filename</code></td>
<td><code></code></td>
<td>
<p>A string, the name of a file to process.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>inactive</code></td>
<td><code></code></td>
<td>
<p>Include currencies with no balance at the given date. The default
is to only include those currencies which have a non-zero balance.</p>
</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>undeclared_source</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the default source module to use to
pull prices for commodities without a price source metadata on their
Commodity directive declaration.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of DatedPrice instances.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def get_price_jobs_at_date(entries, date=None, inactive=False, undeclared_source=None):
    """Get a list of prices to fetch from a stream of entries.

    The active holdings held on the given date are included.

    Args:
      filename: A string, the name of a file to process.
      date: A datetime.date instance.
      inactive: Include currencies with no balance at the given date. The default
        is to only include those currencies which have a non-zero balance.
      undeclared_source: A string, the name of the default source module to use to
        pull prices for commodities without a price source metadata on their
        Commodity directive declaration.
    Returns:
      A list of DatedPrice instances.

    """
    # Find the list of declared currencies, and from it build a mapping for
    # tickers for each (base, quote) pair. This is the only place tickers
    # appear.
    declared_triples = find_currencies_declared(entries, date)
    currency_map = {(base, quote): psources
                    for base, quote, psources in declared_triples}

    # Compute the initial list of currencies to consider.
    if undeclared_source:
        # Use the full set of possible currencies.
        cur_at_cost = find_currencies_at_cost(entries)
        cur_converted = find_currencies_converted(entries, date)
        cur_priced = find_currencies_priced(entries, date)
        currencies = cur_at_cost | cur_converted | cur_priced
        log_currency_list("Currency held at cost", cur_at_cost)
        log_currency_list("Currency converted", cur_converted)
        log_currency_list("Currency priced", cur_priced)
        default_source = import_source(undeclared_source)
    else:
        # Use the currencies from the Commodity directives.
        currencies = set(currency_map.keys())
        default_source = None

    log_currency_list("Currencies in primary list", currencies)

    # By default, restrict to only the currencies with non-zero balances at the
    # given date.
    if not inactive:
        balance_currencies = find_balance_currencies(entries, date)
        log_currency_list("Currencies held in assets", balance_currencies)
        currencies = currencies &amp; balance_currencies

    log_currency_list("Currencies to fetch", currencies)

    # Build up the list of jobs to fetch prices for.
    jobs = []
    for base_quote in currencies:
        psources = currency_map.get(base_quote, None)
        base, quote = base_quote

        # If there are no sources, create a default one.
        if not psources:
            psources = [PriceSource(default_source, base, False)]

        jobs.append(DatedPrice(base, quote, date, psources))
    return sorted(jobs)
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.import_source">
<code class="highlight language-python">
import_source
(module_name)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices.import_source" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Import the source module defined by the given name.</p>
<p>The default location is handled here.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>short_module_name</code></td>
<td><code></code></td>
<td>
<p>A string, the name of a Python module, which may
be within the default package or a full name.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A corresponding Python module object.</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ImportError</code></td>
<td>
<p>If the module cannot be imported.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def import_source(module_name):
    """Import the source module defined by the given name.

    The default location is handled here.

    Args:
      short_module_name: A string, the name of a Python module, which may
        be within the default package or a full name.
    Returns:
      A corresponding Python module object.
    Raises:
      ImportError: If the module cannot be imported.
    """
    default_name = '{}.{}'.format(DEFAULT_PACKAGE, module_name)
    try:
        __import__(default_name)
        return sys.modules[default_name]
    except ImportError:
        try:
            __import__(module_name)
            return sys.modules[module_name]
        except ImportError as exc:
            raise ImportError('Could not find price source module "{}": {}'.format(
                module_name, exc))
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.log_currency_list">
<code class="highlight language-python">
log_currency_list
(message, currencies)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices.log_currency_list" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Log a list of currencies to debug output.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>message</code></td>
<td><code></code></td>
<td>
<p>A message string to prepend.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>currencies</code></td>
<td><code></code></td>
<td>
<p>A list of (base, quote) currency pair.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def log_currency_list(message, currencies):
    """Log a list of currencies to debug output.

    Args:
      message: A message string to prepend.
      currencies: A list of (base, quote) currency pair.
    """
    logging.debug("-------- {}:".format(message))
    for base, quote in currencies:
        logging.debug("  {:&gt;32}".format('{} /{}'.format(base, quote)))
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.parse_single_source">
<code class="highlight language-python">
parse_single_source
(source)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices.parse_single_source" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Parse a single source string.</p>
<p>Source specifications follow the syntax:</p>
<p>&lt;module&gt;/[^]&lt;ticker&gt;</p>
<p>The &lt;module&gt; is resolved against the Python path, but first looked up
under the package where the default price extractors lie.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>source</code></td>
<td><code></code></td>
<td>
<p>A single source string specification.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A PriceSource tuple, or</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ValueError</code></td>
<td>
<p>If invalid.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def parse_single_source(source):
    """Parse a single source string.

    Source specifications follow the syntax:

      &lt;module&gt;/[^]&lt;ticker&gt;

    The &lt;module&gt; is resolved against the Python path, but first looked up
    under the package where the default price extractors lie.

    Args:
      source: A single source string specification.
    Returns:
      A PriceSource tuple, or
    Raises:
      ValueError: If invalid.
    """
    match = re.match(r'([a-zA-Z]+[a-zA-Z0-9\._]+)/(\^?)([a-zA-Z0-9:=_\-\.]+)$', source)
    if not match:
        raise ValueError('Invalid source name: "{}"'.format(source))
    short_module_name, invert, symbol = match.groups()
    module = import_source(short_module_name)
    return PriceSource(module, symbol, bool(invert))
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.find_prices.parse_source_map">
<code class="highlight language-python">
parse_source_map
(source_map_spec)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices.parse_source_map" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Parse a source map specification string.</p>
<p>Source map specifications allow the specification of multiple sources for
multiple quote currencies and follow the following syntax:</p>
<p>&lt;currency1&gt;:&lt;source1&gt;,&lt;source2&gt;,... &lt;currency2&gt;:&lt;source1&gt;,...</p>
<p>Where a &lt;source&gt; itself follows:</p>
<p>&lt;module&gt;/[^]&lt;ticker&gt;</p>
<p>The &lt;module&gt; is resolved against the Python path, but first looked up under
the package where the default price extractors lie. The presence of a '^'
character indicates that we should use the inverse of the rate pull from
this source.</p>
<p>For example, for prices of AAPL in USD:</p>
<p>USD:google/NASDAQ:AAPL,yahoo/AAPL</p>
<p>Or for the exchange rate of a currency, such as INR in USD or in CAD:</p>
<p>USD:google/^CURRENCY:USDINR CAD:google/^CURRENCY:CADINR</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>source_map_spec</code></td>
<td><code></code></td>
<td>
<p>A string, a full source map specification to be parsed.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FIXME</code></td>
<td>
<p>TODO</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ValueError</code></td>
<td>
<p>If an invalid pattern has been specified.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def parse_source_map(source_map_spec):
    """Parse a source map specification string.

    Source map specifications allow the specification of multiple sources for
    multiple quote currencies and follow the following syntax:

       &lt;currency1&gt;:&lt;source1&gt;,&lt;source2&gt;,... &lt;currency2&gt;:&lt;source1&gt;,...

    Where a &lt;source&gt; itself follows:

       &lt;module&gt;/[^]&lt;ticker&gt;

    The &lt;module&gt; is resolved against the Python path, but first looked up under
    the package where the default price extractors lie. The presence of a '^'
    character indicates that we should use the inverse of the rate pull from
    this source.

    For example, for prices of AAPL in USD:

       USD:google/NASDAQ:AAPL,yahoo/AAPL

    Or for the exchange rate of a currency, such as INR in USD or in CAD:

       USD:google/^CURRENCY:USDINR CAD:google/^CURRENCY:CADINR

    Args:
      source_map_spec: A string, a full source map specification to be parsed.
    Returns:
      FIXME: TODO
    Raises:
      ValueError: If an invalid pattern has been specified.
    """
    source_map = collections.defaultdict(list)
    for source_list_spec in re.split('[ ;]', source_map_spec):
        match = re.match('({}):(.*)$'.format(amount.CURRENCY_RE),
                         source_list_spec)
        if not match:
            raise ValueError('Invalid source map pattern: "{}"'.format(source_list_spec))

        currency, source_strs = match.groups()
        source_map[currency].extend(
            parse_single_source(source_str)
            for source_str in source_strs.split(','))
    return source_map
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.prices.find_prices_test">
<code>find_prices_test</code>
<a class="headerlink" href="#beancount.prices.find_prices_test" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Tests for price finding routines.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.find_prices_test.TestFilters">
<code>TestFilters</code>
<a class="headerlink" href="#beancount.prices.find_prices_test.TestFilters" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices_test.TestFilters.test_get_price_jobs__date">
<code class="highlight language-python">
test_get_price_jobs__date
(self, entries, _, __)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices_test.TestFilters.test_get_price_jobs__date" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>2000-01-10 open Assets:US:Invest:QQQ
2000-01-10 open Assets:US:Invest:VEA
2000-01-10 open Assets:US:Invest:Margin</p>
<p>2014-01-01 commodity QQQ
  price: "USD:yahoo/NASDAQ:QQQ"</p>
<p>2014-01-01 commodity VEA
  price: "USD:yahoo/NASDAQ:VEA"</p>
<p>2014-02-06 *
  Assets:US:Invest:QQQ             100 QQQ {86.23 USD}
  Assets:US:Invest:VEA             200 VEA {43.22 USD}
  Assets:US:Invest:Margin</p>
<p>2014-08-07 *
  Assets:US:Invest:QQQ            -100 QQQ {86.23 USD} @ 91.23 USD
  Assets:US:Invest:Margin</p>
<p>2015-01-15 *
  Assets:US:Invest:QQQ              10 QQQ {92.32 USD}
  Assets:US:Invest:VEA            -200 VEA {43.22 USD} @ 41.01 USD
  Assets:US:Invest:Margin</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices_test.py</code></summary>
<pre class="highlight"><code class="language-python linenums">@loader.load_doc()
def test_get_price_jobs__date(self, entries, _, __):
    """
    2000-01-10 open Assets:US:Invest:QQQ
    2000-01-10 open Assets:US:Invest:VEA
    2000-01-10 open Assets:US:Invest:Margin

    2014-01-01 commodity QQQ
      price: "USD:yahoo/NASDAQ:QQQ"

    2014-01-01 commodity VEA
      price: "USD:yahoo/NASDAQ:VEA"

    2014-02-06 *
      Assets:US:Invest:QQQ             100 QQQ {86.23 USD}
      Assets:US:Invest:VEA             200 VEA {43.22 USD}
      Assets:US:Invest:Margin

    2014-08-07 *
      Assets:US:Invest:QQQ            -100 QQQ {86.23 USD} @ 91.23 USD
      Assets:US:Invest:Margin

    2015-01-15 *
      Assets:US:Invest:QQQ              10 QQQ {92.32 USD}
      Assets:US:Invest:VEA            -200 VEA {43.22 USD} @ 41.01 USD
      Assets:US:Invest:Margin
    """
    jobs = find_prices.get_price_jobs_at_date(entries, datetime.date(2014, 1, 1),
                                              False, None)
    self.assertEqual(set(), {(job.base, job.quote) for job in jobs})

    jobs = find_prices.get_price_jobs_at_date(entries, datetime.date(2014, 6, 1),
                                              False, None)
    self.assertEqual({('QQQ', 'USD'), ('VEA', 'USD')},
                     {(job.base, job.quote) for job in jobs})

    jobs = find_prices.get_price_jobs_at_date(entries, datetime.date(2014, 10, 1),
                                              False, None)
    self.assertEqual({('VEA', 'USD')},
                     {(job.base, job.quote) for job in jobs})

    jobs = find_prices.get_price_jobs_at_date(entries, None, False, None)
    self.assertEqual({('QQQ', 'USD')}, {(job.base, job.quote) for job in jobs})
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices_test.TestFilters.test_get_price_jobs__default_source">
<code class="highlight language-python">
test_get_price_jobs__default_source
(self, entries, _, __)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices_test.TestFilters.test_get_price_jobs__default_source" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>2000-01-10 open Assets:US:Invest:QQQ
2000-01-10 open Assets:US:Invest:Margin</p>
<p>2014-01-01 commodity QQQ
  price: "NASDAQ:QQQ"</p>
<p>2014-02-06 *
  Assets:US:Invest:QQQ             100 QQQ {86.23 USD}
  Assets:US:Invest:Margin</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices_test.py</code></summary>
<pre class="highlight"><code class="language-python linenums">@loader.load_doc()
def test_get_price_jobs__default_source(self, entries, _, __):
    """
    2000-01-10 open Assets:US:Invest:QQQ
    2000-01-10 open Assets:US:Invest:Margin

    2014-01-01 commodity QQQ
      price: "NASDAQ:QQQ"

    2014-02-06 *
      Assets:US:Invest:QQQ             100 QQQ {86.23 USD}
      Assets:US:Invest:Margin
    """
    jobs = find_prices.get_price_jobs_at_date(entries, None, False, 'yahoo')
    self.assertEqual(1, len(jobs[0].sources))
    self.assertIsInstance(jobs[0].sources[0], find_prices.PriceSource)
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices_test.TestFilters.test_get_price_jobs__inactive">
<code class="highlight language-python">
test_get_price_jobs__inactive
(self, entries, _, __)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices_test.TestFilters.test_get_price_jobs__inactive" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>2000-01-10 open Assets:US:Invest:QQQ
2000-01-10 open Assets:US:Invest:VEA
2000-01-10 open Assets:US:Invest:Margin</p>
<p>2014-01-01 commodity QQQ
  price: "USD:yahoo/NASDAQ:QQQ"</p>
<p>2014-01-01 commodity VEA
  price: "USD:yahoo/NASDAQ:VEA"</p>
<p>2014-02-06 *
  Assets:US:Invest:QQQ             100 QQQ {86.23 USD}
  Assets:US:Invest:VEA             200 VEA {43.22 USD}
  Assets:US:Invest:Margin</p>
<p>2014-08-07 *
  Assets:US:Invest:QQQ            -100 QQQ {86.23 USD} @ 91.23 USD
  Assets:US:Invest:Margin</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices_test.py</code></summary>
<pre class="highlight"><code class="language-python linenums">@loader.load_doc()
def test_get_price_jobs__inactive(self, entries, _, __):
    """
    2000-01-10 open Assets:US:Invest:QQQ
    2000-01-10 open Assets:US:Invest:VEA
    2000-01-10 open Assets:US:Invest:Margin

    2014-01-01 commodity QQQ
      price: "USD:yahoo/NASDAQ:QQQ"

    2014-01-01 commodity VEA
      price: "USD:yahoo/NASDAQ:VEA"

    2014-02-06 *
      Assets:US:Invest:QQQ             100 QQQ {86.23 USD}
      Assets:US:Invest:VEA             200 VEA {43.22 USD}
      Assets:US:Invest:Margin

    2014-08-07 *
      Assets:US:Invest:QQQ            -100 QQQ {86.23 USD} @ 91.23 USD
      Assets:US:Invest:Margin
    """
    jobs = find_prices.get_price_jobs_at_date(entries, None, False, None)
    self.assertEqual({('VEA', 'USD')}, {(job.base, job.quote) for job in jobs})

    jobs = find_prices.get_price_jobs_at_date(entries, None, True, None)
    self.assertEqual({('VEA', 'USD'), ('QQQ', 'USD')},
                     {(job.base, job.quote) for job in jobs})
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices_test.TestFilters.test_get_price_jobs__undeclared">
<code class="highlight language-python">
test_get_price_jobs__undeclared
(self, entries, _, __)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices_test.TestFilters.test_get_price_jobs__undeclared" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>2000-01-10 open Assets:US:Invest:QQQ
2000-01-10 open Assets:US:Invest:VEA
2000-01-10 open Assets:US:Invest:Margin</p>
<p>2014-01-01 commodity QQQ
  price: "USD:yahoo/NASDAQ:QQQ"</p>
<p>2014-02-06 *
  Assets:US:Invest:QQQ             100 QQQ {86.23 USD}
  Assets:US:Invest:VEA             200 VEA {43.22 USD}
  Assets:US:Invest:Margin</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices_test.py</code></summary>
<pre class="highlight"><code class="language-python linenums">@loader.load_doc()
def test_get_price_jobs__undeclared(self, entries, _, __):
    """
    2000-01-10 open Assets:US:Invest:QQQ
    2000-01-10 open Assets:US:Invest:VEA
    2000-01-10 open Assets:US:Invest:Margin

    2014-01-01 commodity QQQ
      price: "USD:yahoo/NASDAQ:QQQ"

    2014-02-06 *
      Assets:US:Invest:QQQ             100 QQQ {86.23 USD}
      Assets:US:Invest:VEA             200 VEA {43.22 USD}
      Assets:US:Invest:Margin
    """
    jobs = find_prices.get_price_jobs_at_date(entries, None, False, None)
    self.assertEqual({('QQQ', 'USD')}, {(job.base, job.quote) for job in jobs})

    jobs = find_prices.get_price_jobs_at_date(entries, None, False, 'yahoo')
    self.assertEqual({('QQQ', 'USD'), ('VEA', 'USD')},
                     {(job.base, job.quote) for job in jobs})
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.find_prices_test.TestFromFile">
<code>TestFromFile</code>
<a class="headerlink" href="#beancount.prices.find_prices_test.TestFromFile" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.find_prices_test.TestFromFile.setUp">
<code class="highlight language-python">
setUp
(self, entries, _, __)

        </code>
<a class="headerlink" href="#beancount.prices.find_prices_test.TestFromFile.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>2000-01-10 open Assets:US:Investments:QQQ
2000-01-10 open Assets:CA:Investments:XSP
2000-01-10 open Assets:Cash
2000-01-10 open Assets:External
2000-01-10 open Expenses:Foreign</p>
<p>2010-01-01 commodity USD</p>
<p>2010-01-01 commodity QQQ
  name: "PowerShares QQQ Trust, Series 1 (ETF)"
  price: "USD:yahoo/NASDAQ:QQQ"</p>
<p>2010-01-01 commodity XSP
  name: "iShares S&amp;P 500 Index Fund (CAD Hedged)"
  quote: CAD</p>
<p>2010-01-01 commodity AMTKPTS
  quote: USD
  price: ""</p>
<p>2015-02-06 *
  Assets:Cash                     1505.00 USD
  Assets:External                -1000.00 GBP @ 1.5050 USD</p>
<p>2015-02-08 price GBP  1.5050 USD
2015-02-08 price GBP  1.8301 CAD</p>
<p>2015-04-13 *
  Assets:US:Investments:QQQ             3 QQQ {107.48 USD}
  Assets:Cash</p>
<p>2015-05-22 *
  Assets:Cash                     1000.00 USD @ 1.2283 CAD
  Assets:External                -1228.30 CAD</p>
<p>2015-09-04 *
  Assets:US:Investments:QQQ             2 QQQ {101.16 USD}
  Assets:Cash</p>
<p>2015-11-07 *
  Assets:CA:Investments:XSP             2 XSP {24.28 CAD}
  Assets:Cash</p>
<p>2015-12-02 *
  Assets:CA:Investments:XSP            -2 XSP {24.28 CAD} @ 27.00 CAD
  Assets:Cash</p>
<p>2015-12-03 price XSP   27.32 USD</p>
<p>;; Because neither of these currencies remain, they should not be there.
2015-06-22 *
  Assets:Cash                         1000.00 EUR @ 140.004 JPY
  Expenses:Foreign                    -140004 JPY</p>
<p>2015-10-13 *
  Assets:Cash                        -1000.00 EUR @ 140.004 JPY
  Expenses:Foreign                     140004 JPY</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/find_prices_test.py</code></summary>
<pre class="highlight"><code class="language-python linenums">@loader.load_doc()
def setUp(self, entries, _, __):
    """
    2000-01-10 open Assets:US:Investments:QQQ
    2000-01-10 open Assets:CA:Investments:XSP
    2000-01-10 open Assets:Cash
    2000-01-10 open Assets:External
    2000-01-10 open Expenses:Foreign

    2010-01-01 commodity USD

    2010-01-01 commodity QQQ
      name: "PowerShares QQQ Trust, Series 1 (ETF)"
      price: "USD:yahoo/NASDAQ:QQQ"

    2010-01-01 commodity XSP
      name: "iShares S&amp;P 500 Index Fund (CAD Hedged)"
      quote: CAD

    2010-01-01 commodity AMTKPTS
      quote: USD
      price: ""

    2015-02-06 *
      Assets:Cash                     1505.00 USD
      Assets:External                -1000.00 GBP @ 1.5050 USD

    2015-02-08 price GBP  1.5050 USD
    2015-02-08 price GBP  1.8301 CAD

    2015-04-13 *
      Assets:US:Investments:QQQ             3 QQQ {107.48 USD}
      Assets:Cash

    2015-05-22 *
      Assets:Cash                     1000.00 USD @ 1.2283 CAD
      Assets:External                -1228.30 CAD

    2015-09-04 *
      Assets:US:Investments:QQQ             2 QQQ {101.16 USD}
      Assets:Cash

    2015-11-07 *
      Assets:CA:Investments:XSP             2 XSP {24.28 CAD}
      Assets:Cash

    2015-12-02 *
      Assets:CA:Investments:XSP            -2 XSP {24.28 CAD} @ 27.00 CAD
      Assets:Cash

    2015-12-03 price XSP   27.32 USD

    ;; Because neither of these currencies remain, they should not be there.
    2015-06-22 *
      Assets:Cash                         1000.00 EUR @ 140.004 JPY
      Expenses:Foreign                    -140004 JPY

    2015-10-13 *
      Assets:Cash                        -1000.00 EUR @ 140.004 JPY
      Expenses:Foreign                     140004 JPY
    """
    self.entries = entries
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.prices.price">
<code>price</code>
<a class="headerlink" href="#beancount.prices.price" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Driver code for the price script.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.fetch_cached_price">
<code class="highlight language-python">
fetch_cached_price
(source, symbol, date)

        </code>
<a class="headerlink" href="#beancount.prices.price.fetch_cached_price" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Call Source to fetch a price, but look and/or update the cache first.</p>
<p>This function entirely deals with caching and correct expiration. It keeps
old prices if they were fetched in the past, and it quickly expires
intra-day prices if they are fetched on the same day.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>source</code></td>
<td><code></code></td>
<td>
<p>A Python module object.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>symbol</code></td>
<td><code></code></td>
<td>
<p>A string, the ticker to fetch.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance, None if we're to fetch the latest date.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A SourcePrice instance.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def fetch_cached_price(source, symbol, date):
    """Call Source to fetch a price, but look and/or update the cache first.

    This function entirely deals with caching and correct expiration. It keeps
    old prices if they were fetched in the past, and it quickly expires
    intra-day prices if they are fetched on the same day.

    Args:
      source: A Python module object.
      symbol: A string, the ticker to fetch.
      date: A datetime.date instance, None if we're to fetch the latest date.
    Returns:
      A SourcePrice instance.
    """
    # Compute a suitable timestamp from the date, if specified.
    if date is not None:
        # We query as for 4pm for the given date of the current timezone, if
        # specified.
        query_time = datetime.time(16, 0, 0)
        time_local = datetime.datetime.combine(date, query_time, tzinfo=tz.tzlocal())
        time = time_local.astimezone(tz.tzutc())
    else:
        time = None

    if _CACHE is None:
        # The cache is disabled; just call and return.
        result = (source.get_latest_price(symbol)
                  if time is None else
                  source.get_historical_price(symbol, time))

    else:
        # The cache is enabled and we have to compute the current/latest price.
        # Try to fetch from the cache but miss if the price is too old.
        md5 = hashlib.md5()
        md5.update(str((type(source).__module__, symbol, date)).encode('utf-8'))
        key = md5.hexdigest()
        timestamp_now = int(now().timestamp())
        try:
            timestamp_created, result_naive = _CACHE[key]

            # Convert naive timezone to UTC, which is what the cache is always
            # assumed to store. (The reason for this is that timezones from
            # aware datetime objects cannot be serialized properly due to bug.)
            if result_naive.time is not None:
                result = result_naive._replace(
                    time=result_naive.time.replace(tzinfo=tz.tzutc()))
            else:
                result = result_naive

            if (timestamp_now - timestamp_created) &gt; _CACHE.expiration.total_seconds():
                raise KeyError
        except KeyError:
            logging.info("Fetching: %s (time: %s)", symbol, time)
            try:
                result = (source.get_latest_price(symbol)
                          if time is None else
                          source.get_historical_price(symbol, time))
            except ValueError as exc:
                logging.error("Error fetching %s: %s", symbol, exc)
                result = None

            # Make sure the timezone is UTC and make naive before serialization.
            if result and result.time is not None:
                time_utc = result.time.astimezone(tz.tzutc())
                time_naive = time_utc.replace(tzinfo=None)
                result_naive = result._replace(time=time_naive)
            else:
                result_naive = result

            if result_naive is not None:
                _CACHE[key] = (timestamp_now, result_naive)
    return result
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.fetch_price">
<code class="highlight language-python">
fetch_price
(dprice, swap_inverted=False)

        </code>
<a class="headerlink" href="#beancount.prices.price.fetch_price" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Fetch a price for the DatedPrice job.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dprice</code></td>
<td><code></code></td>
<td>
<p>A DatedPrice instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>swap_inverted</code></td>
<td><code></code></td>
<td>
<p>A boolean, true if we should invert currencies instead of
rate for an inverted price source.</p>
</td>
<td><code>False</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A Price entry corresponding to the output of the jobs processed.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def fetch_price(dprice, swap_inverted=False):
    """Fetch a price for the DatedPrice job.

    Args:
      dprice: A DatedPrice instances.
      swap_inverted: A boolean, true if we should invert currencies instead of
        rate for an inverted price source.
    Returns:
      A Price entry corresponding to the output of the jobs processed.

    """
    for psource in dprice.sources:
        try:
            source = psource.module.Source()
        except AttributeError:
            continue
        srcprice = fetch_cached_price(source, psource.symbol, dprice.date)
        if srcprice is not None:
            break
    else:
        if dprice.sources:
            logging.error("Could not fetch for job: %s", dprice)
        return None

    base = dprice.base
    quote = dprice.quote or srcprice.quote_currency
    price = srcprice.price

    # Invert the rate if requested.
    if psource.invert:
        if swap_inverted:
            base, quote = quote, base
        else:
            price = ONE/price

    assert base is not None
    fileloc = data.new_metadata('&lt;{}&gt;'.format(type(psource.module).__name__), 0)

    # The datetime instance is required to be aware. We always convert to the
    # user's timezone before extracting the date. This means that if the market
    # returns a timestamp for a particular date, once we convert to the user's
    # timezone the returned date may be different by a day. The intent is that
    # whatever we print is assumed coherent with the user's timezone. See
    # discussion at
    # https://groups.google.com/d/msg/beancount/9j1E_HLEMBQ/fYRuCQK_BwAJ
    srctime = srcprice.time
    if srctime.tzinfo is None:
        raise ValueError("Time returned by the price source is not timezone aware.")
    date = srctime.astimezone(tz.tzlocal()).date()

    return data.Price(fileloc, date, base,
                      amount.Amount(price, quote or UNKNOWN_CURRENCY))
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.filter_redundant_prices">
<code class="highlight language-python">
filter_redundant_prices
(price_entries, existing_entries, diffs=False)

        </code>
<a class="headerlink" href="#beancount.prices.price.filter_redundant_prices" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Filter out new entries that are redundant from an existing set.</p>
<p>If the price differs, we override it with the new entry only on demand. This
is because this would create conflict with existing price entries when
parsing, if the new entries are simply inserted into the input.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>price_entries</code></td>
<td><code></code></td>
<td>
<p>A list of newly created, proposed to be added Price directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>existing_entries</code></td>
<td><code></code></td>
<td>
<p>A list of existing entries we are proposing to add to.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>diffs</code></td>
<td><code></code></td>
<td>
<p>A boolean, true if we should output differing price entries
at the same date.</p>
</td>
<td><code>False</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A filtered list of remaining entries, and a list of ignored entries.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def filter_redundant_prices(price_entries, existing_entries, diffs=False):
    """Filter out new entries that are redundant from an existing set.

    If the price differs, we override it with the new entry only on demand. This
    is because this would create conflict with existing price entries when
    parsing, if the new entries are simply inserted into the input.

    Args:
      price_entries: A list of newly created, proposed to be added Price directives.
      existing_entries: A list of existing entries we are proposing to add to.
      diffs: A boolean, true if we should output differing price entries
        at the same date.
    Returns:
      A filtered list of remaining entries, and a list of ignored entries.
    """
    # Note: We have to be careful with the dates, because requesting the latest
    # price for a date may yield the price at a previous date. Clobber needs to
    # take this into account. See {1cfa25e37fc1}.
    existing_prices = {(entry.date, entry.currency): entry
                       for entry in existing_entries
                       if isinstance(entry, data.Price)}
    filtered_prices = []
    ignored_prices = []
    for entry in price_entries:
        key = (entry.date, entry.currency)
        if key in existing_prices:
            if diffs:
                existing_entry = existing_prices[key]
                if existing_entry.amount == entry.amount:
                    output = ignored_prices
            else:
                output = ignored_prices
        else:
            output = filtered_prices
        output.append(entry)
    return filtered_prices, ignored_prices
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.now">
<code class="highlight language-python">
now
()

        </code>
<a class="headerlink" href="#beancount.prices.price.now" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Indirection in order to be able to mock it out in the tests.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def now():
    "Indirection in order to be able to mock it out in the tests."
    return datetime.datetime.now(datetime.timezone.utc)
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.process_args">
<code class="highlight language-python">
process_args
()

        </code>
<a class="headerlink" href="#beancount.prices.price.process_args" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Process the arguments. This also initializes the logging module.</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>A tuple of</code></td>
<td>
<p>args: The argparse receiver of command-line arguments.
  jobs: A list of DatedPrice job objects.
  entries: A list of all the parsed entries.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def process_args():
    """Process the arguments. This also initializes the logging module.

    Returns:
      A tuple of:
        args: The argparse receiver of command-line arguments.
        jobs: A list of DatedPrice job objects.
        entries: A list of all the parsed entries.
    """
    parser = version.ArgumentParser(description=beancount.prices.__doc__.splitlines()[0])

    # Input sources or filenames.
    parser.add_argument('sources', nargs='+', help=(
        'A list of filenames (or source "module/symbol", if -e is '
        'specified) from which to create a list of jobs.'))

    parser.add_argument('-e', '--expressions', '--expression', action='store_true', help=(
        'Interpret the arguments as "module/symbol" source strings.'))

    # Regular options.
    parser.add_argument('-v', '--verbose', action='count', help=(
        "Print out progress log. Specify twice for debugging info."))

    parser.add_argument('-d', '--date', action='store',
                        type=date_utils.parse_date_liberally, help=(
        "Specify the date for which to fetch the prices."))

    parser.add_argument('-i', '--inactive', action='store_true', help=(
        "Select all commodities from input files, not just the ones active on the date"))

    parser.add_argument('-u', '--undeclared', action='store', help=(
        "Include commodities viewed in the file even without a "
        "corresponding Commodity directive, from this default source. "
        "The currency name itself is used as the lookup symbol in this default source."))

    parser.add_argument('-c', '--clobber', action='store_true', help=(
        "Do not skip prices which are already present in input files; fetch them anyway."))

    parser.add_argument('-a', '--all', action='store_true', help=(
        "A shorthand for --inactive, --undeclared, --clobber."))

    parser.add_argument('-s', '--swap-inverted', action='store_true', help=(
        "For inverted sources, swap currencies instead of inverting the rate. "
        "For example, if fetching the rate for CAD from 'USD:google/^CURRENCY:USDCAD' "
        "results in 1.25, by default we would output \"price CAD  0.8000 USD\". "
        "Using this option we would instead output \" price USD   1.2500 CAD\"."))

    parser.add_argument('-n', '--dry-run', action='store_true', help=(
        "Don't actually fetch the prices, just print the list of the ones to be fetched."))

    # Caching options.
    cache_group = parser.add_argument_group('cache')
    cache_filename = path.join(tempfile.gettempdir(),
                               "{}.cache".format(path.basename(sys.argv[0])))
    cache_group.add_argument('--cache', dest='cache_filename',
                             action='store', default=cache_filename,
                             help="Enable the cache and with the given cache name.")
    cache_group.add_argument('--no-cache', dest='cache_filename',
                             action='store_const', const=None,
                             help="Disable the price cache.")

    cache_group.add_argument('--clear-cache', action='store_true',
                             help="Clear the cache prior to startup")

    args = parser.parse_args()

    verbose_levels = {None: logging.WARN,
                      0: logging.WARN,
                      1: logging.INFO,
                      2: logging.DEBUG}
    logging.basicConfig(level=verbose_levels[args.verbose],
                        format='%(levelname)-8s: %(message)s')

    if args.all:
        args.inactive = args.clobber = True
        args.undeclared = DEFAULT_SOURCE

    # Setup for processing.
    setup_cache(args.cache_filename, args.clear_cache)

    # Get the list of DatedPrice jobs to get from the arguments.
    logging.info("Processing at date: %s", args.date or datetime.date.today())
    jobs = []
    all_entries = []
    dcontext = None
    if args.expressions:
        # Interpret the arguments as price sources.
        for source_str in args.sources:
            psources = []
            try:
                psource_map = find_prices.parse_source_map(source_str)
            except ValueError:
                extra = "; did you provide a filename?" if path.exists(source_str) else ''
                msg = ('Invalid source "{{}}"{}. '.format(extra) +
                       'Supported format is "CCY:module/SYMBOL"')
                parser.error(msg.format(source_str))
            else:
                for currency, psources in psource_map.items():
                    jobs.append(find_prices.DatedPrice(
                        psources[0].symbol, currency, args.date, psources))
    else:
        # Interpret the arguments as Beancount input filenames.
        for filename in args.sources:
            if not path.exists(filename) or not path.isfile(filename):
                parser.error('File does not exist: "{}"; '
                             'did you mean to use -e?'.format(filename))
                continue
            logging.info('Loading "%s"', filename)
            entries, errors, options_map = loader.load_file(filename, log_errors=sys.stderr)
            if dcontext is None:
                dcontext = options_map['dcontext']
            jobs.extend(
                find_prices.get_price_jobs_at_date(
                    entries, args.date, args.inactive, args.undeclared))
            all_entries.extend(entries)

    return args, jobs, data.sorted(all_entries), dcontext
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.reset_cache">
<code class="highlight language-python">
reset_cache
()

        </code>
<a class="headerlink" href="#beancount.prices.price.reset_cache" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Reset the cache to its uninitialized state.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def reset_cache():
    """Reset the cache to its uninitialized state."""
    global _CACHE
    if _CACHE is not None:
        _CACHE.close()
    _CACHE = None
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.prices.price.setup_cache">
<code class="highlight language-python">
setup_cache
(cache_filename, clear_cache)

        </code>
<a class="headerlink" href="#beancount.prices.price.setup_cache" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Setup the results cache.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cache_filename</code></td>
<td><code></code></td>
<td>
<p>A string or None, the filename for the cache.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>clear_cache</code></td>
<td><code></code></td>
<td>
<p>A boolean, if true, delete the cache before beginning.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/price.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def setup_cache(cache_filename, clear_cache):
    """Setup the results cache.

    Args:
      cache_filename: A string or None, the filename for the cache.
      clear_cache: A boolean, if true, delete the cache before beginning.
    """
    if clear_cache and cache_filename and path.exists(cache_filename):
        logging.info("Clearing cache %s", cache_filename)
        os.remove(cache_filename)

    if cache_filename:
        logging.info('Using price cache at "%s" (with indefinite expiration)',
                     cache_filename)

        global _CACHE
        _CACHE = shelve.open(cache_filename, 'c')
        _CACHE.expiration = DEFAULT_EXPIRATION
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.prices.price_test">
<code>price_test</code>
<a class="headerlink" href="#beancount.prices.price_test" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Tests for main driver for price fetching.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.price_test.TestClobber">
<code>TestClobber</code>
<a class="headerlink" href="#beancount.prices.price_test.TestClobber" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.price_test.TestClobber.setUp">
<code class="highlight language-python">
setUp
(self, entries, _, __)

        </code>
<a class="headerlink" href="#beancount.prices.price_test.TestClobber.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>;; Existing file.
2015-01-05 price HDV                                 75.56 USD
2015-01-23 price HDV                                 77.34 USD
2015-02-06 price HDV                                 77.16 USD
2015-02-12 price HDV                                 78.17 USD
2015-05-01 price HDV                                 77.48 USD
2015-06-02 price HDV                                 76.33 USD
2015-06-29 price HDV                                 73.74 USD
2015-07-06 price HDV                                 73.79 USD
2015-08-11 price HDV                                 74.19 USD
2015-09-04 price HDV                                 68.98 USD</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/price_test.py</code></summary>
<pre class="highlight"><code class="language-python linenums">@loader.load_doc()
def setUp(self, entries, _, __):
    """
      ;; Existing file.
      2015-01-05 price HDV                                 75.56 USD
      2015-01-23 price HDV                                 77.34 USD
      2015-02-06 price HDV                                 77.16 USD
      2015-02-12 price HDV                                 78.17 USD
      2015-05-01 price HDV                                 77.48 USD
      2015-06-02 price HDV                                 76.33 USD
      2015-06-29 price HDV                                 73.74 USD
      2015-07-06 price HDV                                 73.79 USD
      2015-08-11 price HDV                                 74.19 USD
      2015-09-04 price HDV                                 68.98 USD
    """
    self.entries = entries

    # New entries.
    self.price_entries, _, __ = loader.load_string("""
      2015-01-27 price HDV                                 76.83 USD
      2015-02-06 price HDV                                 77.16 USD
      2015-02-19 price HDV                                  77.5 USD
      2015-06-02 price HDV                                 76.33 USD
      2015-06-19 price HDV                                    76 USD
      2015-07-06 price HDV                                 73.79 USD
      2015-07-31 price HDV                                 74.64 USD
      2015-08-11 price HDV                                 74.20 USD ;; Different
    """, dedent=True)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.price_test.TestInverted">
<code>TestInverted</code>
<a class="headerlink" href="#beancount.prices.price_test.TestInverted" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.price_test.TestInverted.setUp">
<code class="highlight language-python">
setUp
(self)

        </code>
<a class="headerlink" href="#beancount.prices.price_test.TestInverted.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/price_test.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def setUp(self):
    fetch_cached = mock.patch('beancount.prices.price.fetch_cached_price').start()
    fetch_cached.return_value = SourcePrice(
        D('125.00'), datetime.datetime(2015, 11, 22, 16, 0, 0, tzinfo=tz.tzlocal()),
        'JPY')
    self.dprice = find_prices.DatedPrice('JPY', 'USD', datetime.date(2015, 11, 22),
                                         None)
    self.addCleanup(mock.patch.stopall)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.price_test.TestProcessArguments">
<code>TestProcessArguments</code>
<a class="headerlink" href="#beancount.prices.price_test.TestProcessArguments" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.price_test.TestProcessArguments.test_explicit_file__badcontents">
<code class="highlight language-python">
test_explicit_file__badcontents
(self, filename)

        </code>
<a class="headerlink" href="#beancount.prices.price_test.TestProcessArguments.test_explicit_file__badcontents" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>2015-01-01 open Assets:Invest
2015-01-01 open USD ;; Error</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/price_test.py</code></summary>
<pre class="highlight"><code class="language-python linenums">@test_utils.docfile
def test_explicit_file__badcontents(self, filename):
    """
    2015-01-01 open Assets:Invest
    2015-01-01 open USD ;; Error
    """
    with test_utils.capture('stderr'):
        args, jobs, _, __ = test_utils.run_with_args(
            price.process_args, ['--no-cache', filename])
        self.assertEqual([], jobs)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.prices.source">
<code>source</code>
<a class="headerlink" href="#beancount.prices.source" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Interface definition for all price sources.</p>
<p>This module describes the contract to be fulfilled by all implementations of
price sources.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.source.Source">
<code>Source</code>
<a class="headerlink" href="#beancount.prices.source.Source" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Interface to be implemented by all price sources.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.source.Source.get_historical_price">
<code class="highlight language-python">
get_historical_price
(self, ticker, time)

        </code>
<a class="headerlink" href="#beancount.prices.source.Source.get_historical_price" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return the historical price found for the symbol at the given date.</p>
<p>This could be the price of the close of the day, for instance. We assume
that there is some single price representative of the day.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ticker</code></td>
<td><code></code></td>
<td>
<p>A string, the ticker to be fetched by the source. This ticker
may include structure, such as the exchange code. Also note that
this ticker is source-specified, and is not necessarily the same
value as the commodity symbol used in the Beancount file.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>time</code></td>
<td><code></code></td>
<td>
<p>The timestamp at which to query for the price. This is a
timezone-aware timestamp you can convert to any timezone. For past
dates we query for a time that is equivalent to 4pm in the user's
timezone.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A SourcePrice instance. If the price could not be fetched, None is
returned and another source should be consulted. There is never any
guarantee that a price source will be able to fetch its value; client
code must be able to handle this. Also note that the price's returned
time must be timezone-aware.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/source.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def get_historical_price(self, ticker, time):
    """Return the historical price found for the symbol at the given date.

    This could be the price of the close of the day, for instance. We assume
    that there is some single price representative of the day.

    Args:
      ticker: A string, the ticker to be fetched by the source. This ticker
        may include structure, such as the exchange code. Also note that
        this ticker is source-specified, and is not necessarily the same
        value as the commodity symbol used in the Beancount file.
      time: The timestamp at which to query for the price. This is a
        timezone-aware timestamp you can convert to any timezone. For past
        dates we query for a time that is equivalent to 4pm in the user's
        timezone.
    Returns:
      A SourcePrice instance. If the price could not be fetched, None is
      returned and another source should be consulted. There is never any
      guarantee that a price source will be able to fetch its value; client
      code must be able to handle this. Also note that the price's returned
      time must be timezone-aware.
    """
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.source.Source.get_latest_price">
<code class="highlight language-python">
get_latest_price
(self, ticker)

        </code>
<a class="headerlink" href="#beancount.prices.source.Source.get_latest_price" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Fetch the current latest price. The date may differ.</p>
<p>This routine attempts to fetch the most recent available price, and
returns the actual date of the quoted price, which may differ from the
date this call is made at. {1cfa25e37fc1}</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ticker</code></td>
<td><code></code></td>
<td>
<p>A string, the ticker to be fetched by the source. This ticker
may include structure, such as the exchange code. Also note that
this ticker is source-specified, and is not necessarily the same
value as the commodity symbol used in the Beancount file.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A SourcePrice instance. If the price could not be fetched, None is
returned and another source should be consulted. There is never any
guarantee that a price source will be able to fetch its value; client
code must be able to handle this. Also note that the price's returned
time must be timezone-aware.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/source.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def get_latest_price(self, ticker):
    """Fetch the current latest price. The date may differ.

    This routine attempts to fetch the most recent available price, and
    returns the actual date of the quoted price, which may differ from the
    date this call is made at. {1cfa25e37fc1}

    Args:
      ticker: A string, the ticker to be fetched by the source. This ticker
        may include structure, such as the exchange code. Also note that
        this ticker is source-specified, and is not necessarily the same
        value as the commodity symbol used in the Beancount file.
    Returns:
      A SourcePrice instance. If the price could not be fetched, None is
      returned and another source should be consulted. There is never any
      guarantee that a price source will be able to fetch its value; client
      code must be able to handle this. Also note that the price's returned
      time must be timezone-aware.
    """
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.prices.source.SourcePrice">
<code>SourcePrice</code>
<a class="headerlink" href="#beancount.prices.source.SourcePrice" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>SourcePrice(price, time, quote_currency)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.source.SourcePrice.__getnewargs__">
<code class="highlight language-python">
__getnewargs__
(self)

        </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.source.SourcePrice.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/source.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def __getnewargs__(self):
    'Return self as a plain tuple.  Used by copy and pickle.'
    return _tuple(self)
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.source.SourcePrice.__new__">
<code class="highlight language-python">
__new__
(_cls, price, time, quote_currency)

        </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.prices.source.SourcePrice.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of SourcePrice(price, time, quote_currency)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.prices.source.SourcePrice.__repr__">
<code class="highlight language-python">
__repr__
(self)

        </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.source.SourcePrice.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/source.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def __repr__(self):
    'Return a nicely formatted representation string'
    return self.__class__.__name__ + repr_fmt % self
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.prices.sources">
<code>sources</code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.prices.sources" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Implementation of various price extractors.</p>
<p>This package is looked up by the driver script to figure out which extractor to
use.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.coinbase">
<code>coinbase</code>
<a class="headerlink" href="#beancount.prices.sources.coinbase" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>A source fetching cryptocurrency prices from Coinbase.</p>
<p>Valid tickers are in the form "XXX-YYY", such as "BTC-USD".</p>
<p>Here is the API documentation:
https://developers.coinbase.com/api/v2</p>
<p>For example:
https://api.coinbase.com/v2/prices/BTC-GBP/spot</p>
<p>Timezone information: Input and output datetimes are specified via UTC
timestamps.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.coinbase.CoinbaseError">
<code>CoinbaseError</code>
<a class="headerlink" href="#beancount.prices.sources.coinbase.CoinbaseError" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>An error from the Coinbase API.</p>
</div>
</div>
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.coinbase.Source">
<code>Source</code>
<a class="headerlink" href="#beancount.prices.sources.coinbase.Source" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Coinbase API price extractor.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.coinbase.Source.get_historical_price">
<code class="highlight language-python">
get_historical_price
(self, ticker, time)

        </code>
<a class="headerlink" href="#beancount.prices.sources.coinbase.Source.get_historical_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/coinbase.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def get_historical_price(self, ticker, time):
    """See contract in beancount.prices.source.Source."""
    raise NotImplementedError(
        "As of Feb 2019, historical prices are not supported on Coinbase. "
        "Please check the API to see if this has changed: "
        "https://developers.coinbase.com/apo/v2")
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.coinbase.Source.get_latest_price">
<code class="highlight language-python">
get_latest_price
(self, ticker)

        </code>
<a class="headerlink" href="#beancount.prices.sources.coinbase.Source.get_latest_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/coinbase.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def get_latest_price(self, ticker):
    """See contract in beancount.prices.source.Source."""
    return fetch_quote(ticker)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.coinbase.fetch_quote">
<code class="highlight language-python">
fetch_quote
(ticker)

        </code>
<a class="headerlink" href="#beancount.prices.sources.coinbase.fetch_quote" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Fetch a quote from Coinbase.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/coinbase.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def fetch_quote(ticker):
    """Fetch a quote from Coinbase."""
    url = "https://api.coinbase.com/v2/prices/{}/spot".format(ticker.lower())
    response = requests.get(url)
    if response.status_code != requests.codes.ok:
        raise CoinbaseError("Invalid response ({}): {}".format(response.status_code,
                                                               response.text))
    result = response.json()

    price = D(result['data']['amount']).quantize(D('0.01'))
    time = datetime.datetime.now(tz.tzutc())
    currency = result['data']['currency']

    return source.SourcePrice(price, time, currency)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.coinbase_test">
<code>coinbase_test</code>
<a class="headerlink" href="#beancount.prices.sources.coinbase_test" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.coinbase_test.response">
<code class="highlight language-python">
response
(contents, status_code=200)

        </code>
<a class="headerlink" href="#beancount.prices.sources.coinbase_test.response" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a context manager to patch a JSON response.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/coinbase_test.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def response(contents, status_code=requests.codes.ok):
    """Return a context manager to patch a JSON response."""
    response = mock.Mock()
    response.status_code = status_code
    response.text = ""
    response.json.return_value = contents
    return mock.patch('requests.get', return_value=response)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.iex">
<code>iex</code>
<a class="headerlink" href="#beancount.prices.sources.iex" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Fetch prices from the IEX 1.0 public API.</p>
<p>This is a really fantastic exchange API with a lot of relevant information.</p>
<p>Timezone information: There is currency no support for historical prices. The
output datetime is provided as a UNIX timestamp.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.iex.IEXError">
<code>IEXError</code>
<a class="headerlink" href="#beancount.prices.sources.iex.IEXError" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>An error from the IEX API.</p>
</div>
</div>
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.iex.Source">
<code>Source</code>
<a class="headerlink" href="#beancount.prices.sources.iex.Source" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>IEX API price extractor.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.iex.Source.get_historical_price">
<code class="highlight language-python">
get_historical_price
(self, ticker, time)

        </code>
<a class="headerlink" href="#beancount.prices.sources.iex.Source.get_historical_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/iex.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def get_historical_price(self, ticker, time):
    """See contract in beancount.prices.source.Source."""
    raise NotImplementedError(
        "This is now implemented at https://iextrading.com/developers/docs/#hist and "
        "needs to be added here.")
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.iex.Source.get_latest_price">
<code class="highlight language-python">
get_latest_price
(self, ticker)

        </code>
<a class="headerlink" href="#beancount.prices.sources.iex.Source.get_latest_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/iex.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def get_latest_price(self, ticker):
    """See contract in beancount.prices.source.Source."""
    return fetch_quote(ticker)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.iex.fetch_quote">
<code class="highlight language-python">
fetch_quote
(ticker)

        </code>
<a class="headerlink" href="#beancount.prices.sources.iex.fetch_quote" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Fetch the latest price for the given ticker.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/iex.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def fetch_quote(ticker):
    """Fetch the latest price for the given ticker."""

    url = "https://api.iextrading.com/1.0/tops/last?symbols={}".format(ticker.upper())
    response = requests.get(url)
    if response.status_code != requests.codes.ok:
        raise IEXError("Invalid response ({}): {}".format(
            response.status_code, response.text))

    results = response.json()
    if len(results) != 1:
        raise IEXError("Invalid number of responses from IEX: {}".format(
            response.text))
    result = results[0]

    price = D(result['price']).quantize(D('0.01'))

    # IEX is American markets.
    us_timezone = tz.gettz("America/New_York")
    time = datetime.datetime.fromtimestamp(result['time'] / 1000)
    time = time.astimezone(us_timezone)

    # As far as can tell, all the instruments on IEX are priced in USD.
    return source.SourcePrice(price, time, 'USD')
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.iex_test">
<code>iex_test</code>
<a class="headerlink" href="#beancount.prices.sources.iex_test" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.iex_test.response">
<code class="highlight language-python">
response
(contents, status_code=200)

        </code>
<a class="headerlink" href="#beancount.prices.sources.iex_test.response" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Produce a context manager to patch a JSON response.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/iex_test.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def response(contents, status_code=requests.codes.ok):
    """Produce a context manager to patch a JSON response."""
    response = mock.Mock()
    response.status_code = status_code
    response.text = ""
    response.json.return_value = contents
    return mock.patch('requests.get', return_value=response)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.oanda">
<code>oanda</code>
<a class="headerlink" href="#beancount.prices.sources.oanda" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>A source fetching currency prices from OANDA.</p>
<p>Valid tickers are in the form "XXX_YYY", such as "EUR_USD".</p>
<p>Here is the API documentation:
https://developer.oanda.com/rest-live/rates/</p>
<p>For example:
https://api-fxtrade.oanda.com/v1/candles?instrument=EUR_USD&amp;granularity=D&amp;start=2016-03-27T00%3A00%3A00Z&amp;end=2016-04-04T00%3A00%3A00Z&amp;candleFormat=midpoint</p>
<p>Timezone information: Input and output datetimes are specified via UTC
timestamps.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.oanda.Source">
<code>Source</code>
<a class="headerlink" href="#beancount.prices.sources.oanda.Source" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>OANDA price source extractor.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.oanda.Source.get_historical_price">
<code class="highlight language-python">
get_historical_price
(self, ticker, time)

        </code>
<a class="headerlink" href="#beancount.prices.sources.oanda.Source.get_historical_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/oanda.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def get_historical_price(self, ticker, time):
    """See contract in beancount.prices.source.Source."""
    time = time.astimezone(tz.tzutc())
    query_interval_begin = (time - datetime.timedelta(days=5))
    query_interval_end = (time + datetime.timedelta(days=1))
    params_dict = {
        'instrument': ticker,
        'granularity': 'H2',  # Every two hours.
        'candleFormat': 'midpoint',
        'start': query_interval_begin.isoformat('T'),
        'end': query_interval_end.isoformat('T'),
    }
    return _fetch_price(params_dict, time)
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.oanda.Source.get_latest_price">
<code class="highlight language-python">
get_latest_price
(self, ticker)

        </code>
<a class="headerlink" href="#beancount.prices.sources.oanda.Source.get_latest_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/oanda.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def get_latest_price(self, ticker):
    """See contract in beancount.prices.source.Source."""
    time = datetime.datetime.now(tz.tzutc())
    params_dict = {
        'instrument': ticker,
        'granularity': 'S5',  # Every two hours.
        'count': '10',
        'candleFormat': 'midpoint',
    }
    return _fetch_price(params_dict, time)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.oanda_test">
<code>oanda_test</code>
<a class="headerlink" href="#beancount.prices.sources.oanda_test" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Test for price extractor of OANDA.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.oanda_test.TestOandaGetHistorical">
<code>TestOandaGetHistorical</code>
<a class="headerlink" href="#beancount.prices.sources.oanda_test.TestOandaGetHistorical" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.oanda_test.TestOandaGetHistorical.setUp">
<code class="highlight language-python">
setUp
(self)

        </code>
<a class="headerlink" href="#beancount.prices.sources.oanda_test.TestOandaGetHistorical.setUp" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/oanda_test.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def setUp(self):
    self.fetcher = oanda.Source()
    super(TestOandaGetHistorical, self).setUp()
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.oanda_test.TestOandaGetLatest">
<code>TestOandaGetLatest</code>
<a class="headerlink" href="#beancount.prices.sources.oanda_test.TestOandaGetLatest" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.oanda_test.TestOandaGetLatest.setUp">
<code class="highlight language-python">
setUp
(self)

        </code>
<a class="headerlink" href="#beancount.prices.sources.oanda_test.TestOandaGetLatest.setUp" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/oanda_test.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def setUp(self):
    self.fetcher = oanda.Source()
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.quandl">
<code>quandl</code>
<a class="headerlink" href="#beancount.prices.sources.quandl" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Fetch prices from Quandl's simple URL-based API.</p>
<p>Quandl is a useful source of alternative data and it offers a simple REST API
that serves CSV and JSON and XML formats. There's also a Python client library,
but we specifically avoid using that here, in order to keep Beancount
dependency-free.</p>
<p>Many of the datasets are freely available, which is why this is included here.
You can get information about the available databases and associated lists of
symbols you can use here: https://www.quandl.com/search</p>
<p>If you have a paid account and would like to be able to access the premium
databases from the Quandl site, you can set QUANDL_API_KEY environment variable.</p>
<p>Use the "&lt;DATABASE_CODE&gt;:&lt;DATASET_CODE&gt;" format to refer to Quandl symbols.
Note that their symbols are usually identified by "&lt;DATABASE_CODE&gt;/&lt;DATASET_CODE&gt;".</p>
<p>(For now, this supports only the Time-Series API. There is also a Tables API,
which could easily get integrated. We would just have to encode the
'datatable_code' and 'format' and perhaps other fields in the ticker name.)</p>
<p>Timezone information: Input and output datetimes are limited to dates, and I
believe the dates are presumed to live in the timezone of each particular data
source. (It's unclear, not documented.)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.quandl.QuandlError">
<code>QuandlError</code>
<a class="headerlink" href="#beancount.prices.sources.quandl.QuandlError" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>An error from the Quandl API.</p>
</div>
</div>
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.quandl.Source">
<code>Source</code>
<a class="headerlink" href="#beancount.prices.sources.quandl.Source" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Quandl API price extractor.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.quandl.Source.get_historical_price">
<code class="highlight language-python">
get_historical_price
(self, ticker, time)

        </code>
<a class="headerlink" href="#beancount.prices.sources.quandl.Source.get_historical_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/quandl.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def get_historical_price(self, ticker, time):
    """See contract in beancount.prices.source.Source."""
    return fetch_time_series(ticker, time)
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.quandl.Source.get_latest_price">
<code class="highlight language-python">
get_latest_price
(self, ticker)

        </code>
<a class="headerlink" href="#beancount.prices.sources.quandl.Source.get_latest_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/quandl.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def get_latest_price(self, ticker):
    """See contract in beancount.prices.source.Source."""
    return fetch_time_series(ticker)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.quandl.fetch_time_series">
<code class="highlight language-python">
fetch_time_series
(ticker, time=None)

        </code>
<a class="headerlink" href="#beancount.prices.sources.quandl.fetch_time_series" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Fetch</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/quandl.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def fetch_time_series(ticker, time=None):
    """Fetch"""
    # Create request payload.
    database, dataset = parse_ticker(ticker)
    url = "https://www.quandl.com/api/v3/datasets/{}/{}.json".format(database, dataset)
    payload = {"limit": 1}
    if time is not None:
        date = time.date()
        payload["start_date"] = (date - datetime.timedelta(days=10)).isoformat()
        payload["end_date"] = date.isoformat()

    # Add API key, if it is set in the environment.
    if 'QUANDL_API_KEY' in os.environ:
        payload['api_key'] = os.environ['QUANDL_API_KEY']

    # Fetch and process errors.
    response = requests.get(url, params=payload)
    if response.status_code != requests.codes.ok:
        raise QuandlError("Invalid response ({}): {}".format(response.status_code,
                                                             response.text))
    result = response.json()
    if 'quandl_error' in result:
        raise QuandlError(result['quandl_error']['message'])

    # Parse result container.
    dataset = result['dataset']
    column_names = dataset['column_names']
    date_index = column_names.index('Date')
    try:
        data_index = column_names.index('Adj. Close')
    except ValueError:
        data_index = column_names.index('Close')
    data = dataset['data'][0]

    # Gather time and assume it's in UTC timezone (Quandl does not provide the
    # market's timezone).
    time = datetime.datetime.strptime(data[date_index], '%Y-%m-%d')
    time = time.replace(tzinfo=tz.tzutc())

    # Gather price.
    # Quantize with the same precision default rendering of floats occur.
    price_float = data[data_index]
    price = D(price_float)
    match = re.search(r'(\..*)', str(price_float))
    if match:
        price = price.quantize(D(match.group(1)))

    # Note: There is no currency information in the response (surprising).
    return source.SourcePrice(price, time, None)
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.quandl.parse_ticker">
<code class="highlight language-python">
parse_ticker
(ticker)

        </code>
<a class="headerlink" href="#beancount.prices.sources.quandl.parse_ticker" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Convert ticker to Quandl codes.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/quandl.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def parse_ticker(ticker):
    """Convert ticker to Quandl codes."""
    if not re.match(r"[A-Z0-9]+:[A-Z0-9]+$", ticker):
        raise ValueError('Invalid code. Use "&lt;DATABASE&gt;/&lt;DATASET&gt;" format.')
    return tuple(ticker.split(":"))
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.quandl_test">
<code>quandl_test</code>
<a class="headerlink" href="#beancount.prices.sources.quandl_test" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.quandl_test.response">
<code class="highlight language-python">
response
(contents, status_code=200)

        </code>
<a class="headerlink" href="#beancount.prices.sources.quandl_test.response" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Produce a context manager to patch a JSON response.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/quandl_test.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def response(contents, status_code=requests.codes.ok):
    """Produce a context manager to patch a JSON response."""
    response = mock.Mock()
    response.status_code = status_code
    response.text = ""
    response.json.return_value = contents
    return mock.patch('requests.get', return_value=response)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.yahoo">
<code>yahoo</code>
<a class="headerlink" href="#beancount.prices.sources.yahoo" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Fetch prices from Yahoo Finance's CSV API.</p>
<p>As of late 2017, the older Yahoo finance API deprecated. In particular, the
ichart endpoint is gone, and the download endpoint requires a cookie (which
could be gotten - here's some documentation for that
http://blog.bradlucas.com/posts/2017-06-02-new-yahoo-finance-quote-download-url/).</p>
<p>We're using both the v7 and v8 APIs here, both of which are, as far as I can
tell, undocumented:</p>
<p>https://query1.finance.yahoo.com/v7/finance/quote
https://query1.finance.yahoo.com/v8/finance/chart/SYMBOL</p>
<p>Timezone information: Input and output datetimes are specified via UNIX
timestamps, but the timezone of the particular market is included in the output.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.yahoo.Source">
<code>Source</code>
<a class="headerlink" href="#beancount.prices.sources.yahoo.Source" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Yahoo Finance CSV API price extractor.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.yahoo.Source.get_historical_price">
<code class="highlight language-python">
get_historical_price
(self, ticker, time)

        </code>
<a class="headerlink" href="#beancount.prices.sources.yahoo.Source.get_historical_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/yahoo.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def get_historical_price(self, ticker, time):
    """See contract in beancount.prices.source.Source."""
    if requests is None:
        raise YahooError("You must install the 'requests' library.")
    url = "https://query1.finance.yahoo.com/v8/finance/chart/{}".format(ticker)
    dt_start = time - datetime.timedelta(days=5)
    dt_end = time
    payload = {
        'period1': int(dt_start.timestamp()),
        'period2': int(dt_end.timestamp()),
        'interval': '1d',
    }
    payload.update(_DEFAULT_PARAMS)
    response = requests.get(url, params=payload)
    result = parse_response(response)

    meta = result['meta']
    timezone = datetime.timezone(datetime.timedelta(hours=meta['gmtoffset'] / 3600),
                                 meta['exchangeTimezoneName'])

    timestamp_array = result['timestamp']
    close_array = result['indicators']['quote'][0]['close']
    series = [(datetime.datetime.fromtimestamp(timestamp, tz=timezone), D(price))
              for timestamp, price in zip(timestamp_array, close_array)]

    # Get the latest data returned.
    latest = None
    for data_dt, price in sorted(series):
        if data_dt &gt;= time:
            break
        latest = data_dt, price
    if latest is None:
        raise YahooError("Could not find price before {} in {}".format(time, series))

    currency = result['meta']['currency']
    return source.SourcePrice(price, data_dt, currency)
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h5 class="doc doc-heading" id="beancount.prices.sources.yahoo.Source.get_latest_price">
<code class="highlight language-python">
get_latest_price
(self, ticker)

        </code>
<a class="headerlink" href="#beancount.prices.sources.yahoo.Source.get_latest_price" title="Permanent link"></a></h5>
<div class="doc doc-contents">
<p>See contract in beancount.prices.source.Source.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/yahoo.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def get_latest_price(self, ticker):
    """See contract in beancount.prices.source.Source."""

    url = "https://query1.finance.yahoo.com/v7/finance/quote"
    fields = ['symbol', 'regularMarketPrice', 'regularMarketTime']
    payload = {
        'symbols': ticker,
        'fields': ','.join(fields),
        'exchange': 'NYSE',
    }
    payload.update(_DEFAULT_PARAMS)
    response = requests.get(url, params=payload)
    result = parse_response(response)
    try:
        price = D(result['regularMarketPrice'])

        timezone = datetime.timezone(
            datetime.timedelta(hours=result['gmtOffSetMilliseconds'] / 3600000),
            result['exchangeTimezoneName'])
        trade_time = datetime.datetime.fromtimestamp(result['regularMarketTime'],
                                                     tz=timezone)
    except KeyError:
        raise YahooError("Invalid response from Yahoo: {}".format(repr(result)))

    currency = parse_currency(result)

    return source.SourcePrice(price, trade_time, currency)
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.yahoo.YahooError">
<code>YahooError</code>
<a class="headerlink" href="#beancount.prices.sources.yahoo.YahooError" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>An error from the Yahoo API.</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.yahoo.parse_currency">
<code class="highlight language-python">
parse_currency
(result)

        </code>
<a class="headerlink" href="#beancount.prices.sources.yahoo.parse_currency" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Infer the currency from the result.</p>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/yahoo.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def parse_currency(result: Dict[str, Any]) -&gt; str:
    """Infer the currency from the result."""
    if 'market' not in result:
        return None
    return _MARKETS.get(result['market'], None)
</code></pre>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="beancount.prices.sources.yahoo.parse_response">
<code class="highlight language-python">
parse_response
(response)

        </code>
<a class="headerlink" href="#beancount.prices.sources.yahoo.parse_response" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Process as response from Yahoo.</p>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>YahooError</code></td>
<td>
<p>If there is an error in the response.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/prices/sources/yahoo.py</code></summary>
<pre class="highlight"><code class="language-python linenums">def parse_response(response: requests.models.Response) -&gt; Dict:
    """Process as response from Yahoo.

    Raises:
      YahooError: If there is an error in the response.
    """
    json = response.json(parse_float=D)
    content = next(iter(json.values()))
    if response.status_code != requests.codes.ok:
        raise YahooError("Status {}: {}".format(response.status_code, content['error']))
    if len(json) != 1:
        raise YahooError("Invalid format in response from Yahoo; many keys: {}".format(
            ','.join(json.keys())))
    if content['error'] is not None:
        raise YahooError("Error fetching Yahoo data: {}".format(content['error']))
    return content['result'][0]
</code></pre>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="beancount.prices.sources.yahoo_test">
<code>yahoo_test</code>
<a class="headerlink" href="#beancount.prices.sources.yahoo_test" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h4 class="doc doc-heading" id="beancount.prices.sources.yahoo_test.MockResponse">
<code>MockResponse</code>
<a class="headerlink" href="#beancount.prices.sources.yahoo_test.MockResponse" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>A mock requests.Models.Response object for testing.</p>
<div class="doc doc-children">
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<footer>
<div aria-label="footer navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-right" href="beancount.query.html" title="beancount.query">Next <span class="icon icon-circle-arrow-right"></span></a>
<a class="btn btn-neutral" href="beancount.plugins.html" title="beancount.plugins"><span class="icon icon-circle-arrow-left"></span> Previous</a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<a class="fa fa-github" href="https://github.com/beancount/docs/" style="float: left; color: #fcfcfc"> GitHub</a>
<span><a href="beancount.plugins.html" style="color: #fcfcfc;">« Previous</a></span>
<span style="margin-left: 15px"><a href="beancount.query.html" style="color: #fcfcfc">Next »</a></span>
</span>
</div>
<script>var base_url = '..';</script>
<script defer="" src="../js/theme.js"></script>
<script defer="" src="../js/extra.js"></script>
<script defer="" src="../search/main.js"></script>
<script defer="">
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>
</body>
</html>
