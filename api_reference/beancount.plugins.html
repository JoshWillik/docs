<!DOCTYPE html>

<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://xuhcc.github.io/beancount-docs/api_reference/beancount.plugins.html" rel="canonical"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>beancount.plugins - Beancount Documentation</title>
<link href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet">
<link href="../css/theme.css" rel="stylesheet">
<link href="../css/theme_extra.css" rel="stylesheet"/>
<link href="../css/custom.css" rel="stylesheet"/>
<script>
    // Current page data
    var mkdocs_page_name = "beancount.plugins";
    var mkdocs_page_input_path = "api_reference/beancount.plugins.md";
    var mkdocs_page_url = "/beancount-docs/api_reference/beancount.plugins.html";
  </script>
<script defer="" src="../js/jquery-2.1.1.min.js"></script>
<script defer="" src="../js/modernizr-2.8.3.min.js"></script>
</link></link></head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href=".."> Beancount Documentation</a>
</div>
<div aria-label="main navigation" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Index</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Outline</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="#">Documentation for Users</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../01_command_line_accounting_in_context.html">Command Line Accounting in Context</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../02_the_double_entry_counting_method.html">The Double Entry Counting Method</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../03_installing_beancount.html">Installing Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../04_running_beancount_and_generating_reports.html">Running Beancount and Generating Reports</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../05_getting_started_with_beancount.html">Getting Started with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../06_beancount_language_syntax.html">Beancount Language Syntax</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../07_beancount_options_reference.html">Beancount Options Reference</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../08_precision_tolerances.html">Precision Tolerances</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../09_beancount_query_language.html">Beancount Query Language</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../10_beancount_cheat_sheet.html">Beancount Cheat Sheet</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../11_how_inventories_work.html">How Inventories Work</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../12_exporting_your_portfolio.html">Exporting Your Portfolio</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../13_tutorial_example.html">Tutorial &amp; Example</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../14_beancount_history_and_credits.html">Beancount History and Credits</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../15_a_comparison_of_beancount_and_ledger_hledger.html">A Comparison of Beancount and Ledger Hledger</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../16_fetching_prices_in_beancount.html">Fetching Prices in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../17_importing_external_data.html">Importing External Data</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Cookbooks &amp; Examples</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../18_command_line_accounting_cookbook.html">Command Line Accounting Cookbook</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../19_trading_with_beancount.html">Trading with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../20_stock_vesting_in_beancount.html">Stock Vesting in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../21_sharing_expenses_with_beancount.html">Sharing Expenses with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../22_how_we_share_expenses.html">How We Share Expenses</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Documentation for Developers</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../23_beancount_scripting_plugins.html">Beancount Scripting Plugins</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../24_beancount_design_doc.html">Beancount Design Doc</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../25_ledgerhub_design_doc.html">Ledgerhub Design Doc</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../26_external_contributions.html">External Contributions</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Enhancement Proposals &amp; Discussions</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../27_a_proposal_for_an_improvement_on_inventory_booking.html">A Proposal for an Improvement on Inventory Booking</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../28_settlement_dates_in_beancount.html">Settlement Dates in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../29_balance_assertions_in_beancount.html">Balance Assertions in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../30_fund_accounting_with_beancount.html">Fund Accounting with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../31_rounding_precision_in_beancount.html">Rounding Precision in Beancount</a>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">beancount</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.core.html">beancount.core</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.ingest.html">beancount.ingest</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.ops.html">beancount.ops</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.parser.html">beancount.parser</a>
</li>
<li class="toctree-l1 current"><a class="reference internal current" href="beancount.plugins.html">beancount.plugins</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins">beancount.plugins</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.auto">auto</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.auto_accounts">auto_accounts</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.auto_accounts.auto_insert_open">auto_insert_open()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.book_conversions">book_conversions</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.book_conversions.BookConversionError">BookConversionError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.book_conversions.BookConversionError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.book_conversions.BookConversionError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.book_conversions.BookConversionError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.book_conversions.ConfigError">ConfigError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.book_conversions.ConfigError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.book_conversions.ConfigError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.book_conversions.ConfigError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.book_conversions.augment_inventory">augment_inventory()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.book_conversions.book_price_conversions">book_price_conversions()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.book_conversions.book_price_conversions_plugin">book_price_conversions_plugin()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.book_conversions.extract_trades">extract_trades()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.book_conversions.is_matching">is_matching()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.book_conversions.link_entries_with_metadata">link_entries_with_metadata()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.book_conversions.main">main()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.book_conversions.reduce_inventory">reduce_inventory()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.check_average_cost">check_average_cost</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.check_average_cost.MatchBasisError">MatchBasisError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.check_average_cost.MatchBasisError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.check_average_cost.MatchBasisError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.check_average_cost.MatchBasisError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.check_average_cost.validate_average_cost">validate_average_cost()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.check_closing">check_closing</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.check_closing.check_closing">check_closing()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.check_commodity">check_commodity</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.check_commodity.CheckCommodityError">CheckCommodityError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.check_commodity.CheckCommodityError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.check_commodity.CheckCommodityError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.check_commodity.CheckCommodityError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.check_commodity.validate_commodity_directives">validate_commodity_directives()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.coherent_cost">coherent_cost</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.coherent_cost.CoherentCostError">CoherentCostError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.coherent_cost.CoherentCostError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.coherent_cost.CoherentCostError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.coherent_cost.CoherentCostError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.coherent_cost.validate_coherent_cost">validate_coherent_cost()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.commodity_attr">commodity_attr</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.commodity_attr.CommodityError">CommodityError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.commodity_attr.CommodityError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.commodity_attr.CommodityError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.commodity_attr.CommodityError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.commodity_attr.ConfigError">ConfigError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.commodity_attr.ConfigError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.commodity_attr.ConfigError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.commodity_attr.ConfigError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.commodity_attr.validate_commodity_attr">validate_commodity_attr()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.currency_accounts">currency_accounts</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.currency_accounts.get_neutralizing_postings">get_neutralizing_postings()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.currency_accounts.group_postings_by_weight_currency">group_postings_by_weight_currency()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.currency_accounts.insert_currency_trading_postings">insert_currency_trading_postings()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.divert_expenses">divert_expenses</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.divert_expenses.divert_expenses">divert_expenses()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.divert_expenses.replace_expenses_accounts">replace_expenses_accounts()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.exclude_tag">exclude_tag</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.exclude_tag.exclude_tag">exclude_tag()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.fill_account">fill_account</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.fill_account.FillAccountError">FillAccountError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.fill_account.FillAccountError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.fill_account.FillAccountError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.fill_account.FillAccountError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.fill_account.fill_account">fill_account()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.fix_payees">fix_payees</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.fix_payees.FixPayeesError">FixPayeesError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.fix_payees.FixPayeesError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.fix_payees.FixPayeesError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.fix_payees.FixPayeesError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.fix_payees.fix_payees">fix_payees()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.fix_payees_test">fix_payees_test</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.fix_payees_test.TestFixPayees">TestFixPayees</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.fix_payees_test.TestFixPayees.fix">fix()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.fix_payees_test.TestFixPayees.setUp">setUp()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.forecast">forecast</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.forecast.forecast_plugin">forecast_plugin()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.implicit_prices">implicit_prices</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.implicit_prices.ImplicitPriceError">ImplicitPriceError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.implicit_prices.ImplicitPriceError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.implicit_prices.ImplicitPriceError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.implicit_prices.ImplicitPriceError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.implicit_prices.add_implicit_prices">add_implicit_prices()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.ira_contribs">ira_contribs</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.ira_contribs.add_ira_contribs">add_ira_contribs()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.ira_contribs.add_postings">add_postings()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.leafonly">leafonly</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.leafonly.LeafOnlyError">LeafOnlyError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.leafonly.LeafOnlyError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.leafonly.LeafOnlyError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.leafonly.LeafOnlyError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.leafonly.validate_leaf_only">validate_leaf_only()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.mark_unverified">mark_unverified</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.mark_unverified.mark_unverified">mark_unverified()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.merge_meta">merge_meta</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.merge_meta.merge_meta">merge_meta()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.noduplicates">noduplicates</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.noduplicates.validate_no_duplicates">validate_no_duplicates()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.nounused">nounused</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.nounused.UnusedAccountError">UnusedAccountError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.nounused.UnusedAccountError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.nounused.UnusedAccountError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.nounused.UnusedAccountError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.nounused.validate_unused_accounts">validate_unused_accounts()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.onecommodity">onecommodity</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.onecommodity.OneCommodityError">OneCommodityError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.onecommodity.OneCommodityError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.onecommodity.OneCommodityError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.onecommodity.OneCommodityError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.onecommodity.validate_one_commodity">validate_one_commodity()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.pedantic">pedantic</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.sellgains">sellgains</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.sellgains.SellGainsError">SellGainsError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.sellgains.SellGainsError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.sellgains.SellGainsError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.sellgains.SellGainsError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.sellgains.validate_sell_gains">validate_sell_gains()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.split_expenses">split_expenses</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.split_expenses.get_participants">get_participants()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.split_expenses.main">main()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.split_expenses.save_query">save_query()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.split_expenses.split_expenses">split_expenses()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.split_expenses_test">split_expenses_test</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.split_expenses_test.TestSplitReports">TestSplitReports</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.split_expenses_test.TestSplitReports.run_split_reports">run_split_reports()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.tag_pending">tag_pending</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.tag_pending.tag_pending_plugin">tag_pending_plugin()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.tag_pending.tag_pending_transactions">tag_pending_transactions()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.unique_prices">unique_prices</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.unique_prices.UniquePricesError">UniquePricesError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.unique_prices.UniquePricesError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.unique_prices.UniquePricesError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.unique_prices.UniquePricesError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.unique_prices.validate_unique_prices">validate_unique_prices()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.unrealized">unrealized</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.unrealized.UnrealizedError">UnrealizedError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.unrealized.UnrealizedError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.unrealized.UnrealizedError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.plugins.unrealized.UnrealizedError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.unrealized.add_unrealized_gains">add_unrealized_gains()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.unrealized.get_unrealized_entries">get_unrealized_entries()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.plugins.unrealized_test">unrealized_test</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.plugins.unrealized_test.get_entries_with_narration">get_entries_with_narration()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.query.html">beancount.query</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.reports.html">beancount.reports</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.scripts.html">beancount.scripts</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.utils.html">beancount.utils</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="top navigation" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="..">Beancount Documentation</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a href="..">Docs</a> »</li>
<li>API reference »</li>
<li>beancount.plugins</li>
<li class="wy-breadcrumbs-aside">
<a class="icon icon-github" href="https://github.com/xuhcc/beancount-docs/edit/master/docs/api_reference/beancount.plugins.md"> Edit on GitHub</a>
</li>
</ul>
<hr/>
</div>
<div role="main">
<div class="section">
<h1 id="beancountplugins">beancount.plugins<a class="headerlink" href="#beancountplugins" title="Permanent link"></a></h1>
<div class="doc doc-object doc-module">
<h2 class="hidden-toc" href="#beancount.plugins" id="beancount.plugins" style="visibility: hidden; width: 0; height: 0;">
<a class="headerlink" href="#beancount.plugins" title="Permanent link"></a></h2>
<div class="doc doc-contents first">
<p>Example plugins for filtering transactions.</p>
<p>These are various examples of how to filter entries in various creative ways.</p>
<p>IMPORTANT: These are not meant to tbe complete features, rather just experiments
in problem-solving using Beancount, work-in-progress that can be selectively
installed via a --plugin option, or one-offs to answer questions on the
mailing-list.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.auto">
<code>auto</code>
<a class="headerlink" href="#beancount.plugins.auto" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>A plugin of plugins which triggers are all the automatic and lax plugins.</p>
<p>In a sense, this is the inverse of "pedantic." This is useful when doing some
types of quick and dirty tests. You can just import the "auto" plugin. Put that
in a macro.</p>
<p>Also see: the 'pedantic' plugin.</p>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.auto_accounts">
<code>auto_accounts</code>
<a class="headerlink" href="#beancount.plugins.auto_accounts" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>This module automatically inserts Open directives for accounts not opened (at
the date of the first entry) and automatically removes open directives for
unused accounts. This can be used as a convenience for doing demos, or when
setting up your initial transactions, as an intermediate step.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.auto_accounts.auto_insert_open">
<code class="highlight language-python">
auto_insert_open<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.auto_accounts.auto_insert_open" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Insert implicitly defined prices from Transactions.</p>
<p>Explicit price entries are simply maintained in the output list. Prices from
postings with costs or with prices from Transaction entries are synthesized
as new Price entries in the list of entries output.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives. We're interested only in the Transaction instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>A parser options dict.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of entries, possibly with more Price entries than before, and a
list of errors.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/auto_accounts.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">auto_insert_open</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
    <span class="sd">"""Insert implicitly defined prices from Transactions.</span>

<span class="sd">    Explicit price entries are simply maintained in the output list. Prices from</span>
<span class="sd">    postings with costs or with prices from Transaction entries are synthesized</span>
<span class="sd">    as new Price entries in the list of entries output.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives. We're interested only in the Transaction instances.</span>
<span class="sd">      unused_options_map: A parser options dict.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of entries, possibly with more Price entries than before, and a</span>
<span class="sd">      list of errors.</span>
<span class="sd">    """</span>
    <span class="n">opened_accounts</span> <span class="o">=</span> <span class="p">{</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span>
                       <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span>
                       <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">)}</span>

    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">accounts_first</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_accounts_use_map</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">date_first_used</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">accounts_first</span><span class="o">.</span><span class="n">items</span><span class="p">())):</span>
        <span class="k">if</span> <span class="n">account</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opened_accounts</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;auto_accounts&gt;'</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">date_first_used</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span>
                                         <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">new_entries</span><span class="p">:</span>
        <span class="n">new_entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="n">new_entries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">entry_sortkey</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_entries</span> <span class="o">=</span> <span class="n">entries</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="p">[]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.book_conversions">
<code>book_conversions</code>
<a class="headerlink" href="#beancount.plugins.book_conversions" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>A plugin that automatically converts postings at price to postings held at
cost, applying an automatic booking algorithm in assigning the cost bases and
matching lots.</p>
<p>This plugin restricts itself to applying these transformations within a
particular account, which you provide. For each of those accounts, it also
requires a corresponding Income account to book the profit/loss of reducing
lots (i.e., sales):</p>
<p>plugin "beancount.plugins.book_conversions" "Assets:Bitcoin,Income:Bitcoin"</p>
<p>Then, simply input the transactions with price conversion. We use "Bitcoins" in
this example, converting Bitcoin purchases that were carried out as currency
into maintaining these with cost basis, for tax reporting purposes:</p>
<p>2015-09-04 * "Buy some bitcoins"
    Assets:Bank          -1000.00 USD
    Assets:Bitcoin       4.333507 BTC @ 230.76 USD</p>
<p>2015-09-05 * "Buy some more bitcoins at a different price"
    Assets:Bank          -1000.00 USD
    Assets:Bitcoin       4.345747 BTC @ 230.11 USD</p>
<p>2015-09-20 * "Use (sell) some bitcoins"
    Assets:Bitcoin       -6.000000 BTC @ 230.50 USD
    Expenses:Something</p>
<p>The result is that cost bases are inserted on augmenting lots:</p>
<p>2015-09-04 * "Buy some bitcoins"
    Assets:Bitcoin  4.333507 BTC {230.76 USD} @ 230.76 USD
    Assets:Bank     -1000.00 USD</p>
<p>2015-09-05 * "Buy some more bitcoins at a different price"
    Assets:Bitcoin  4.345747 BTC {230.11 USD} @ 230.11 USD
    Assets:Bank     -1000.00 USD</p>
<p>While on reducing lots, matching FIFO lots are automatically found and the
corresponding cost basis added:</p>
<p>2015-09-20 * "Use (sell) some bitcoins"
    Assets:Bitcoin          -4.333507 BTC {230.76 USD} @ 230.50 USD
    Assets:Bitcoin          -1.666493 BTC {230.11 USD} @ 230.50 USD
    Income:Bitcoin         0.47677955 USD
    Expenses:Something  1383.00000000 USD</p>
<p>Note that multiple lots were required to fulfill the sale quantity here. As in
this example, this may result in multiple lots being created for a single one.</p>
<p>Finally, Beancount will eventually support booking methods built-in, but this is
a quick method that shows how to hack your own booking method via
transformations of the postings that run in in a plugin.</p>
<p>Implementation notes:</p>
<ul>
<li>
<p>This code uses the FIFO method only for now. However, it would be very easy to
  customize it to provide other booking methods, e.g. LIFO, or otherwise. This
  will be added eventually, and I'm hoping to reuse the same inventory
  abstractions that will be used to implement the fallback booking methods from
  the booking proposal review (http://furius.ca/beancount/doc/proposal-booking).</p>
</li>
<li>
<p>Instead of keeping a list of (Position, Transaction) pairs for the pending
  FIFO lots, we really ought to use a beancount.core.inventory.Inventory
  instance. However, the class does not contain sufficient data to carry out
  FIFO booking at the moment. A newer implementation, living in the "booking"
  branch, does, and will be used in the future.</p>
</li>
<li>
<p>This code assumes that a positive number of units is an augmenting lot and a
  reducing one has a negative number of units, though we never call them that
  way on purpose (to eventually allow this code to handle short positions). This
  is not strictly true; however, we would need an Inventory in order to figrue
  this out. This will be done in the future and is not difficult to do.</p>
</li>
</ul>
<p>IMPORTANT:</p>
<p>This plugin was developed before the booking methods (FIFO, LIFO, and others)
  were fully implemented in Beancount. It was built to answer a question on the
  mailing-list about FIFO booking. You probably don't need to use them anymore.
  Always prefer to use the native syntax instead of this.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.book_conversions.BookConversionError">
<code>BookConversionError</code>
<a class="headerlink" href="#beancount.plugins.book_conversions.BookConversionError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>BookConversionError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.book_conversions.BookConversionError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.book_conversions.BookConversionError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/book_conversions.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.book_conversions.BookConversionError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.book_conversions.BookConversionError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of BookConversionError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.book_conversions.BookConversionError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.book_conversions.BookConversionError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/book_conversions.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.book_conversions.ConfigError">
<code>ConfigError</code>
<a class="headerlink" href="#beancount.plugins.book_conversions.ConfigError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>ConfigError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.book_conversions.ConfigError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.book_conversions.ConfigError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/book_conversions.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.book_conversions.ConfigError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.book_conversions.ConfigError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of ConfigError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.book_conversions.ConfigError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.book_conversions.ConfigError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/book_conversions.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.book_conversions.augment_inventory">
<code class="highlight language-python">
augment_inventory<span class="p">(</span><span class="n">pending_lots</span><span class="p">,</span> <span class="n">posting</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">eindex</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.book_conversions.augment_inventory" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Add the lots from the given posting to the running inventory.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pending_lots</code></td>
<td><code></code></td>
<td>
<p>A list of pending ([number], Posting, Transaction) to be matched.
The number is modified in-place, destructively.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>posting</code></td>
<td><code></code></td>
<td>
<p>The posting whose position is to be added.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>entry</code></td>
<td><code></code></td>
<td>
<p>The parent transaction.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>eindex</code></td>
<td><code></code></td>
<td>
<p>The index of the parent transaction housing this posting.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A new posting with cost basis inserted to be added to a transformed transaction.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/book_conversions.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">augment_inventory</span><span class="p">(</span><span class="n">pending_lots</span><span class="p">,</span> <span class="n">posting</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">eindex</span><span class="p">):</span>
    <span class="sd">"""Add the lots from the given posting to the running inventory.</span>

<span class="sd">    Args:</span>
<span class="sd">      pending_lots: A list of pending ([number], Posting, Transaction) to be matched.</span>
<span class="sd">        The number is modified in-place, destructively.</span>
<span class="sd">      posting: The posting whose position is to be added.</span>
<span class="sd">      entry: The parent transaction.</span>
<span class="sd">      eindex: The index of the parent transaction housing this posting.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new posting with cost basis inserted to be added to a transformed transaction.</span>
<span class="sd">    """</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span>
    <span class="n">new_posting</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
        <span class="n">units</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="p">),</span>
        <span class="n">cost</span><span class="o">=</span><span class="n">position</span><span class="o">.</span><span class="n">Cost</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                           <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
                           <span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                           <span class="kc">None</span><span class="p">))</span>
    <span class="n">pending_lots</span><span class="o">.</span><span class="n">append</span><span class="p">(([</span><span class="n">number</span><span class="p">],</span> <span class="n">new_posting</span><span class="p">,</span> <span class="n">eindex</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_posting</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.book_conversions.book_price_conversions">
<code class="highlight language-python">
book_price_conversions<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">assets_account</span><span class="p">,</span> <span class="n">income_account</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.book_conversions.book_price_conversions" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Rewrite transactions to insert cost basis according to a booking method.</p>
<p>See module docstring for full details.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of entry instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>assets_account</code></td>
<td><code></code></td>
<td>
<p>An account string, the name of the account to process.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>income_account</code></td>
<td><code></code></td>
<td>
<p>An account string, the name of the account to use for booking
realized profit/loss.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>A tuple of
  entries</code></td>
<td>
<p>A list of new, modified entries.
  errors: A list of errors generated by this plugin.
  matches: A list of (number, augmenting-posting, reducing-postings) for all
    matched lots.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/book_conversions.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">book_price_conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">assets_account</span><span class="p">,</span> <span class="n">income_account</span><span class="p">):</span>
    <span class="sd">"""Rewrite transactions to insert cost basis according to a booking method.</span>

<span class="sd">    See module docstring for full details.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of entry instances.</span>
<span class="sd">      assets_account: An account string, the name of the account to process.</span>
<span class="sd">      income_account: An account string, the name of the account to use for booking</span>
<span class="sd">        realized profit/loss.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A tuple of</span>
<span class="sd">        entries: A list of new, modified entries.</span>
<span class="sd">        errors: A list of errors generated by this plugin.</span>
<span class="sd">        matches: A list of (number, augmenting-posting, reducing-postings) for all</span>
<span class="sd">          matched lots.</span>
<span class="sd">    """</span>
    <span class="c1"># Pairs of (Position, Transaction) instances used to match augmenting</span>
    <span class="c1"># entries with reducing ones.</span>
    <span class="n">pending_lots</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># A list of pairs of matching (augmenting, reducing) postings.</span>
    <span class="n">all_matches</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">eindex</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>

        <span class="c1"># Figure out if this transaction has postings in Bitcoins without a cost.</span>
        <span class="c1"># The purpose of this plugin is to fixup those.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_matching</span><span class="p">(</span><span class="n">posting</span><span class="p">,</span> <span class="n">assets_account</span><span class="p">)</span>
                                                       <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">):</span>

            <span class="c1"># Segregate the reducing lots, augmenting lots and other lots.</span>
            <span class="n">augmenting</span><span class="p">,</span> <span class="n">reducing</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pindex</span><span class="p">,</span> <span class="n">posting</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">is_matching</span><span class="p">(</span><span class="n">posting</span><span class="p">,</span> <span class="n">assets_account</span><span class="p">):</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">augmenting</span> <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="n">ZERO</span> <span class="k">else</span> <span class="n">reducing</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">other</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>

            <span class="c1"># We will create a replacement list of postings with costs filled</span>
            <span class="c1"># in, possibly more than the original list, to account for the</span>
            <span class="c1"># different lots.</span>
            <span class="n">new_postings</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Convert all the augmenting postings to cost basis.</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">augmenting</span><span class="p">:</span>
                <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">augment_inventory</span><span class="p">(</span><span class="n">pending_lots</span><span class="p">,</span> <span class="n">posting</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">eindex</span><span class="p">))</span>

            <span class="c1"># Then process reducing postings.</span>
            <span class="k">if</span> <span class="n">reducing</span><span class="p">:</span>
                <span class="c1"># Process all the reducing postings, booking them to matching lots.</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">reducing</span><span class="p">:</span>
                    <span class="n">rpostings</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">posting_pnl</span><span class="p">,</span> <span class="n">new_errors</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">reduce_inventory</span><span class="p">(</span><span class="n">pending_lots</span><span class="p">,</span> <span class="n">posting</span><span class="p">,</span> <span class="n">eindex</span><span class="p">))</span>
                    <span class="n">new_postings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rpostings</span><span class="p">)</span>
                    <span class="n">all_matches</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_errors</span><span class="p">)</span>
                    <span class="n">pnl</span><span class="o">.</span><span class="n">add_amount</span><span class="p">(</span><span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">posting_pnl</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>

                <span class="c1"># If some reducing lots were seen in this transaction, insert an</span>
                <span class="c1"># Income leg to absorb the P/L. We need to do this for each currency</span>
                <span class="c1"># which incurred P/L.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pnl</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">pnl</span><span class="p">:</span>
                        <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;book_conversions&gt;'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">income_account</span><span class="p">,</span>
                                         <span class="o">-</span><span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                         <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">meta</span><span class="p">))</span>

            <span class="c1"># Third, add back all the other unrelated legs in.</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
                <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>

            <span class="c1"># Create a replacement entry.</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">postings</span><span class="o">=</span><span class="n">new_postings</span><span class="p">)</span>

        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="c1"># Add matching metadata to all matching postings.</span>
    <span class="n">mod_matches</span> <span class="o">=</span> <span class="n">link_entries_with_metadata</span><span class="p">(</span><span class="n">new_entries</span><span class="p">,</span> <span class="n">all_matches</span><span class="p">)</span>

    <span class="c1"># Resolve the indexes to their possibly modified Transaction instances.</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[(</span><span class="n">data</span><span class="o">.</span><span class="n">TxnPosting</span><span class="p">(</span><span class="n">new_entries</span><span class="p">[</span><span class="n">aug_index</span><span class="p">],</span> <span class="n">aug_posting</span><span class="p">),</span>
                <span class="n">data</span><span class="o">.</span><span class="n">TxnPosting</span><span class="p">(</span><span class="n">new_entries</span><span class="p">[</span><span class="n">red_index</span><span class="p">],</span> <span class="n">red_posting</span><span class="p">))</span>
               <span class="k">for</span> <span class="p">(</span><span class="n">aug_index</span><span class="p">,</span> <span class="n">aug_posting</span><span class="p">),</span> <span class="p">(</span><span class="n">red_index</span><span class="p">,</span> <span class="n">red_posting</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mod_matches</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">matches</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.book_conversions.book_price_conversions_plugin">
<code class="highlight language-python">
book_price_conversions_plugin<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.book_conversions.book_price_conversions_plugin" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Plugin that rewrites transactions to insert cost basis according to a booking method.</p>
<p>See book_price_conversions() for details.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of entry instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>A dict of options parsed from the file.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>config</code></td>
<td><code></code></td>
<td>
<p>A string, in "&lt;ACCOUNT1&gt;,&lt;ACCOUNT2&gt;" format.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>A tuple of
  entries</code></td>
<td>
<p>A list of new, modified entries.
  errors: A list of errors generated by this plugin.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/book_conversions.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">book_price_conversions_plugin</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="sd">"""Plugin that rewrites transactions to insert cost basis according to a booking method.</span>

<span class="sd">    See book_price_conversions() for details.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of entry instances.</span>
<span class="sd">      options_map: A dict of options parsed from the file.</span>
<span class="sd">      config: A string, in "&lt;ACCOUNT1&gt;,&lt;ACCOUNT2&gt;" format.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A tuple of</span>
<span class="sd">        entries: A list of new, modified entries.</span>
<span class="sd">        errors: A list of errors generated by this plugin.</span>
<span class="sd">    """</span>
    <span class="c1"># The expected configuration is two account names, separated by whitespace.</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">assets_account</span><span class="p">,</span> <span class="n">income_account</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">'[,; \t]'</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">account</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">assets_account</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">account</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">income_account</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Invalid account string"</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ConfigError</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="p">(</span><span class="s1">'Invalid configuration: "</span><span class="si">{}</span><span class="s1">": </span><span class="si">{}</span><span class="s1">, skipping booking'</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">exc</span><span class="p">),</span>
                <span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>

    <span class="n">new_entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">book_price_conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">assets_account</span><span class="p">,</span> <span class="n">income_account</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.book_conversions.extract_trades">
<code class="highlight language-python">
extract_trades<span class="p">(</span><span class="n">entries</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.book_conversions.extract_trades" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Find all the matching trades from the metadata attached to postings.</p>
<p>This inspects all the postings and pairs them up using the special metadata
field that was added by this plugin when booking matching lots, and returns
pairs of those postings.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>The list of directives to extract from.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of (number, augmenting-posting, reducing-posting).</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/book_conversions.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">extract_trades</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
    <span class="sd">"""Find all the matching trades from the metadata attached to postings.</span>

<span class="sd">    This inspects all the postings and pairs them up using the special metadata</span>
<span class="sd">    field that was added by this plugin when booking matching lots, and returns</span>
<span class="sd">    pairs of those postings.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: The list of directives to extract from.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of (number, augmenting-posting, reducing-posting).</span>
<span class="sd">    """</span>
    <span class="n">trade_map</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="n">links_str</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">META</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">links_str</span><span class="p">:</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">links_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                    <span class="n">trade_map</span><span class="p">[</span><span class="n">link</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">posting</span><span class="p">))</span>

    <span class="c1"># Sort matches according to the index of the first entry, drop the index</span>
    <span class="c1"># used for doing this, and convert the objects to tuples..</span>
    <span class="n">trades</span> <span class="o">=</span> <span class="p">[(</span><span class="n">data</span><span class="o">.</span><span class="n">TxnPosting</span><span class="p">(</span><span class="n">augmenting</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">augmenting</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
               <span class="n">data</span><span class="o">.</span><span class="n">TxnPosting</span><span class="p">(</span><span class="n">reducing</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reducing</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
              <span class="k">for</span> <span class="n">augmenting</span><span class="p">,</span> <span class="n">reducing</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">trade_map</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>

    <span class="c1"># Sanity check.</span>
    <span class="k">for</span> <span class="n">matches</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">trades</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.book_conversions.is_matching">
<code class="highlight language-python">
is_matching<span class="p">(</span><span class="n">posting</span><span class="p">,</span> <span class="n">account</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.book_conversions.is_matching" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>"Identify if the given posting is one to be booked.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>posting</code></td>
<td><code></code></td>
<td>
<p>An instance of a Posting.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account</code></td>
<td><code></code></td>
<td>
<p>The account name configured.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A boolean, true if this posting is one that we should be adding a cost to.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/book_conversions.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>117
118
119
120
121
122
123
124
125
126
127
128</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">is_matching</span><span class="p">(</span><span class="n">posting</span><span class="p">,</span> <span class="n">account</span><span class="p">):</span>
    <span class="sd">""""Identify if the given posting is one to be booked.</span>

<span class="sd">    Args:</span>
<span class="sd">      posting: An instance of a Posting.</span>
<span class="sd">      account: The account name configured.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A boolean, true if this posting is one that we should be adding a cost to.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span> <span class="o">==</span> <span class="n">account</span> <span class="ow">and</span>
            <span class="n">posting</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="n">posting</span><span class="o">.</span><span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.book_conversions.link_entries_with_metadata">
<code class="highlight language-python">
link_entries_with_metadata<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">all_matches</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.book_conversions.link_entries_with_metadata" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Modify the entries in-place to add matching links to postings.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>The list of entries to modify.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>all_matches</code></td>
<td><code></code></td>
<td>
<p>A list of pairs of (augmenting-posting, reducing-posting).</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of pairs of (index, Posting) for the new (augmenting, reducing)
annotated postings.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/book_conversions.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">link_entries_with_metadata</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">all_matches</span><span class="p">):</span>
    <span class="sd">"""Modify the entries in-place to add matching links to postings.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: The list of entries to modify.</span>
<span class="sd">      all_matches: A list of pairs of (augmenting-posting, reducing-posting).</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of pairs of (index, Posting) for the new (augmenting, reducing)</span>
<span class="sd">      annotated postings.</span>
<span class="sd">    """</span>
    <span class="c1"># Allocate trade names and compute a map of posting to trade names.</span>
    <span class="n">link_map</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">aug_index</span><span class="p">,</span> <span class="n">aug_posting</span><span class="p">),</span> <span class="p">(</span><span class="n">red_index</span><span class="p">,</span> <span class="n">red_posting</span><span class="p">)</span> <span class="ow">in</span> <span class="n">all_matches</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s1">'trade-</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'-'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">link_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">aug_posting</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
        <span class="n">link_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">red_posting</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>

    <span class="c1"># Modify the postings.</span>
    <span class="n">postings_repl_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">posting</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">):</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">link_map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">posting</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">links</span><span class="p">:</span>
                    <span class="n">new_posting</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                    <span class="n">new_posting</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">META</span><span class="p">]</span> <span class="o">=</span> <span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_posting</span>
                    <span class="n">postings_repl_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">posting</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_posting</span>

    <span class="c1"># Just a sanity check.</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">link_map</span><span class="p">,</span> <span class="s2">"Internal error: not all matches found."</span>

    <span class="c1"># Return a list of the modified postings (mapping the old matches to the</span>
    <span class="c1"># newly created ones).</span>
    <span class="k">return</span> <span class="p">[((</span><span class="n">aug_index</span><span class="p">,</span> <span class="n">postings_repl_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">aug_posting</span><span class="p">)]),</span>
             <span class="p">(</span><span class="n">red_index</span><span class="p">,</span> <span class="n">postings_repl_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">red_posting</span><span class="p">)]))</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">aug_index</span><span class="p">,</span> <span class="n">aug_posting</span><span class="p">),</span> <span class="p">(</span><span class="n">red_index</span><span class="p">,</span> <span class="n">red_posting</span><span class="p">)</span> <span class="ow">in</span> <span class="n">all_matches</span><span class="p">]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.book_conversions.main">
<code class="highlight language-python">
main<span class="p">()</span> </code>
<a class="headerlink" href="#beancount.plugins.book_conversions.main" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Extract trades from metadata-annotated postings and report on them.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/book_conversions.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">"""Extract trades from metadata-annotated postings and report on them.</span>
<span class="sd">    """</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">'</span><span class="si">%(levelname)-8s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'filename'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">'Beancount input filename'</span><span class="p">)</span>

    <span class="n">oparser</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">'Outputs'</span><span class="p">)</span>
    <span class="n">oparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-o'</span><span class="p">,</span> <span class="s1">'--output'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store'</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">"Filename to output results to (default goes to stdout)"</span><span class="p">)</span>
    <span class="n">oparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-f'</span><span class="p">,</span> <span class="s1">'--format'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">'text'</span><span class="p">,</span>
                         <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">'text'</span><span class="p">,</span> <span class="s1">'csv'</span><span class="p">],</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">"Output format to render to (text, csv)"</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Load the input file.</span>
    <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">options_map</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Get the list of trades.</span>
    <span class="n">trades</span> <span class="o">=</span> <span class="n">extract_trades</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="c1"># Produce a table of all the trades.</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'units currency cost_currency '</span>
               <span class="s1">'buy_date buy_price sell_date sell_price pnl'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Units'</span><span class="p">,</span> <span class="s1">'Currency'</span><span class="p">,</span> <span class="s1">'Cost Currency'</span><span class="p">,</span>
              <span class="s1">'Buy Date'</span><span class="p">,</span> <span class="s1">'Buy Price'</span><span class="p">,</span> <span class="s1">'Sell Date'</span><span class="p">,</span> <span class="s1">'Sell Price'</span><span class="p">,</span>
              <span class="s1">'P/L'</span><span class="p">]</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">aug</span><span class="p">,</span> <span class="n">red</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
        <span class="n">units</span> <span class="o">=</span> <span class="o">-</span><span class="n">red</span><span class="o">.</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span>
        <span class="n">buy_price</span> <span class="o">=</span> <span class="n">aug</span><span class="o">.</span><span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">number</span>
        <span class="n">sell_price</span> <span class="o">=</span> <span class="n">red</span><span class="o">.</span><span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">number</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">units</span> <span class="o">*</span> <span class="p">(</span><span class="n">sell_price</span> <span class="o">-</span> <span class="n">buy_price</span><span class="p">))</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">buy_price</span><span class="p">)</span>
        <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
            <span class="o">-</span><span class="n">red</span><span class="o">.</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
            <span class="n">red</span><span class="o">.</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
            <span class="n">red</span><span class="o">.</span><span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
            <span class="n">aug</span><span class="o">.</span><span class="n">txn</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">buy_price</span><span class="p">,</span>
            <span class="n">red</span><span class="o">.</span><span class="n">txn</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">sell_price</span><span class="p">,</span>
            <span class="n">pnl</span>
            <span class="p">])</span>
    <span class="n">trades_table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="c1"># Render the table as text or CSV.</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="n">table</span><span class="o">.</span><span class="n">render_table</span><span class="p">(</span><span class="n">trades_table</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.book_conversions.reduce_inventory">
<code class="highlight language-python">
reduce_inventory<span class="p">(</span><span class="n">pending_lots</span><span class="p">,</span> <span class="n">posting</span><span class="p">,</span> <span class="n">eindex</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.book_conversions.reduce_inventory" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Match a reducing posting against a list of lots (using FIFO order).</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pending_lots</code></td>
<td><code></code></td>
<td>
<p>A list of pending ([number], Posting, Transaction) to be matched.
The number is modified in-place, destructively.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>posting</code></td>
<td><code></code></td>
<td>
<p>The posting whose position is to be added.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>eindex</code></td>
<td><code></code></td>
<td>
<p>The index of the parent transaction housing this posting.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>A tuple of
  postings</code></td>
<td>
<p>A list of new Posting instances corresponding to the given
    posting, that were booked to the current list of lots.
  matches: A list of pairs of (augmenting-posting, reducing-posting).
  pnl: A Decimal, the P/L incurred in reducing these lots.
  errors: A list of new errors generated in reducing these lots.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/book_conversions.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">reduce_inventory</span><span class="p">(</span><span class="n">pending_lots</span><span class="p">,</span> <span class="n">posting</span><span class="p">,</span> <span class="n">eindex</span><span class="p">):</span>
    <span class="sd">"""Match a reducing posting against a list of lots (using FIFO order).</span>

<span class="sd">    Args:</span>
<span class="sd">      pending_lots: A list of pending ([number], Posting, Transaction) to be matched.</span>
<span class="sd">        The number is modified in-place, destructively.</span>
<span class="sd">      posting: The posting whose position is to be added.</span>
<span class="sd">      eindex: The index of the parent transaction housing this posting.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A tuple of</span>
<span class="sd">        postings: A list of new Posting instances corresponding to the given</span>
<span class="sd">          posting, that were booked to the current list of lots.</span>
<span class="sd">        matches: A list of pairs of (augmenting-posting, reducing-posting).</span>
<span class="sd">        pnl: A Decimal, the P/L incurred in reducing these lots.</span>
<span class="sd">        errors: A list of new errors generated in reducing these lots.</span>
<span class="sd">    """</span>
    <span class="n">new_postings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pnl</span> <span class="o">=</span> <span class="n">ZERO</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">match_number</span> <span class="o">=</span> <span class="o">-</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span>
    <span class="n">match_currency</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span>
    <span class="n">cost_currency</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">currency</span>
    <span class="k">while</span> <span class="n">match_number</span> <span class="o">!=</span> <span class="n">ZERO</span><span class="p">:</span>

        <span class="c1"># Find the first lot with matching currency.</span>
        <span class="k">for</span> <span class="n">fnumber</span><span class="p">,</span> <span class="n">fposting</span><span class="p">,</span> <span class="n">findex</span> <span class="ow">in</span> <span class="n">pending_lots</span><span class="p">:</span>
            <span class="n">funits</span> <span class="o">=</span> <span class="n">fposting</span><span class="o">.</span><span class="n">units</span>
            <span class="n">fcost</span> <span class="o">=</span> <span class="n">fposting</span><span class="o">.</span><span class="n">cost</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">funits</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="n">match_currency</span> <span class="ow">and</span>
                <span class="n">fcost</span> <span class="ow">and</span> <span class="n">fcost</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="n">cost_currency</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">fnumber</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ZERO</span><span class="p">,</span> <span class="s2">"Internal error, zero lot"</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">BookConversionError</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                          <span class="s2">"Could not match position </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">posting</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">break</span>

        <span class="c1"># Reduce the pending lots.</span>
        <span class="n">number</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">match_number</span><span class="p">,</span> <span class="n">fnumber</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">fcost</span>
        <span class="n">match_number</span> <span class="o">-=</span> <span class="n">number</span>
        <span class="n">fnumber</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">number</span>
        <span class="k">if</span> <span class="n">fnumber</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ZERO</span><span class="p">:</span>
            <span class="n">pending_lots</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Add a corresponding posting.</span>
        <span class="n">rposting</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
            <span class="n">units</span><span class="o">=</span><span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="o">-</span><span class="n">number</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">),</span>
            <span class="n">cost</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">cost</span><span class="p">))</span>
        <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rposting</span><span class="p">)</span>

        <span class="c1"># Update the P/L.</span>
        <span class="n">pnl</span> <span class="o">+=</span> <span class="n">number</span> <span class="o">*</span> <span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">number</span> <span class="o">-</span> <span class="n">cost</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

        <span class="c1"># Add to the list of matches.</span>
        <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">findex</span><span class="p">,</span> <span class="n">fposting</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">eindex</span><span class="p">,</span> <span class="n">rposting</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">new_postings</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">pnl</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.check_average_cost">
<code>check_average_cost</code>
<a class="headerlink" href="#beancount.plugins.check_average_cost" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>A plugin that ensures cost basis is preserved in unbooked transactions.</p>
<p>This is intended to be used in accounts using the "NONE" booking method, to
manually ensure that the sum total of the cost basis of reducing legs matches
the average of what's in the account inventory. This is a partial first step
toward implementing the "AVERAGE" booking method. In other words, this plugins
provides assertions that will constrain you to approximate what the "AVERAGE"
booking method will do, manually, and not to leak too much cost basis through
unmatching bookings without checks. (Note the contrived context here: Ideally
the "NONE" booking method would simply not exist.)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.check_average_cost.MatchBasisError">
<code>MatchBasisError</code>
<a class="headerlink" href="#beancount.plugins.check_average_cost.MatchBasisError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>MatchBasisError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.check_average_cost.MatchBasisError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.check_average_cost.MatchBasisError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/check_average_cost.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.check_average_cost.MatchBasisError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.check_average_cost.MatchBasisError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of MatchBasisError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.check_average_cost.MatchBasisError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.check_average_cost.MatchBasisError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/check_average_cost.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.check_average_cost.validate_average_cost">
<code class="highlight language-python">
validate_average_cost<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config_str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.check_average_cost.validate_average_cost" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check that reducing legs on unbooked postings are near the average cost basis.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>config_str</code></td>
<td><code></code></td>
<td>
<p>The configuration as a string version of a float.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/check_average_cost.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_average_cost</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config_str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Check that reducing legs on unbooked postings are near the average cost basis.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">      config_str: The configuration as a string version of a float.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="c1"># Initialize tolerance bounds.</span>
    <span class="k">if</span> <span class="n">config_str</span> <span class="ow">and</span> <span class="n">config_str</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="c1"># pylint: disable=eval-used</span>
        <span class="n">config_obj</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">config_str</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_obj</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Invalid configuration for check_average_cost: "</span>
                               <span class="s2">"must be a float"</span><span class="p">)</span>
        <span class="n">tolerance</span> <span class="o">=</span> <span class="n">config_obj</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tolerance</span> <span class="o">=</span> <span class="n">DEFAULT_TOLERANCE</span>
    <span class="n">min_tolerance</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tolerance</span><span class="p">)</span>
    <span class="n">max_tolerance</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">tolerance</span><span class="p">)</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ocmap</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_account_open_close</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="n">balances</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
                <span class="n">dopen</span> <span class="o">=</span> <span class="n">ocmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># Only process accounts with a NONE booking value.</span>
                <span class="k">if</span> <span class="n">dopen</span> <span class="ow">and</span> <span class="n">dopen</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">dopen</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">booking</span> <span class="o">==</span> <span class="n">Booking</span><span class="o">.</span><span class="n">NONE</span><span class="p">:</span>
                    <span class="n">balance</span> <span class="o">=</span> <span class="n">balances</span><span class="p">[(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                                        <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
                                        <span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">currency</span> <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span> <span class="o">&lt;</span> <span class="n">ZERO</span><span class="p">:</span>
                        <span class="n">average</span> <span class="o">=</span> <span class="n">balance</span><span class="o">.</span><span class="n">average</span><span class="p">()</span><span class="o">.</span><span class="n">get_only_position</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">average</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">number</span> <span class="o">=</span> <span class="n">average</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">number</span>
                            <span class="n">min_valid</span> <span class="o">=</span> <span class="n">number</span> <span class="o">*</span> <span class="n">min_tolerance</span>
                            <span class="n">max_valid</span> <span class="o">=</span> <span class="n">number</span> <span class="o">*</span> <span class="n">max_tolerance</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">min_valid</span> <span class="o">&lt;=</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">number</span> <span class="o">&lt;=</span> <span class="n">max_valid</span><span class="p">):</span>
                                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="n">MatchBasisError</span><span class="p">(</span>
                                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                                        <span class="p">(</span><span class="s2">"Cost basis on reducing posting is too far from "</span>
                                         <span class="s2">"the average cost (</span><span class="si">{}</span><span class="s2"> vs. </span><span class="si">{}</span><span class="s2">)"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                             <span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">average</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">number</span><span class="p">)),</span>
                                        <span class="n">entry</span><span class="p">))</span>
                    <span class="n">balance</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.check_closing">
<code>check_closing</code>
<a class="headerlink" href="#beancount.plugins.check_closing" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>A plugin that automatically inserts a balance check on a tagged closing posting.</p>
<p>Some postings are known to the user to be "closing trades", which means that the
resulting position of the instrument just after the trade should be zero. For
instance, this is the case for most ordinary options trading, only one lot of a
particular instrument is held, and eventually expires or gets sold off in its
entirely. One would like to confirm that, and the way to do this in Beancount is
to insert a balance check.</p>
<p>This plugin allows you to do that more simply, by inserting metadata. For
example, this transaction:</p>
<p>2018-02-16 * "SOLD -14 QQQ 100 16 FEB 18 160 CALL @5.31"
    Assets:US:Brokerage:Main:Options     -1400 QQQ180216C160 {2.70 USD} @ 5.31 USD
      closing: TRUE
    Expenses:Financial:Commissions       17.45 USD
    Expenses:Financial:Fees               0.42 USD
    Assets:US:Brokerage:Main:Cash      7416.13 USD
    Income:US:Brokerage:Main:PnL</p>
<p>Would expand into the following two directives:</p>
<p>2018-02-16 * "SOLD -14 QQQ 100 16 FEB 18 160 CALL @5.31"
    Assets:US:Brokerage:Main:Options     -1400 QQQ180216C160 {2.70 USD} @ 5.31 USD
    Expenses:Financial:Commissions       17.45 USD
    Expenses:Financial:Fees               0.42 USD
    Assets:US:Brokerage:Main:Cash      7416.13 USD
    Income:US:Brokerage:Main:PnL</p>
<p>2018-02-17 balance Assets:US:Brokerage:Main:Options  0 QQQ180216C160</p>
<p>Insert the closing line when you know you're closing the position.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.check_closing.check_closing">
<code class="highlight language-python">
check_closing<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.check_closing.check_closing" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Expand 'closing' metadata to a zero balance check.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/check_closing.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">check_closing</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Expand 'closing' metadata to a zero balance check.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">meta</span> <span class="ow">and</span> <span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'closing'</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="c1"># Remove the metadata.</span>
                    <span class="n">meta</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">del</span> <span class="n">meta</span><span class="p">[</span><span class="s1">'closing'</span><span class="p">]</span>
                    <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>

                    <span class="c1"># Insert a balance.</span>
                    <span class="n">date</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">balance</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Balance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s2">"&lt;check_closing&gt;"</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                           <span class="n">date</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                                           <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">ZERO</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">),</span>
                                           <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span>
        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="p">[]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.check_commodity">
<code>check_commodity</code>
<a class="headerlink" href="#beancount.plugins.check_commodity" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>A plugin that verifies that all seen commodities have a Commodity directive.</p>
<p>This is useful if you're a bit pedantic and like to make sure that you're
declared attributes for each of the commodities you use. It's useful if you use
the portfolio export, for example.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.check_commodity.CheckCommodityError">
<code>CheckCommodityError</code>
<a class="headerlink" href="#beancount.plugins.check_commodity.CheckCommodityError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>CheckCommodityError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.check_commodity.CheckCommodityError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.check_commodity.CheckCommodityError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/check_commodity.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.check_commodity.CheckCommodityError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.check_commodity.CheckCommodityError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of CheckCommodityError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.check_commodity.CheckCommodityError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.check_commodity.CheckCommodityError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/check_commodity.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.check_commodity.validate_commodity_directives">
<code class="highlight language-python">
validate_commodity_directives<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.check_commodity.validate_commodity_directives" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Find all commodities used and ensure they have a corresponding Commodity directive.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/check_commodity.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_commodity_directives</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Find all commodities used and ensure they have a corresponding Commodity directive.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">commodities_used</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s1">'commodities'</span><span class="p">]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;check_commodity&gt;'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">commodity_map</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_commodity_map</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">create_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="n">commodities_used</span><span class="p">:</span>
        <span class="n">commodity_entry</span> <span class="o">=</span> <span class="n">commodity_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">commodity_entry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">CheckCommodityError</span><span class="p">(</span>
                    <span class="n">meta</span><span class="p">,</span>
                    <span class="s2">"Missing Commodity directive for '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">currency</span><span class="p">),</span>
                    <span class="kc">None</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.coherent_cost">
<code>coherent_cost</code>
<a class="headerlink" href="#beancount.plugins.coherent_cost" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>This plugin validates that currencies held at cost aren't ever converted at
price and vice-versa. This is usually the case, and using it will prevent users
from making the mistake of selling a lot without specifying it via its cost
basis.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.coherent_cost.CoherentCostError">
<code>CoherentCostError</code>
<a class="headerlink" href="#beancount.plugins.coherent_cost.CoherentCostError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>CoherentCostError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.coherent_cost.CoherentCostError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.coherent_cost.CoherentCostError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/coherent_cost.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.coherent_cost.CoherentCostError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.coherent_cost.CoherentCostError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of CoherentCostError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.coherent_cost.CoherentCostError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.coherent_cost.CoherentCostError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/coherent_cost.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.coherent_cost.validate_coherent_cost">
<code class="highlight language-python">
validate_coherent_cost<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.coherent_cost.validate_coherent_cost" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check that all currencies are either used at cost or not at all, but never both.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/coherent_cost.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_coherent_cost</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
    <span class="sd">"""Check that all currencies are either used at cost or not at all, but never both.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">with_cost</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">without_cost</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">filter_txns</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="n">target_set</span> <span class="o">=</span> <span class="n">without_cost</span> <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">with_cost</span>
            <span class="n">currency</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span>
            <span class="n">target_set</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">with_cost</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">without_cost</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">CoherentCostError</span><span class="p">(</span>
                <span class="n">without_cost</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                <span class="s2">"Currency '</span><span class="si">{}</span><span class="s2">' is used both with and without cost"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">currency</span><span class="p">),</span>
                <span class="n">with_cost</span><span class="p">[</span><span class="n">currency</span><span class="p">]))</span>
        <span class="c1"># Note: We really ought to include both of the first transactions here.</span>

    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.commodity_attr">
<code>commodity_attr</code>
<a class="headerlink" href="#beancount.plugins.commodity_attr" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>A plugin that asserts that all Commodity directives have a particular
attribute and that it is part of a set of enum values.</p>
<p>The configuration must be a mapping of attribute name to list of valid values,
like this:</p>
<p>plugin "beancount.plugins.commodity_attr" "{
    'sector': ['Technology', 'Financials', 'Energy'],
    'name': None,
  }"</p>
<p>The plugin issues an error if a Commodity directive is missing the attribute, or
if the attribute value is not in the valid set. If you'd like to just ensure the
attribute is set, set the list of valid values to None, as in the 'name'
attribute in the example above.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.commodity_attr.CommodityError">
<code>CommodityError</code>
<a class="headerlink" href="#beancount.plugins.commodity_attr.CommodityError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>CommodityError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.commodity_attr.CommodityError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.commodity_attr.CommodityError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/commodity_attr.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.commodity_attr.CommodityError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.commodity_attr.CommodityError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of CommodityError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.commodity_attr.CommodityError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.commodity_attr.CommodityError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/commodity_attr.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.commodity_attr.ConfigError">
<code>ConfigError</code>
<a class="headerlink" href="#beancount.plugins.commodity_attr.ConfigError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>ConfigError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.commodity_attr.ConfigError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.commodity_attr.ConfigError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/commodity_attr.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.commodity_attr.ConfigError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.commodity_attr.ConfigError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of ConfigError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.commodity_attr.ConfigError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.commodity_attr.ConfigError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/commodity_attr.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.commodity_attr.validate_commodity_attr">
<code class="highlight language-python">
validate_commodity_attr<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">,</span> <span class="n">config_str</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.commodity_attr.validate_commodity_attr" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check that all Commodity directives have a valid attribute.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>config_str</code></td>
<td><code></code></td>
<td>
<p>A configuration string.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/commodity_attr.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_commodity_attr</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">,</span> <span class="n">config_str</span><span class="p">):</span>
    <span class="sd">"""Check that all Commodity directives have a valid attribute.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">      config_str: A configuration string.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># pylint: disable=eval-used</span>
    <span class="n">config_obj</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">config_str</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConfigError</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;commodity_attr&gt;'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">"Invalid configuration for commodity_attr plugin; skipping."</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>

    <span class="n">validmap</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">config_obj</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Commodity</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">validmap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommodityError</span><span class="p">(</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                    <span class="s2">"Missing attribute '</span><span class="si">{}</span><span class="s2">' for Commodity directive </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">attr</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">currency</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">values</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CommodityError</span><span class="p">(</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                    <span class="s2">"Invalid attribute '</span><span class="si">{}</span><span class="s2">' for Commodity"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">" directive </span><span class="si">{}</span><span class="s2">; valid options: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span> <span class="kc">None</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.currency_accounts">
<code>currency_accounts</code>
<a class="headerlink" href="#beancount.plugins.currency_accounts" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>An implementation of currency accounts.</p>
<p>This is an automatic implementation of the method described here:
https://www.mathstat.dal.ca/~selinger/accounting/tutorial.html</p>
<p>You enable it just like this:</p>
<p>plugin "beancount.plugins.currency_accounts" "Equity:CurrencyAcccounts"</p>
<p>Accounts will be automatically created under the given base account, with the
currency name appended to it, e.g.,</p>
<p>Equity:CurrencyAcccounts:CAD
  Equity:CurrencyAcccounts:USD</p>
<p>etc., where used. You can have a look at the account balances with a query like
this:</p>
<p>bean-query $L "select account, sum(position), convert(sum(position), 'USD')
                 where date &gt;= 2018-01-01 and  account ~ 'CurrencyAccounts' "</p>
<p>The sum total of the converted amounts should be a number not too large:</p>
<p>bean-query $L "select convert(sum(position), 'USD')
                 where date &gt;= 2018-01-01 and  account ~ 'CurrencyAccounts'"</p>
<p>WARNING: This is a prototype. Note the FIXMEs in the code below, which indicate
some potential problems.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.currency_accounts.get_neutralizing_postings">
<code class="highlight language-python">
get_neutralizing_postings<span class="p">(</span><span class="n">curmap</span><span class="p">,</span> <span class="n">base_account</span><span class="p">,</span> <span class="n">new_accounts</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.currency_accounts.get_neutralizing_postings" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Process an entry.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>curmap</code></td>
<td><code></code></td>
<td>
<p>A dict of currency to a list of Postings of this transaction.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>base_account</code></td>
<td><code></code></td>
<td>
<p>A string, the root account name to insert.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>new_accounts</code></td>
<td><code></code></td>
<td>
<p>A set, a mutable accumulator of new account names.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A modified entry, with new postings inserted to rebalance currency trading
accounts.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/currency_accounts.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_neutralizing_postings</span><span class="p">(</span><span class="n">curmap</span><span class="p">,</span> <span class="n">base_account</span><span class="p">,</span> <span class="n">new_accounts</span><span class="p">):</span>
    <span class="sd">"""Process an entry.</span>

<span class="sd">    Args:</span>
<span class="sd">      curmap: A dict of currency to a list of Postings of this transaction.</span>
<span class="sd">      base_account: A string, the root account name to insert.</span>
<span class="sd">      new_accounts: A set, a mutable accumulator of new account names.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A modified entry, with new postings inserted to rebalance currency trading</span>
<span class="sd">      accounts.</span>
<span class="sd">    """</span>
    <span class="n">new_postings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">postings</span> <span class="ow">in</span> <span class="n">curmap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Compute the per-currency balance.</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">postings</span><span class="p">:</span>
            <span class="n">inv</span><span class="o">.</span><span class="n">add_amount</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">get_cost</span><span class="p">(</span><span class="n">posting</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">inv</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">new_postings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">postings</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Re-insert original postings and remove price conversions.</span>
        <span class="c1">#</span>
        <span class="c1"># Note: This may cause problems if the implicit_prices plugin is</span>
        <span class="c1"># configured to run after this one, or if you need the price annotations</span>
        <span class="c1"># for some scripting or serious work.</span>
        <span class="c1">#</span>
        <span class="c1"># FIXME: We need to handle these important cases (they're not frivolous,</span>
        <span class="c1"># this is a prototype), probably by inserting some exceptions with</span>
        <span class="c1"># collaborating code in the booking (e.g. insert some metadata that</span>
        <span class="c1"># disables price conversions on those postings).</span>
        <span class="c1">#</span>
        <span class="c1"># FIXME(2): Ouch! Some of the residual seeps through here, where there</span>
        <span class="c1"># are more than a single currency block. This needs fixing too. You can</span>
        <span class="c1"># easily mitigate some of this to some extent, by excluding transactions</span>
        <span class="c1"># which don't have any price conversion in them.</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">postings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

        <span class="c1"># Insert the currency trading accounts postings.</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="n">inv</span><span class="o">.</span><span class="n">get_only_position</span><span class="p">()</span><span class="o">.</span><span class="n">units</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_account</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
        <span class="n">new_accounts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
        <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Posting</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="o">-</span><span class="n">amount</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">new_postings</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.currency_accounts.group_postings_by_weight_currency">
<code class="highlight language-python">
group_postings_by_weight_currency<span class="p">(</span><span class="n">entry</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.currency_accounts.group_postings_by_weight_currency" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return where this entry might require adjustment.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/currency_accounts.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">group_postings_by_weight_currency</span><span class="p">(</span><span class="n">entry</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">):</span>
    <span class="sd">"""Return where this entry might require adjustment."""</span>
    <span class="n">curmap</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">has_price</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
        <span class="n">currency</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span>
        <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="p">:</span>
            <span class="n">currency</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">currency</span>
            <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="n">currency</span>
            <span class="k">elif</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="p">:</span>
                <span class="n">has_price</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">currency</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">currency</span>
        <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="p">:</span>
            <span class="n">has_price</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">curmap</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">curmap</span><span class="p">,</span> <span class="n">has_price</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.currency_accounts.insert_currency_trading_postings">
<code class="highlight language-python">
insert_currency_trading_postings<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.currency_accounts.insert_currency_trading_postings" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Insert currency trading postings.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>config</code></td>
<td><code></code></td>
<td>
<p>The base account name for currency trading accounts.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/currency_accounts.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">insert_currency_trading_postings</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="sd">"""Insert currency trading postings.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">      config: The base account name for currency trading accounts.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">base_account</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">account</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">base_account</span><span class="p">):</span>
        <span class="n">base_account</span> <span class="o">=</span> <span class="n">DEFAULT_BASE_ACCOUNT</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_accounts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">):</span>
            <span class="n">curmap</span><span class="p">,</span> <span class="n">has_price</span> <span class="o">=</span> <span class="n">group_postings_by_weight_currency</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_price</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">curmap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">new_postings</span> <span class="o">=</span> <span class="n">get_neutralizing_postings</span><span class="p">(</span>
                    <span class="n">curmap</span><span class="p">,</span> <span class="n">base_account</span><span class="p">,</span> <span class="n">new_accounts</span><span class="p">)</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">postings</span><span class="o">=</span><span class="n">new_postings</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">META_PROCESSED</span><span class="p">:</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">META_PROCESSED</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="n">earliest_date</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span>
    <span class="n">open_entries</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;currency_accounts&gt;'</span><span class="p">,</span> <span class="n">index</span><span class="p">),</span>
                  <span class="n">earliest_date</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">acc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">new_accounts</span><span class="p">))]</span>

    <span class="k">return</span> <span class="n">open_entries</span> <span class="o">+</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.divert_expenses">
<code>divert_expenses</code>
<a class="headerlink" href="#beancount.plugins.divert_expenses" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>For tagged transactions, convert expenses to a single account.</p>
<p>This plugin allows you to select a tag and it automatically converts all the
Expenses postings to use a single account. For example, with this input:</p>
<p>plugin "divert_expenses" "['kid', 'Expenses:Child']"</p>
<p>2018-01-28 * "CVS" "Formula" #kid
    Liabilities:CreditCard      -10.27 USD
    Expenses:Food:Grocery        10.27 USD</p>
<p>It will output:</p>
<p>2018-01-28 * "CVS" "Formula" #kid
    Liabilities:CreditCard      -10.27 USD
    Expenses:Child               10.27 USD</p>
<p>You can limit the diversion to one posting only, like this:</p>
<p>2018-05-05 * "CVS/PHARMACY" "" #kai
    Liabilities:CreditCard        -66.38 USD
    Expenses:Pharmacy              21.00 USD  ;; Vitamins for Kai
    Expenses:Pharmacy              45.38 USD
      divert: FALSE</p>
<p>See unit test for details.</p>
<p>See this thread for context:
https://docs.google.com/drawings/d/18fTrrGlmz0jFbfcGGHTffbdRwbmST8r9_3O26Dd1Xww/edit?usp=sharing</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.divert_expenses.divert_expenses">
<code class="highlight language-python">
divert_expenses<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config_str</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.divert_expenses.divert_expenses" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Divert expenses.</p>
<p>Explicit price entries are simply maintained in the output list. Prices from
postings with costs or with prices from Transaction entries are synthesized
as new Price entries in the list of entries output.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives. We're interested only in the Transaction instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>A parser options dict.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>config_str</code></td>
<td><code></code></td>
<td>
<p>A configuration string, which is intended to be a list of two strings,
a tag, and an account to replace expenses with.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A modified list of entries.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/divert_expenses.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">divert_expenses</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config_str</span><span class="p">):</span>
    <span class="sd">"""Divert expenses.</span>

<span class="sd">    Explicit price entries are simply maintained in the output list. Prices from</span>
<span class="sd">    postings with costs or with prices from Transaction entries are synthesized</span>
<span class="sd">    as new Price entries in the list of entries output.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives. We're interested only in the Transaction instances.</span>
<span class="sd">      options_map: A parser options dict.</span>
<span class="sd">      config_str: A configuration string, which is intended to be a list of two strings,</span>
<span class="sd">        a tag, and an account to replace expenses with.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A modified list of entries.</span>
<span class="sd">    """</span>
    <span class="c1"># pylint: disable=eval-used</span>
    <span class="n">config_obj</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">config_str</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Invalid plugin configuration: should be a single dict."</span><span class="p">)</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">config_obj</span><span class="p">[</span><span class="s1">'tag'</span><span class="p">]</span>
    <span class="n">replacement_account</span> <span class="o">=</span> <span class="n">config_obj</span><span class="p">[</span><span class="s1">'account'</span><span class="p">]</span>

    <span class="n">acctypes</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_account_types</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>

    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">replace_expenses_accounts</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">replacement_account</span><span class="p">,</span> <span class="n">acctypes</span><span class="p">)</span>
        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.divert_expenses.replace_expenses_accounts">
<code class="highlight language-python">
replace_expenses_accounts<span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">replacement_account</span><span class="p">,</span> <span class="n">acctypes</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.divert_expenses.replace_expenses_accounts" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Replace the Expenses accounts from the entry.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entry</code></td>
<td><code></code></td>
<td>
<p>A Transaction directive.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>replacement_account</code></td>
<td><code></code></td>
<td>
<p>A string, the account to use for replacement.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>acctypes</code></td>
<td><code></code></td>
<td>
<p>An AccountTypes instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A possibly entry directive.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/divert_expenses.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">replace_expenses_accounts</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">replacement_account</span><span class="p">,</span> <span class="n">acctypes</span><span class="p">):</span>
    <span class="sd">"""Replace the Expenses accounts from the entry.</span>

<span class="sd">    Args:</span>
<span class="sd">      entry: A Transaction directive.</span>
<span class="sd">      replacement_account: A string, the account to use for replacement.</span>
<span class="sd">      acctypes: An AccountTypes instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A possibly entry directive.</span>
<span class="sd">    """</span>
    <span class="n">new_postings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">account_types</span><span class="o">.</span><span class="n">is_account_type</span><span class="p">(</span><span class="n">acctypes</span><span class="o">.</span><span class="n">expenses</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'divert'</span><span class="p">,</span> <span class="kc">True</span><span class="p">)):</span>
            <span class="n">posting</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">account</span><span class="o">=</span><span class="n">replacement_account</span><span class="p">,</span>
                                       <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">'diverted_account'</span><span class="p">:</span> <span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">})</span>
        <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">postings</span><span class="o">=</span><span class="n">new_postings</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.exclude_tag">
<code>exclude_tag</code>
<a class="headerlink" href="#beancount.plugins.exclude_tag" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Exclude #virtual tags.</p>
<p>This is used to demonstrate excluding a set of transactions from a particular
tag. In this example module, the tag name is fixed, but if we integrated this we
could provide a way to choose which tags to exclude. This is simply just another
mechanism for selecting a subset of transactions.</p>
<p>See discussion here for details:
https://groups.google.com/d/msg/ledger-cli/N8Slh2t45K0/aAz0i3Be4LYJ</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.exclude_tag.exclude_tag">
<code class="highlight language-python">
exclude_tag<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.exclude_tag.exclude_tag" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Select all transactions that do not have a #virtual tag.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of entry instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>A dict of options parsed from the file.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A tuple of entries and errors.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/exclude_tag.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">exclude_tag</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Select all transactions that do not have a #virtual tag.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of entry instances.</span>
<span class="sd">      options_map: A dict of options parsed from the file.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A tuple of entries and errors.</span>
<span class="sd">    """</span>
    <span class="n">filtered_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span>
                        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span>
                        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">or</span>
                            <span class="ow">not</span> <span class="n">entry</span><span class="o">.</span><span class="n">tags</span> <span class="ow">or</span>
                            <span class="n">EXCLUDED_TAG</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">tags</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">filtered_entries</span><span class="p">,</span> <span class="p">[])</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.fill_account">
<code>fill_account</code>
<a class="headerlink" href="#beancount.plugins.fill_account" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Insert an posting with a default account when there is only a single posting.</p>
<p>This is convenient to use in files which have mostly expenses, such as during a trip.
Set the name of the default account to fill in as an option.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.fill_account.FillAccountError">
<code>FillAccountError</code>
<a class="headerlink" href="#beancount.plugins.fill_account.FillAccountError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>FillAccountError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.fill_account.FillAccountError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.fill_account.FillAccountError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/fill_account.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.fill_account.FillAccountError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.fill_account.FillAccountError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of FillAccountError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.fill_account.FillAccountError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.fill_account.FillAccountError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/fill_account.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.fill_account.fill_account">
<code class="highlight language-python">
fill_account<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">,</span> <span class="n">insert_account</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.fill_account.fill_account" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Insert an posting with a default account when there is only a single posting.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>A parser options dict.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>insert_account</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the account.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of entries, possibly with more Price entries than before, and a
list of errors.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/fill_account.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">fill_account</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">,</span> <span class="n">insert_account</span><span class="p">):</span>
    <span class="sd">"""Insert an posting with a default account when there is only a single posting.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: A parser options dict.</span>
<span class="sd">      insert_account: A string, the name of the account.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of entries, possibly with more Price entries than before, and a</span>
<span class="sd">      list of errors.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">account</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">insert_account</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="p">[</span>
            <span class="n">FillAccountError</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;fill_account&gt;'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                             <span class="s2">"Invalid account name: '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">insert_account</span><span class="p">),</span>
                             <span class="kc">None</span><span class="p">)]</span>

    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">inv</span><span class="o">.</span><span class="n">add_amount</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inv</span><span class="o">.</span><span class="n">add_amount</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">get_cost</span><span class="p">(</span><span class="n">posting</span><span class="p">))</span>
            <span class="n">inv</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">get_units</span><span class="p">)</span>
            <span class="n">new_postings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">inv</span><span class="p">:</span>
                <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">insert_account</span><span class="p">,</span> <span class="o">-</span><span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                                                 <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">postings</span><span class="o">=</span><span class="n">new_postings</span><span class="p">)</span>
        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="p">[]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.fix_payees">
<code>fix_payees</code>
<a class="headerlink" href="#beancount.plugins.fix_payees" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Rename payees based on a set of rules.</p>
<p>This can be used to clean up dirty imported payee names.</p>
<p>This plugin accepts a list of rules in this format:</p>
<p>plugin "beancount.plugins.fix_payees" "[
      (PAYEE, MATCH1, MATCH2, ...),
  ]"</p>
<p>Each of the "MATCH" clauses is a string, in the format:</p>
<p>"A:&lt;regexp&gt;" : Match the account name.
  "D:&lt;regexp&gt;" : Match the payee or the narration.</p>
<p>The plugin matches the Transactions in the file and if there is a
case-insensitive match against the regular expression (we use re.search()),
replaces the payee name by "PAYEE". If multiple rules match, only the first rule
is used.</p>
<p>For example:</p>
<p>plugin "beancount.plugins.fix_payees" "[</p>
<pre><code>  ("T-Mobile USA",
   "A:Expenses:Communications:Phone",
   "D:t-mobile"),

  ("Con Edison",
   "A:Expenses:Home:Electricity",
   "D:con ?ed"),

  ("Birreria @ Eataly",
   "D:EATALY BIRRERIA"),
</code></pre>
<p>]"</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.fix_payees.FixPayeesError">
<code>FixPayeesError</code>
<a class="headerlink" href="#beancount.plugins.fix_payees.FixPayeesError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>FixPayeesError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.fix_payees.FixPayeesError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.fix_payees.FixPayeesError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/fix_payees.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.fix_payees.FixPayeesError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.fix_payees.FixPayeesError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of FixPayeesError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.fix_payees.FixPayeesError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.fix_payees.FixPayeesError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/fix_payees.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.fix_payees.fix_payees">
<code class="highlight language-python">
fix_payees<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.fix_payees.fix_payees" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Rename payees based on a set of rules. See module docstring for details.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>a list of entry instances</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>a dict of options parsed from the file</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>config</code></td>
<td><code></code></td>
<td>
<p>A configuration string, which is intended to be a list of
(PAYEE, MATCH, ...) rules. See module docstring for details.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A tuple of entries and errors.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/fix_payees.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">fix_payees</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="sd">"""Rename payees based on a set of rules. See module docstring for details.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: a list of entry instances</span>
<span class="sd">      options_map: a dict of options parsed from the file</span>
<span class="sd">      config: A configuration string, which is intended to be a list of</span>
<span class="sd">        (PAYEE, MATCH, ...) rules. See module docstring for details.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A tuple of entries and errors.</span>
<span class="sd">    """</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">options_map</span><span class="p">[</span><span class="s1">'filename'</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FixPayeesError</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span>
                                         <span class="s2">"Syntax error in config: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">),</span>
                                         <span class="kc">None</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>

    <span class="c1"># Pre-compile the regular expressions for performance.</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
        <span class="n">new_payee</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">clauses</span><span class="p">)</span>
        <span class="n">regexps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">clauses</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">'([AD]):(.*)'</span><span class="p">,</span> <span class="n">clause</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">options_map</span><span class="p">[</span><span class="s1">'filename'</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FixPayeesError</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span>
                                             <span class="s2">"Invalid clause: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clause</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">command</span><span class="p">,</span> <span class="n">regexp</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">regexps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">command</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regexp</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">))</span>
        <span class="n">new_rule</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_payee</span><span class="p">]</span> <span class="o">+</span> <span class="n">regexps</span>
        <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_rule</span><span class="p">))</span>

    <span class="c1"># Run the rules over the transaction objects.</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">replaced_entries</span> <span class="o">=</span> <span class="p">{</span><span class="n">rule</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                <span class="n">clauses</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
                <span class="n">new_payee</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">clauses</span><span class="p">)</span>

                <span class="c1"># Attempt to match all the clauses.</span>
                <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">clauses</span><span class="p">:</span>
                    <span class="n">command</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">clause</span>
                    <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">'D'</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">entry</span><span class="o">.</span><span class="n">payee</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">func</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">payee</span><span class="p">))</span> <span class="ow">or</span>
                                <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">narration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">func</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">narration</span><span class="p">))):</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">'A'</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">)</span> <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">):</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Make the replacement.</span>
                    <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">payee</span><span class="o">=</span><span class="n">new_payee</span><span class="p">)</span>
                    <span class="n">replaced_entries</span><span class="p">[</span><span class="n">new_payee</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_DEBUG</span><span class="p">:</span>
        <span class="c1"># Print debugging info.</span>
        <span class="k">for</span> <span class="n">payee</span><span class="p">,</span> <span class="n">repl_entries</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">replaced_entries</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                          <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                          <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="si">{:60}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">payee</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">repl_entries</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.fix_payees_test">
<code>fix_payees_test</code>
<a class="headerlink" href="#beancount.plugins.fix_payees_test" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.fix_payees_test.TestFixPayees">
<code>TestFixPayees</code>
<a class="headerlink" href="#beancount.plugins.fix_payees_test.TestFixPayees" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.fix_payees_test.TestFixPayees.fix">
<code class="highlight language-python">
fix<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.fix_payees_test.TestFixPayees.fix" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Apply the fixing process.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/fix_payees_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>31
32
33</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="s2">"Apply the fixing process."</span>
    <span class="k">return</span> <span class="n">fix_payees</span><span class="o">.</span><span class="n">fix_payees</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_entries</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_map</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.fix_payees_test.TestFixPayees.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.fix_payees_test.TestFixPayees.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/fix_payees_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="nd">@loader</span><span class="o">.</span><span class="n">load_doc</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    2014-01-01 open Liabilities:CreditCard</span>
<span class="sd">    2014-01-01 open Expenses:Car-Rental</span>

<span class="sd">    2014-02-01 * "BIGAP  NEW YO" "Another Luxury Rental"</span>
<span class="sd">      Liabilities:CreditCard     -293.23 USD</span>
<span class="sd">      Expenses:Car-Rental</span>

<span class="sd">    2014-02-01 * "Big Apple Rental Co" "Another Luxury Rental"</span>
<span class="sd">      Liabilities:CreditCard     -293.23 USD</span>
<span class="sd">      Expenses:Car-Rental</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">options_map</span> <span class="o">=</span> <span class="n">options_map</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">in_entries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exp_entries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_entries</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_entries</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.forecast">
<code>forecast</code>
<a class="headerlink" href="#beancount.plugins.forecast" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>An example of adding a forecasting feature to Beancount via a plugin.</p>
<p>This entry filter plugin uses existing syntax to define and automatically
inserted transactions in the future based on a convention. It serves mostly as
an example of how you can experiment by creating and installing a local filter,
and not so much as a serious forecasting feature (though the experiment is a
good way to get something more general kickstarted eventually, I think the
concept would generalize nicely and should eventually be added as a common
feature of Beancount).</p>
<p>A user can create a transaction like this:</p>
<p>2014-03-08 # "Electricity bill [MONTHLY]"
    Expenses:Electricity                        50.10 USD
    Assets:Checking                            -50.10 USD</p>
<p>and new transactions will be created monthly for the following year.
Note the use of the '#' flag and the word 'MONTHLY' which defines the
periodicity.</p>
<p>The number of recurrences can optionally be specified either by providing an
end date or by specifying the number of times that the transaction will be
repeated. For example:</p>
<p>2014-03-08 # "Electricity bill [MONTHLY UNTIL 2019-12-31]"
    Expenses:Electricity                        50.10 USD
    Assets:Checking                            -50.10 USD</p>
<p>2014-03-08 # "Electricity bill [MONTHLY REPEAT 10 TIMES]"
    Expenses:Electricity                        50.10 USD
    Assets:Checking                            -50.10 USD</p>
<p>Transactions can also be repeated at yearly intervals, e.g.:</p>
<p>2014-03-08 # "Electricity bill [YEARLY REPEAT 10 TIMES]"
    Expenses:Electricity                        50.10 USD
    Assets:Checking                            -50.10 USD</p>
<p>Other examples:</p>
<p>2014-03-08 # "Electricity bill [WEEKLY SKIP 1 TIME REPEAT 10 TIMES]"
    Expenses:Electricity                        50.10 USD
    Assets:Checking                            -50.10 USD</p>
<p>2014-03-08 # "Electricity bill [DAILY SKIP 3 TIMES REPEAT 1 TIME]"
    Expenses:Electricity                        50.10 USD
    Assets:Checking                            -50.10 USD</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.forecast.forecast_plugin">
<code class="highlight language-python">
forecast_plugin<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.forecast.forecast_plugin" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>An example filter that piggybacks on top of the Beancount input syntax to
insert forecast entries automatically. This functions accepts the return
value of beancount.loader.load_file() and must return the same type of output.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>a list of entry instances</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>a dict of options parsed from the file</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A tuple of entries and errors.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/forecast.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">forecast_plugin</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""An example filter that piggybacks on top of the Beancount input syntax to</span>
<span class="sd">    insert forecast entries automatically. This functions accepts the return</span>
<span class="sd">    value of beancount.loader.load_file() and must return the same type of output.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: a list of entry instances</span>
<span class="sd">      options_map: a dict of options parsed from the file</span>
<span class="sd">    Returns:</span>
<span class="sd">      A tuple of entries and errors.</span>
<span class="sd">    """</span>

    <span class="c1"># Find the last entry's date.</span>
    <span class="n">date_today</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span>

    <span class="c1"># Filter out forecast entries from the list of valid entries.</span>
    <span class="n">forecast_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filtered_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="n">outlist</span> <span class="o">=</span> <span class="p">(</span><span class="n">forecast_entries</span>
                   <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">flag</span> <span class="o">==</span> <span class="s1">'#'</span><span class="p">)</span>
                   <span class="k">else</span> <span class="n">filtered_entries</span><span class="p">)</span>
        <span class="n">outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="c1"># Generate forecast entries up to the end of the current year.</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">forecast_entries</span><span class="p">:</span>
        <span class="c1"># Parse the periodicity.</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'(^.*)\[(MONTHLY|YEARLY|WEEKLY|DAILY)'</span>
                          <span class="sa">r</span><span class="s1">'(\s+SKIP\s+([1-9][0-9]*)\s+TIME.?)'</span>
                          <span class="sa">r</span><span class="s1">'?(\s+REPEAT\s+([1-9][0-9]*)\s+TIME.?)'</span>
                          <span class="sa">r</span><span class="s1">'?(\s+UNTIL\s+([0-9\-]+))?\]'</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">narration</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">forecast_narration</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">forecast_interval</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rrule</span><span class="o">.</span><span class="n">YEARLY</span> <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'YEARLY'</span>
            <span class="k">else</span> <span class="n">rrule</span><span class="o">.</span><span class="n">WEEKLY</span> <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'WEEKLY'</span>
            <span class="k">else</span> <span class="n">rrule</span><span class="o">.</span><span class="n">DAILY</span> <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'DAILY'</span>
            <span class="k">else</span> <span class="n">rrule</span><span class="o">.</span><span class="n">MONTHLY</span><span class="p">)</span>
        <span class="n">forecast_periodicity</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'dtstart'</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>  <span class="c1"># e.g., [MONTHLY REPEAT 3 TIMES]:</span>
            <span class="n">forecast_periodicity</span><span class="p">[</span><span class="s1">'count'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>  <span class="c1"># e.g., [MONTHLY UNTIL 2020-01-01]:</span>
            <span class="n">forecast_periodicity</span><span class="p">[</span><span class="s1">'until'</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="s1">'%Y-%m-</span><span class="si">%d</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># e.g., [MONTHLY]</span>
            <span class="n">forecast_periodicity</span><span class="p">[</span><span class="s1">'until'</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="c1"># SKIP</span>
            <span class="n">forecast_periodicity</span><span class="p">[</span><span class="s1">'interval'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Generate a new entry for each forecast date.</span>
        <span class="n">forecast_dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">rrule</span><span class="o">.</span><span class="n">rrule</span><span class="p">(</span><span class="n">forecast_interval</span><span class="p">,</span>
                                                          <span class="o">**</span><span class="n">forecast_periodicity</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">forecast_date</span> <span class="ow">in</span> <span class="n">forecast_dates</span><span class="p">:</span>
            <span class="n">forecast_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">forecast_date</span><span class="p">,</span>
                                            <span class="n">narration</span><span class="o">=</span><span class="n">forecast_narration</span><span class="p">)</span>
            <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">forecast_entry</span><span class="p">)</span>

    <span class="c1"># Make sure the new entries inserted are sorted.</span>
    <span class="n">new_entries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">entry_sortkey</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">filtered_entries</span> <span class="o">+</span> <span class="n">new_entries</span><span class="p">,</span> <span class="p">[])</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.implicit_prices">
<code>implicit_prices</code>
<a class="headerlink" href="#beancount.plugins.implicit_prices" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>This plugin synthesizes Price directives for all Postings with a price or
directive or if it is an augmenting posting, has a cost directive.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.implicit_prices.ImplicitPriceError">
<code>ImplicitPriceError</code>
<a class="headerlink" href="#beancount.plugins.implicit_prices.ImplicitPriceError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>ImplicitPriceError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.implicit_prices.ImplicitPriceError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.implicit_prices.ImplicitPriceError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/implicit_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.implicit_prices.ImplicitPriceError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.implicit_prices.ImplicitPriceError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of ImplicitPriceError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.implicit_prices.ImplicitPriceError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.implicit_prices.ImplicitPriceError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/implicit_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.implicit_prices.add_implicit_prices">
<code class="highlight language-python">
add_implicit_prices<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.implicit_prices.add_implicit_prices" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Insert implicitly defined prices from Transactions.</p>
<p>Explicit price entries are simply maintained in the output list. Prices from
postings with costs or with prices from Transaction entries are synthesized
as new Price entries in the list of entries output.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives. We're interested only in the Transaction instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>A parser options dict.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of entries, possibly with more Price entries than before, and a
list of errors.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/implicit_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">add_implicit_prices</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
    <span class="sd">"""Insert implicitly defined prices from Transactions.</span>

<span class="sd">    Explicit price entries are simply maintained in the output list. Prices from</span>
<span class="sd">    postings with costs or with prices from Transaction entries are synthesized</span>
<span class="sd">    as new Price entries in the list of entries output.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives. We're interested only in the Transaction instances.</span>
<span class="sd">      unused_options_map: A parser options dict.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of entries, possibly with more Price entries than before, and a</span>
<span class="sd">      list of errors.</span>
<span class="sd">    """</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># A dict of (date, currency, cost-currency) to price entry.</span>
    <span class="n">new_price_entry_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">balances</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="c1"># Always replicate the existing entries.</span>
        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">):</span>
            <span class="c1"># Inspect all the postings in the transaction.</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span>

                <span class="c1"># Check if the position is matching against an existing</span>
                <span class="c1"># position.</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">booking</span> <span class="o">=</span> <span class="n">balances</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">]</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>

                <span class="c1"># Add prices when they're explicitly specified on a posting. An</span>
                <span class="c1"># explicitly specified price may occur in a conversion, e.g.</span>
                <span class="c1">#      Assets:Account    100 USD @ 1.10 CAD</span>
                <span class="c1"># or, if a cost is also specified, as the current price of the</span>
                <span class="c1"># underlying instrument, e.g.</span>
                <span class="c1">#      Assets:Account    100 HOOL {564.20} @ {581.97} USD</span>
                <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">"filename"</span><span class="p">],</span> <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">"lineno"</span><span class="p">])</span>
                    <span class="n">price_entry</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Price</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                                             <span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
                                             <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>

                <span class="c1"># Add costs, when we're not matching against an existing</span>
                <span class="c1"># position. This happens when we're just specifying the cost,</span>
                <span class="c1"># e.g.</span>
                <span class="c1">#      Assets:Account    100 HOOL {564.20}</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                      <span class="n">booking</span> <span class="o">!=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">Booking</span><span class="o">.</span><span class="n">REDUCED</span><span class="p">):</span>
                    <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">"filename"</span><span class="p">],</span> <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">"lineno"</span><span class="p">])</span>
                    <span class="n">price_entry</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Price</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                                             <span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
                                             <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">cost</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                                           <span class="n">cost</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">price_entry</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">price_entry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">price_entry</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                           <span class="n">price_entry</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
                           <span class="n">price_entry</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>  <span class="c1"># Ideally should be removed.</span>
                           <span class="n">price_entry</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_price_entry_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                        <span class="c1">## Do not fail for now. We still have many valid use</span>
                        <span class="c1">## cases of duplicate prices on the same date, for</span>
                        <span class="c1">## example, stock splits, or trades on two dates with</span>
                        <span class="c1">## two separate reported prices. We need to figure out a</span>
                        <span class="c1">## more elegant solution for this in the long term.</span>
                        <span class="c1">## Keeping both for now. We should ideally not use the</span>
                        <span class="c1">## number in the de-dup key above.</span>
                        <span class="c1">#</span>
                        <span class="c1"># dup_entry = new_price_entry_map[key]</span>
                        <span class="c1"># if price_entry.amount.number == dup_entry.amount.number:</span>
                        <span class="c1">#     # Skip duplicates.</span>
                        <span class="c1">#     continue</span>
                        <span class="c1"># else:</span>
                        <span class="c1">#     errors.append(</span>
                        <span class="c1">#         ImplicitPriceError(</span>
                        <span class="c1">#             entry.meta,</span>
                        <span class="c1">#             "Duplicate prices for {} on {}".format(entry,</span>
                        <span class="c1">#                                                    dup_entry),</span>
                        <span class="c1">#             entry))</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">new_price_entry_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_entry</span>
                        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price_entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.ira_contribs">
<code>ira_contribs</code>
<a class="headerlink" href="#beancount.plugins.ira_contribs" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Automatically adding IRA contributions postings.</p>
<p>This plugin looks for increasing postings on specified accounts ('+' sign for
Assets and Expenses accounts, '-' sign for the others), or postings with a
particular flag on them and when it finds some, inserts a pair of postings on
that transaction of the corresponding amounts in a different currency. The
currency is intended to be an imaginary currency used to track the number of
dollars contributed to a retirement account over time.</p>
<p>For example, a possible configuration could be:</p>
<p>plugin "beancount.plugins.ira_contribs" "{
      'currency': 'IRAUSD',
      'flag': 'M',
      'accounts': {</p>
<pre><code>      'Income:US:Acme:Match401k': (
          'Assets:US:Federal:Match401k',
          'Expenses:Taxes:TY{year}:US:Federal:Match401k'),

      ('C', 'Assets:US:Fidelity:PreTax401k:Cash'): (
          'Assets:US:Federal:PreTax401k',
          'Expenses:Taxes:TY{year}:US:Federal:PreTax401k'),
   }
</code></pre>
<p>}"</p>
<p>Note: In this example, the configuration that triggers on the
"Income:US:Acme:Match401k" account does not require a flag for those accounts;
the configuration for the "Assets:US:Fidelity:PreTax401k:Cash" account requires
postings to have a "C" flag to trigger an insertion.</p>
<p>Given a transaction like the following, which would be typical for a salary
entry where the employer is automatically diverting some of the pre-tax money to
a retirement account (in this example, at Fidelity):</p>
<p>2013-02-15 * "ACME INC       PAYROLL"
    Income:US:Acme:Salary                   ...
    ...
    Assets:US:BofA:Checking                 ...
    Assets:US:Fidelity:PreTax401k:Cash      620.50 USD
    ...</p>
<p>A posting with account 'Assets:US:Fidelity:PreTax401k:Cash', which is configured
to match, would be found. The configuration above instructs the plugin to
automatically insert new postings like this:</p>
<p>2013-02-15 * "ACME INC       PAYROLL"
    ...
    Assets:US:Fidelity:PreTax401k:Cash              620.50 USD
    M Assets:US:Federal:PreTax401k                 -620.50 IRAUSD
    M Expenses:Taxes:TY2013:US:Federal:PreTax401k   620.50 IRAUSD
    ...</p>
<p>Notice that the "{year}" string in the configuration's account names is
automatically replaced by the current year in the account name. This is useful
if you maintain separate tax accounts per yera.</p>
<p>Furthermore, as in the configuration example above, you may have multiple
matching entries to trigger multiple insertions. For example, the employer may
also match the employee's retirement contribution by depositing some money in
the retirement account:</p>
<p>2013-02-15 * "BUYMF - MATCH" "Employer match, invested in SaveEasy 2030 fund"
    Assets:US:Fidelity:Match401k:SE2030   34.793 SE2030 {17.834 USD}
    Income:US:Acme:Match401k             -620.50 USD</p>
<p>In this example the funds get reported as invested immediately (an intermediate
deposit into a cash account does not take place). The plugin configuration would
match against the 'Income:US:Acme:Match401k' account and since it increases its
value (the normal balance of an Income account is negative), postings would be
inserted like this:</p>
<p>2013-02-15 * "BUYMF - MATCH" "Employer match, invested in SaveEasy 2030 fund"
    Assets:US:Fidelity:Match401k:SE2030              34.793 SE2030 {17.834 USD}
    Income:US:Acme:Match401k                        -620.50 USD
    M Assets:US:Federal:Match401k                   -620.50 IRAUSD
    M Expenses:Taxes:TY2013:US:Federal:Match401k     620.50 IRAUSD</p>
<p>Note that the special dict keys 'currency' and 'flag' are used to
specify which currency to use for the inserted postings, and if set, which flag
to mark these postings with.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.ira_contribs.add_ira_contribs">
<code class="highlight language-python">
add_ira_contribs<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config_str</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.ira_contribs.add_ira_contribs" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Add legs for 401k employer match contributions.</p>
<p>See module docstring for an example configuration.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>a list of entry instances</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>a dict of options parsed from the file</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>config_str</code></td>
<td><code></code></td>
<td>
<p>A configuration string, which is intended to be a Python dict
mapping match-accounts to a pair of (negative-account, position-account)
account names.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A tuple of entries and errors.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/ira_contribs.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">add_ira_contribs</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config_str</span><span class="p">):</span>
    <span class="sd">"""Add legs for 401k employer match contributions.</span>

<span class="sd">    See module docstring for an example configuration.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: a list of entry instances</span>
<span class="sd">      options_map: a dict of options parsed from the file</span>
<span class="sd">      config_str: A configuration string, which is intended to be a Python dict</span>
<span class="sd">        mapping match-accounts to a pair of (negative-account, position-account)</span>
<span class="sd">        account names.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A tuple of entries and errors.</span>
<span class="sd">    """</span>
    <span class="c1"># Parse and extract configuration values.</span>
    <span class="c1"># FIXME: Use ast.literal_eval() here; you need to convert this code and the getters.</span>
    <span class="c1"># FIXME: Also, don't raise a RuntimeError, return an error object; review</span>
    <span class="c1"># this for all the plugins.</span>
    <span class="c1"># FIXME: This too is temporary.</span>
    <span class="c1"># pylint: disable=eval-used</span>
    <span class="n">config_obj</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">config_str</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Invalid plugin configuration: should be a single dict."</span><span class="p">)</span>

    <span class="c1"># Currency of the inserted postings.</span>
    <span class="n">currency</span> <span class="o">=</span> <span class="n">config_obj</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'currency'</span><span class="p">,</span> <span class="s1">'UNKNOWN'</span><span class="p">)</span>

    <span class="c1"># Flag to attach to the inserted postings.</span>
    <span class="n">insert_flag</span> <span class="o">=</span> <span class="n">config_obj</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'flag'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># A dict of account names that trigger the insertion of postings to pairs of</span>
    <span class="c1"># inserted accounts when triggered.</span>
    <span class="n">accounts</span> <span class="o">=</span> <span class="n">config_obj</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'accounts'</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Convert the key in the accounts configuration for matching.</span>
    <span class="n">account_transforms</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">accounts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">account</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">account</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">account_transforms</span><span class="p">[</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="n">orig_entry</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">MISSING</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span> <span class="ow">in</span> <span class="n">account_transforms</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">account_types</span><span class="o">.</span><span class="n">get_account_sign</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">)</span> <span class="o">*</span>
                     <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>

                    <span class="c1"># Get the new account legs to insert.</span>
                    <span class="n">required_flag</span><span class="p">,</span> <span class="p">(</span><span class="n">neg_account</span><span class="p">,</span>
                                    <span class="n">pos_account</span><span class="p">)</span> <span class="o">=</span> <span class="n">account_transforms</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="kc">None</span>

                    <span class="c1"># Check required flag if present.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">required_flag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="n">required_flag</span> <span class="ow">and</span> <span class="n">required_flag</span> <span class="o">==</span> <span class="n">posting</span><span class="o">.</span><span class="n">flag</span><span class="p">)):</span>
                        <span class="c1"># Insert income/expense entries for 401k.</span>
                        <span class="n">entry</span> <span class="o">=</span> <span class="n">add_postings</span><span class="p">(</span>
                            <span class="n">entry</span><span class="p">,</span>
                            <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span><span class="p">),</span> <span class="n">currency</span><span class="p">),</span>
                            <span class="n">neg_account</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">),</span>
                            <span class="n">pos_account</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">),</span>
                            <span class="n">insert_flag</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">DEBUG</span> <span class="ow">and</span> <span class="n">orig_entry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">:</span>
                <span class="n">printer</span><span class="o">.</span><span class="n">print_entry</span><span class="p">(</span><span class="n">orig_entry</span><span class="p">)</span>
                <span class="n">printer</span><span class="o">.</span><span class="n">print_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="p">[]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.ira_contribs.add_postings">
<code class="highlight language-python">
add_postings<span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">amount_</span><span class="p">,</span> <span class="n">neg_account</span><span class="p">,</span> <span class="n">pos_account</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.ira_contribs.add_postings" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Insert positive and negative postings of a position in an entry.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entry</code></td>
<td><code></code></td>
<td>
<p>A Transaction instance.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>amount_</code></td>
<td><code></code></td>
<td>
<p>An Amount instance to create the position, with positive number.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>neg_account</code></td>
<td><code></code></td>
<td>
<p>An account for the posting with the negative amount.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>pos_account</code></td>
<td><code></code></td>
<td>
<p>An account for the posting with the positive amount.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>flag</code></td>
<td><code></code></td>
<td>
<p>A string, that is to be set as flag for the new postings.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A new, modified entry.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/ira_contribs.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">add_postings</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">amount_</span><span class="p">,</span> <span class="n">neg_account</span><span class="p">,</span> <span class="n">pos_account</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
    <span class="sd">"""Insert positive and negative postings of a position in an entry.</span>

<span class="sd">    Args:</span>
<span class="sd">      entry: A Transaction instance.</span>
<span class="sd">      amount_: An Amount instance to create the position, with positive number.</span>
<span class="sd">      neg_account: An account for the posting with the negative amount.</span>
<span class="sd">      pos_account: An account for the posting with the positive amount.</span>
<span class="sd">      flag: A string, that is to be set as flag for the new postings.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new, modified entry.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">postings</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">postings</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">neg_account</span><span class="p">,</span> <span class="o">-</span><span class="n">amount_</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">pos_account</span><span class="p">,</span> <span class="n">amount_</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">])</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.leafonly">
<code>leafonly</code>
<a class="headerlink" href="#beancount.plugins.leafonly" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>A plugin that issues errors when amounts are posted to non-leaf accounts,
that is, accounts with child accounts.</p>
<p>This is an extra constraint that you may want to apply optionally. If you
install this plugin, it will issue errors for all accounts that have
postings to non-leaf accounts. Some users may want to disallow this and
enforce that only leaf accounts may have postings on them.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.leafonly.LeafOnlyError">
<code>LeafOnlyError</code>
<a class="headerlink" href="#beancount.plugins.leafonly.LeafOnlyError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>LeafOnlyError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.leafonly.LeafOnlyError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.leafonly.LeafOnlyError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/leafonly.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.leafonly.LeafOnlyError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.leafonly.LeafOnlyError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of LeafOnlyError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.leafonly.LeafOnlyError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.leafonly.LeafOnlyError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/leafonly.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.leafonly.validate_leaf_only">
<code class="highlight language-python">
validate_leaf_only<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.leafonly.validate_leaf_only" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check for non-leaf accounts that have postings on them.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/leafonly.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_leaf_only</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
    <span class="sd">"""Check for non-leaf accounts that have postings on them.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">real_root</span> <span class="o">=</span> <span class="n">realization</span><span class="o">.</span><span class="n">realize</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">compute_balance</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">default_meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;leafonly&gt;'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">open_close_map</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Lazily computed.</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">real_account</span> <span class="ow">in</span> <span class="n">realization</span><span class="o">.</span><span class="n">iter_children</span><span class="p">(</span><span class="n">real_root</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">real_account</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">real_account</span><span class="o">.</span><span class="n">txn_postings</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">open_close_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">open_close_map</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_account_open_close</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">open_entry</span> <span class="o">=</span> <span class="n">open_close_map</span><span class="p">[</span><span class="n">real_account</span><span class="o">.</span><span class="n">account</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">open_entry</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LeafOnlyError</span><span class="p">(</span>
                <span class="n">open_entry</span><span class="o">.</span><span class="n">meta</span> <span class="k">if</span> <span class="n">open_entry</span> <span class="k">else</span> <span class="n">default_meta</span><span class="p">,</span>
                <span class="s2">"Non-leaf account '</span><span class="si">{}</span><span class="s2">' has postings on it"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">real_account</span><span class="o">.</span><span class="n">account</span><span class="p">),</span>
                <span class="n">open_entry</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.mark_unverified">
<code>mark_unverified</code>
<a class="headerlink" href="#beancount.plugins.mark_unverified" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Add metadata to Postings which occur after their last Balance directives.</p>
<p>Some people use Balance directives as a way to indicate that all postings before
them are verified. They want to compute balances in each account as of the date
of that last Balance directives. One way to do that is to use this plugin to
mark the postings which occur after and to then filter them out using a WHERE
clause on that metadata:</p>
<p>SELECT account, sum(position) WHERE NOT meta("unverified")</p>
<p>Note that doing such a filtering may result in a list of balances which may not
add to zero.</p>
<p>Also, postings for accounts without a single Balance directive on them will not
be marked as unverified as all (otherwise all the postings would be marked, this
would make no sense).</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.mark_unverified.mark_unverified">
<code class="highlight language-python">
mark_unverified<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.mark_unverified.mark_unverified" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Add metadata to postings after the last Balance entry. See module doc.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of data directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>A dict of options, that confirms to beancount.parser.options.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of entries, which includes the new unrealized capital gains entries
at the end, and a list of errors. The new list of entries is still sorted.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/mark_unverified.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">mark_unverified</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Add metadata to postings after the last Balance entry. See module doc.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of data directives.</span>
<span class="sd">      options_map: A dict of options, that confirms to beancount.parser.options.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of entries, which includes the new unrealized capital gains entries</span>
<span class="sd">      at the end, and a list of errors. The new list of entries is still sorted.</span>
<span class="sd">    """</span>
    <span class="c1"># The last Balance directive seen for each account.</span>
    <span class="n">last_balances</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Balance</span><span class="p">):</span>
            <span class="n">last_balances</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="n">postings</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span>
            <span class="n">new_postings</span> <span class="o">=</span> <span class="n">postings</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">posting</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">postings</span><span class="p">):</span>
                <span class="n">balance</span> <span class="o">=</span> <span class="n">last_balances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">balance</span> <span class="ow">and</span> <span class="n">balance</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">new_postings</span> <span class="ow">is</span> <span class="n">postings</span><span class="p">:</span>
                        <span class="n">new_postings</span> <span class="o">=</span> <span class="n">postings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">new_meta</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">new_meta</span><span class="p">[</span><span class="s1">'unverified'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">new_postings</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">new_meta</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_postings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">postings</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">postings</span><span class="o">=</span><span class="n">new_postings</span><span class="p">)</span>
        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="p">[]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.merge_meta">
<code>merge_meta</code>
<a class="headerlink" href="#beancount.plugins.merge_meta" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Merge the metadata from a second file into the current set of entries.</p>
<p>This is useful if you like to keep more sensitive private data, such as account
numbers or passwords, in a second, possibly encrypted file. This can be used to
generate a will, for instance, for your loved ones to be able to figure where
all your assets are in case you pass away. You can store all the super secret
stuff in a more closely guarded, hidden away separate file.</p>
<p>The metadata from</p>
<ul>
<li>Open directives: Account name must match.</li>
<li>Close directives: Account name must match.</li>
<li>Commodity directives: Currency must match.</li>
</ul>
<p>are copied over. Metadata from the external file conflicting with that present
in the main file overwrites it (external data wins).</p>
<p>WARNING! If you include an encrypted file and the main file is not encrypted,
  the contents extraction from the encrypted file may appear in the cache.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.merge_meta.merge_meta">
<code class="highlight language-python">
merge_meta<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.merge_meta.merge_meta" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Load a secondary file and merge its metadata in our given set of entries.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives. We're interested only in the Transaction instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>A parser options dict.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>config</code></td>
<td><code></code></td>
<td>
<p>The plugin configuration string.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of entries, with more metadata attached to them.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/merge_meta.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">merge_meta</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="sd">"""Load a secondary file and merge its metadata in our given set of entries.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives. We're interested only in the Transaction instances.</span>
<span class="sd">      unused_options_map: A parser options dict.</span>
<span class="sd">      config: The plugin configuration string.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of entries, with more metadata attached to them.</span>
<span class="sd">    """</span>
    <span class="n">external_filename</span> <span class="o">=</span> <span class="n">config</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="n">ext_entries</span><span class="p">,</span> <span class="n">ext_errors</span><span class="p">,</span> <span class="n">ext_options_map</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">external_filename</span><span class="p">)</span>

    <span class="c1"># Map Open and Close directives.</span>
    <span class="n">oc_map</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_account_open_close</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="n">ext_oc_map</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_account_open_close</span><span class="p">(</span><span class="n">ext_entries</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">oc_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">ext_oc_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">open_entry</span><span class="p">,</span> <span class="n">close_entry</span> <span class="o">=</span> <span class="n">oc_map</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
        <span class="n">ext_open_entry</span><span class="p">,</span> <span class="n">ext_close_entry</span> <span class="o">=</span> <span class="n">ext_oc_map</span><span class="p">[</span><span class="n">account</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">open_entry</span> <span class="ow">and</span> <span class="n">ext_open_entry</span><span class="p">:</span>
            <span class="n">open_entry</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ext_open_entry</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">close_entry</span> <span class="ow">and</span> <span class="n">ext_close_entry</span><span class="p">:</span>
            <span class="n">close_entry</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ext_close_entry</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>

    <span class="c1"># Map Commodity directives.</span>
    <span class="n">comm_map</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_commodity_map</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">ext_comm_map</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_commodity_map</span><span class="p">(</span><span class="n">ext_entries</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">comm_map</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">ext_comm_map</span><span class="p">):</span>
        <span class="n">comm_entry</span> <span class="o">=</span> <span class="n">comm_map</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span>
        <span class="n">ext_comm_entry</span> <span class="o">=</span> <span class="n">ext_comm_map</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">comm_entry</span> <span class="ow">and</span> <span class="n">ext_comm_entry</span><span class="p">:</span>
            <span class="n">comm_entry</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ext_comm_entry</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>

    <span class="c1"># Note: We cannot include the external file in the list of inputs so that a</span>
    <span class="c1"># change of it triggers a cache rebuild because side-effects on options_map</span>
    <span class="c1"># aren't cascaded through. This is something that should be defined better</span>
    <span class="c1"># in the plugin interface and perhaps improved upon.</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">ext_errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.noduplicates">
<code>noduplicates</code>
<a class="headerlink" href="#beancount.plugins.noduplicates" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>This plugin validates that there are no duplicate transactions.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.noduplicates.validate_no_duplicates">
<code class="highlight language-python">
validate_no_duplicates<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.noduplicates.validate_no_duplicates" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check that the entries are unique, by computing hashes.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/noduplicates.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>11
12
13
14
15
16
17
18
19
20
21</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_no_duplicates</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
    <span class="sd">"""Check that the entries are unique, by computing hashes.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">unused_hashes</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">compare</span><span class="o">.</span><span class="n">hash_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.nounused">
<code>nounused</code>
<a class="headerlink" href="#beancount.plugins.nounused" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>This plugin validates that there are no unused accounts.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.nounused.UnusedAccountError">
<code>UnusedAccountError</code>
<a class="headerlink" href="#beancount.plugins.nounused.UnusedAccountError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>UnusedAccountError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.nounused.UnusedAccountError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.nounused.UnusedAccountError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/nounused.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.nounused.UnusedAccountError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.nounused.UnusedAccountError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of UnusedAccountError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.nounused.UnusedAccountError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.nounused.UnusedAccountError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/nounused.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.nounused.validate_unused_accounts">
<code class="highlight language-python">
validate_unused_accounts<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.nounused.validate_unused_accounts" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check that all accounts declared open are actually used.</p>
<p>We check that all of the accounts that are open are at least referred to by
another directive. These are probably unused, so issue a warning (we like to
be pedantic). Note that an account that is open and then closed is
considered used--this is a valid use case that may occur in reality. If you
have a use case for an account to be open but never used, you can quiet that
warning by initializing the account with a balance asserts or a pad
directive, or even use a note will be sufficient.</p>
<p>(This is probably a good candidate for optional inclusion as a "pedantic"
plugin.)</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/nounused.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_unused_accounts</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
    <span class="sd">"""Check that all accounts declared open are actually used.</span>

<span class="sd">    We check that all of the accounts that are open are at least referred to by</span>
<span class="sd">    another directive. These are probably unused, so issue a warning (we like to</span>
<span class="sd">    be pedantic). Note that an account that is open and then closed is</span>
<span class="sd">    considered used--this is a valid use case that may occur in reality. If you</span>
<span class="sd">    have a use case for an account to be open but never used, you can quiet that</span>
<span class="sd">    warning by initializing the account with a balance asserts or a pad</span>
<span class="sd">    directive, or even use a note will be sufficient.</span>

<span class="sd">    (This is probably a good candidate for optional inclusion as a "pedantic"</span>
<span class="sd">    plugin.)</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="c1"># Find all the accounts referenced by entries which are not Open, and the</span>
    <span class="c1"># open directives for error reporting below.</span>
    <span class="n">open_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">referenced_accounts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">):</span>
            <span class="n">open_map</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="k">continue</span>
        <span class="n">referenced_accounts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">getters</span><span class="o">.</span><span class="n">get_entry_accounts</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>

    <span class="c1"># Create a list of suitable errors, with the location of the Open directives</span>
    <span class="c1"># corresponding to the unused accounts.</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">UnusedAccountError</span><span class="p">(</span><span class="n">open_entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                                 <span class="s2">"Unused account '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account</span><span class="p">),</span>
                                 <span class="n">open_entry</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">account</span><span class="p">,</span> <span class="n">open_entry</span> <span class="ow">in</span> <span class="n">open_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
              <span class="k">if</span> <span class="n">account</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">referenced_accounts</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.onecommodity">
<code>onecommodity</code>
<a class="headerlink" href="#beancount.plugins.onecommodity" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>A plugin that issues errors when more than one commodity is used in an account.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.onecommodity.OneCommodityError">
<code>OneCommodityError</code>
<a class="headerlink" href="#beancount.plugins.onecommodity.OneCommodityError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>OneCommodityError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.onecommodity.OneCommodityError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.onecommodity.OneCommodityError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/onecommodity.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.onecommodity.OneCommodityError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.onecommodity.OneCommodityError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of OneCommodityError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.onecommodity.OneCommodityError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.onecommodity.OneCommodityError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/onecommodity.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.onecommodity.validate_one_commodity">
<code class="highlight language-python">
validate_one_commodity<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.onecommodity.validate_one_commodity" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check that each account has units in only a single commodity.</p>
<p>This is an extra constraint that you may want to apply optionally, despite
Beancount's ability to support inventories and aggregations with more than
one commodity. I believe this also matches GnuCash's model, where each
account has a single commodity attached to it.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/onecommodity.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_one_commodity</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
    <span class="sd">"""Check that each account has units in only a single commodity.</span>

<span class="sd">    This is an extra constraint that you may want to apply optionally, despite</span>
<span class="sd">    Beancount's ability to support inventories and aggregations with more than</span>
<span class="sd">    one commodity. I believe this also matches GnuCash's model, where each</span>
<span class="sd">    account has a single commodity attached to it.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="c1"># Mappings of account name to lists of currencies for each units and cost.</span>
    <span class="n">units_map</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
    <span class="n">cost_map</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

    <span class="c1"># Mappings to use just for getting a relevant source.</span>
    <span class="n">units_source_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cost_source_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Accumulate all the commodities used.</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span>
                <span class="n">units_map</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">units_map</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">units_source_map</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

                <span class="n">cost</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span>
                <span class="k">if</span> <span class="n">cost</span><span class="p">:</span>
                    <span class="n">cost_map</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cost</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cost_map</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">units_source_map</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Balance</span><span class="p">):</span>
            <span class="n">units_map</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">units_map</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">units_source_map</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="c1"># Check units.</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">account</span><span class="p">,</span> <span class="n">currencies</span> <span class="ow">in</span> <span class="n">units_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">currencies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OneCommodityError</span><span class="p">(</span>
                <span class="n">units_source_map</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                <span class="s2">"More than one currency in account '</span><span class="si">{}</span><span class="s2">': </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">account</span><span class="p">,</span> <span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">currencies</span><span class="p">)),</span>
                <span class="kc">None</span><span class="p">))</span>

    <span class="c1"># Check costs.</span>
    <span class="k">for</span> <span class="n">account</span><span class="p">,</span> <span class="n">currencies</span> <span class="ow">in</span> <span class="n">cost_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">currencies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OneCommodityError</span><span class="p">(</span>
                <span class="n">cost_source_map</span><span class="p">[</span><span class="n">account</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                <span class="s2">"More than one cost currency in account '</span><span class="si">{}</span><span class="s2">': </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">account</span><span class="p">,</span> <span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">currencies</span><span class="p">)),</span>
                <span class="kc">None</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.pedantic">
<code>pedantic</code>
<a class="headerlink" href="#beancount.plugins.pedantic" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>A plugin of plugins which triggers are all the pedantic plugins.</p>
<p>In a sense, this is the inverse of "pedantic." This is useful when doing some
types of quick and dirty tests.</p>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.sellgains">
<code>sellgains</code>
<a class="headerlink" href="#beancount.plugins.sellgains" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>A plugin that cross-checks declared gains against prices on lot sales.</p>
<p>When you sell stock, the gains can be automatically implied by the corresponding
cash amounts. For example, in the following transaction the 2nd and 3rd postings
should match the value of the stock sold:</p>
<p>1999-07-31 * "Sell"
  Assets:US:BRS:Company:ESPP          -81 ADSK {26.3125 USD}
  Assets:US:BRS:Company:Cash      2141.36 USD
  Expenses:Financial:Fees            0.08 USD
  Income:US:Company:ESPP:PnL      -10.125 USD</p>
<p>The cost basis is checked against: 2141.36 + 008 + -10.125. That is, the balance
checks computes</p>
<p>-81 x 26.3125  = -2131.3125  +
                    2141.36    +
                       0.08    +
                     -10.125</p>
<p>and checks that the residual is below a small tolernace.</p>
<p>But... usually the income leg isn't given to you in statements. Beancount can
automatically infer it using the balance, which is convenient, like this:</p>
<p>1999-07-31 * "Sell"
  Assets:US:BRS:Company:ESPP          -81 ADSK {26.3125 USD}
  Assets:US:BRS:Company:Cash      2141.36 USD
  Expenses:Financial:Fees            0.08 USD
  Income:US:Company:ESPP:PnL</p>
<p>Additionally, most often you have the sales prices given to you on your
transaction confirmation statement, so you can enter this:</p>
<p>1999-07-31 * "Sell"
  Assets:US:BRS:Company:ESPP          -81 ADSK {26.3125 USD} @ 26.4375 USD
  Assets:US:BRS:Company:Cash      2141.36 USD
  Expenses:Financial:Fees            0.08 USD
  Income:US:Company:ESPP:PnL</p>
<p>So in theory, if the price is given (26.4375 USD), we could verify that the
proceeds from the sale at the given price match non-Income postings. That is,
verify that</p>
<p>-81 x 26.4375  = -2141.4375  +
                    2141.36    +
                       0.08    +</p>
<p>is below a small tolerance value. So this plugin does this.</p>
<p>In general terms, it does the following: For transactions with postings that
have a cost and a price, it verifies that the sum of the positions on all
postings to non-income accounts is below tolerance.</p>
<p>This provides yet another level of verification and allows you to elide the
income amounts, knowing that the price is there to provide an extra level of
error-checking in case you enter a typo.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.sellgains.SellGainsError">
<code>SellGainsError</code>
<a class="headerlink" href="#beancount.plugins.sellgains.SellGainsError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>SellGainsError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.sellgains.SellGainsError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.sellgains.SellGainsError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/sellgains.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.sellgains.SellGainsError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.sellgains.SellGainsError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of SellGainsError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.sellgains.SellGainsError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.sellgains.SellGainsError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/sellgains.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.sellgains.validate_sell_gains">
<code class="highlight language-python">
validate_sell_gains<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.sellgains.validate_sell_gains" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check the sum of asset account totals for lots sold with a price on them.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/sellgains.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_sell_gains</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Check the sum of asset account totals for lots sold with a price on them.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">acc_types</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_account_types</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">proceed_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">acc_types</span><span class="o">.</span><span class="n">assets</span><span class="p">,</span>
                         <span class="n">acc_types</span><span class="o">.</span><span class="n">liabilities</span><span class="p">,</span>
                         <span class="n">acc_types</span><span class="o">.</span><span class="n">equity</span><span class="p">,</span>
                         <span class="n">acc_types</span><span class="o">.</span><span class="n">expenses</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Find transactions whose lots at cost all have a price.</span>
        <span class="n">postings_at_cost</span> <span class="o">=</span> <span class="p">[</span><span class="n">posting</span>
                            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span>
                            <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">postings_at_cost</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                           <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">postings_at_cost</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Accumulate the total expected proceeds and the sum of the asset and</span>
        <span class="c1"># expenses legs.</span>
        <span class="n">total_price</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">()</span>
        <span class="n">total_proceeds</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="c1"># If the posting is held at cost, add the priced value to the balance.</span>
            <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">price</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span>
                <span class="n">total_price</span><span class="o">.</span><span class="n">add_amount</span><span class="p">(</span><span class="n">amount</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="o">-</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Otherwise, use the weight and ignore postings to Income accounts.</span>
                <span class="n">atype</span> <span class="o">=</span> <span class="n">account_types</span><span class="o">.</span><span class="n">get_account_type</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">atype</span> <span class="ow">in</span> <span class="n">proceed_types</span><span class="p">:</span>
                    <span class="n">total_proceeds</span><span class="o">.</span><span class="n">add_amount</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">get_weight</span><span class="p">(</span><span class="n">posting</span><span class="p">))</span>

        <span class="c1"># Compare inventories, currency by currency.</span>
        <span class="n">dict_price</span> <span class="o">=</span> <span class="p">{</span><span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span>
                      <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">total_price</span><span class="p">}</span>
        <span class="n">dict_proceeds</span> <span class="o">=</span> <span class="p">{</span><span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span>
                         <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">total_proceeds</span><span class="p">}</span>

        <span class="n">tolerances</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">infer_tolerances</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span>
        <span class="n">invalid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">price_number</span> <span class="ow">in</span> <span class="n">dict_price</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Accept a looser than usual tolerance because rounding occurs</span>
            <span class="c1"># differently. Also, it would be difficult for the user to satisfy</span>
            <span class="c1"># two sets of constraints manually.</span>
            <span class="n">tolerance</span> <span class="o">=</span> <span class="n">tolerances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">currency</span><span class="p">)</span> <span class="o">*</span> <span class="n">EXTRA_TOLERANCE_MULTIPLIER</span>

            <span class="n">proceeds_number</span> <span class="o">=</span> <span class="n">dict_proceeds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="n">ZERO</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">price_number</span> <span class="o">-</span> <span class="n">proceeds_number</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">:</span>
                <span class="n">invalid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">invalid</span> <span class="ow">or</span> <span class="n">dict_proceeds</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">SellGainsError</span><span class="p">(</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                    <span class="s2">"Invalid price vs. proceeds/gains: </span><span class="si">{}</span><span class="s2"> vs. </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">total_price</span><span class="p">,</span> <span class="n">total_proceeds</span><span class="p">),</span>
                    <span class="n">entry</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.split_expenses">
<code>split_expenses</code>
<a class="headerlink" href="#beancount.plugins.split_expenses" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Split expenses of a Beancount ledger between multiple people.</p>
<p>This plugin is given a list of names. It assumes that any Expenses account whose
components do not include any of the given names are to be split between the
members. It goes through all the transactions and converts all such postings
into multiple postings, one for each member.</p>
<p>For example, given the names 'Martin' and 'Caroline', the following transaction:</p>
<p>2015-02-01 * "Aqua Viva Tulum - two nights"
     Income:Caroline:CreditCard      -269.00 USD
     Expenses:Accommodation</p>
<p>Will be converted to this:</p>
<p>2015-02-01 * "Aqua Viva Tulum - two nights"
    Income:Caroline:CreditCard       -269.00 USD
    Expenses:Accommodation:Martin     134.50 USD
    Expenses:Accommodation:Caroline   134.50 USD</p>
<p>After these transformations, all account names should include the name of a
member. You can generate reports for a particular person by filtering postings
to accounts with a component by their name.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.split_expenses.get_participants">
<code class="highlight language-python">
get_participants<span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.split_expenses.get_participants" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Get the list of participants from the plugin configuration in the input file.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>The options map, as produced by the parser.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of strings, the names of participants as they should appear in the
account names.</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>KeyError</code></td>
<td>
<p>If the configuration does not contain configuration for the list</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/split_expenses.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_participants</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Get the list of participants from the plugin configuration in the input file.</span>

<span class="sd">    Args:</span>
<span class="sd">      options_map: The options map, as produced by the parser.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of strings, the names of participants as they should appear in the</span>
<span class="sd">      account names.</span>
<span class="sd">    Raises:</span>
<span class="sd">      KeyError: If the configuration does not contain configuration for the list</span>
<span class="sd">      of participants.</span>
<span class="sd">    """</span>
    <span class="n">plugin_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">options_map</span><span class="p">[</span><span class="s2">"plugin"</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plugin_options</span><span class="p">[</span><span class="s2">"beancount.plugins.split_expenses"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">"Could not find the split_expenses plugin configuration."</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.split_expenses.main">
<code class="highlight language-python">
main<span class="p">()</span> </code>
<a class="headerlink" href="#beancount.plugins.split_expenses.main" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Generate final reports for a shared expenses on a trip or project.</p>
<p>For each of many participants, generate a detailed list of expenses,
contributions, a categorized summary of expenses, and a final balance. Also
produce a global list of final balances so that participants can reconcile
between each other.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/split_expenses.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">"""Generate final reports for a shared expenses on a trip or project.</span>

<span class="sd">    For each of many participants, generate a detailed list of expenses,</span>
<span class="sd">    contributions, a categorized summary of expenses, and a final balance. Also</span>
<span class="sd">    produce a global list of final balances so that participants can reconcile</span>
<span class="sd">    between each other.</span>
<span class="sd">    """</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">'</span><span class="si">%(levelname)-8s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'filename'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">'Beancount input filename'</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-c'</span><span class="p">,</span> <span class="s1">'--currency'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"Convert all the amounts to a single common currency"</span><span class="p">)</span>

    <span class="n">oparser</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">'Outputs'</span><span class="p">)</span>

    <span class="n">oparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-o'</span><span class="p">,</span> <span class="s1">'--output-text'</span><span class="p">,</span> <span class="s1">'--text'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store'</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">"Render results to text boxes"</span><span class="p">)</span>
    <span class="n">oparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--output-csv'</span><span class="p">,</span> <span class="s1">'--csv'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store'</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">"Render results to CSV files"</span><span class="p">)</span>
    <span class="n">oparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--output-stdout'</span><span class="p">,</span> <span class="s1">'--stdout'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">"Render results to stdout"</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Ensure the directories exist.</span>
    <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">output_text</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output_csv</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">directory</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Load the input file and get the list of participants.</span>
    <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">options_map</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">participants</span> <span class="o">=</span> <span class="n">get_participants</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">participant</span> <span class="ow">in</span> <span class="n">participants</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Participant: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">participant</span><span class="p">))</span>

        <span class="n">save_query</span><span class="p">(</span><span class="s2">"balances"</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"""</span>
<span class="s2">          SELECT</span>
<span class="s2">            PARENT(account) AS account,</span>
<span class="s2">            CONV[SUM(position)] AS amount</span>
<span class="s2">          WHERE account ~ ':\b</span><span class="si">{}</span><span class="s2">'</span>
<span class="s2">          GROUP BY 1</span>
<span class="s2">          ORDER BY 2 DESC</span>
<span class="s2">        """</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">boxed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

        <span class="n">save_query</span><span class="p">(</span><span class="s2">"expenses"</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"""</span>
<span class="s2">          SELECT</span>
<span class="s2">            date, flag, description,</span>
<span class="s2">            PARENT(account) AS account,</span>
<span class="s2">            JOINSTR(links) AS links,</span>
<span class="s2">            CONV[position] AS amount,</span>
<span class="s2">            CONV[balance] AS balance</span>
<span class="s2">          WHERE account ~ 'Expenses.*\b</span><span class="si">{}</span><span class="s2">'</span>
<span class="s2">        """</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

        <span class="n">save_query</span><span class="p">(</span><span class="s2">"income"</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"""</span>
<span class="s2">          SELECT</span>
<span class="s2">            date, flag, description,</span>
<span class="s2">            account,</span>
<span class="s2">            JOINSTR(links) AS links,</span>
<span class="s2">            CONV[position] AS amount,</span>
<span class="s2">            CONV[balance] AS balance</span>
<span class="s2">          WHERE account ~ 'Income.*\b</span><span class="si">{}</span><span class="s2">'</span>
<span class="s2">        """</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

    <span class="n">save_query</span><span class="p">(</span><span class="s2">"final"</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"""</span>
<span class="s2">      SELECT</span>
<span class="s2">        GREP('\b(</span><span class="si">{}</span><span class="s2">)\b', account) AS participant,</span>
<span class="s2">        CONV[SUM(position)] AS balance</span>
<span class="s2">      GROUP BY 1</span>
<span class="s2">      ORDER BY 2</span>
<span class="s2">    """</span><span class="p">,</span> <span class="s1">'|'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">participants</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.split_expenses.save_query">
<code class="highlight language-python">
save_query<span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">,</span> <span class="o">*</span><span class="n">format_args</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">boxed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">spaced</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.split_expenses.save_query" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Save the multiple files for this query.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>title</code></td>
<td><code></code></td>
<td>
<p>A string, the title of this particular report to render.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>participant</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the participant under consideration.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives (as per the loader).</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>A dict of options (as per the loader).</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>sql_query</code></td>
<td><code></code></td>
<td>
<p>A string with the SQL query, possibly with some placeholders left for
*format_args to replace.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>*format_args</code></td>
<td><code></code></td>
<td>
<p>A tuple of arguments to be formatted into the SQL query string.
This is provided as a convenience.</p>
</td>
<td><code>()</code></td>
</tr>
<tr>
<td><code>boxed</code></td>
<td><code></code></td>
<td>
<p>A boolean, true if we should render the results in a fancy-looking ASCII box.</p>
</td>
<td><code>True</code></td>
</tr>
<tr>
<td><code>spaced</code></td>
<td><code></code></td>
<td>
<p>If true, leave an empty line between each of the rows. This is useful if the
results have a lot of rows that render over multiple lines.</p>
</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>args</code></td>
<td><code></code></td>
<td>
<p>A dummy object with the following attributes:
output_text: An optional directory name, to produce a text rendering of
  the report.
output_csv: An optional directory name, to produce a CSV rendering of
  the report.
output_stdout: A boolean, if true, also render the output to stdout.
currency: An optional currency (a string). If you use this, you should
  wrap query targets to be converted with the pseudo-function
  "CONV[...]" and it will get replaced to CONVERT(..., CURRENCY)
  automatically.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/split_expenses.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">save_query</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">,</span> <span class="o">*</span><span class="n">format_args</span><span class="p">,</span>
               <span class="n">boxed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">spaced</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Save the multiple files for this query.</span>

<span class="sd">    Args:</span>
<span class="sd">      title: A string, the title of this particular report to render.</span>
<span class="sd">      participant: A string, the name of the participant under consideration.</span>
<span class="sd">      entries: A list of directives (as per the loader).</span>
<span class="sd">      options_map: A dict of options (as per the loader).</span>
<span class="sd">      sql_query: A string with the SQL query, possibly with some placeholders left for</span>
<span class="sd">        *format_args to replace.</span>
<span class="sd">      *format_args: A tuple of arguments to be formatted into the SQL query string.</span>
<span class="sd">        This is provided as a convenience.</span>
<span class="sd">      boxed: A boolean, true if we should render the results in a fancy-looking ASCII box.</span>
<span class="sd">      spaced: If true, leave an empty line between each of the rows. This is useful if the</span>
<span class="sd">        results have a lot of rows that render over multiple lines.</span>
<span class="sd">      args: A dummy object with the following attributes:</span>
<span class="sd">        output_text: An optional directory name, to produce a text rendering of</span>
<span class="sd">          the report.</span>
<span class="sd">        output_csv: An optional directory name, to produce a CSV rendering of</span>
<span class="sd">          the report.</span>
<span class="sd">        output_stdout: A boolean, if true, also render the output to stdout.</span>
<span class="sd">        currency: An optional currency (a string). If you use this, you should</span>
<span class="sd">          wrap query targets to be converted with the pseudo-function</span>
<span class="sd">          "CONV[...]" and it will get replaced to CONVERT(..., CURRENCY)</span>
<span class="sd">          automatically.</span>
<span class="sd">    """</span>
    <span class="c1"># Replace CONV() to convert the currencies or not; if so, replace to</span>
    <span class="c1"># CONVERT(..., currency).</span>
    <span class="n">replacement</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s1">'\1'</span>
                   <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">currency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
                   <span class="sa">r</span><span class="s1">'CONVERT(\1, "</span><span class="si">{}</span><span class="s1">")'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>
    <span class="n">sql_query</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'CONV\[(.*?)\]'</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">)</span>

    <span class="c1"># Run the query.</span>
    <span class="n">rtypes</span><span class="p">,</span> <span class="n">rrows</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">run_query</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span>
                                    <span class="n">sql_query</span><span class="p">,</span> <span class="o">*</span><span class="n">format_args</span><span class="p">,</span>
                                    <span class="n">numberify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># The base of all filenames.</span>
    <span class="n">filebase</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">)</span>

    <span class="n">fmtopts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxed</span><span class="o">=</span><span class="n">boxed</span><span class="p">,</span>
                   <span class="n">spaced</span><span class="o">=</span><span class="n">spaced</span><span class="p">)</span>

    <span class="c1"># Output the text files.</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output_text</span><span class="p">:</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_text</span><span class="p">,</span> <span class="n">participant</span><span class="p">)</span>
                   <span class="k">if</span> <span class="n">participant</span>
                   <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">output_text</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">filebase</span> <span class="o">+</span> <span class="s1">'.txt'</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">query_render</span><span class="o">.</span><span class="n">render_text</span><span class="p">(</span><span class="n">rtypes</span><span class="p">,</span> <span class="n">rrows</span><span class="p">,</span> <span class="n">options_map</span><span class="p">[</span><span class="s1">'dcontext'</span><span class="p">],</span>
                                     <span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">fmtopts</span><span class="p">)</span>

    <span class="c1"># Output the CSV files.</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output_csv</span><span class="p">:</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_csv</span><span class="p">,</span> <span class="n">participant</span><span class="p">)</span>
                   <span class="k">if</span> <span class="n">participant</span>
                   <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">output_csv</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">filebase</span> <span class="o">+</span> <span class="s1">'.csv'</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">query_render</span><span class="o">.</span><span class="n">render_csv</span><span class="p">(</span><span class="n">rtypes</span><span class="p">,</span> <span class="n">rrows</span><span class="p">,</span> <span class="n">options_map</span><span class="p">[</span><span class="s1">'dcontext'</span><span class="p">],</span>
                                    <span class="n">file</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output_stdout</span><span class="p">:</span>
        <span class="c1"># Write out the query to stdout.</span>
        <span class="n">query_render</span><span class="o">.</span><span class="n">render_text</span><span class="p">(</span><span class="n">rtypes</span><span class="p">,</span> <span class="n">rrows</span><span class="p">,</span> <span class="n">options_map</span><span class="p">[</span><span class="s1">'dcontext'</span><span class="p">],</span>
                                 <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="o">**</span><span class="n">fmtopts</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.split_expenses.split_expenses">
<code class="highlight language-python">
split_expenses<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.split_expenses.split_expenses" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Split postings according to expenses (see module docstring for details).</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives. We're interested only in the Transaction instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>A parser options dict.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>config</code></td>
<td><code></code></td>
<td>
<p>The plugin configuration string.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of entries, with potentially more accounts and potentially more
postings with smaller amounts.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/split_expenses.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">split_expenses</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="sd">"""Split postings according to expenses (see module docstring for details).</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives. We're interested only in the Transaction instances.</span>
<span class="sd">      unused_options_map: A parser options dict.</span>
<span class="sd">      config: The plugin configuration string.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of entries, with potentially more accounts and potentially more</span>
<span class="sd">      postings with smaller amounts.</span>
<span class="sd">    """</span>

    <span class="c1"># Validate and sanitize configuration.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">members</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">members</span> <span class="o">=</span> <span class="n">config</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Invalid plugin configuration: configuration for split_expenses "</span>
                           <span class="s2">"should be a string or a sequence."</span><span class="p">)</span>

    <span class="n">acctypes</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_account_types</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">is_expense_account</span><span class="p">(</span><span class="n">account</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">account_types</span><span class="o">.</span><span class="n">get_account_type</span><span class="p">(</span><span class="n">account</span><span class="p">)</span> <span class="o">==</span> <span class="n">acctypes</span><span class="o">.</span><span class="n">expenses</span>

    <span class="c1"># A predicate to quickly identify if an account contains the name of a</span>
    <span class="c1"># member.</span>
    <span class="n">is_individual_account</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">'|'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">,</span> <span class="n">members</span><span class="p">)))</span><span class="o">.</span><span class="n">search</span>

    <span class="c1"># Existing and previously unseen accounts.</span>
    <span class="n">new_accounts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Filter the entries and transform transactions.</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="n">new_postings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">is_expense_account</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="ow">not</span> <span class="n">is_individual_account</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">)):</span>

                    <span class="c1"># Split this posting into multiple postings.</span>
                    <span class="n">split_units</span> <span class="o">=</span> <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">),</span>
                                                <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
                        <span class="c1"># Mark the account as new if never seen before.</span>
                        <span class="n">subaccount</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
                        <span class="n">new_accounts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">subaccount</span><span class="p">)</span>

                        <span class="c1"># Ensure the modified postings are marked as</span>
                        <span class="c1"># automatically calculated, so that the resulting</span>
                        <span class="c1"># calculated amounts aren't used to affect inferred</span>
                        <span class="c1"># tolerances.</span>
                        <span class="n">meta</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">meta</span> <span class="k">else</span> <span class="p">{}</span>
                        <span class="n">meta</span><span class="p">[</span><span class="n">interpolate</span><span class="o">.</span><span class="n">AUTOMATIC_META</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="c1"># Add a new posting for each member, to a new account</span>
                        <span class="c1"># with the name of this member.</span>
                        <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">posting</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
                                             <span class="n">account</span><span class="o">=</span><span class="n">subaccount</span><span class="p">,</span>
                                             <span class="n">units</span><span class="o">=</span><span class="n">split_units</span><span class="p">,</span>
                                             <span class="n">cost</span><span class="o">=</span><span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>

            <span class="c1"># Modify the entry in-place, replace its postings.</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">postings</span><span class="o">=</span><span class="n">new_postings</span><span class="p">)</span>

        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="c1"># Create Open directives for new subaccounts if necessary.</span>
    <span class="n">oc_map</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_account_open_close</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="n">open_date</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;split_expenses&gt;'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">open_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">new_account</span> <span class="ow">in</span> <span class="n">new_accounts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">new_account</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">oc_map</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">open_date</span><span class="p">,</span> <span class="n">new_account</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">open_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">open_entries</span> <span class="o">+</span> <span class="n">new_entries</span><span class="p">,</span> <span class="p">[]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.split_expenses_test">
<code>split_expenses_test</code>
<a class="headerlink" href="#beancount.plugins.split_expenses_test" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.split_expenses_test.TestSplitReports">
<code>TestSplitReports</code>
<a class="headerlink" href="#beancount.plugins.split_expenses_test.TestSplitReports" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.split_expenses_test.TestSplitReports.run_split_reports">
<code class="highlight language-python">
run_split_reports<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.split_expenses_test.TestSplitReports.run_split_reports" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Run the split_reports command.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>args</code></td>
<td><code></code></td>
<td>
<p>A list of extra arguments (beyond the filename).</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/split_expenses_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>110
111
112
113
114
115
116
117
118
119
120
121
122
123
124</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">run_split_reports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">"""Run the split_reports command.</span>

<span class="sd">    Args:</span>
<span class="sd">      args: A list of extra arguments (beyond the filename).</span>
<span class="sd">    """</span>
    <span class="n">rootdir</span> <span class="o">=</span> <span class="n">test_utils</span><span class="o">.</span><span class="n">find_repository_root</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rootdir</span><span class="p">,</span> <span class="s1">'examples'</span><span class="p">,</span> <span class="s1">'sharing'</span><span class="p">,</span> <span class="s1">'duxbury2015.beancount'</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">test_utils</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
        <span class="n">test_utils</span><span class="o">.</span><span class="n">run_with_args</span><span class="p">(</span><span class="n">split_expenses</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="n">args</span> <span class="o">+</span> <span class="p">[</span><span class="n">filename</span><span class="p">])</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">"Participant"</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">"Expenses:Food:Restaurant"</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">"balance"</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.tag_pending">
<code>tag_pending</code>
<a class="headerlink" href="#beancount.plugins.tag_pending" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>An example of tracking unpaid payables or receivables.</p>
<p>A user with lots of invoices to track may want to produce a report of pending or
incomplete payables or receivables. Beancount does not by default offer such a
dedicated feature, but it is easy to build one by using existing link attributes
on transactions. This is an example on how to implement that with a plugin.</p>
<p>For example, assuming the user enters linked transactions like this:</p>
<p>2013-03-28 * "Bill for datacenter electricity"  ^invoice-27a30ab61191
    Expenses:Electricity                          450.82 USD
    Liabilities:AccountsPayable</p>
<p>2013-04-15 * "Paying electricity company" ^invoice-27a30ab61191
    Assets:Checking                             -450.82 USD
    Liabilities:AccountsPayable</p>
<p>Transactions are grouped by link ("invoice-27a30ab61191") and then the
intersection of their common accounts is automatically calculated
("Liabilities:AccountsPayable"). We then add up the balance of all the postings
for this account in this link group and check if the sum is zero. If there is a
residual amount in this balance, we mark the associated entries as incomplete by
inserting a #PENDING tag on them. The user can then use that tag to navigate to
the corresponding view in the web interface, or just find the entries and
produce a listing of them.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.tag_pending.tag_pending_plugin">
<code class="highlight language-python">
tag_pending_plugin<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.tag_pending.tag_pending_plugin" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>A plugin that finds and tags pending transactions.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of entry instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>A dict of options parsed from the file.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A tuple of entries and errors.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/tag_pending.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>82
83
84
85
86
87
88
89
90
91</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">tag_pending_plugin</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""A plugin that finds and tags pending transactions.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of entry instances.</span>
<span class="sd">      options_map: A dict of options parsed from the file.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A tuple of entries and errors.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">tag_pending_transactions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="s1">'PENDING'</span><span class="p">),</span> <span class="p">[])</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.tag_pending.tag_pending_transactions">
<code class="highlight language-python">
tag_pending_transactions<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">tag_name</span><span class="o">=</span><span class="s1">'PENDING'</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.tag_pending.tag_pending_transactions" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Filter out incomplete linked transactions to a transfer account.</p>
<p>Given a list of entries, group the entries by their link and compute the
balance of the intersection of their common accounts. If the balance does
not sum to zero, insert a 'tag_name' tag in the entries.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives/transactions to process.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>tag_name</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the tag to be inserted if a linked group
of entries is found not to match</p>
</td>
<td><code>'PENDING'</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A modified set of entries, possibly tagged as pending.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/tag_pending.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">tag_pending_transactions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">tag_name</span><span class="o">=</span><span class="s1">'PENDING'</span><span class="p">):</span>
    <span class="sd">"""Filter out incomplete linked transactions to a transfer account.</span>

<span class="sd">    Given a list of entries, group the entries by their link and compute the</span>
<span class="sd">    balance of the intersection of their common accounts. If the balance does</span>
<span class="sd">    not sum to zero, insert a 'tag_name' tag in the entries.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives/transactions to process.</span>
<span class="sd">      tag_name: A string, the name of the tag to be inserted if a linked group</span>
<span class="sd">        of entries is found not to match</span>
<span class="sd">    Returns:</span>
<span class="sd">      A modified set of entries, possibly tagged as pending.</span>

<span class="sd">    """</span>
    <span class="n">link_groups</span> <span class="o">=</span> <span class="n">basicops</span><span class="o">.</span><span class="n">group_entries_by_link</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="n">pending_entry_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">link</span><span class="p">,</span> <span class="n">link_entries</span> <span class="ow">in</span> <span class="n">link_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">link_entries</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">link_entries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># If a single entry is present, it is assumed incomplete.</span>
            <span class="n">pending_entry_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">link_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Compute the sum total balance of the common accounts.</span>
            <span class="n">common_accounts</span> <span class="o">=</span> <span class="n">basicops</span><span class="o">.</span><span class="n">get_common_accounts</span><span class="p">(</span><span class="n">link_entries</span><span class="p">)</span>
            <span class="n">common_balance</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">link_entries</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">account</span> <span class="ow">in</span> <span class="n">common_accounts</span><span class="p">:</span>
                        <span class="n">common_balance</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>

            <span class="c1"># Mark entries as pending if a residual balance is found.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">common_balance</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">link_entries</span><span class="p">:</span>
                    <span class="n">pending_entry_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>

    <span class="c1"># Insert tags if marked.</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">tags</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">((</span><span class="n">tag_name</span><span class="p">,)))</span>
             <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pending_entry_ids</span>
             <span class="k">else</span> <span class="n">entry</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.unique_prices">
<code>unique_prices</code>
<a class="headerlink" href="#beancount.plugins.unique_prices" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>This module adds validation that there is a single price defined per
date and base/quote currencies. If multiple conflicting price values are
declared, an error is generated. Note that multiple price entries with the
same number do not generate an error.</p>
<p>This is meant to be turned on if you want to use a very strict mode for
entering prices, and may not be realistic usage. For example, if you have
(1) a transaction with an implicitly generated price during the day (from
its cost) and (2) a separate explicit price directive that declares a
different price for the day's closing price, this would generate an error.
I'm not certain this will be useful in the long run, so placing it in a
plugin.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.unique_prices.UniquePricesError">
<code>UniquePricesError</code>
<a class="headerlink" href="#beancount.plugins.unique_prices.UniquePricesError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>UniquePricesError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.unique_prices.UniquePricesError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.unique_prices.UniquePricesError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/unique_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.unique_prices.UniquePricesError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.unique_prices.UniquePricesError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of UniquePricesError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.unique_prices.UniquePricesError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.unique_prices.UniquePricesError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/unique_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.unique_prices.validate_unique_prices">
<code class="highlight language-python">
validate_unique_prices<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.unique_prices.validate_unique_prices" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check that there is only a single price per day for a particular base/quote.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives. We're interested only in the Transaction instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>A parser options dict.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>The list of input entries, and a list of new UniquePricesError instances generated.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/unique_prices.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_unique_prices</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
    <span class="sd">"""Check that there is only a single price per day for a particular base/quote.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives. We're interested only in the Transaction instances.</span>
<span class="sd">      unused_options_map: A parser options dict.</span>
<span class="sd">    Returns:</span>
<span class="sd">      The list of input entries, and a list of new UniquePricesError instances generated.</span>
<span class="sd">    """</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">prices</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Price</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
        <span class="n">prices</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">price_entries</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">price_entries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">number_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">price_entry</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">number</span><span class="p">:</span> <span class="n">price_entry</span>
                          <span class="k">for</span> <span class="n">price_entry</span> <span class="ow">in</span> <span class="n">price_entries</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">number_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Note: This should be a list of entries for better error</span>
                <span class="c1"># reporting. (Later.)</span>
                <span class="n">error_entry</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">number_map</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">UniquePricesError</span><span class="p">(</span><span class="n">error_entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                                      <span class="s2">"Disagreeing price entries"</span><span class="p">,</span>
                                      <span class="n">price_entries</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.unrealized">
<code>unrealized</code>
<a class="headerlink" href="#beancount.plugins.unrealized" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Compute unrealized gains.</p>
<p>The configuration for this plugin is a single string, the name of the subaccount
to add to post the unrealized gains to, like this:</p>
<p>plugin "beancount.plugins.unrealized" "Unrealized"</p>
<p>If you don't specify a name for the subaccount (the configuration value is
optional), by default it inserts the unrealized gains in the same account that
is being adjusted.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.plugins.unrealized.UnrealizedError">
<code>UnrealizedError</code>
<a class="headerlink" href="#beancount.plugins.unrealized.UnrealizedError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>UnrealizedError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.unrealized.UnrealizedError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.unrealized.UnrealizedError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/unrealized.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.unrealized.UnrealizedError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.unrealized.UnrealizedError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of UnrealizedError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.plugins.unrealized.UnrealizedError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.plugins.unrealized.UnrealizedError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/plugins/unrealized.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.unrealized.add_unrealized_gains">
<code class="highlight language-python">
add_unrealized_gains<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">subaccount</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.unrealized.add_unrealized_gains" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Insert entries for unrealized capital gains.</p>
<p>This function inserts entries that represent unrealized gains, at the end of
the available history. It returns a new list of entries, with the new gains
inserted. It replaces the account type with an entry in an income account.
Optionally, it can book the gain in a subaccount of the original and income
accounts.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of data directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>A dict of options, that confirms to beancount.parser.options.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>subaccount</code></td>
<td><code></code></td>
<td>
<p>A string, and optional the name of a subaccount to create
under an account to book the unrealized gain. If this is left to its
default value, the gain is booked directly in the same account.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of entries, which includes the new unrealized capital gains entries
at the end, and a list of errors. The new list of entries is still sorted.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/unrealized.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">add_unrealized_gains</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">subaccount</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Insert entries for unrealized capital gains.</span>

<span class="sd">    This function inserts entries that represent unrealized gains, at the end of</span>
<span class="sd">    the available history. It returns a new list of entries, with the new gains</span>
<span class="sd">    inserted. It replaces the account type with an entry in an income account.</span>
<span class="sd">    Optionally, it can book the gain in a subaccount of the original and income</span>
<span class="sd">    accounts.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of data directives.</span>
<span class="sd">      options_map: A dict of options, that confirms to beancount.parser.options.</span>
<span class="sd">      subaccount: A string, and optional the name of a subaccount to create</span>
<span class="sd">        under an account to book the unrealized gain. If this is left to its</span>
<span class="sd">        default value, the gain is booked directly in the same account.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of entries, which includes the new unrealized capital gains entries</span>
<span class="sd">      at the end, and a list of errors. The new list of entries is still sorted.</span>
<span class="sd">    """</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;unrealized_gains&gt;'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">account_types</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_account_types</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>

    <span class="c1"># Assert the subaccount name is in valid format.</span>
    <span class="k">if</span> <span class="n">subaccount</span><span class="p">:</span>
        <span class="n">validation_account</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">account_types</span><span class="o">.</span><span class="n">assets</span><span class="p">,</span> <span class="n">subaccount</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">account</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">validation_account</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">UnrealizedError</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span>
                                <span class="s2">"Invalid subaccount name: '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subaccount</span><span class="p">),</span>
                                <span class="kc">None</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>

    <span class="c1"># Group positions by (account, cost, cost_currency).</span>
    <span class="n">price_map</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">build_price_map</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="n">holdings_list</span> <span class="o">=</span> <span class="n">holdings</span><span class="o">.</span><span class="n">get_final_holdings</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">price_map</span><span class="o">=</span><span class="n">price_map</span><span class="p">)</span>

    <span class="c1"># Group positions by (account, cost, cost_currency).</span>
    <span class="n">holdings_list</span> <span class="o">=</span> <span class="n">holdings</span><span class="o">.</span><span class="n">aggregate_holdings_by</span><span class="p">(</span>
        <span class="n">holdings_list</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">))</span>

    <span class="c1"># Get the latest prices from the entries.</span>
    <span class="n">price_map</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">build_price_map</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="c1"># Create transactions to account for each position.</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">latest_date</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">holding</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">holdings_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span> <span class="ow">or</span>
            <span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Note: since we're only considering positions held at cost, the</span>
        <span class="c1"># transaction that created the position *must* have created at least one</span>
        <span class="c1"># price point for that commodity, so we never expect for a price not to</span>
        <span class="c1"># be available, which is reasonable.</span>
        <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">price_number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># An entry without a price might indicate that this is a holding</span>
            <span class="c1"># resulting from leaked cost basis. {0ed05c502e63, b/16}</span>
            <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">UnrealizedError</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span>
                                    <span class="s2">"A valid price for </span><span class="si">{h.currency}</span><span class="s2">/</span><span class="si">{h.cost_currency}</span><span class="s2"> "</span>
                                    <span class="s2">"could not be found"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="o">=</span><span class="n">holding</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="c1"># Compute the PnL; if there is no profit or loss, we create a</span>
        <span class="c1"># corresponding entry anyway.</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="n">holding</span><span class="o">.</span><span class="n">market_value</span> <span class="o">-</span> <span class="n">holding</span><span class="o">.</span><span class="n">book_value</span>
        <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">number</span> <span class="o">==</span> <span class="n">ZERO</span><span class="p">:</span>
            <span class="c1"># If the number of units sum to zero, the holdings should have been</span>
            <span class="c1"># zero.</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">UnrealizedError</span><span class="p">(</span>
                    <span class="n">meta</span><span class="p">,</span>
                    <span class="s2">"Number of units of </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2"> in holdings sum to zero "</span>
                    <span class="s2">"for account </span><span class="si">{}</span><span class="s2"> and should not"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">holding</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">,</span> <span class="n">holding</span><span class="o">.</span><span class="n">account</span><span class="p">),</span>
                    <span class="kc">None</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="c1"># Compute the name of the accounts and add the requested subaccount name</span>
        <span class="c1"># if requested.</span>
        <span class="n">asset_account</span> <span class="o">=</span> <span class="n">holding</span><span class="o">.</span><span class="n">account</span>
        <span class="n">income_account</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">account_types</span><span class="o">.</span><span class="n">income</span><span class="p">,</span>
                                      <span class="n">account</span><span class="o">.</span><span class="n">sans_root</span><span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">account</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">subaccount</span><span class="p">:</span>
            <span class="n">asset_account</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asset_account</span><span class="p">,</span> <span class="n">subaccount</span><span class="p">)</span>
            <span class="n">income_account</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">income_account</span><span class="p">,</span> <span class="n">subaccount</span><span class="p">)</span>

        <span class="c1"># Create a new transaction to account for this difference in gain.</span>
        <span class="n">gain_loss_str</span> <span class="o">=</span> <span class="s2">"gain"</span> <span class="k">if</span> <span class="n">pnl</span> <span class="o">&gt;</span> <span class="n">ZERO</span> <span class="k">else</span> <span class="s2">"loss"</span>
        <span class="n">narration</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"Unrealized </span><span class="si">{}</span><span class="s2"> for </span><span class="si">{h.number}</span><span class="s2"> units of </span><span class="si">{h.currency}</span><span class="s2"> "</span>
                     <span class="s2">"(price: </span><span class="si">{h.price_number:.4f}</span><span class="s2"> </span><span class="si">{h.cost_currency}</span><span class="s2"> as of </span><span class="si">{h.price_date}</span><span class="s2">, "</span>
                     <span class="s2">"average cost: </span><span class="si">{h.cost_number:.4f}</span><span class="s2"> </span><span class="si">{h.cost_currency}</span><span class="s2">)"</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                         <span class="n">gain_loss_str</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">holding</span><span class="p">)</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s2">"filename"</span><span class="p">],</span> <span class="n">lineno</span><span class="o">=</span><span class="mi">1000</span> <span class="o">+</span> <span class="n">index</span><span class="p">),</span>
                                 <span class="n">latest_date</span><span class="p">,</span> <span class="n">flags</span><span class="o">.</span><span class="n">FLAG_UNREALIZED</span><span class="p">,</span>
                                 <span class="kc">None</span><span class="p">,</span> <span class="n">narration</span><span class="p">,</span> <span class="n">EMPTY_SET</span><span class="p">,</span> <span class="n">EMPTY_SET</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># Book this as income, converting the account name to be the same, but as income.</span>
        <span class="c1"># Note: this is a rather convenient but arbitrary choice--maybe it would be best to</span>
        <span class="c1"># let the user decide to what account to book it, but I don't a nice way to let the</span>
        <span class="c1"># user specify this.</span>
        <span class="c1">#</span>
        <span class="c1"># Note: we never set a price because we don't want these to end up in Conversions.</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span>
                <span class="n">asset_account</span><span class="p">,</span>
                <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">pnl</span><span class="p">,</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">),</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">),</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span>
                <span class="n">income_account</span><span class="p">,</span>
                <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="o">-</span><span class="n">pnl</span><span class="p">,</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">),</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="c1"># Ensure that the accounts we're going to use to book the postings exist, by</span>
    <span class="c1"># creating open entries for those that we generated that weren't already</span>
    <span class="c1"># existing accounts.</span>
    <span class="n">new_accounts</span> <span class="o">=</span> <span class="p">{</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span>
                    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">new_entries</span>
                    <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">}</span>
    <span class="n">open_entries</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_account_open_close</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="n">new_open_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">account_</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">new_accounts</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">account_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">open_entries</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s2">"filename"</span><span class="p">],</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">open_entry</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">latest_date</span><span class="p">,</span> <span class="n">account_</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">new_open_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">open_entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">new_open_entries</span> <span class="o">+</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.unrealized.get_unrealized_entries">
<code class="highlight language-python">
get_unrealized_entries<span class="p">(</span><span class="n">entries</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.unrealized.get_unrealized_entries" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return entries automatically created for unrealized gains.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of directives, all of which are in the original list.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/unrealized.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>181
182
183
184
185
186
187
188
189
190
191
192</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_unrealized_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
    <span class="sd">"""Return entries automatically created for unrealized gains.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of directives, all of which are in the original list.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">entry</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">flag</span> <span class="o">==</span> <span class="n">flags</span><span class="o">.</span><span class="n">FLAG_UNREALIZED</span><span class="p">)]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.plugins.unrealized_test">
<code>unrealized_test</code>
<a class="headerlink" href="#beancount.plugins.unrealized_test" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.plugins.unrealized_test.get_entries_with_narration">
<code class="highlight language-python">
get_entries_with_narration<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">regexp</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.plugins.unrealized_test.get_entries_with_narration" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return the entries whose narration matches the regexp.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>regexp</code></td>
<td><code></code></td>
<td>
<p>A regular expression string, to be matched against the
narration field of transactions.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/plugins/unrealized_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_entries_with_narration</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">regexp</span><span class="p">):</span>
    <span class="sd">"""Return the entries whose narration matches the regexp.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      regexp: A regular expression string, to be matched against the</span>
<span class="sd">        narration field of transactions.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of directives.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">entry</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regexp</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">narration</span><span class="p">))]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<footer>
<div aria-label="footer navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-right" href="beancount.query.html" title="beancount.query">Next <span class="icon icon-circle-arrow-right"></span></a>
<a class="btn btn-neutral" href="beancount.parser.html" title="beancount.parser"><span class="icon icon-circle-arrow-left"></span> Previous</a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<a class="fa fa-github" href="https://github.com/xuhcc/beancount-docs/" style="float: left; color: #fcfcfc"> GitHub</a>
<span><a href="beancount.parser.html" style="color: #fcfcfc;">« Previous</a></span>
<span style="margin-left: 15px"><a href="beancount.query.html" style="color: #fcfcfc">Next »</a></span>
</span>
</div>
<script>var base_url = '..';</script>
<script defer="" src="../js/theme.js"></script>
<script defer="" src="../js/extra.js"></script>
<script defer="">
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>
</body>
</html>
