<!DOCTYPE html>

<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://xuhcc.github.io/beancount-docs/api_reference/beancount.ops.html" rel="canonical"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>beancount.ops - Beancount Documentation</title>
<link href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" rel="stylesheet">
<link href="../css/theme.css" rel="stylesheet">
<link href="../css/theme_extra.css" rel="stylesheet"/>
<script>
    // Current page data
    var mkdocs_page_name = "beancount.ops";
    var mkdocs_page_input_path = "api_reference/beancount.ops.md";
    var mkdocs_page_url = "/beancount-docs/api_reference/beancount.ops.html";
  </script>
<script defer="" src="../js/jquery-2.1.1.min.js"></script>
<script defer="" src="../js/modernizr-2.8.3.min.js"></script>
</link></link></head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href=".."> Beancount Documentation</a>
</div>
<div aria-label="main navigation" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Index</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Outline</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="#">Documentation for Users</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../01_command_line_accounting_in_context.html">Command Line Accounting in Context</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../02_the_double_entry_counting_method.html">The Double Entry Counting Method</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../03_installing_beancount.html">Installing Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../04_running_beancount_and_generating_reports.html">Running Beancount and Generating Reports</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../05_getting_started_with_beancount.html">Getting Started with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../06_beancount_language_syntax.html">Beancount Language Syntax</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../07_beancount_options_reference.html">Beancount Options Reference</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../08_precision_tolerances.html">Precision Tolerances</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../09_beancount_query_language.html">Beancount Query Language</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../10_beancount_cheat_sheet.html">Beancount Cheat Sheet</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../11_how_inventories_work.html">How Inventories Work</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../12_exporting_your_portfolio.html">Exporting Your Portfolio</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../13_tutorial_example.html">Tutorial &amp; Example</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../14_beancount_history_and_credits.html">Beancount History and Credits</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../15_a_comparison_of_beancount_and_ledger_hledger.html">A Comparison of Beancount and Ledger Hledger</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../16_fetching_prices_in_beancount.html">Fetching Prices in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../17_importing_external_data.html">Importing External Data</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Cookbooks &amp; Examples</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../18_command_line_accounting_cookbook.html">Command Line Accounting Cookbook</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../19_trading_with_beancount.html">Trading with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../20_stock_vesting_in_beancount.html">Stock Vesting in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../21_sharing_expenses_with_beancount.html">Sharing Expenses with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../22_how_we_share_expenses.html">How We Share Expenses</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Documentation for Developers</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../23_beancount_scripting_plugins.html">Beancount Scripting Plugins</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../24_beancount_design_doc.html">Beancount Design Doc</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../25_ledgerhub_design_doc.html">Ledgerhub Design Doc</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../26_external_contributions.html">External Contributions</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#">Enhancement Proposals &amp; Discussions</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../27_a_proposal_for_an_improvement_on_inventory_booking.html">A Proposal for an Improvement on Inventory Booking</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../28_settlement_dates_in_beancount.html">Settlement Dates in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../29_balance_assertions_in_beancount.html">Balance Assertions in Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../30_fund_accounting_with_beancount.html">Fund Accounting with Beancount</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../31_rounding_precision_in_beancount.html">Rounding Precision in Beancount</a>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">beancount</a>
</li>
<li class="toctree-l1 current"><a class="reference internal current" href="beancount.ops.html">beancount.ops</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="#beancount.ops">beancount.ops</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ops.balance">balance</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.balance.BalanceError">BalanceError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.balance.BalanceError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.balance.BalanceError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.balance.BalanceError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.balance.check">check()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.balance.get_balance_tolerance">get_balance_tolerance()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ops.basicops">basicops</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.basicops.filter_link">filter_link()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.basicops.filter_tag">filter_tag()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.basicops.get_common_accounts">get_common_accounts()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.basicops.group_entries_by_link">group_entries_by_link()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ops.compress">compress</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.compress.compress">compress()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.compress.merge">merge()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ops.documents">documents</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.documents.DocumentError">DocumentError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.documents.DocumentError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.documents.DocumentError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.documents.DocumentError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.documents.find_documents">find_documents()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.documents.process_documents">process_documents()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.documents.verify_document_files_exist">verify_document_files_exist()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ops.documents_test">documents_test</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ops.holdings">holdings</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.holdings.Holding">Holding</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.holdings.Holding.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.holdings.Holding.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.holdings.Holding.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.holdings.aggregate_holdings_by">aggregate_holdings_by()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.holdings.aggregate_holdings_list">aggregate_holdings_list()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.holdings.convert_to_currency">convert_to_currency()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.holdings.get_commodities_at_date">get_commodities_at_date()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.holdings.get_final_holdings">get_final_holdings()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.holdings.holding_to_position">holding_to_position()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.holdings.holding_to_posting">holding_to_posting()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.holdings.reduce_relative">reduce_relative()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.holdings.scale_holding">scale_holding()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ops.lifetimes">lifetimes</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.lifetimes.compress_intervals_days">compress_intervals_days()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.lifetimes.compress_lifetimes_days">compress_lifetimes_days()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.lifetimes.get_commodity_lifetimes">get_commodity_lifetimes()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.lifetimes.required_weekly_prices">required_weekly_prices()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ops.pad">pad</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.pad.PadError">PadError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.pad.PadError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.pad.PadError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.pad.PadError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.pad.pad">pad()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ops.summarize">summarize</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.balance_by_account">balance_by_account()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.cap">cap()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.cap_opt">cap_opt()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.clamp">clamp()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.clamp_opt">clamp_opt()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.clear">clear()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.clear_opt">clear_opt()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.close">close()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.close_opt">close_opt()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.conversions">conversions()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.create_entries_from_balances">create_entries_from_balances()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.get_open_entries">get_open_entries()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.open">open()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.open_opt">open_opt()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.summarize">summarize()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.transfer_balances">transfer_balances()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize.truncate">truncate()</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ops.summarize_test">summarize_test</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize_test.TestBalanceByAccount">TestBalanceByAccount</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.summarize_test.TestBalanceByAccount.setUp">setUp()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize_test.TestConversions">TestConversions</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.summarize_test.TestConversions.setUp">setUp()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize_test.TestEntriesFromBalance">TestEntriesFromBalance</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.summarize_test.TestEntriesFromBalance.setUp">setUp()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize_test.TestOpenAtDate">TestOpenAtDate</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.summarize_test.TestOpenAtDate.setUp">setUp()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize_test.TestOpenClose">TestOpenClose</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.summarize_test.TestOpenClose.setUp">setUp()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize_test.TestOpenCloseWithOptions">TestOpenCloseWithOptions</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize_test.TestTransferBalances">TestTransferBalances</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.summarize_test.TestTransferBalances.setUp">setUp()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.summarize_test.TestTruncate">TestTruncate</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.summarize_test.TestTruncate.setUp">setUp()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beancount.ops.validation">validation</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.ValidationError">ValidationError</a>
<ul>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.validation.ValidationError.__getnewargs__">__getnewargs__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.validation.ValidationError.__new__">__new__()</a>
</li>
<li class="toctree-l4"><a class="reference internal" href="#beancount.ops.validation.ValidationError.__repr__">__repr__()</a>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate">validate()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_active_accounts">validate_active_accounts()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_check_transaction_balances">validate_check_transaction_balances()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_currency_constraints">validate_currency_constraints()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_data_types">validate_data_types()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_documents_paths">validate_documents_paths()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_duplicate_balances">validate_duplicate_balances()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_duplicate_commodities">validate_duplicate_commodities()</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#beancount.ops.validation.validate_open_close">validate_open_close()</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="beancount.utils.html">beancount.utils</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="top navigation" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="..">Beancount Documentation</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a href="..">Docs</a> »</li>
<li>API reference »</li>
<li>beancount.ops</li>
<li class="wy-breadcrumbs-aside">
<a class="icon icon-github" href="https://github.com/xuhcc/beancount-docs/edit/master/docs/api_reference/beancount.ops.md"> Edit on GitHub</a>
</li>
</ul>
<hr/>
</div>
<div role="main">
<div class="section">
<h1 id="beancountops">beancount.ops<a class="headerlink" href="#beancountops" title="Permanent link"></a></h1>
<div class="doc doc-object doc-module">
<h2 class="hidden-toc" href="#beancount.ops" id="beancount.ops" style="visibility: hidden; width: 0; height: 0;">
<a class="headerlink" href="#beancount.ops" title="Permanent link"></a></h2>
<div class="doc doc-contents first">
<p>Operations on the entries defined in the core modules.</p>
<p>This package contains various functions which operate on lists of entries.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ops.balance">
<code>balance</code>
<a class="headerlink" href="#beancount.ops.balance" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Automatic padding of gaps between entries.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ops.balance.BalanceError">
<code>BalanceError</code>
<a class="headerlink" href="#beancount.ops.balance.BalanceError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>BalanceError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.balance.BalanceError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ops.balance.BalanceError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/balance.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.balance.BalanceError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.ops.balance.BalanceError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of BalanceError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.balance.BalanceError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ops.balance.BalanceError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/balance.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.balance.check">
<code class="highlight language-python">
check<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.balance.check" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Process the balance assertion directives.</p>
<p>For each Balance directive, check that their expected balance corresponds to
the actual balance computed at that time and replace failing ones by new
ones with a flag that indicates failure.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>A dict of options, parsed from the input file.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A pair of a list of directives and a list of balance check errors.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/balance.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Process the balance assertion directives.</span>

<span class="sd">    For each Balance directive, check that their expected balance corresponds to</span>
<span class="sd">    the actual balance computed at that time and replace failing ones by new</span>
<span class="sd">    ones with a flag that indicates failure.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      options_map: A dict of options, parsed from the input file.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A pair of a list of directives and a list of balance check errors.</span>
<span class="sd">    """</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">check_errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># This is similar to realization, but performed in a different order, and</span>
    <span class="c1"># where we only accumulate inventories for accounts that have balance</span>
    <span class="c1"># assertions in them (this saves on time). Here we process the entries one</span>
    <span class="c1"># by one along with the balance checks. We use a temporary realization in</span>
    <span class="c1"># order to hold the incremental tree of balances, so that we can easily get</span>
    <span class="c1"># the amounts of an account's subaccounts for making checks on parent</span>
    <span class="c1"># accounts.</span>
    <span class="n">real_root</span> <span class="o">=</span> <span class="n">realization</span><span class="o">.</span><span class="n">RealAccount</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>

    <span class="c1"># Figure out the set of accounts for which we need to compute a running</span>
    <span class="c1"># inventory balance.</span>
    <span class="n">asserted_accounts</span> <span class="o">=</span> <span class="p">{</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span>
                         <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span>
                         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Balance</span><span class="p">)}</span>

    <span class="c1"># Add all children accounts of an asserted account to be calculated as well,</span>
    <span class="c1"># and pre-create these accounts, and only those (we're just being tight to</span>
    <span class="c1"># make sure).</span>
    <span class="n">asserted_match_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">account</span><span class="o">.</span><span class="n">parent_matcher</span><span class="p">(</span><span class="n">account_</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">account_</span> <span class="ow">in</span> <span class="n">asserted_accounts</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">account_</span> <span class="ow">in</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_accounts</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">account_</span> <span class="ow">in</span> <span class="n">asserted_accounts</span> <span class="ow">or</span>
            <span class="nb">any</span><span class="p">(</span><span class="n">match</span><span class="p">(</span><span class="n">account_</span><span class="p">)</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">asserted_match_list</span><span class="p">)):</span>
            <span class="n">realization</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">real_root</span><span class="p">,</span> <span class="n">account_</span><span class="p">)</span>

    <span class="c1"># Get the Open directives for each account.</span>
    <span class="n">open_close_map</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_account_open_close</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">):</span>
            <span class="c1"># For each of the postings' accounts, update the balance inventory.</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
                <span class="n">real_account</span> <span class="o">=</span> <span class="n">realization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">real_root</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>

                <span class="c1"># The account will have been created only if we're meant to track it.</span>
                <span class="k">if</span> <span class="n">real_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Note: Always allow negative lots for the purpose of balancing.</span>
                    <span class="c1"># This error should show up somewhere else than here.</span>
                    <span class="n">real_account</span><span class="o">.</span><span class="n">balance</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Balance</span><span class="p">):</span>
            <span class="c1"># Check that the currency of the balance check is one of the allowed</span>
            <span class="c1"># currencies for that account.</span>
            <span class="n">expected_amount</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">amount</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">open</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">open_close_map</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">check_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">BalanceError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                                 <span class="s2">"Account '</span><span class="si">{}</span><span class="s2">' does not exist: "</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">),</span>
                                 <span class="n">entry</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">expected_amount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="nb">open</span> <span class="ow">and</span> <span class="nb">open</span><span class="o">.</span><span class="n">currencies</span> <span class="ow">and</span>
                <span class="n">expected_amount</span><span class="o">.</span><span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">open</span><span class="o">.</span><span class="n">currencies</span><span class="p">):</span>
                <span class="n">check_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">BalanceError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                                 <span class="s2">"Invalid currency '</span><span class="si">{}</span><span class="s2">' for Balance directive: "</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                     <span class="n">expected_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">),</span>
                                 <span class="n">entry</span><span class="p">))</span>

            <span class="c1"># Check the balance against the check entry.</span>
            <span class="n">real_account</span> <span class="o">=</span> <span class="n">realization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">real_root</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">real_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">"Missing </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>

            <span class="c1"># Sum up the current balances for this account and its</span>
            <span class="c1"># sub-accounts. We want to support checks for parent accounts</span>
            <span class="c1"># for the total sum of their subaccounts.</span>
            <span class="n">subtree_balance</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">real_child</span> <span class="ow">in</span> <span class="n">realization</span><span class="o">.</span><span class="n">iter_children</span><span class="p">(</span><span class="n">real_account</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">subtree_balance</span> <span class="o">+=</span> <span class="n">real_child</span><span class="o">.</span><span class="n">balance</span>

            <span class="c1"># Get only the amount in the desired currency.</span>
            <span class="n">balance_amount</span> <span class="o">=</span> <span class="n">subtree_balance</span><span class="o">.</span><span class="n">get_currency_units</span><span class="p">(</span><span class="n">expected_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>

            <span class="c1"># Check if the amount is within bounds of the expected amount.</span>
            <span class="n">diff_amount</span> <span class="o">=</span> <span class="n">amount</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">balance_amount</span><span class="p">,</span> <span class="n">expected_amount</span><span class="p">)</span>

            <span class="c1"># Use the specified tolerance or automatically infer it.</span>
            <span class="n">tolerance</span> <span class="o">=</span> <span class="n">get_balance_tolerance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff_amount</span><span class="o">.</span><span class="n">number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">:</span>
                <span class="n">check_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">BalanceError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                                 <span class="p">(</span><span class="s2">"Balance failed for '</span><span class="si">{}</span><span class="s2">': "</span>
                                  <span class="s2">"expected </span><span class="si">{}</span><span class="s2"> != accumulated </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">)"</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                      <span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">expected_amount</span><span class="p">,</span> <span class="n">balance_amount</span><span class="p">,</span>
                                      <span class="nb">abs</span><span class="p">(</span><span class="n">diff_amount</span><span class="o">.</span><span class="n">number</span><span class="p">),</span>
                                      <span class="p">(</span><span class="s1">'too much'</span>
                                       <span class="k">if</span> <span class="n">diff_amount</span><span class="o">.</span><span class="n">number</span> <span class="o">&gt;</span> <span class="mi">0</span>
                                       <span class="k">else</span> <span class="s1">'too little'</span><span class="p">)),</span>
                                 <span class="n">entry</span><span class="p">))</span>

                <span class="c1"># Substitute the entry by a failing entry, with the diff_amount</span>
                <span class="c1"># field set on it. I'm not entirely sure that this is the best</span>
                <span class="c1"># of ideas, maybe leaving the original check intact and insert a</span>
                <span class="c1"># new error entry might be more functional or easier to</span>
                <span class="c1"># understand.</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                    <span class="n">meta</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="n">diff_amount</span><span class="o">=</span><span class="n">diff_amount</span><span class="p">)</span>

        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">check_errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.balance.get_balance_tolerance">
<code class="highlight language-python">
get_balance_tolerance<span class="p">(</span><span class="n">balance_entry</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.balance.get_balance_tolerance" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Get the tolerance amount for a single entry.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>balance_entry</code></td>
<td><code></code></td>
<td>
<p>An instance of data.Balance</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>An options dict, as per the parser.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A Decimal, the amount of tolerance implied by the directive.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/balance.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_balance_tolerance</span><span class="p">(</span><span class="n">balance_entry</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Get the tolerance amount for a single entry.</span>

<span class="sd">    Args:</span>
<span class="sd">      balance_entry: An instance of data.Balance</span>
<span class="sd">      options_map: An options dict, as per the parser.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A Decimal, the amount of tolerance implied by the directive.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">balance_entry</span><span class="o">.</span><span class="n">tolerance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Use the balance-specific tolerance override if it is provided.</span>
        <span class="n">tolerance</span> <span class="o">=</span> <span class="n">balance_entry</span><span class="o">.</span><span class="n">tolerance</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">expo</span> <span class="o">=</span> <span class="n">balance_entry</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">as_tuple</span><span class="p">()</span><span class="o">.</span><span class="n">exponent</span>
        <span class="k">if</span> <span class="n">expo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Be generous and always allow twice the multiplier on Balance and</span>
            <span class="c1"># Pad because the user creates these and the rounding of those</span>
            <span class="c1"># balances may often be further off than those used within a single</span>
            <span class="c1"># transaction.</span>
            <span class="n">tolerance</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s2">"inferred_tolerance_multiplier"</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">tolerance</span> <span class="o">=</span> <span class="n">ONE</span><span class="o">.</span><span class="n">scaleb</span><span class="p">(</span><span class="n">expo</span><span class="p">)</span> <span class="o">*</span> <span class="n">tolerance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tolerance</span> <span class="o">=</span> <span class="n">ZERO</span>

    <span class="k">return</span> <span class="n">tolerance</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ops.basicops">
<code>basicops</code>
<a class="headerlink" href="#beancount.ops.basicops" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Basic filteirng and aggregration operations on lists of entries.</p>
<p>This module contains some common basic operations on entries that are complex
enough not to belong in core/data.py.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.basicops.filter_link">
<code class="highlight language-python">
filter_link<span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">entries</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.basicops.filter_link" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Yield all the entries which have the given link.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>link</code></td>
<td><code></code></td>
<td>
<p>A string, the link we are interested in.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p>Yields:
  Every entry in 'entries' that links to 'link.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/basicops.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>30
31
32
33
34
35
36
37
38
39
40
41
42</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">filter_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">entries</span><span class="p">):</span>
    <span class="sd">"""Yield all the entries which have the given link.</span>

<span class="sd">    Args:</span>
<span class="sd">      link: A string, the link we are interested in.</span>
<span class="sd">    Yields:</span>
<span class="sd">      Every entry in 'entries' that links to 'link.</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="c1"># pylint: disable=bad-continuation</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">links</span> <span class="ow">and</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">links</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">entry</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.basicops.filter_tag">
<code class="highlight language-python">
filter_tag<span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">entries</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.basicops.filter_tag" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Yield all the entries which have the given tag.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tag</code></td>
<td><code></code></td>
<td>
<p>A string, the tag we are interested in.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p>Yields:
  Every entry in 'entries' that tags to 'tag.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/basicops.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">filter_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">entries</span><span class="p">):</span>
    <span class="sd">"""Yield all the entries which have the given tag.</span>

<span class="sd">    Args:</span>
<span class="sd">      tag: A string, the tag we are interested in.</span>
<span class="sd">    Yields:</span>
<span class="sd">      Every entry in 'entries' that tags to 'tag.</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="c1"># pylint: disable=bad-continuation</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span>
            <span class="n">tag</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">tags</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">entry</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.basicops.get_common_accounts">
<code class="highlight language-python">
get_common_accounts<span class="p">(</span><span class="n">entries</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.basicops.get_common_accounts" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Compute the intersection of the accounts on the given entries.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of Transaction entries to process.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A set of strings, the names of the common accounts from these
entries.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/basicops.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_common_accounts</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
    <span class="sd">"""Compute the intersection of the accounts on the given entries.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of Transaction entries to process.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A set of strings, the names of the common accounts from these</span>
<span class="sd">      entries.</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">)</span>

    <span class="c1"># If there is a single entry, the common accounts to it is all its accounts.</span>
    <span class="c1"># Note that this also works with no entries (yields an empty set).</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">intersection</span> <span class="o">=</span> <span class="p">{</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span> <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">postings</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">intersection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">entries_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span> <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="nb">next</span><span class="p">(</span><span class="n">entries_iter</span><span class="p">)</span><span class="o">.</span><span class="n">postings</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries_iter</span><span class="p">:</span>
            <span class="n">accounts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span> <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">)</span>
            <span class="n">intersection</span> <span class="o">&amp;=</span> <span class="n">accounts</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">intersection</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">intersection</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.basicops.group_entries_by_link">
<code class="highlight language-python">
group_entries_by_link<span class="p">(</span><span class="n">entries</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.basicops.group_entries_by_link" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Group the list of entries by link.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives/transactions to process.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A dict of link-name to list of entries.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/basicops.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">group_entries_by_link</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
    <span class="sd">"""Group the list of entries by link.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives/transactions to process.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A dict of link-name to list of entries.</span>
<span class="sd">    """</span>
    <span class="n">link_groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">links</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="n">link_groups</span><span class="p">[</span><span class="n">link</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">link_groups</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ops.compress">
<code>compress</code>
<a class="headerlink" href="#beancount.ops.compress" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Compress multiple entries into a single one.</p>
<p>This can be used during import to compress the effective output, for accounts
with a large number of similar entries. For example, I had a trading account
which would pay out interest every single day. I have no desire to import the
full detail of these daily interests, and compressing these interest-only
entries to monthly ones made sense. This is the code that was used to carry this
out.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.compress.compress">
<code class="highlight language-python">
compress<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">predicate</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.compress.compress" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Compress multiple transactions into single transactions.</p>
<p>Replace consecutive sequences of Transaction entries that fulfill the given
predicate by a single entry at the date of the last matching entry.
'predicate' is the function that determines if an entry should be
compressed.</p>
<p>This can be used to simply a list of transactions that are similar and occur
frequently. As an example, in a retail FOREX trading account, differential
interest of very small amounts is paid every day; it is not relevant to look
at the full detail of this interest unless there are other transactions. You
can use this to compress it into single entries between other types of
transactions.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>predicate</code></td>
<td><code></code></td>
<td>
<p>A callbable which accepts an entry and return true if the entry
  is intended to be compressed.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of directives, with compressible transactions replaced by a summary
equivalent.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/compress.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">predicate</span><span class="p">):</span>
    <span class="sd">"""Compress multiple transactions into single transactions.</span>

<span class="sd">    Replace consecutive sequences of Transaction entries that fulfill the given</span>
<span class="sd">    predicate by a single entry at the date of the last matching entry.</span>
<span class="sd">    'predicate' is the function that determines if an entry should be</span>
<span class="sd">    compressed.</span>

<span class="sd">    This can be used to simply a list of transactions that are similar and occur</span>
<span class="sd">    frequently. As an example, in a retail FOREX trading account, differential</span>
<span class="sd">    interest of very small amounts is paid every day; it is not relevant to look</span>
<span class="sd">    at the full detail of this interest unless there are other transactions. You</span>
<span class="sd">    can use this to compress it into single entries between other types of</span>
<span class="sd">    transactions.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      predicate: A callbable which accepts an entry and return true if the entry</span>
<span class="sd">          is intended to be compressed.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of directives, with compressible transactions replaced by a summary</span>
<span class="sd">      equivalent.</span>
<span class="sd">    """</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pending</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span> <span class="n">predicate</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
            <span class="c1"># Save for compressing later.</span>
            <span class="n">pending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Compress and output all the pending entries.</span>
            <span class="k">if</span> <span class="n">pending</span><span class="p">:</span>
                <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">pending</span><span class="p">,</span> <span class="n">pending</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">pending</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="c1"># Output the differing entry.</span>
            <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pending</span><span class="p">:</span>
        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">pending</span><span class="p">,</span> <span class="n">pending</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">new_entries</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.compress.merge">
<code class="highlight language-python">
merge<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">prototype_txn</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.compress.merge" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Merge the postings of a list of Transactions into a single one.</p>
<p>Merge postings the given entries into a single entry with the Transaction
attributes of the prototype. Return the new entry. The combined list of
postings are merged if everything about the postings is the same except the
number.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>prototype_txn</code></td>
<td><code></code></td>
<td>
<p>A Transaction which is used to create the compressed
  Transaction instance. Its list of postings is ignored.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A new Transaction instance which contains all the postings from the input
entries merged together.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/compress.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">prototype_txn</span><span class="p">):</span>
    <span class="sd">"""Merge the postings of a list of Transactions into a single one.</span>

<span class="sd">    Merge postings the given entries into a single entry with the Transaction</span>
<span class="sd">    attributes of the prototype. Return the new entry. The combined list of</span>
<span class="sd">    postings are merged if everything about the postings is the same except the</span>
<span class="sd">    number.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      prototype_txn: A Transaction which is used to create the compressed</span>
<span class="sd">          Transaction instance. Its list of postings is ignored.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new Transaction instance which contains all the postings from the input</span>
<span class="sd">      entries merged together.</span>

<span class="sd">    """</span>
    <span class="c1"># Aggregate the postings together. This is a mapping of numberless postings</span>
    <span class="c1"># to their number of units.</span>
    <span class="n">postings_map</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">Decimal</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">filter_txns</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="c1"># We strip the number off the posting to act as an aggregation key.</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                               <span class="n">Amount</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">),</span>
                               <span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
                               <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                               <span class="n">posting</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                               <span class="kc">None</span><span class="p">)</span>
            <span class="n">postings_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span>

    <span class="c1"># Create a new transaction with the aggregated postings.</span>
    <span class="n">new_entry</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">(</span><span class="n">prototype_txn</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                                 <span class="n">prototype_txn</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                                 <span class="n">prototype_txn</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                                 <span class="n">prototype_txn</span><span class="o">.</span><span class="n">payee</span><span class="p">,</span>
                                 <span class="n">prototype_txn</span><span class="o">.</span><span class="n">narration</span><span class="p">,</span>
                                 <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># Sort for at least some stability of output.</span>
    <span class="n">sorted_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">postings_map</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                          <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                                            <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
                                            <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># Issue the merged postings.</span>
    <span class="k">for</span> <span class="n">posting</span><span class="p">,</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">sorted_items</span><span class="p">:</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">Amount</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
        <span class="n">new_entry</span><span class="o">.</span><span class="n">postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                         <span class="n">posting</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">new_entry</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ops.documents">
<code>documents</code>
<a class="headerlink" href="#beancount.ops.documents" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Everything that relates to creating the Document directives.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ops.documents.DocumentError">
<code>DocumentError</code>
<a class="headerlink" href="#beancount.ops.documents.DocumentError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>DocumentError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.documents.DocumentError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ops.documents.DocumentError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/documents.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.documents.DocumentError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.ops.documents.DocumentError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of DocumentError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.documents.DocumentError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ops.documents.DocumentError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/documents.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.documents.find_documents">
<code class="highlight language-python">
find_documents<span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">input_filename</span><span class="p">,</span> <span class="n">accounts_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.documents.find_documents" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Find dated document files under the given directory.</p>
<p>If a restricting set of accounts is provided in 'accounts_only', only return
entries that correspond to one of the given accounts.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>directory</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the root of the directory hierarchy to be searched.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>input_filename</code></td>
<td><code></code></td>
<td>
<p>The name of the file to be used for the Document directives. This is
also used to resolve relative directory names.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>accounts_only</code></td>
<td><code></code></td>
<td>
<p>A set of valid accounts strings to search for.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>strict</code></td>
<td><code></code></td>
<td>
<p>A boolean, set to true if you want to generate errors on documents
found in accounts not provided in accounts_only. This is only meaningful
if accounts_only is specified.</p>
</td>
<td><code>False</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new Document objects that were created from the files found, and a list
of new errors generated.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/documents.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_documents</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">input_filename</span><span class="p">,</span> <span class="n">accounts_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Find dated document files under the given directory.</span>

<span class="sd">    If a restricting set of accounts is provided in 'accounts_only', only return</span>
<span class="sd">    entries that correspond to one of the given accounts.</span>

<span class="sd">    Args:</span>
<span class="sd">      directory: A string, the name of the root of the directory hierarchy to be searched.</span>
<span class="sd">      input_filename: The name of the file to be used for the Document directives. This is</span>
<span class="sd">        also used to resolve relative directory names.</span>
<span class="sd">      accounts_only: A set of valid accounts strings to search for.</span>
<span class="sd">      strict: A boolean, set to true if you want to generate errors on documents</span>
<span class="sd">        found in accounts not provided in accounts_only. This is only meaningful</span>
<span class="sd">        if accounts_only is specified.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new Document objects that were created from the files found, and a list</span>
<span class="sd">      of new errors generated.</span>

<span class="sd">    """</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Compute the documents directory name relative to the beancount input</span>
    <span class="c1"># file itself.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">input_directory</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_filename</span><span class="p">)</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_directory</span><span class="p">,</span>
                                                         <span class="n">directory</span><span class="p">)))</span>

    <span class="c1"># If the directory does not exist, just generate an error and return.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">DocumentError</span><span class="p">(</span>
            <span class="n">meta</span><span class="p">,</span> <span class="s2">"Document root '</span><span class="si">{}</span><span class="s2">' does not exist"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">([],</span> <span class="p">[</span><span class="n">error</span><span class="p">])</span>

    <span class="c1"># Walk the hierarchy of files.</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">account_name</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">account</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

        <span class="c1"># Look for files that have a dated filename.</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">'(\d\d\d\d)-(\d\d)-(\d\d).(.*)'</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># If a restricting set of accounts was specified, skip document</span>
            <span class="c1"># directives found in accounts with no corresponding account name.</span>
            <span class="k">if</span> <span class="n">accounts_only</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">account_name</span> <span class="ow">in</span> <span class="n">accounts_only</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">account_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">account</span><span class="p">)</span> <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">accounts_only</span><span class="p">):</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DocumentError</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="s2">"Document '</span><span class="si">{}</span><span class="s2">' found in child account </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">filename</span><span class="p">,</span> <span class="n">account_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">account_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">accounts_only</span><span class="p">):</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DocumentError</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="s2">"Document '</span><span class="si">{}</span><span class="s2">' found in parent account </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">filename</span><span class="p">,</span> <span class="n">account_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c1"># Create a new directive.</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DocumentError</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s2">"Invalid date on document file '</span><span class="si">{}</span><span class="s2">': </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">filename</span><span class="p">,</span> <span class="n">exc</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_name</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                                      <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">)</span>
                <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.documents.process_documents">
<code class="highlight language-python">
process_documents<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.documents.process_documents" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check files for document directives and create documents directives automatically.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of all directives parsed from the file.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>An options dict, as is output by the parser.
We're using its 'filename' option to figure out relative path to
search for documents.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A pair of list of all entries (including new ones), and errors
generated during the process of creating document directives.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/documents.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">process_documents</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Check files for document directives and create documents directives automatically.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of all directives parsed from the file.</span>
<span class="sd">      options_map: An options dict, as is output by the parser.</span>
<span class="sd">        We're using its 'filename' option to figure out relative path to</span>
<span class="sd">        search for documents.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A pair of list of all entries (including new ones), and errors</span>
<span class="sd">      generated during the process of creating document directives.</span>
<span class="sd">    """</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s2">"filename"</span><span class="p">]</span>

    <span class="c1"># Detect filenames that should convert into entries.</span>
    <span class="n">autodoc_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">autodoc_errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">document_dirs</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s1">'documents'</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">document_dirs</span><span class="p">:</span>
        <span class="c1"># Restrict to the list of valid accounts only.</span>
        <span class="n">accounts</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_accounts</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

        <span class="c1"># Accumulate all the entries.</span>
        <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">,</span> <span class="n">document_dirs</span><span class="p">):</span>
            <span class="n">new_entries</span><span class="p">,</span> <span class="n">new_errors</span> <span class="o">=</span> <span class="n">find_documents</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">accounts</span><span class="p">)</span>
            <span class="n">autodoc_entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_entries</span><span class="p">)</span>
            <span class="n">autodoc_errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_errors</span><span class="p">)</span>

    <span class="c1"># Merge the two lists of entries and errors. Keep the entries sorted.</span>
    <span class="n">entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">autodoc_entries</span><span class="p">)</span>
    <span class="n">entries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">entry_sortkey</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">autodoc_errors</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.documents.verify_document_files_exist">
<code class="highlight language-python">
verify_document_files_exist<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.documents.verify_document_files_exist" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Verify that the document entries point to existing files.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>a list of directives whose documents need to be validated.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>A parser options dict. We're not using it.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>The same list of entries, and a list of new errors, if any were encountered.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/documents.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">verify_document_files_exist</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
    <span class="sd">"""Verify that the document entries point to existing files.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: a list of directives whose documents need to be validated.</span>
<span class="sd">      unused_options_map: A parser options dict. We're not using it.</span>
<span class="sd">    Returns:</span>
<span class="sd">      The same list of entries, and a list of new errors, if any were encountered.</span>
<span class="sd">    """</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Document</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">DocumentError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                              <span class="s1">'File does not exist: "</span><span class="si">{}</span><span class="s1">"'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span>
                              <span class="n">entry</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ops.documents_test">
<code>documents_test</code>
<a class="headerlink" href="#beancount.ops.documents_test" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Tests for documents.</p>
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ops.holdings">
<code>holdings</code>
<a class="headerlink" href="#beancount.ops.holdings" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Compute final holdings for a list of entries.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ops.holdings.Holding">
<code>Holding</code>
<a class="headerlink" href="#beancount.ops.holdings.Holding" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Holding(account, number, currency, cost_number, cost_currency, book_value, market_value, price_number, price_date)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.holdings.Holding.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ops.holdings.Holding.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/holdings.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.holdings.Holding.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">cost_number</span><span class="p">,</span> <span class="n">cost_currency</span><span class="p">,</span> <span class="n">book_value</span><span class="p">,</span> <span class="n">market_value</span><span class="p">,</span> <span class="n">price_number</span><span class="p">,</span> <span class="n">price_date</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.ops.holdings.Holding.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of Holding(account, number, currency, cost_number, cost_currency, book_value, market_value, price_number, price_date)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.holdings.Holding.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ops.holdings.Holding.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/holdings.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.holdings.aggregate_holdings_by">
<code class="highlight language-python">
aggregate_holdings_by<span class="p">(</span><span class="n">holdings</span><span class="p">,</span> <span class="n">keyfun</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.holdings.aggregate_holdings_by" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Aggregate holdings by some key.</p>
<p>Note that the cost-currency must always be included in the group-key (sums
over multiple currency units do not make sense), so it is appended to the
sort-key automatically.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>keyfun</code></td>
<td><code></code></td>
<td>
<p>A callable, which returns the key to aggregate by. This key need
not include the cost-currency.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of aggregated holdings.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/holdings.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">aggregate_holdings_by</span><span class="p">(</span><span class="n">holdings</span><span class="p">,</span> <span class="n">keyfun</span><span class="p">):</span>
    <span class="sd">"""Aggregate holdings by some key.</span>

<span class="sd">    Note that the cost-currency must always be included in the group-key (sums</span>
<span class="sd">    over multiple currency units do not make sense), so it is appended to the</span>
<span class="sd">    sort-key automatically.</span>

<span class="sd">    Args:</span>
<span class="sd">      keyfun: A callable, which returns the key to aggregate by. This key need</span>
<span class="sd">        not include the cost-currency.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of aggregated holdings.</span>
<span class="sd">    """</span>
    <span class="c1"># Aggregate the groups of holdings.</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">holding</span> <span class="ow">in</span> <span class="n">holdings</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">keyfun</span><span class="p">(</span><span class="n">holding</span><span class="p">),</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">)</span>
        <span class="n">grouped</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">holding</span><span class="p">)</span>
    <span class="n">grouped_holdings</span> <span class="o">=</span> <span class="p">(</span><span class="n">aggregate_holdings_list</span><span class="p">(</span><span class="n">key_holdings</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">key_holdings</span> <span class="ow">in</span> <span class="n">grouped</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># We could potentially filter out holdings with zero units here. These types</span>
    <span class="c1"># of holdings might occur on a group with leaked (i.e., non-zero) cost basis</span>
    <span class="c1"># and zero units. However, sometimes are valid merging of multiple</span>
    <span class="c1"># currencies may occur, and the number value will be legitimately set to</span>
    <span class="c1"># ZERO (for various reasons downstream), so we prefer not to ignore the</span>
    <span class="c1"># holding. Callers must be prepared to deal with a holding of ZERO units and</span>
    <span class="c1"># a non-zero cost basis. {0ed05c502e63, b/16}</span>
    <span class="c1">## nonzero_holdings = (holding</span>
    <span class="c1">##                     for holding in grouped_holdings</span>
    <span class="c1">##                     if holding.number != ZERO)</span>

    <span class="c1"># Return the holdings in order.</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">grouped_holdings</span><span class="p">,</span>
                  <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">holding</span><span class="p">:</span> <span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">holding</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.holdings.aggregate_holdings_list">
<code class="highlight language-python">
aggregate_holdings_list<span class="p">(</span><span class="n">holdings</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.holdings.aggregate_holdings_list" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Aggregate a list of holdings.</p>
<p>If there are varying 'account', 'currency' or 'cost_currency' attributes,
their values are replaced by '*'. Otherwise they are preserved. Note that
all the cost-currency values must be equal in order for aggregations to
succeed (without this constraint a sum of units in different currencies has
no meaning).</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>holdings</code></td>
<td><code></code></td>
<td>
<p>A list of Holding instances.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A single Holding instance, or None, if there are no holdings in the input
list.</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ValueError</code></td>
<td>
<p>If multiple cost currencies encountered.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/holdings.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">aggregate_holdings_list</span><span class="p">(</span><span class="n">holdings</span><span class="p">):</span>
    <span class="sd">"""Aggregate a list of holdings.</span>

<span class="sd">    If there are varying 'account', 'currency' or 'cost_currency' attributes,</span>
<span class="sd">    their values are replaced by '*'. Otherwise they are preserved. Note that</span>
<span class="sd">    all the cost-currency values must be equal in order for aggregations to</span>
<span class="sd">    succeed (without this constraint a sum of units in different currencies has</span>
<span class="sd">    no meaning).</span>

<span class="sd">    Args:</span>
<span class="sd">      holdings: A list of Holding instances.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A single Holding instance, or None, if there are no holdings in the input</span>
<span class="sd">      list.</span>
<span class="sd">    Raises:</span>
<span class="sd">      ValueError: If multiple cost currencies encountered.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">holdings</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Note: Holding is a bit overspecified with book and market values. We</span>
    <span class="c1"># recompute them from cost and price numbers here anyhow.</span>
    <span class="n">units</span><span class="p">,</span> <span class="n">total_book_value</span><span class="p">,</span> <span class="n">total_market_value</span> <span class="o">=</span> <span class="n">ZERO</span><span class="p">,</span> <span class="n">ZERO</span><span class="p">,</span> <span class="n">ZERO</span>
    <span class="n">accounts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">cost_currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">price_dates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">book_value_seen</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">market_value_seen</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">holding</span> <span class="ow">in</span> <span class="n">holdings</span><span class="p">:</span>
        <span class="n">units</span> <span class="o">+=</span> <span class="n">holding</span><span class="o">.</span><span class="n">number</span>
        <span class="n">accounts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
        <span class="n">price_dates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">price_date</span><span class="p">)</span>
        <span class="n">currencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
        <span class="n">cost_currencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">book_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total_book_value</span> <span class="o">+=</span> <span class="n">holding</span><span class="o">.</span><span class="n">book_value</span>
            <span class="n">book_value_seen</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total_book_value</span> <span class="o">+=</span> <span class="n">holding</span><span class="o">.</span><span class="n">number</span> <span class="o">*</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_number</span>
            <span class="n">book_value_seen</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">market_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total_market_value</span> <span class="o">+=</span> <span class="n">holding</span><span class="o">.</span><span class="n">market_value</span>
            <span class="n">market_value_seen</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">holding</span><span class="o">.</span><span class="n">price_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total_market_value</span> <span class="o">+=</span> <span class="n">holding</span><span class="o">.</span><span class="n">number</span> <span class="o">*</span> <span class="n">holding</span><span class="o">.</span><span class="n">price_number</span>
            <span class="n">market_value_seen</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">book_value_seen</span><span class="p">:</span>
        <span class="n">average_cost</span> <span class="o">=</span> <span class="n">total_book_value</span> <span class="o">/</span> <span class="n">units</span> <span class="k">if</span> <span class="n">units</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">total_book_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">average_cost</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">market_value_seen</span><span class="p">:</span>
        <span class="n">average_price</span> <span class="o">=</span> <span class="n">total_market_value</span> <span class="o">/</span> <span class="n">units</span> <span class="k">if</span> <span class="n">units</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">total_market_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">average_price</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cost_currencies</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Cost currencies are not homogeneous for aggregation: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cost_currencies</span><span class="p">))))</span>

    <span class="n">units</span> <span class="o">=</span> <span class="n">units</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">currencies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ZERO</span>
    <span class="n">currency</span> <span class="o">=</span> <span class="n">currencies</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">currencies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">'*'</span>
    <span class="n">cost_currency</span> <span class="o">=</span> <span class="n">cost_currencies</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="n">account_</span> <span class="o">=</span> <span class="p">(</span><span class="n">accounts</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">accounts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="n">account</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">(</span><span class="n">accounts</span><span class="p">))</span>
    <span class="n">price_date</span> <span class="o">=</span> <span class="n">price_dates</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">price_dates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">Holding</span><span class="p">(</span><span class="n">account_</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">average_cost</span><span class="p">,</span> <span class="n">cost_currency</span><span class="p">,</span>
                   <span class="n">total_book_value</span><span class="p">,</span> <span class="n">total_market_value</span><span class="p">,</span> <span class="n">average_price</span><span class="p">,</span> <span class="n">price_date</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.holdings.convert_to_currency">
<code class="highlight language-python">
convert_to_currency<span class="p">(</span><span class="n">price_map</span><span class="p">,</span> <span class="n">target_currency</span><span class="p">,</span> <span class="n">holdings_list</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.holdings.convert_to_currency" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Convert the given list of holdings's fields to a common currency.</p>
<p>If the rate is not available to convert, leave the fields empty.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>price_map</code></td>
<td><code></code></td>
<td>
<p>A price-map, as built by prices.build_price_map().</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>target_currency</code></td>
<td><code></code></td>
<td>
<p>The target common currency to convert amounts to.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>holdings_list</code></td>
<td><code></code></td>
<td>
<p>A list of holdings.Holding instances.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A modified list of holdings, with the 'extra' field set to the value in
'currency', or None, if it was not possible to convert.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/holdings.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">convert_to_currency</span><span class="p">(</span><span class="n">price_map</span><span class="p">,</span> <span class="n">target_currency</span><span class="p">,</span> <span class="n">holdings_list</span><span class="p">):</span>
    <span class="sd">"""Convert the given list of holdings's fields to a common currency.</span>

<span class="sd">    If the rate is not available to convert, leave the fields empty.</span>

<span class="sd">    Args:</span>
<span class="sd">      price_map: A price-map, as built by prices.build_price_map().</span>
<span class="sd">      target_currency: The target common currency to convert amounts to.</span>
<span class="sd">      holdings_list: A list of holdings.Holding instances.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A modified list of holdings, with the 'extra' field set to the value in</span>
<span class="sd">      'currency', or None, if it was not possible to convert.</span>
<span class="sd">    """</span>
    <span class="c1"># A list of the fields we should convert.</span>
    <span class="n">convert_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'cost_number'</span><span class="p">,</span> <span class="s1">'book_value'</span><span class="p">,</span> <span class="s1">'market_value'</span><span class="p">,</span> <span class="s1">'price_number'</span><span class="p">)</span>

    <span class="n">new_holdings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">holding</span> <span class="ow">in</span> <span class="n">holdings_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span> <span class="o">==</span> <span class="n">target_currency</span><span class="p">:</span>
            <span class="c1"># The holding is already priced in the target currency; do nothing.</span>
            <span class="n">new_holding</span> <span class="o">=</span> <span class="n">holding</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># There is no cost currency; make the holding priced in its own</span>
                <span class="c1"># units. The price-map should yield a rate of 1.0 and everything</span>
                <span class="c1"># else works out.</span>
                <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">currency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Invalid currency '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>
                <span class="n">holding</span> <span class="o">=</span> <span class="n">holding</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">cost_currency</span><span class="o">=</span><span class="n">holding</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>

                <span class="c1"># Fill in with book and market value as well.</span>
                <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">book_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">holding</span> <span class="o">=</span> <span class="n">holding</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">book_value</span><span class="o">=</span><span class="n">holding</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">market_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">holding</span> <span class="o">=</span> <span class="n">holding</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">market_value</span><span class="o">=</span><span class="n">holding</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">,</span> <span class="s2">"Missing cost currency: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">holding</span><span class="p">)</span>
            <span class="n">base_quote</span> <span class="o">=</span> <span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">,</span> <span class="n">target_currency</span><span class="p">)</span>

            <span class="c1"># Get the conversion rate and replace the required numerical</span>
            <span class="c1"># fields..</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">get_latest_price</span><span class="p">(</span><span class="n">price_map</span><span class="p">,</span> <span class="n">base_quote</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_holding</span> <span class="o">=</span> <span class="n">misc_utils</span><span class="o">.</span><span class="n">map_namedtuple_attributes</span><span class="p">(</span>
                    <span class="n">convert_fields</span><span class="p">,</span>
                    <span class="k">lambda</span> <span class="n">number</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">rate</span><span class="p">:</span> <span class="n">number</span> <span class="k">if</span> <span class="n">number</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">number</span> <span class="o">*</span> <span class="n">r</span><span class="p">,</span>
                    <span class="n">holding</span><span class="p">)</span>
                <span class="c1"># Ensure we set the new cost currency after conversion.</span>
                <span class="n">new_holding</span> <span class="o">=</span> <span class="n">new_holding</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">cost_currency</span><span class="o">=</span><span class="n">target_currency</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Could not get the rate... clear every field and set the cost</span>
                <span class="c1"># currency to None. This enough marks the holding conversion as</span>
                <span class="c1"># a failure.</span>
                <span class="n">new_holding</span> <span class="o">=</span> <span class="n">misc_utils</span><span class="o">.</span><span class="n">map_namedtuple_attributes</span><span class="p">(</span>
                    <span class="n">convert_fields</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">number</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">holding</span><span class="p">)</span>
                <span class="n">new_holding</span> <span class="o">=</span> <span class="n">new_holding</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">cost_currency</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">new_holdings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_holding</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_holdings</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.holdings.get_commodities_at_date">
<code class="highlight language-python">
get_commodities_at_date<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.holdings.get_commodities_at_date" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Return a list of commodities present at a particular date.</p>
<p>This routine fetches the holdings present at a particular date and returns a
list of the commodities held in those holdings. This should define the list
of price date points required to assess the market value of this portfolio.</p>
<p>Notes:</p>
<ul>
<li>
<p>The ticker symbol will be fetched from the corresponding Commodity
  directive. If there is no ticker symbol defined for a directive or no
  corresponding Commodity directive, the currency is still included, but
  'None' is specified for the symbol. The code that uses this routine should
  be free to use the currency name to make an attempt to fetch the currency
  using its name, or to ignore it.</p>
</li>
<li>
<p>The 'cost-currency' is that which is found on the holdings instance and
  can be ignored. The 'quote-currency' is that which is declared on the
  Commodity directive from its 'quote' metadata field.</p>
</li>
</ul>
<p>This is used in a routine that fetches prices from a data source on the
internet (either from Ledgerhub, but you can reuse this in your own script
if you build one).</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance, the date at which to get the list of
relevant holdings.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>A list of (currency, cost-currency, quote-currency, ticker) tuples, where
  currency</code></td>
<td>
<p>The Beancount base currency to fetch a price for.
  cost-currency: The cost-currency of the holdings found at the given date.
  quote-currency: The currency formally declared as quote currency in the
    metadata of Commodity directives.
  ticker: The ticker symbol to use for fetching the price (extracted from
    the metadata of Commodity directives).</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/holdings.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_commodities_at_date</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Return a list of commodities present at a particular date.</span>

<span class="sd">    This routine fetches the holdings present at a particular date and returns a</span>
<span class="sd">    list of the commodities held in those holdings. This should define the list</span>
<span class="sd">    of price date points required to assess the market value of this portfolio.</span>

<span class="sd">    Notes:</span>

<span class="sd">    * The ticker symbol will be fetched from the corresponding Commodity</span>
<span class="sd">      directive. If there is no ticker symbol defined for a directive or no</span>
<span class="sd">      corresponding Commodity directive, the currency is still included, but</span>
<span class="sd">      'None' is specified for the symbol. The code that uses this routine should</span>
<span class="sd">      be free to use the currency name to make an attempt to fetch the currency</span>
<span class="sd">      using its name, or to ignore it.</span>

<span class="sd">    * The 'cost-currency' is that which is found on the holdings instance and</span>
<span class="sd">      can be ignored. The 'quote-currency' is that which is declared on the</span>
<span class="sd">      Commodity directive from its 'quote' metadata field.</span>

<span class="sd">    This is used in a routine that fetches prices from a data source on the</span>
<span class="sd">    internet (either from Ledgerhub, but you can reuse this in your own script</span>
<span class="sd">    if you build one).</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance, the date at which to get the list of</span>
<span class="sd">        relevant holdings.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of (currency, cost-currency, quote-currency, ticker) tuples, where</span>
<span class="sd">        currency: The Beancount base currency to fetch a price for.</span>
<span class="sd">        cost-currency: The cost-currency of the holdings found at the given date.</span>
<span class="sd">        quote-currency: The currency formally declared as quote currency in the</span>
<span class="sd">          metadata of Commodity directives.</span>
<span class="sd">        ticker: The ticker symbol to use for fetching the price (extracted from</span>
<span class="sd">          the metadata of Commodity directives).</span>
<span class="sd">    """</span>
    <span class="c1"># Remove all the entries after the given date, if requested.</span>
    <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">summarize</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="c1"># Get the list of holdings at the particular date.</span>
    <span class="n">holdings_list</span> <span class="o">=</span> <span class="n">get_final_holdings</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="c1"># Obtain the unique list of currencies we need to fetch.</span>
    <span class="n">commodities_list</span> <span class="o">=</span> <span class="p">{(</span><span class="n">holding</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">holding</span> <span class="ow">in</span> <span class="n">holdings_list</span><span class="p">}</span>

    <span class="c1"># Add in the associated ticker symbols.</span>
    <span class="n">commodities_map</span> <span class="o">=</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_commodity_map</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="n">commodities_symbols_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">cost_currency</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">commodities_list</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">commodity_entry</span> <span class="o">=</span> <span class="n">commodities_map</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="n">commodity_entry</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'ticker'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">quote_currency</span> <span class="o">=</span> <span class="n">commodity_entry</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'quote'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">quote_currency</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">commodities_symbols_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="n">cost_currency</span><span class="p">,</span> <span class="n">quote_currency</span><span class="p">,</span> <span class="n">ticker</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">commodities_symbols_list</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.holdings.get_final_holdings">
<code class="highlight language-python">
get_final_holdings<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">included_account_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">price_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.holdings.get_final_holdings" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Get a dictionary of the latest holdings by account.</p>
<p>This basically just flattens the balance sheet's final positions, including
that of equity accounts. If a 'price_map' is provided, insert price
information in the flattened holdings at the latest date, or at the given
date, if one is provided.</p>
<p>Only the accounts in 'included_account_types' will be included, and this is
always called for Assets and Liabilities only. If left unspecified, holdings
from all account types will be included, including Equity, Income and
Expenses.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>included_account_types</code></td>
<td><code></code></td>
<td>
<p>A sequence of strings, the account types to
include in the output. A reasonable example would be
('Assets', 'Liabilities'). If not specified, include all account types.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>price_map</code></td>
<td><code></code></td>
<td>
<p>A dict of prices, as built by prices.build_price_map().</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance, the date at which to price the
holdings. If left unspecified, we use the latest price information.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>A list of dicts, with the following fields</code></td>
<td></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/holdings.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_final_holdings</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">included_account_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">price_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Get a dictionary of the latest holdings by account.</span>

<span class="sd">    This basically just flattens the balance sheet's final positions, including</span>
<span class="sd">    that of equity accounts. If a 'price_map' is provided, insert price</span>
<span class="sd">    information in the flattened holdings at the latest date, or at the given</span>
<span class="sd">    date, if one is provided.</span>

<span class="sd">    Only the accounts in 'included_account_types' will be included, and this is</span>
<span class="sd">    always called for Assets and Liabilities only. If left unspecified, holdings</span>
<span class="sd">    from all account types will be included, including Equity, Income and</span>
<span class="sd">    Expenses.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      included_account_types: A sequence of strings, the account types to</span>
<span class="sd">        include in the output. A reasonable example would be</span>
<span class="sd">        ('Assets', 'Liabilities'). If not specified, include all account types.</span>
<span class="sd">      price_map: A dict of prices, as built by prices.build_price_map().</span>
<span class="sd">      date: A datetime.date instance, the date at which to price the</span>
<span class="sd">        holdings. If left unspecified, we use the latest price information.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of dicts, with the following fields:</span>
<span class="sd">    """</span>
    <span class="c1"># Remove the entries inserted by unrealized gains/losses. Those entries do</span>
    <span class="c1"># affect asset accounts, and we don't want them to appear in holdings.</span>
    <span class="c1">#</span>
    <span class="c1"># Note: Perhaps it would make sense to generalize this concept of "inserted</span>
    <span class="c1"># unrealized gains."</span>
    <span class="n">simple_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span>
                      <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span>
                      <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">or</span>
                          <span class="n">entry</span><span class="o">.</span><span class="n">flag</span> <span class="o">!=</span> <span class="n">flags</span><span class="o">.</span><span class="n">FLAG_UNREALIZED</span><span class="p">)]</span>

    <span class="c1"># Realize the accounts into a tree (because we want the positions by-account).</span>
    <span class="n">root_account</span> <span class="o">=</span> <span class="n">realization</span><span class="o">.</span><span class="n">realize</span><span class="p">(</span><span class="n">simple_entries</span><span class="p">)</span>

    <span class="c1"># For each account, look at the list of positions and build a list.</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">real_account</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">realization</span><span class="o">.</span><span class="n">iter_children</span><span class="p">(</span><span class="n">root_account</span><span class="p">)),</span>
                               <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ra</span><span class="p">:</span> <span class="n">ra</span><span class="o">.</span><span class="n">account</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">included_account_types</span><span class="p">:</span>
            <span class="c1"># Skip accounts of invalid types, we only want to reflect the requested</span>
            <span class="c1"># account types, typically assets and liabilities.</span>
            <span class="n">account_type</span> <span class="o">=</span> <span class="n">account_types</span><span class="o">.</span><span class="n">get_account_type</span><span class="p">(</span><span class="n">real_account</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">account_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">included_account_types</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">real_account</span><span class="o">.</span><span class="n">balance</span><span class="o">.</span><span class="n">get_positions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Get price information if we have a price_map.</span>
                <span class="n">market_value</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">price_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">base_quote</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
                    <span class="n">price_date</span><span class="p">,</span> <span class="n">price_number</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">price_map</span><span class="p">,</span>
                                                                <span class="n">base_quote</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">price_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">market_value</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span> <span class="o">*</span> <span class="n">price_number</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">price_date</span><span class="p">,</span> <span class="n">price_number</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

                <span class="n">holding</span> <span class="o">=</span> <span class="n">Holding</span><span class="p">(</span><span class="n">real_account</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                                  <span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                  <span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
                                  <span class="n">pos</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                  <span class="n">pos</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
                                  <span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span> <span class="o">*</span> <span class="n">pos</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                  <span class="n">market_value</span><span class="p">,</span>
                                  <span class="n">price_number</span><span class="p">,</span>
                                  <span class="n">price_date</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">holding</span> <span class="o">=</span> <span class="n">Holding</span><span class="p">(</span><span class="n">real_account</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                                  <span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                  <span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
                                  <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
                                  <span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                  <span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                  <span class="kc">None</span><span class="p">,</span>
                                  <span class="kc">None</span><span class="p">)</span>
            <span class="n">holdings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">holding</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">holdings</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.holdings.holding_to_position">
<code class="highlight language-python">
holding_to_position<span class="p">(</span><span class="n">holding</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.holdings.holding_to_position" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Convert the holding to a position.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>holding</code></td>
<td><code></code></td>
<td>
<p>An instance of Holding.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>An instance of Position.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/holdings.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>446
447
448
449
450
451
452
453
454
455
456
457
458</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">holding_to_position</span><span class="p">(</span><span class="n">holding</span><span class="p">):</span>
    <span class="sd">"""Convert the holding to a position.</span>

<span class="sd">    Args:</span>
<span class="sd">      holding: An instance of Holding.</span>
<span class="sd">    Returns:</span>
<span class="sd">      An instance of Position.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">position</span><span class="o">.</span><span class="n">Position</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">holding</span><span class="o">.</span><span class="n">currency</span><span class="p">),</span>
        <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">Cost</span><span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">cost_number</span><span class="p">,</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_number</span>
         <span class="k">else</span> <span class="kc">None</span><span class="p">))</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.holdings.holding_to_posting">
<code class="highlight language-python">
holding_to_posting<span class="p">(</span><span class="n">holding</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.holdings.holding_to_posting" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Convert the holding to an instance of Posting.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>holding</code></td>
<td><code></code></td>
<td>
<p>An instance of Holding.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>An instance of Position.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/holdings.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>461
462
463
464
465
466
467
468
469
470
471
472
473</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">holding_to_posting</span><span class="p">(</span><span class="n">holding</span><span class="p">):</span>
    <span class="sd">"""Convert the holding to an instance of Posting.</span>

<span class="sd">    Args:</span>
<span class="sd">      holding: An instance of Holding.</span>
<span class="sd">    Returns:</span>
<span class="sd">      An instance of Position.</span>
<span class="sd">    """</span>
    <span class="n">position_</span> <span class="o">=</span> <span class="n">holding_to_position</span><span class="p">(</span><span class="n">holding</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="p">(</span><span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">price_number</span><span class="p">,</span> <span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">)</span>
             <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">price_number</span>
             <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">position_</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">position_</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.holdings.reduce_relative">
<code class="highlight language-python">
reduce_relative<span class="p">(</span><span class="n">holdings</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.holdings.reduce_relative" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Convert the market and book values of the given list of holdings to relative data.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>holdings</code></td>
<td><code></code></td>
<td>
<p>A list of Holding instances.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of holdings instances with the absolute value fields replaced by
fractions of total portfolio. The new list of holdings is sorted by
currency, and the relative fractions are also relative to that currency.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/holdings.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">reduce_relative</span><span class="p">(</span><span class="n">holdings</span><span class="p">):</span>
    <span class="sd">"""Convert the market and book values of the given list of holdings to relative data.</span>

<span class="sd">    Args:</span>
<span class="sd">      holdings: A list of Holding instances.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of holdings instances with the absolute value fields replaced by</span>
<span class="sd">      fractions of total portfolio. The new list of holdings is sorted by</span>
<span class="sd">      currency, and the relative fractions are also relative to that currency.</span>
<span class="sd">    """</span>
    <span class="c1"># Group holdings by value currency.</span>
    <span class="n">by_currency</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">ordering</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">holding</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">holdings</span><span class="p">):</span>
        <span class="n">ordering</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">by_currency</span><span class="p">[</span><span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">holding</span><span class="p">)</span>

    <span class="n">fractional_holdings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">by_currency</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">ordering</span><span class="o">.</span><span class="n">get</span><span class="p">):</span>
        <span class="n">currency_holdings</span> <span class="o">=</span> <span class="n">by_currency</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span>

        <span class="c1"># Compute total market value for that currency.</span>
        <span class="n">total_book_value</span> <span class="o">=</span> <span class="n">ZERO</span>
        <span class="n">total_market_value</span> <span class="o">=</span> <span class="n">ZERO</span>
        <span class="k">for</span> <span class="n">holding</span> <span class="ow">in</span> <span class="n">currency_holdings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">book_value</span><span class="p">:</span>
                <span class="n">total_book_value</span> <span class="o">+=</span> <span class="n">holding</span><span class="o">.</span><span class="n">book_value</span>
            <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">market_value</span><span class="p">:</span>
                <span class="n">total_market_value</span> <span class="o">+=</span> <span class="n">holding</span><span class="o">.</span><span class="n">market_value</span>

        <span class="c1"># Sort the currency's holdings with decreasing values of market value.</span>
        <span class="n">currency_holdings</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">holding</span><span class="p">:</span> <span class="n">holding</span><span class="o">.</span><span class="n">market_value</span> <span class="ow">or</span> <span class="n">ZERO</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Output new holdings with the relevant values replaced.</span>
        <span class="k">for</span> <span class="n">holding</span> <span class="ow">in</span> <span class="n">currency_holdings</span><span class="p">:</span>
            <span class="n">fractional_holdings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">holding</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">book_value</span><span class="o">=</span><span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">book_value</span> <span class="o">/</span> <span class="n">total_book_value</span>
                                             <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">book_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                             <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
                                 <span class="n">market_value</span><span class="o">=</span><span class="p">(</span><span class="n">holding</span><span class="o">.</span><span class="n">market_value</span> <span class="o">/</span> <span class="n">total_market_value</span>
                                               <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">market_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                               <span class="k">else</span> <span class="kc">None</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">fractional_holdings</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.holdings.scale_holding">
<code class="highlight language-python">
scale_holding<span class="p">(</span><span class="n">holding</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.holdings.scale_holding" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Scale the values of a holding.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>holding</code></td>
<td><code></code></td>
<td>
<p>An instance of Holding.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>scale_factor</code></td>
<td><code></code></td>
<td>
<p>A float or Decimal number.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A scaled copy of the holding.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/holdings.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">scale_holding</span><span class="p">(</span><span class="n">holding</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">):</span>
    <span class="sd">"""Scale the values of a holding.</span>

<span class="sd">    Args:</span>
<span class="sd">      holding: An instance of Holding.</span>
<span class="sd">      scale_factor: A float or Decimal number.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A scaled copy of the holding.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">Holding</span><span class="p">(</span>
        <span class="n">holding</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
        <span class="n">holding</span><span class="o">.</span><span class="n">number</span> <span class="o">*</span> <span class="n">scale_factor</span> <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">number</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">holding</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
        <span class="n">holding</span><span class="o">.</span><span class="n">cost_number</span><span class="p">,</span>
        <span class="n">holding</span><span class="o">.</span><span class="n">cost_currency</span><span class="p">,</span>
        <span class="n">holding</span><span class="o">.</span><span class="n">book_value</span> <span class="o">*</span> <span class="n">scale_factor</span> <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">book_value</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">holding</span><span class="o">.</span><span class="n">market_value</span> <span class="o">*</span> <span class="n">scale_factor</span> <span class="k">if</span> <span class="n">holding</span><span class="o">.</span><span class="n">market_value</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">holding</span><span class="o">.</span><span class="n">price_number</span><span class="p">,</span>
        <span class="n">holding</span><span class="o">.</span><span class="n">price_date</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ops.lifetimes">
<code>lifetimes</code>
<a class="headerlink" href="#beancount.ops.lifetimes" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Given a Beancount ledger, compute time intervals where we hold each commodity.</p>
<p>This script computes, for each commodity, which time intervals it is required at.
This can then be used to identify a list of dates at which we need to fetch prices
in order to properly fill the price database.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.lifetimes.compress_intervals_days">
<code class="highlight language-python">
compress_intervals_days<span class="p">(</span><span class="n">intervals</span><span class="p">,</span> <span class="n">num_days</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.lifetimes.compress_intervals_days" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Compress a list of date pairs to ignore short stretches of unused days.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>intervals</code></td>
<td><code></code></td>
<td>
<p>A list of pairs of datetime.date instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>num_days</code></td>
<td><code></code></td>
<td>
<p>An integer, the number of unused days to require for intervals
to be distinct, to allow a gap.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A new dict of lifetimes map where some intervals may have been joined.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/lifetimes.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">compress_intervals_days</span><span class="p">(</span><span class="n">intervals</span><span class="p">,</span> <span class="n">num_days</span><span class="p">):</span>
    <span class="sd">"""Compress a list of date pairs to ignore short stretches of unused days.</span>

<span class="sd">    Args:</span>
<span class="sd">      intervals: A list of pairs of datetime.date instances.</span>
<span class="sd">      num_days: An integer, the number of unused days to require for intervals</span>
<span class="sd">        to be distinct, to allow a gap.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new dict of lifetimes map where some intervals may have been joined.</span>
<span class="sd">    """</span>
    <span class="n">ignore_interval</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">num_days</span><span class="p">)</span>
    <span class="n">new_intervals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">iter_intervals</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span>
    <span class="n">last_begin</span><span class="p">,</span> <span class="n">last_end</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iter_intervals</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">date_begin</span><span class="p">,</span> <span class="n">date_end</span> <span class="ow">in</span> <span class="n">iter_intervals</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">date_begin</span> <span class="o">-</span> <span class="n">last_end</span> <span class="o">&lt;</span> <span class="n">ignore_interval</span><span class="p">:</span>
            <span class="c1"># Compress.</span>
            <span class="n">last_end</span> <span class="o">=</span> <span class="n">date_end</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">last_begin</span><span class="p">,</span> <span class="n">last_end</span><span class="p">))</span>
            <span class="n">last_begin</span><span class="p">,</span> <span class="n">last_end</span> <span class="o">=</span> <span class="n">date_begin</span><span class="p">,</span> <span class="n">date_end</span>
    <span class="n">new_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">last_begin</span><span class="p">,</span> <span class="n">last_end</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_intervals</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.lifetimes.compress_lifetimes_days">
<code class="highlight language-python">
compress_lifetimes_days<span class="p">(</span><span class="n">lifetimes_map</span><span class="p">,</span> <span class="n">num_days</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.lifetimes.compress_lifetimes_days" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Compress a lifetimes map to ignore short stretches of unused days.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lifetimes_map</code></td>
<td><code></code></td>
<td>
<p>A dict of currency intervals as returned by get_commodity_lifetimes.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>num_days</code></td>
<td><code></code></td>
<td>
<p>An integer, the number of unused days to ignore.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A new dict of lifetimes map where some intervals may have been joined.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/lifetimes.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>105
106
107
108
109
110
111
112
113
114
115</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">compress_lifetimes_days</span><span class="p">(</span><span class="n">lifetimes_map</span><span class="p">,</span> <span class="n">num_days</span><span class="p">):</span>
    <span class="sd">"""Compress a lifetimes map to ignore short stretches of unused days.</span>

<span class="sd">    Args:</span>
<span class="sd">      lifetimes_map: A dict of currency intervals as returned by get_commodity_lifetimes.</span>
<span class="sd">      num_days: An integer, the number of unused days to ignore.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new dict of lifetimes map where some intervals may have been joined.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">currency_pair</span><span class="p">:</span> <span class="n">compress_intervals_days</span><span class="p">(</span><span class="n">intervals</span><span class="p">,</span> <span class="n">num_days</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">currency_pair</span><span class="p">,</span> <span class="n">intervals</span> <span class="ow">in</span> <span class="n">lifetimes_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.lifetimes.get_commodity_lifetimes">
<code class="highlight language-python">
get_commodity_lifetimes<span class="p">(</span><span class="n">entries</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.lifetimes.get_commodity_lifetimes" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Given a list of directives, figure out the life of each commodity.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A dict of (currency, cost-currency) commodity strings to lists of (start,
end) datetime.date pairs. The dates are inclusive of the day the commodity
was seen; the end/last dates are one day <em>after</em> the last date seen.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/lifetimes.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_commodity_lifetimes</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
    <span class="sd">"""Given a list of directives, figure out the life of each commodity.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A dict of (currency, cost-currency) commodity strings to lists of (start,</span>
<span class="sd">      end) datetime.date pairs. The dates are inclusive of the day the commodity</span>
<span class="sd">      was seen; the end/last dates are one day _after_ the last date seen.</span>
<span class="sd">    """</span>
    <span class="n">lifetimes</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="c1"># The current set of active commodities.</span>
    <span class="n">commodities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># The current balances across all accounts.</span>
    <span class="n">balances</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="c1"># Process only transaction entries.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Update the balance of affected accounts and check locally whether that</span>
        <span class="c1"># triggered a change in the set of commodities.</span>
        <span class="n">commodities_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="n">balances</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">]</span>
            <span class="n">commodities_before</span> <span class="o">=</span> <span class="n">balance</span><span class="o">.</span><span class="n">currency_pairs</span><span class="p">()</span>
            <span class="n">balance</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>
            <span class="n">commodities_after</span> <span class="o">=</span> <span class="n">balance</span><span class="o">.</span><span class="n">currency_pairs</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">commodities_after</span> <span class="o">!=</span> <span class="n">commodities_before</span><span class="p">:</span>
                <span class="n">commodities_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># If there was a change in one of the affected account's list of</span>
        <span class="c1"># commodities, recompute the total set globally. This should not</span>
        <span class="c1"># occur very frequently.</span>
        <span class="k">if</span> <span class="n">commodities_changed</span><span class="p">:</span>
            <span class="n">new_commodities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">inv</span><span class="o">.</span><span class="n">currency_pairs</span><span class="p">()</span> <span class="k">for</span> <span class="n">inv</span> <span class="ow">in</span> <span class="n">balances</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
            <span class="k">if</span> <span class="n">new_commodities</span> <span class="o">!=</span> <span class="n">commodities</span><span class="p">:</span>
                <span class="c1"># The new global set of commodities has changed; update our</span>
                <span class="c1"># the dictionary of intervals.</span>
                <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="n">new_commodities</span> <span class="o">-</span> <span class="n">commodities</span><span class="p">:</span>
                    <span class="n">lifetimes</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="n">commodities</span> <span class="o">-</span> <span class="n">new_commodities</span><span class="p">:</span>
                    <span class="n">lifetime</span> <span class="o">=</span> <span class="n">lifetimes</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span>
                    <span class="n">begin_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="n">lifetime</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">end_date</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="n">lifetime</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">begin_date</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">ONEDAY</span><span class="p">))</span>

                <span class="c1"># Update our current set.</span>
                <span class="n">commodities</span> <span class="o">=</span> <span class="n">new_commodities</span>

    <span class="k">return</span> <span class="n">lifetimes</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.lifetimes.required_weekly_prices">
<code class="highlight language-python">
required_weekly_prices<span class="p">(</span><span class="n">lifetimes_map</span><span class="p">,</span> <span class="n">date_last</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.lifetimes.required_weekly_prices" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Enumerate all the commodities and fridays where the price is required.</p>
<p>Given a map of lifetimes for a set of commodities, enumerate all the Fridays
for each commodity where it is active. This can be used to connect to a
historical price fetcher routine to fill in missing price entries from an
existing ledger.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lifetimes_map</code></td>
<td><code></code></td>
<td>
<p>A dict of currency to active intervals as returned by
get_commodity_lifetimes().</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date_last</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance, the last date which we're interested in.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Tuples of (date, currency, cost-currency).</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/lifetimes.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">required_weekly_prices</span><span class="p">(</span><span class="n">lifetimes_map</span><span class="p">,</span> <span class="n">date_last</span><span class="p">):</span>
    <span class="sd">"""Enumerate all the commodities and fridays where the price is required.</span>

<span class="sd">    Given a map of lifetimes for a set of commodities, enumerate all the Fridays</span>
<span class="sd">    for each commodity where it is active. This can be used to connect to a</span>
<span class="sd">    historical price fetcher routine to fill in missing price entries from an</span>
<span class="sd">    existing ledger.</span>

<span class="sd">    Args:</span>
<span class="sd">      lifetimes_map: A dict of currency to active intervals as returned by</span>
<span class="sd">        get_commodity_lifetimes().</span>
<span class="sd">      date_last: A datetime.date instance, the last date which we're interested in.</span>
<span class="sd">    Returns:</span>
<span class="sd">      Tuples of (date, currency, cost-currency).</span>
<span class="sd">    """</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">currency_pair</span><span class="p">,</span> <span class="n">intervals</span> <span class="ow">in</span> <span class="n">lifetimes_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">currency_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">date_begin</span><span class="p">,</span> <span class="n">date_end</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
            <span class="c1"># Find first Friday before the minimum date.</span>
            <span class="n">diff_days</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">date_begin</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">diff_days</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">diff_days</span> <span class="o">-=</span> <span class="mi">7</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">date_begin</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">diff_days</span><span class="p">)</span>

            <span class="c1"># Iterate over all Fridays.</span>
            <span class="k">if</span> <span class="n">date_end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">date_end</span> <span class="o">=</span> <span class="n">date_last</span>
            <span class="k">while</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">date_end</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">date</span><span class="p">,</span> <span class="n">currency_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">currency_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">date</span> <span class="o">+=</span> <span class="n">ONE_WEEK</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ops.pad">
<code>pad</code>
<a class="headerlink" href="#beancount.ops.pad" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Automatic padding of gaps between entries.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ops.pad.PadError">
<code>PadError</code>
<a class="headerlink" href="#beancount.ops.pad.PadError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>PadError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.pad.PadError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ops.pad.PadError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/pad.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.pad.PadError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.ops.pad.PadError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of PadError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.pad.PadError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ops.pad.PadError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/pad.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.pad.pad">
<code class="highlight language-python">
pad<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.pad.pad" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Insert transaction entries for to fulfill a subsequent balance check.</p>
<p>Synthesize and insert Transaction entries right after Pad entries in order
to fulfill checks in the padded accounts. Returns a new list of entries.
Note that this doesn't pad across parent-child relationships, it is a very
simple kind of pad. (I have found this to be sufficient in practice, and
simpler to implement and understand.)</p>
<p>Furthermore, this pads for a single currency only, that is, balance checks
are specified only for one currency at a time, and pads will only be
inserted for those currencies.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>A parser options dict.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A new list of directives, with Pad entries inserte, and a list of new
errors produced.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/pad.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Insert transaction entries for to fulfill a subsequent balance check.</span>

<span class="sd">    Synthesize and insert Transaction entries right after Pad entries in order</span>
<span class="sd">    to fulfill checks in the padded accounts. Returns a new list of entries.</span>
<span class="sd">    Note that this doesn't pad across parent-child relationships, it is a very</span>
<span class="sd">    simple kind of pad. (I have found this to be sufficient in practice, and</span>
<span class="sd">    simpler to implement and understand.)</span>

<span class="sd">    Furthermore, this pads for a single currency only, that is, balance checks</span>
<span class="sd">    are specified only for one currency at a time, and pads will only be</span>
<span class="sd">    inserted for those currencies.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      options_map: A parser options dict.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new list of directives, with Pad entries inserte, and a list of new</span>
<span class="sd">      errors produced.</span>
<span class="sd">    """</span>
    <span class="n">pad_errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Find all the pad entries and group them by account.</span>
    <span class="n">pads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">misc_utils</span><span class="o">.</span><span class="n">filter_type</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Pad</span><span class="p">))</span>
    <span class="n">pad_dict</span> <span class="o">=</span> <span class="n">misc_utils</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">pads</span><span class="p">)</span>

    <span class="c1"># Partially realize the postings, so we can iterate them by account.</span>
    <span class="n">by_account</span> <span class="o">=</span> <span class="n">realization</span><span class="o">.</span><span class="n">postings_by_account</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="c1"># A dict of pad -&gt; list of entries to be inserted.</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">{</span><span class="nb">id</span><span class="p">(</span><span class="n">pad</span><span class="p">):</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">pad</span> <span class="ow">in</span> <span class="n">pads</span><span class="p">}</span>

    <span class="c1"># Process each account that has a padding group.</span>
    <span class="k">for</span> <span class="n">account_</span><span class="p">,</span> <span class="n">pad_list</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pad_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

        <span class="c1"># Last encountered / currency active pad entry.</span>
        <span class="n">active_pad</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Gather all the postings for the account and its children.</span>
        <span class="n">postings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">is_child</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">parent_matcher</span><span class="p">(</span><span class="n">account_</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item_account</span><span class="p">,</span> <span class="n">item_postings</span> <span class="ow">in</span> <span class="n">by_account</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">is_child</span><span class="p">(</span><span class="n">item_account</span><span class="p">):</span>
                <span class="n">postings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item_postings</span><span class="p">)</span>
        <span class="n">postings</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">posting_sortkey</span><span class="p">)</span>

        <span class="c1"># A set of currencies already padded so far in this account.</span>
        <span class="n">padded_lots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">pad_balance</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">postings</span><span class="p">:</span>

            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">TxnPosting</span><span class="p">):</span>
                <span class="c1"># This is a transaction; update the running balance for this</span>
                <span class="c1"># account.</span>
                <span class="n">pad_balance</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">posting</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Pad</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">account</span> <span class="o">==</span> <span class="n">account_</span><span class="p">:</span>
                    <span class="c1"># Mark this newly encountered pad as active and allow all lots</span>
                    <span class="c1"># to be padded heretofore.</span>
                    <span class="n">active_pad</span> <span class="o">=</span> <span class="n">entry</span>
                    <span class="n">padded_lots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Balance</span><span class="p">):</span>
                <span class="n">check_amount</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">amount</span>

                <span class="c1"># Compare the current balance amount to the expected one from</span>
                <span class="c1"># the check entry. IMPORTANT: You need to understand that this</span>
                <span class="c1"># does not check a single position, but rather checks that the</span>
                <span class="c1"># total amount for a particular currency (which itself is</span>
                <span class="c1"># distinct from the cost).</span>
                <span class="n">balance_amount</span> <span class="o">=</span> <span class="n">pad_balance</span><span class="o">.</span><span class="n">get_currency_units</span><span class="p">(</span><span class="n">check_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
                <span class="n">diff_amount</span> <span class="o">=</span> <span class="n">amount</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">balance_amount</span><span class="p">,</span> <span class="n">check_amount</span><span class="p">)</span>

                <span class="c1"># Use the specified tolerance or automatically infer it.</span>
                <span class="n">tolerance</span> <span class="o">=</span> <span class="n">balance</span><span class="o">.</span><span class="n">get_balance_tolerance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff_amount</span><span class="o">.</span><span class="n">number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">:</span>
                    <span class="c1"># The check fails; we need to pad.</span>

                    <span class="c1"># Pad only if pad entry is active and we haven't already</span>
                    <span class="c1"># padded that lot since it was last encountered.</span>
                    <span class="k">if</span> <span class="n">active_pad</span> <span class="ow">and</span> <span class="p">(</span><span class="n">check_amount</span><span class="o">.</span><span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">padded_lots</span><span class="p">):</span>

                        <span class="c1"># Note: we decide that it's an error to try to pad</span>
                        <span class="c1"># positions at cost; we check here that all the existing</span>
                        <span class="c1"># positions with that currency have no cost.</span>
                        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos</span>
                                     <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">pad_balance</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
                                     <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="n">check_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">position_</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">position_</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">pad_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="n">PadError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                                             <span class="p">(</span><span class="s2">"Attempt to pad an entry with cost for "</span>
                                              <span class="s2">"balance: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pad_balance</span><span class="p">)),</span>
                                             <span class="n">active_pad</span><span class="p">))</span>

                        <span class="c1"># Thus our padding lot is without cost by default.</span>
                        <span class="n">diff_position</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">from_amounts</span><span class="p">(</span>
                            <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">check_amount</span><span class="o">.</span><span class="n">number</span> <span class="o">-</span> <span class="n">balance_amount</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                          <span class="n">check_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>

                        <span class="c1"># Synthesize a new transaction entry for the difference.</span>
                        <span class="n">narration</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'(Padding inserted for Balance of </span><span class="si">{}</span><span class="s1"> for '</span>
                                     <span class="s1">'difference </span><span class="si">{}</span><span class="s1">)'</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_amount</span><span class="p">,</span> <span class="n">diff_position</span><span class="p">)</span>
                        <span class="n">new_entry</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">(</span>
                            <span class="n">active_pad</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">active_pad</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">flags</span><span class="o">.</span><span class="n">FLAG_PADDING</span><span class="p">,</span>
                            <span class="kc">None</span><span class="p">,</span> <span class="n">narration</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="p">[])</span>

                        <span class="n">new_entry</span><span class="o">.</span><span class="n">postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">active_pad</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                                         <span class="n">diff_position</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">diff_position</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
                                         <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                        <span class="n">neg_diff_position</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff_position</span>
                        <span class="n">new_entry</span><span class="o">.</span><span class="n">postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">active_pad</span><span class="o">.</span><span class="n">source_account</span><span class="p">,</span>
                                         <span class="n">neg_diff_position</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">neg_diff_position</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
                                         <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

                        <span class="c1"># Save it for later insertion after the active pad.</span>
                        <span class="n">new_entries</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">active_pad</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_entry</span><span class="p">)</span>

                        <span class="c1"># Fixup the running balance.</span>
                        <span class="n">pos</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pad_balance</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">diff_position</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pos</span><span class="o">.</span><span class="n">is_negative_at_cost</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">"Position held at cost goes negative: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>

                <span class="c1"># Mark this lot as padded. Further checks should not pad this lot.</span>
                <span class="n">padded_lots</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">check_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>

    <span class="c1"># Insert the newly created entries right after the pad entries that created them.</span>
    <span class="n">padded_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="n">padded_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Pad</span><span class="p">):</span>
            <span class="n">entry_list</span> <span class="o">=</span> <span class="n">new_entries</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">entry</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">entry_list</span><span class="p">:</span>
                <span class="n">padded_entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">entry_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Generate errors on unused pad entries.</span>
                <span class="n">pad_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">PadError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"Unused Pad entry"</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">padded_entries</span><span class="p">,</span> <span class="n">pad_errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ops.summarize">
<code>summarize</code>
<a class="headerlink" href="#beancount.ops.summarize" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Summarization of entries.</p>
<p>This code is used to summarize a sequence of entries (e.g. during a time period)
into a few "opening balance" entries. This is when computing a balance sheet for
a specific time period: we don't want to see the entries from before some period
of time, so we fold them into a single transaction per account that has the sum
total amount of that account.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.balance_by_account">
<code class="highlight language-python">
balance_by_account<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.balance_by_account" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Sum up the balance per account for all entries strictly before 'date'.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>An optional datetime.date instance. If provided, stop accumulating
on and after this date. This is useful for summarization before a
specific date.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A pair of a dict of account string to instance Inventory (the balance of
this account before the given date), and the index in the list of entries
where the date was encountered. If all entries are located before the
cutoff date, an index one beyond the last entry is returned.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">balance_by_account</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Sum up the balance per account for all entries strictly before 'date'.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: An optional datetime.date instance. If provided, stop accumulating</span>
<span class="sd">        on and after this date. This is useful for summarization before a</span>
<span class="sd">        specific date.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A pair of a dict of account string to instance Inventory (the balance of</span>
<span class="sd">      this account before the given date), and the index in the list of entries</span>
<span class="sd">      where the date was encountered. If all entries are located before the</span>
<span class="sd">      cutoff date, an index one beyond the last entry is returned.</span>
<span class="sd">    """</span>
    <span class="n">balances</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
                <span class="n">account_balance</span> <span class="o">=</span> <span class="n">balances</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">]</span>

                <span class="c1"># Note: We must allow negative lots at cost, because this may be</span>
                <span class="c1"># used to reduce a filtered list of entries which may not</span>
                <span class="c1"># include the entries necessary to keep units at cost always</span>
                <span class="c1"># above zero. The only summation that is guaranteed to be above</span>
                <span class="c1"># zero is if all the entries are being summed together, no</span>
                <span class="c1"># entries are filtered, at least for a particular account's</span>
                <span class="c1"># postings.</span>
                <span class="n">account_balance</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">balances</span><span class="p">,</span> <span class="n">index</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.cap">
<code class="highlight language-python">
cap<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.cap" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Transfer net income to equity and insert a final conversion entry.</p>
<p>This is used to move and nullify balances from the income and expense
accounts to an equity account in order to draw up a balance sheet with a
balance of precisely zero.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_types</code></td>
<td><code></code></td>
<td>
<p>An instance of AccountTypes.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>conversion_currency</code></td>
<td><code></code></td>
<td>
<p>A string, the transfer currency to use for zero prices
on the conversion entry.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_earnings</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the equity account to transfer
final balances of the income and expense accounts to.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_conversions</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the equity account to use as
the source for currency conversions.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A modified list of entries, with the income and expense accounts
transferred.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">cap</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span>
        <span class="n">account_types</span><span class="p">,</span>
        <span class="n">conversion_currency</span><span class="p">,</span>
        <span class="n">account_earnings</span><span class="p">,</span>
        <span class="n">account_conversions</span><span class="p">):</span>
    <span class="sd">"""Transfer net income to equity and insert a final conversion entry.</span>

<span class="sd">    This is used to move and nullify balances from the income and expense</span>
<span class="sd">    accounts to an equity account in order to draw up a balance sheet with a</span>
<span class="sd">    balance of precisely zero.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      account_types: An instance of AccountTypes.</span>
<span class="sd">      conversion_currency: A string, the transfer currency to use for zero prices</span>
<span class="sd">        on the conversion entry.</span>
<span class="sd">      account_earnings: A string, the name of the equity account to transfer</span>
<span class="sd">        final balances of the income and expense accounts to.</span>
<span class="sd">      account_conversions: A string, the name of the equity account to use as</span>
<span class="sd">        the source for currency conversions.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A modified list of entries, with the income and expense accounts</span>
<span class="sd">      transferred.</span>
<span class="sd">    """</span>

    <span class="c1"># Transfer the balances of income and expense accounts as earnings / net</span>
    <span class="c1"># income.</span>
    <span class="n">income_statement_account_pred</span> <span class="o">=</span> <span class="p">(</span>
        <span class="k">lambda</span> <span class="n">account</span><span class="p">:</span> <span class="n">is_income_statement_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">account_types</span><span class="p">))</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">transfer_balances</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">income_statement_account_pred</span><span class="p">,</span>
                                <span class="n">account_earnings</span><span class="p">)</span>

    <span class="c1"># Insert final conversion entries.</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entries</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.cap_opt">
<code class="highlight language-python">
cap_opt<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.cap_opt" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Close by getting all the parameters from an options map.</p>
<p>See cap() for details.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>See cap().</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>A parser's option_map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Same as close().</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">cap_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Close by getting all the parameters from an options map.</span>

<span class="sd">    See cap() for details.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: See cap().</span>
<span class="sd">      options_map: A parser's option_map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      Same as close().</span>
<span class="sd">    """</span>
    <span class="n">account_types</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_account_types</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">current_accounts</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_current_accounts</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">conversion_currency</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s1">'conversion_currency'</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cap</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span>
               <span class="n">account_types</span><span class="p">,</span>
               <span class="n">conversion_currency</span><span class="p">,</span>
               <span class="o">*</span><span class="n">current_accounts</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.clamp">
<code class="highlight language-python">
clamp<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">begin_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">,</span> <span class="n">account_opening</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.clamp" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Filter entries to include only those during a specified time period.</p>
<p>Firstly, this method will transfer all balances for the income and expense
accounts occurring before the given period begin date to the
'account_earnings' account (earnings before the period, or "retained
earnings") and summarize all of the transactions before that date against
the 'account_opening' account (usually "opening balances"). The resulting
income and expense accounts should have no transactions (since their
balances have been transferred out and summarization of zero balances should
not add any transactions).</p>
<p>Secondly, all the entries after the period end date will be truncated and a
conversion entry will be added for the resulting transactions that reflect
changes occurring between the beginning and end of the exercise period. The
resulting balance of all account should be empty.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directive tuples.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>begin_date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance, the beginning of the period.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>end_date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance, one day beyond the end of the period.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_types</code></td>
<td><code></code></td>
<td>
<p>An instance of AccountTypes.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>conversion_currency</code></td>
<td><code></code></td>
<td>
<p>A string, the transfer currency to use for zero prices
on the conversion entry.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_earnings</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the account to transfer
previous earnings from the income statement accounts to the balance
sheet.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_opening</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the account in equity
to transfer previous balances from, in order to initialize account
balances at the beginning of the period. This is typically called an
opening balances account.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_conversions</code></td>
<td><code></code></td>
<td>
<p>A string, tne name of the equity account to
book currency conversions against.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A new list of entries is returned, and the index that points to the first
original transaction after the beginning date of the period. This index
can be used to generate the opening balances report, which is a balance
sheet fed with only the summarized entries.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">clamp</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span>
          <span class="n">begin_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span>
          <span class="n">account_types</span><span class="p">,</span>
          <span class="n">conversion_currency</span><span class="p">,</span>
          <span class="n">account_earnings</span><span class="p">,</span>
          <span class="n">account_opening</span><span class="p">,</span>
          <span class="n">account_conversions</span><span class="p">):</span>
    <span class="sd">"""Filter entries to include only those during a specified time period.</span>

<span class="sd">    Firstly, this method will transfer all balances for the income and expense</span>
<span class="sd">    accounts occurring before the given period begin date to the</span>
<span class="sd">    'account_earnings' account (earnings before the period, or "retained</span>
<span class="sd">    earnings") and summarize all of the transactions before that date against</span>
<span class="sd">    the 'account_opening' account (usually "opening balances"). The resulting</span>
<span class="sd">    income and expense accounts should have no transactions (since their</span>
<span class="sd">    balances have been transferred out and summarization of zero balances should</span>
<span class="sd">    not add any transactions).</span>

<span class="sd">    Secondly, all the entries after the period end date will be truncated and a</span>
<span class="sd">    conversion entry will be added for the resulting transactions that reflect</span>
<span class="sd">    changes occurring between the beginning and end of the exercise period. The</span>
<span class="sd">    resulting balance of all account should be empty.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directive tuples.</span>
<span class="sd">      begin_date: A datetime.date instance, the beginning of the period.</span>
<span class="sd">      end_date: A datetime.date instance, one day beyond the end of the period.</span>
<span class="sd">      account_types: An instance of AccountTypes.</span>
<span class="sd">      conversion_currency: A string, the transfer currency to use for zero prices</span>
<span class="sd">        on the conversion entry.</span>
<span class="sd">      account_earnings: A string, the name of the account to transfer</span>
<span class="sd">        previous earnings from the income statement accounts to the balance</span>
<span class="sd">        sheet.</span>
<span class="sd">      account_opening: A string, the name of the account in equity</span>
<span class="sd">        to transfer previous balances from, in order to initialize account</span>
<span class="sd">        balances at the beginning of the period. This is typically called an</span>
<span class="sd">        opening balances account.</span>
<span class="sd">      account_conversions: A string, tne name of the equity account to</span>
<span class="sd">        book currency conversions against.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new list of entries is returned, and the index that points to the first</span>
<span class="sd">      original transaction after the beginning date of the period. This index</span>
<span class="sd">      can be used to generate the opening balances report, which is a balance</span>
<span class="sd">      sheet fed with only the summarized entries.</span>
<span class="sd">    """</span>
    <span class="c1"># Transfer income and expenses before the period to equity.</span>
    <span class="n">income_statement_account_pred</span> <span class="o">=</span> <span class="p">(</span>
        <span class="k">lambda</span> <span class="n">account</span><span class="p">:</span> <span class="n">is_income_statement_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">account_types</span><span class="p">))</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">transfer_balances</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">begin_date</span><span class="p">,</span>
                                <span class="n">income_statement_account_pred</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">)</span>

    <span class="c1"># Summarize all the previous balances, after transferring the income and</span>
    <span class="c1"># expense balances, so all entries for those accounts before the begin date</span>
    <span class="c1"># should now disappear.</span>
    <span class="n">entries</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">begin_date</span><span class="p">,</span> <span class="n">account_opening</span><span class="p">)</span>

    <span class="c1"># Truncate the entries after this.</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">truncate</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>

    <span class="c1"># Insert conversion entries.</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">index</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.clamp_opt">
<code class="highlight language-python">
clamp_opt<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">begin_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.clamp_opt" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Clamp by getting all the parameters from an options map.</p>
<p>See clamp() for details.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>See clamp().</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>begin_date</code></td>
<td><code></code></td>
<td>
<p>See clamp().</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>end_date</code></td>
<td><code></code></td>
<td>
<p>See clamp().</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>options_map</code></td>
<td><code></code></td>
<td>
<p>A parser's option_map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>Same as clamp().</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">clamp_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">begin_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Clamp by getting all the parameters from an options map.</span>

<span class="sd">    See clamp() for details.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: See clamp().</span>
<span class="sd">      begin_date: See clamp().</span>
<span class="sd">      end_date: See clamp().</span>
<span class="sd">      options_map: A parser's option_map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      Same as clamp().</span>
<span class="sd">    """</span>
    <span class="n">account_types</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_account_types</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">previous_accounts</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_previous_accounts</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">conversion_currency</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s1">'conversion_currency'</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">clamp</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">begin_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span>
                 <span class="n">account_types</span><span class="p">,</span>
                 <span class="n">conversion_currency</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">previous_accounts</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.clear">
<code class="highlight language-python">
clear<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.clear" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Transfer income and expenses balances at the given date to the equity accounts.</p>
<p>This method insert entries to zero out balances on income and expenses
accounts by transfering them to an equity account.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directive tuples.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance, one day beyond the end of the period. This
date can be optionally left to None in order to close at the end of the
list of entries.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_types</code></td>
<td><code></code></td>
<td>
<p>An instance of AccountTypes.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_earnings</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the account to transfer
previous earnings from the income statement accounts to the balance
sheet.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A new list of entries is returned, and the index that points to one before
the last original transaction before the transfers.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span>
          <span class="n">date</span><span class="p">,</span>
          <span class="n">account_types</span><span class="p">,</span>
          <span class="n">account_earnings</span><span class="p">):</span>
    <span class="sd">"""Transfer income and expenses balances at the given date to the equity accounts.</span>

<span class="sd">    This method insert entries to zero out balances on income and expenses</span>
<span class="sd">    accounts by transfering them to an equity account.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directive tuples.</span>
<span class="sd">      date: A datetime.date instance, one day beyond the end of the period. This</span>
<span class="sd">        date can be optionally left to None in order to close at the end of the</span>
<span class="sd">        list of entries.</span>
<span class="sd">      account_types: An instance of AccountTypes.</span>
<span class="sd">      account_earnings: A string, the name of the account to transfer</span>
<span class="sd">        previous earnings from the income statement accounts to the balance</span>
<span class="sd">        sheet.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new list of entries is returned, and the index that points to one before</span>
<span class="sd">      the last original transaction before the transfers.</span>
<span class="sd">    """</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="c1"># Transfer income and expenses before the period to equity.</span>
    <span class="n">income_statement_account_pred</span> <span class="o">=</span> <span class="p">(</span>
        <span class="k">lambda</span> <span class="n">account</span><span class="p">:</span> <span class="n">is_income_statement_account</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">account_types</span><span class="p">))</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="n">transfer_balances</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span>
                                    <span class="n">income_statement_account_pred</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">index</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.clear_opt">
<code class="highlight language-python">
clear_opt<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.clear_opt" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Convenience function to clear() using an options map.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>195
196
197
198
199
200</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">clear_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Convenience function to clear() using an options map.</span>
<span class="sd">    """</span>
    <span class="n">account_types</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_account_types</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">current_accounts</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_current_accounts</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clear</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">current_accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.close">
<code class="highlight language-python">
close<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.close" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Truncate entries that occur after a particular date and ensure balance.</p>
<p>This method essentially removes entries after a date. It truncates the
future. To do so, it will</p>
<ol>
<li>
<p>Remove all entries which occur after 'date', if given.</p>
</li>
<li>
<p>Insert conversion transactions at the end of the list of entries to
   ensure that the total balance of all postings sums up to empty.</p>
</li>
</ol>
<p>The result is a list of entries with a total balance of zero, with possibly
non-zero balances for the income/expense accounts. To produce a final
balance sheet, use transfer() to move the net income to the equity accounts.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directive tuples.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance, one day beyond the end of the period. This
date can be optionally left to None in order to close at the end of the
list of entries.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>conversion_currency</code></td>
<td><code></code></td>
<td>
<p>A string, the transfer currency to use for zero prices
on the conversion entry.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_conversions</code></td>
<td><code></code></td>
<td>
<p>A string, tne name of the equity account to
book currency conversions against.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A new list of entries is returned, and the index that points to one beyond
the last original transaction that was provided. Further entries may have
been inserted to normalize conversions and ensure the total balance sums
to zero.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span>
          <span class="n">date</span><span class="p">,</span>
          <span class="n">conversion_currency</span><span class="p">,</span>
          <span class="n">account_conversions</span><span class="p">):</span>
    <span class="sd">"""Truncate entries that occur after a particular date and ensure balance.</span>

<span class="sd">    This method essentially removes entries after a date. It truncates the</span>
<span class="sd">    future. To do so, it will</span>

<span class="sd">    1. Remove all entries which occur after 'date', if given.</span>

<span class="sd">    2. Insert conversion transactions at the end of the list of entries to</span>
<span class="sd">       ensure that the total balance of all postings sums up to empty.</span>

<span class="sd">    The result is a list of entries with a total balance of zero, with possibly</span>
<span class="sd">    non-zero balances for the income/expense accounts. To produce a final</span>
<span class="sd">    balance sheet, use transfer() to move the net income to the equity accounts.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directive tuples.</span>
<span class="sd">      date: A datetime.date instance, one day beyond the end of the period. This</span>
<span class="sd">        date can be optionally left to None in order to close at the end of the</span>
<span class="sd">        list of entries.</span>
<span class="sd">      conversion_currency: A string, the transfer currency to use for zero prices</span>
<span class="sd">        on the conversion entry.</span>
<span class="sd">      account_conversions: A string, tne name of the equity account to</span>
<span class="sd">        book currency conversions against.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new list of entries is returned, and the index that points to one beyond</span>
<span class="sd">      the last original transaction that was provided. Further entries may have</span>
<span class="sd">      been inserted to normalize conversions and ensure the total balance sums</span>
<span class="sd">      to zero.</span>
<span class="sd">    """</span>

    <span class="c1"># Truncate the entries after the date, if a date has been provided.</span>
    <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">truncate</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="c1"># Keep an index to the truncated list of entries (before conversions).</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="c1"># Insert a conversions entry to ensure the total balance of all accounts is</span>
    <span class="c1"># flush zero.</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">index</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.close_opt">
<code class="highlight language-python">
close_opt<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.close_opt" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Convenience function to close() using an options map.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>188
189
190
191
192
193</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">close_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Convenience function to close() using an options map.</span>
<span class="sd">    """</span>
    <span class="n">conversion_currency</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s1">'conversion_currency'</span><span class="p">]</span>
    <span class="n">current_accounts</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_current_accounts</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">close</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">current_accounts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.conversions">
<code class="highlight language-python">
conversions<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">conversion_account</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.conversions" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Insert a conversion entry at date 'date' at the given account.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of entries.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>conversion_account</code></td>
<td><code></code></td>
<td>
<p>A string, the account to book against.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>conversion_currency</code></td>
<td><code></code></td>
<td>
<p>A string, the transfer currency to use for zero prices
on the conversion entry.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>The date before which to insert the conversion entry. The new
entry will be inserted as the last entry of the date just previous
to this date.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A modified list of entries.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">conversion_account</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Insert a conversion entry at date 'date' at the given account.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of entries.</span>
<span class="sd">      conversion_account: A string, the account to book against.</span>
<span class="sd">      conversion_currency: A string, the transfer currency to use for zero prices</span>
<span class="sd">        on the conversion entry.</span>
<span class="sd">      date: The date before which to insert the conversion entry. The new</span>
<span class="sd">        entry will be inserted as the last entry of the date just previous</span>
<span class="sd">        to this date.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A modified list of entries.</span>
<span class="sd">    """</span>
    <span class="c1"># Compute the balance at the given date.</span>
    <span class="n">conversion_balance</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">compute_entries_balance</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>

    <span class="c1"># Early exit if there is nothing to do.</span>
    <span class="n">conversion_cost_balance</span> <span class="o">=</span> <span class="n">conversion_balance</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">get_cost</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">conversion_cost_balance</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">entries</span>

    <span class="c1"># Calculate the index and the date for the new entry. We want to store it as</span>
    <span class="c1"># the last transaction of the day before.</span>
    <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">bisect_key</span><span class="o">.</span><span class="n">bisect_left_with_key</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="n">last_date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="n">last_date</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span>

    <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;conversions&gt;'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">narration</span> <span class="o">=</span> <span class="s1">'Conversion for </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conversion_balance</span><span class="p">)</span>
    <span class="n">conversion_entry</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">last_date</span><span class="p">,</span> <span class="n">flags</span><span class="o">.</span><span class="n">FLAG_CONVERSIONS</span><span class="p">,</span>
                                   <span class="kc">None</span><span class="p">,</span> <span class="n">narration</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">conversion_cost_balance</span><span class="o">.</span><span class="n">get_positions</span><span class="p">():</span>
        <span class="c1"># Important note: Set the cost to zero here to maintain the balance</span>
        <span class="c1"># invariant. (This is the only single place we cheat on the balance rule</span>
        <span class="c1"># in the entire system and this is necessary; see documentation on</span>
        <span class="c1"># Conversions.)</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">ZERO</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">)</span>
        <span class="n">neg_pos</span> <span class="o">=</span> <span class="o">-</span><span class="n">position</span>
        <span class="n">conversion_entry</span><span class="o">.</span><span class="n">postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">conversion_account</span><span class="p">,</span> <span class="n">neg_pos</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">neg_pos</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
                         <span class="n">price</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="c1"># Make a copy of the list of entries and insert the new transaction into it.</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="n">new_entries</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">conversion_entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entries</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.create_entries_from_balances">
<code class="highlight language-python">
create_entries_from_balances<span class="p">(</span><span class="n">balances</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">source_account</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">narration_template</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.create_entries_from_balances" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>"Create a list of entries from a dict of balances.</p>
<p>This method creates a list of new entries to transfer the amounts in the
'balances' dict to/from another account specified in 'source_account'.</p>
<p>The balancing posting is created with the equivalent at cost. In other
words, if you attempt to balance 10 HOOL {500 USD}, this will synthesize a
posting with this position on one leg, and with 5000 USD on the
'source_account' leg.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>balances</code></td>
<td><code></code></td>
<td>
<p>A dict of account name strings to Inventory instances.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date object, the date at which to create the transaction.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>source_account</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the account to pull the balances
from. This is the magician's hat to pull the rabbit from.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>direction</code></td>
<td><code></code></td>
<td>
<p>If 'direction' is True, the new entries transfer TO the
balances account from the source account; otherwise the new entries
transfer FROM the balances into the source account.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>meta</code></td>
<td><code></code></td>
<td>
<p>A dict to use as metadata for the transactions.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>flag</code></td>
<td><code></code></td>
<td>
<p>A string, the flag to use for the transactinos.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>narration_template</code></td>
<td><code></code></td>
<td>
<p>A format string for creating the narration. It is
formatted with 'account' and 'date' replacement variables.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of newly synthesizes Transaction entries.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">create_entries_from_balances</span><span class="p">(</span><span class="n">balances</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">source_account</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span>
                                 <span class="n">meta</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">narration_template</span><span class="p">):</span>
    <span class="sd">""""Create a list of entries from a dict of balances.</span>

<span class="sd">    This method creates a list of new entries to transfer the amounts in the</span>
<span class="sd">    'balances' dict to/from another account specified in 'source_account'.</span>

<span class="sd">    The balancing posting is created with the equivalent at cost. In other</span>
<span class="sd">    words, if you attempt to balance 10 HOOL {500 USD}, this will synthesize a</span>
<span class="sd">    posting with this position on one leg, and with 5000 USD on the</span>
<span class="sd">    'source_account' leg.</span>

<span class="sd">    Args:</span>
<span class="sd">      balances: A dict of account name strings to Inventory instances.</span>
<span class="sd">      date: A datetime.date object, the date at which to create the transaction.</span>
<span class="sd">      source_account: A string, the name of the account to pull the balances</span>
<span class="sd">        from. This is the magician's hat to pull the rabbit from.</span>
<span class="sd">      direction: If 'direction' is True, the new entries transfer TO the</span>
<span class="sd">        balances account from the source account; otherwise the new entries</span>
<span class="sd">        transfer FROM the balances into the source account.</span>
<span class="sd">      meta: A dict to use as metadata for the transactions.</span>
<span class="sd">      flag: A string, the flag to use for the transactinos.</span>
<span class="sd">      narration_template: A format string for creating the narration. It is</span>
<span class="sd">        formatted with 'account' and 'date' replacement variables.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of newly synthesizes Transaction entries.</span>
<span class="sd">    """</span>
    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">account</span><span class="p">,</span> <span class="n">account_balance</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">balances</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

        <span class="c1"># Don't create new entries where there is no balance.</span>
        <span class="k">if</span> <span class="n">account_balance</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">continue</span>

        <span class="n">narration</span> <span class="o">=</span> <span class="n">narration_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account</span><span class="o">=</span><span class="n">account</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">direction</span><span class="p">:</span>
            <span class="n">account_balance</span> <span class="o">=</span> <span class="o">-</span><span class="n">account_balance</span>

        <span class="n">postings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_entry</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">(</span>
            <span class="n">meta</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">narration</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">EMPTY_SET</span><span class="p">,</span> <span class="n">postings</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">account_balance</span><span class="o">.</span><span class="n">get_positions</span><span class="p">():</span>
            <span class="n">postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">position</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">position</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
                                         <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="o">-</span><span class="n">convert</span><span class="o">.</span><span class="n">get_cost</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
            <span class="n">postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">source_account</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                         <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_entries</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.get_open_entries">
<code class="highlight language-python">
get_open_entries<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.get_open_entries" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Gather the list of active Open entries at date.</p>
<p>This returns the list of Open entries that have not been closed at the given
date, in the same order they were observed in the document.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>The date at which to look for an open entry. If not specified, will
return the entries still open at the latest date.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of Open directives.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_open_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
    <span class="sd">"""Gather the list of active Open entries at date.</span>

<span class="sd">    This returns the list of Open entries that have not been closed at the given</span>
<span class="sd">    date, in the same order they were observed in the document.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: The date at which to look for an open entry. If not specified, will</span>
<span class="sd">        return the entries still open at the latest date.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of Open directives.</span>
<span class="sd">    """</span>
    <span class="n">open_entries</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Open</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ex_index</span><span class="p">,</span> <span class="n">ex_entry</span> <span class="o">=</span> <span class="n">open_entries</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">ex_entry</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
                    <span class="n">open_entries</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">open_entries</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Close</span><span class="p">):</span>
            <span class="c1"># If there is no corresponding open, don't raise an error.</span>
            <span class="n">open_entries</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">entry</span> <span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">open_entries</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.open">
<code class="highlight language-python">
open<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">,</span> <span class="n">account_opening</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.open" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Summarize entries before a date and transfer income/expenses to equity.</p>
<p>This method essentially prepares a list of directives to contain only
transactions that occur after a particular date. It truncates the past. To
do so, it will</p>
<ol>
<li>
<p>Insert conversion transactions at the given open date, then</p>
</li>
<li>
<p>Insert transactions at that date to move accumulated balances from before
   that date from the income and expenses accounts to an equity account, and
   finally</p>
</li>
<li>
<p>It removes all the transactions previous to the date and replaces them by
   opening balances entries to bring the balances to the same amount.</p>
</li>
</ol>
<p>The result is a list of entries for which the income and expense accounts
are beginning with a balance of zero, and all other accounts begin with a
transaction that brings their balance to the expected amount. All the past
has been summarized at that point.</p>
<p>An index is returned to the first transaction past the balance opening
transactions, so you can keep just those in order to render a balance sheet
for only the opening balances.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directive tuples.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance, the date at which to do this.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_types</code></td>
<td><code></code></td>
<td>
<p>An instance of AccountTypes.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>conversion_currency</code></td>
<td><code></code></td>
<td>
<p>A string, the transfer currency to use for zero prices
on the conversion entry.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_earnings</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the account to transfer
previous earnings from the income statement accounts to the balance
sheet.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_opening</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the account in equity
to transfer previous balances from, in order to initialize account
balances at the beginning of the period. This is typically called an
opening balances account.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_conversions</code></td>
<td><code></code></td>
<td>
<p>A string, tne name of the equity account to
book currency conversions against.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A new list of entries is returned, and the index that points to the first
original transaction after the beginning date of the period. This index
can be used to generate the opening balances report, which is a balance
sheet fed with only the summarized entries.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span>
         <span class="n">date</span><span class="p">,</span>
         <span class="n">account_types</span><span class="p">,</span>
         <span class="n">conversion_currency</span><span class="p">,</span>
         <span class="n">account_earnings</span><span class="p">,</span>
         <span class="n">account_opening</span><span class="p">,</span>
         <span class="n">account_conversions</span><span class="p">):</span>
    <span class="sd">"""Summarize entries before a date and transfer income/expenses to equity.</span>

<span class="sd">    This method essentially prepares a list of directives to contain only</span>
<span class="sd">    transactions that occur after a particular date. It truncates the past. To</span>
<span class="sd">    do so, it will</span>

<span class="sd">    1. Insert conversion transactions at the given open date, then</span>

<span class="sd">    2. Insert transactions at that date to move accumulated balances from before</span>
<span class="sd">       that date from the income and expenses accounts to an equity account, and</span>
<span class="sd">       finally</span>

<span class="sd">    3. It removes all the transactions previous to the date and replaces them by</span>
<span class="sd">       opening balances entries to bring the balances to the same amount.</span>

<span class="sd">    The result is a list of entries for which the income and expense accounts</span>
<span class="sd">    are beginning with a balance of zero, and all other accounts begin with a</span>
<span class="sd">    transaction that brings their balance to the expected amount. All the past</span>
<span class="sd">    has been summarized at that point.</span>

<span class="sd">    An index is returned to the first transaction past the balance opening</span>
<span class="sd">    transactions, so you can keep just those in order to render a balance sheet</span>
<span class="sd">    for only the opening balances.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directive tuples.</span>
<span class="sd">      date: A datetime.date instance, the date at which to do this.</span>
<span class="sd">      account_types: An instance of AccountTypes.</span>
<span class="sd">      conversion_currency: A string, the transfer currency to use for zero prices</span>
<span class="sd">        on the conversion entry.</span>
<span class="sd">      account_earnings: A string, the name of the account to transfer</span>
<span class="sd">        previous earnings from the income statement accounts to the balance</span>
<span class="sd">        sheet.</span>
<span class="sd">      account_opening: A string, the name of the account in equity</span>
<span class="sd">        to transfer previous balances from, in order to initialize account</span>
<span class="sd">        balances at the beginning of the period. This is typically called an</span>
<span class="sd">        opening balances account.</span>
<span class="sd">      account_conversions: A string, tne name of the equity account to</span>
<span class="sd">        book currency conversions against.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new list of entries is returned, and the index that points to the first</span>
<span class="sd">      original transaction after the beginning date of the period. This index</span>
<span class="sd">      can be used to generate the opening balances report, which is a balance</span>
<span class="sd">      sheet fed with only the summarized entries.</span>

<span class="sd">    """</span>
    <span class="c1"># Insert conversion entries.</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">account_conversions</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="c1"># Transfer income and expenses before the period to equity.</span>
    <span class="n">entries</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clear</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">account_earnings</span><span class="p">)</span>

    <span class="c1"># Summarize all the previous balances, after transferring the income and</span>
    <span class="c1"># expense balances, so all entries for those accounts before the begin date</span>
    <span class="c1"># should now disappear.</span>
    <span class="n">entries</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_opening</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">index</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.open_opt">
<code class="highlight language-python">
open_opt<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.open_opt" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Convenience function to open() using an options map.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>180
181
182
183
184
185
186</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">open_opt</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Convenience function to open() using an options map.</span>
<span class="sd">    """</span>
    <span class="n">account_types</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_account_types</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">previous_accounts</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_previous_accounts</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
    <span class="n">conversion_currency</span> <span class="o">=</span> <span class="n">options_map</span><span class="p">[</span><span class="s1">'conversion_currency'</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_types</span><span class="p">,</span> <span class="n">conversion_currency</span><span class="p">,</span> <span class="o">*</span><span class="n">previous_accounts</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.summarize">
<code class="highlight language-python">
summarize<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_opening</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.summarize" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Summarize all entries before a date by replacing then with summarization entries.</p>
<p>This function replaces the transactions up to (and not including) the given
date with a opening balance transactions, one for each account. It returns
new entries, all of the transactions before the given date having been
replaced by a few summarization entries, one for each account.</p>
<p>Notes:
- Open entries are preserved for active accounts.
- The last relevant price entry for each (base, quote) pair is preserved.
- All other entries before the cutoff date are culled.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance, the cutoff date before which to summararize.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_opening</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the source account to book summarization
entries against.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>The function returns a list of new entries and the integer index at which
the entries on or after the cutoff date begin.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_opening</span><span class="p">):</span>
    <span class="sd">"""Summarize all entries before a date by replacing then with summarization entries.</span>

<span class="sd">    This function replaces the transactions up to (and not including) the given</span>
<span class="sd">    date with a opening balance transactions, one for each account. It returns</span>
<span class="sd">    new entries, all of the transactions before the given date having been</span>
<span class="sd">    replaced by a few summarization entries, one for each account.</span>

<span class="sd">    Notes:</span>
<span class="sd">    - Open entries are preserved for active accounts.</span>
<span class="sd">    - The last relevant price entry for each (base, quote) pair is preserved.</span>
<span class="sd">    - All other entries before the cutoff date are culled.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance, the cutoff date before which to summararize.</span>
<span class="sd">      account_opening: A string, the name of the source account to book summarization</span>
<span class="sd">        entries against.</span>
<span class="sd">    Returns:</span>
<span class="sd">      The function returns a list of new entries and the integer index at which</span>
<span class="sd">      the entries on or after the cutoff date begin.</span>
<span class="sd">    """</span>
    <span class="c1"># Compute balances at date.</span>
    <span class="n">balances</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">balance_by_account</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="c1"># We need to insert the entries with a date previous to subsequent checks,</span>
    <span class="c1"># to maintain ensure the open directives show up before any transaction.</span>
    <span class="n">summarize_date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Create summarization / opening balance entries.</span>
    <span class="n">summarizing_entries</span> <span class="o">=</span> <span class="n">create_entries_from_balances</span><span class="p">(</span>
        <span class="n">balances</span><span class="p">,</span> <span class="n">summarize_date</span><span class="p">,</span> <span class="n">account_opening</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;summarize&gt;'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">flags</span><span class="o">.</span><span class="n">FLAG_SUMMARIZE</span><span class="p">,</span>
        <span class="s2">"Opening balance for '</span><span class="si">{account}</span><span class="s2">' (Summarization)"</span><span class="p">)</span>

    <span class="c1"># Insert the last price entry for each commodity from before the date.</span>
    <span class="n">price_entries</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">get_last_price_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="c1"># Gather the list of active open entries at date.</span>
    <span class="n">open_entries</span> <span class="o">=</span> <span class="n">get_open_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="c1"># Compute entries before the date and preserve the entries after the date.</span>
    <span class="n">before_entries</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">open_entries</span> <span class="o">+</span> <span class="n">price_entries</span> <span class="o">+</span> <span class="n">summarizing_entries</span><span class="p">,</span>
                            <span class="n">key</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">entry_sortkey</span><span class="p">)</span>
    <span class="n">after_entries</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>

    <span class="c1"># Return a new list of entries and the index that points after the entries</span>
    <span class="c1"># were inserted.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">before_entries</span> <span class="o">+</span> <span class="n">after_entries</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">before_entries</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.transfer_balances">
<code class="highlight language-python">
transfer_balances<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_pred</span><span class="p">,</span> <span class="n">transfer_account</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.transfer_balances" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Synthesize transactions to transfer balances from some accounts at a given date.</p>
<p>For all accounts that match the 'account_pred' predicate, create new entries
to transfer the balance at the given date from the account to the transfer
account. This is used to transfer balances from income and expenses from a
previous period to a "retained earnings" account. This is accomplished by
creating new entries.</p>
<p>Note that inserting transfers breaks any following balance checks that are
in the transferred accounts. For this reason, all balance assertion entries
following the cutoff date for those accounts are removed from the list in
output.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance, the date at which to make the transfer.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>account_pred</code></td>
<td><code></code></td>
<td>
<p>A predicate function that, given an account string, returns
true if the account is meant to be transferred.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>transfer_account</code></td>
<td><code></code></td>
<td>
<p>A string, the name of the source account to be used on
the transfer entries to receive balances at the given date.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A new list of entries, with the new transfer entries added in.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">transfer_balances</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">account_pred</span><span class="p">,</span> <span class="n">transfer_account</span><span class="p">):</span>
    <span class="sd">"""Synthesize transactions to transfer balances from some accounts at a given date.</span>

<span class="sd">    For all accounts that match the 'account_pred' predicate, create new entries</span>
<span class="sd">    to transfer the balance at the given date from the account to the transfer</span>
<span class="sd">    account. This is used to transfer balances from income and expenses from a</span>
<span class="sd">    previous period to a "retained earnings" account. This is accomplished by</span>
<span class="sd">    creating new entries.</span>

<span class="sd">    Note that inserting transfers breaks any following balance checks that are</span>
<span class="sd">    in the transferred accounts. For this reason, all balance assertion entries</span>
<span class="sd">    following the cutoff date for those accounts are removed from the list in</span>
<span class="sd">    output.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      date: A datetime.date instance, the date at which to make the transfer.</span>
<span class="sd">      account_pred: A predicate function that, given an account string, returns</span>
<span class="sd">        true if the account is meant to be transferred.</span>
<span class="sd">      transfer_account: A string, the name of the source account to be used on</span>
<span class="sd">        the transfer entries to receive balances at the given date.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new list of entries, with the new transfer entries added in.</span>
<span class="sd">    """</span>
    <span class="c1"># Don't bother doing anything if there are no entries.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">entries</span>

    <span class="c1"># Compute balances at date.</span>
    <span class="n">balances</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">balance_by_account</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="c1"># Filter out to keep only the accounts we want.</span>
    <span class="n">transfer_balances</span> <span class="o">=</span> <span class="p">{</span><span class="n">account</span><span class="p">:</span> <span class="n">balance</span>
                         <span class="k">for</span> <span class="n">account</span><span class="p">,</span> <span class="n">balance</span> <span class="ow">in</span> <span class="n">balances</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                         <span class="k">if</span> <span class="n">account_pred</span><span class="p">(</span><span class="n">account</span><span class="p">)}</span>

    <span class="c1"># We need to insert the entries at the end of the previous day.</span>
    <span class="k">if</span> <span class="n">date</span><span class="p">:</span>
        <span class="n">transfer_date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transfer_date</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span>

    <span class="c1"># Create transfer entries.</span>
    <span class="n">transfer_entries</span> <span class="o">=</span> <span class="n">create_entries_from_balances</span><span class="p">(</span>
        <span class="n">transfer_balances</span><span class="p">,</span> <span class="n">transfer_date</span><span class="p">,</span> <span class="n">transfer_account</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">'&lt;transfer_balances&gt;'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">flags</span><span class="o">.</span><span class="n">FLAG_TRANSFER</span><span class="p">,</span>
        <span class="s2">"Transfer balance for '</span><span class="si">{account}</span><span class="s2">' (Transfer balance)"</span><span class="p">)</span>

    <span class="c1"># Remove balance assertions that occur after a transfer on an account that</span>
    <span class="c1"># has been transferred away; they would break.</span>
    <span class="n">after_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span>
                     <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
                     <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">balance</span><span class="o">.</span><span class="n">Balance</span><span class="p">)</span> <span class="ow">and</span>
                             <span class="n">entry</span><span class="o">.</span><span class="n">account</span> <span class="ow">in</span> <span class="n">transfer_balances</span><span class="p">)]</span>

    <span class="c1"># Split the new entries in a new list.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">entries</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">transfer_entries</span> <span class="o">+</span> <span class="n">after_entries</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.summarize.truncate">
<code class="highlight language-python">
truncate<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize.truncate" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Filter out all the entries at and after date. Returns a new list of entries.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A sorted list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>date</code></td>
<td><code></code></td>
<td>
<p>A datetime.date instance.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A truncated list of directives.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>512
513
514
515
516
517
518
519
520
521
522
523</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
    <span class="sd">"""Filter out all the entries at and after date. Returns a new list of entries.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A sorted list of directives.</span>
<span class="sd">      date: A datetime.date instance.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A truncated list of directives.</span>
<span class="sd">    """</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">bisect_key</span><span class="o">.</span><span class="n">bisect_left_with_key</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span>
                                            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entries</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ops.summarize_test">
<code>summarize_test</code>
<a class="headerlink" href="#beancount.ops.summarize_test" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Unit tests for summarization.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ops.summarize_test.TestBalanceByAccount">
<code>TestBalanceByAccount</code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestBalanceByAccount" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.summarize_test.TestBalanceByAccount.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestBalanceByAccount.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>1127
1128
1129
1130
1131
1132
1133
1134
1135
1136
1137
1138
1139
1140
1141
1142
1143</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="nd">@loader</span><span class="o">.</span><span class="n">load_doc</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    2001-01-01 open Assets:AccountA</span>
<span class="sd">    2001-01-01 open Assets:AccountB</span>
<span class="sd">    2001-01-01 open Equity:Opening-Balances</span>

<span class="sd">    2014-02-01 *</span>
<span class="sd">      Assets:AccountA   10 USD</span>
<span class="sd">      Equity:Opening-Balances</span>

<span class="sd">    2014-03-01 *</span>
<span class="sd">      Assets:AccountA   1 USD</span>
<span class="sd">      Assets:AccountB  12 USD</span>
<span class="sd">      Equity:Opening-Balances</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ops.summarize_test.TestConversions">
<code>TestConversions</code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestConversions" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.summarize_test.TestConversions.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestConversions.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>849
850
851
852
853
854
855
856
857
858
859
860
861
862
863
864
865
866
867
868
869
870
871
872
873
874</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="nd">@loader</span><span class="o">.</span><span class="n">load_doc</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">      2012-01-01 open Income:US:Job</span>
<span class="sd">      2012-01-01 open Assets:US:Checking</span>
<span class="sd">      2012-01-01 open Assets:CA:Invest</span>
<span class="sd">      2012-01-01 open Assets:CA:Invest:NT</span>

<span class="sd">      2012-03-01 * "Earn some money"</span>
<span class="sd">        Income:US:Job            -1000.00 USD</span>
<span class="sd">        Assets:US:Checking        1000.00 USD</span>

<span class="sd">      2012-03-02 * "Transfer to Investment"</span>
<span class="sd">        Assets:US:Checking       -800.00 USD</span>
<span class="sd">        Assets:CA:Invest          800.00 CAD @ 1 USD</span>

<span class="sd">      2012-03-03 * "Buy some stock"</span>
<span class="sd">        Assets:CA:Invest         -600.00 CAD</span>
<span class="sd">        Assets:CA:Invest:NT        60 NT {10 CAD}</span>

<span class="sd">      2012-05-01 * "Transfer some money back"</span>
<span class="sd">        Assets:CA:Invest         -100.00 CAD @ 1 USD</span>
<span class="sd">        Assets:US:Checking        100.00 USD</span>

<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ops.summarize_test.TestEntriesFromBalance">
<code>TestEntriesFromBalance</code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestEntriesFromBalance" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.summarize_test.TestEntriesFromBalance.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestEntriesFromBalance.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>1088
1089
1090
1091
1092</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">balances</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">balances</span><span class="p">[</span><span class="s1">'Assets:US:Investment'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">inventory</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s1">'10 HOOL {500.00 USD, 2014-01-01}'</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">balances</span><span class="p">[</span><span class="s1">'Assets:US:Bank:Checking'</span><span class="p">]</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s1">'1823.23 USD'</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ops.summarize_test.TestOpenAtDate">
<code>TestOpenAtDate</code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestOpenAtDate" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.summarize_test.TestOpenAtDate.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestOpenAtDate.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>1176
1177
1178
1179
1180
1181
1182
1183
1184
1185
1186
1187
1188
1189
1190
1191
1192
1193
1194
1195
1196
1197
1198
1199
1200
1201
1202
1203
1204</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="nd">@loader</span><span class="o">.</span><span class="n">load_doc</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">      2011-01-01 open Assets:AccountA</span>
<span class="sd">      2011-02-01 open Assets:AccountB</span>
<span class="sd">      2011-03-01 open Assets:AccountC</span>

<span class="sd">      2011-03-15 close Assets:AccountA</span>

<span class="sd">      2011-04-01 open Assets:AccountD</span>
<span class="sd">      2011-05-01 open Assets:AccountE</span>
<span class="sd">      2011-06-01 open Assets:AccountF</span>
<span class="sd">      2011-07-01 open Assets:AccountG</span>
<span class="sd">      2011-08-01 open Assets:AccountH</span>
<span class="sd">      2011-09-01 open Assets:AccountI</span>
<span class="sd">      2011-10-01 open Assets:AccountJ</span>
<span class="sd">      2011-11-01 open Assets:AccountK</span>
<span class="sd">      2011-12-01 open Assets:AccountL</span>

<span class="sd">      2012-07-01 close Assets:AccountG</span>
<span class="sd">      2012-07-01 close Assets:AccountH</span>
<span class="sd">      2012-07-01 close Assets:AccountI</span>
<span class="sd">      2012-07-01 close Assets:AccountJ</span>
<span class="sd">      2012-07-01 close Assets:AccountK</span>
<span class="sd">      2012-07-01 close Assets:AccountL</span>

<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ops.summarize_test.TestOpenClose">
<code>TestOpenClose</code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestOpenClose" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.summarize_test.TestOpenClose.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestOpenClose.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="nd">@loader</span><span class="o">.</span><span class="n">load_doc</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    option "account_previous_earnings"    "Earnings:Previous"</span>
<span class="sd">    option "account_previous_balances"    "Opening-Balances"</span>
<span class="sd">    option "account_previous_conversions" "Conversions:Previous"</span>

<span class="sd">    option "account_current_earnings"     "Earnings:Current"</span>
<span class="sd">    option "account_current_conversions"  "Conversions:Current"</span>
<span class="sd">    option "conversion_currency"          "NOTHING"</span>

<span class="sd">    2012-01-01 open Income:Salary</span>
<span class="sd">    2012-01-01 open Expenses:Taxes</span>
<span class="sd">    2012-01-01 open Assets:US:Checking</span>
<span class="sd">    2012-01-01 open Assets:CA:Checking</span>

<span class="sd">    2012-03-01 * "Some income and expense to be summarized"</span>
<span class="sd">      Income:Salary        10000 USD</span>
<span class="sd">      Expenses:Taxes        3600 USD</span>
<span class="sd">      Assets:US:Checking  -13600 USD</span>

<span class="sd">    2012-03-02 * "Some conversion to be summarized"</span>
<span class="sd">      Assets:US:Checking   -5000 USD @ 1.2 CAD</span>
<span class="sd">      Assets:CA:Checking    6000 CAD</span>

<span class="sd">    ;; 2012-06-01  BEGIN --------------------------------</span>

<span class="sd">    2012-08-01 * "Some income and expense to show"</span>
<span class="sd">      Income:Salary        11000 USD</span>
<span class="sd">      Expenses:Taxes        3200 USD</span>
<span class="sd">      Assets:US:Checking  -14200 USD</span>

<span class="sd">    2012-08-02 * "Some other conversion to be summarized"</span>
<span class="sd">      Assets:US:Checking   -3000 USD @ 1.25 CAD</span>
<span class="sd">      Assets:CA:Checking    3750 CAD</span>

<span class="sd">    ;; 2012-09-01  END   --------------------------------</span>

<span class="sd">    2012-11-01 * "Some income and expense to be truncated"</span>
<span class="sd">      Income:Salary        10000 USD</span>
<span class="sd">      Expenses:Taxes        3600 USD</span>
<span class="sd">      Assets:US:Checking  -13600 USD</span>

<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">options_map</span> <span class="o">=</span> <span class="n">options_map</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">account_types</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get_account_types</span><span class="p">(</span><span class="n">options_map</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ops.summarize_test.TestOpenCloseWithOptions">
<code>TestOpenCloseWithOptions</code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestOpenCloseWithOptions" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Same test as the previous, but invoking all with options.</p>
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ops.summarize_test.TestTransferBalances">
<code>TestTransferBalances</code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestTransferBalances" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.summarize_test.TestTransferBalances.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestTransferBalances.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>626
627
628
629</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">__</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_string</span><span class="p">(</span><span class="n">INPUT</span><span class="p">)</span>
    <span class="n">printer</span><span class="o">.</span><span class="n">print_errors</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ops.summarize_test.TestTruncate">
<code>TestTruncate</code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestTruncate" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.summarize_test.TestTruncate.setUp">
<code class="highlight language-python">
setUp<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.summarize_test.TestTruncate.setUp" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Hook method for setting up the test fixture before exercising it.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/summarize_test.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 981
 982
 983
 984
 985
 986
 987
 988
 989
 990
 991
 992
 993
 994
 995
 996
 997
 998
 999
1000
1001
1002
1003
1004
1005
1006
1007
1008
1009
1010
1011</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="nd">@loader</span><span class="o">.</span><span class="n">load_doc</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    2014-01-01 open Assets:US:Bank:Checking</span>
<span class="sd">    2014-01-01 open Equity:Opening-Balances</span>

<span class="sd">    2014-03-10 * "A"</span>
<span class="sd">      Assets:US:Bank:Checking   1 USD</span>
<span class="sd">      Equity:Opening-Balances  -1 USD</span>

<span class="sd">    2014-03-11 * "B"</span>
<span class="sd">      Assets:US:Bank:Checking   1 USD</span>
<span class="sd">      Equity:Opening-Balances  -1 USD</span>

<span class="sd">    2014-03-12 * "C"</span>
<span class="sd">      Assets:US:Bank:Checking   1 USD</span>
<span class="sd">      Equity:Opening-Balances  -1 USD</span>

<span class="sd">    2014-03-13 * "D1"</span>
<span class="sd">      Assets:US:Bank:Checking   1 USD</span>
<span class="sd">      Equity:Opening-Balances  -1 USD</span>

<span class="sd">    2014-03-13 * "D2"</span>
<span class="sd">      Assets:US:Bank:Checking   1 USD</span>
<span class="sd">      Equity:Opening-Balances  -1 USD</span>

<span class="sd">    2014-03-14 * "E"</span>
<span class="sd">      Assets:US:Bank:Checking   1 USD</span>
<span class="sd">      Equity:Opening-Balances  -1 USD</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h2 class="doc doc-heading" id="beancount.ops.validation">
<code>validation</code>
<a class="headerlink" href="#beancount.ops.validation" title="Permanent link"></a></h2>
<div class="doc doc-contents">
<p>Validation checks.</p>
<p>These checks are intended to be run after all the plugins have transformed the
list of entries, just before serving them or generating reports from them. The
idea is to ensure a reasonable set of invariants and generate errors if those
invariants are violated. They are not sanity checks--user data is subject to
constraints which are hopefully detected here and which will result in errors
trickled up to the user.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="beancount.ops.validation.ValidationError">
<code>ValidationError</code>
<a class="headerlink" href="#beancount.ops.validation.ValidationError" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>ValidationError(source, message, entry)</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.validation.ValidationError.__getnewargs__">
<code class="highlight language-python">
__getnewargs__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ops.validation.ValidationError.__getnewargs__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return self as a plain tuple.  Used by copy and pickle.</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/validation.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>427
428
429</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return self as a plain tuple.  Used by copy and pickle.'</span>
    <span class="k">return</span> <span class="n">_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.validation.ValidationError.__new__">
<code class="highlight language-python">
__new__<span class="p">(</span><span class="n">_cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
<small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
</span>
<a class="headerlink" href="#beancount.ops.validation.ValidationError.__new__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Create new instance of ValidationError(source, message, entry)</p>
</div>
</div>
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="beancount.ops.validation.ValidationError.__repr__">
<code class="highlight language-python">
__repr__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#beancount.ops.validation.ValidationError.__repr__" title="Permanent link"></a></h4>
<div class="doc doc-contents">
<p>Return a nicely formatted representation string</p>
<details class="quote">
<summary>Source code in <code>beancount/ops/validation.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>419
420
421</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s1">'Return a nicely formatted representation string'</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">repr_fmt</span> <span class="o">%</span> <span class="bp">self</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.validation.validate">
<code class="highlight language-python">
validate<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">log_timings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_validations</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.validation.validate" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Perform all the standard checks on parsed contents.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>log_timings</code></td>
<td><code></code></td>
<td>
<p>An optional function to use for logging the time of individual
operations.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>extra_validations</code></td>
<td><code></code></td>
<td>
<p>A list of extra validation functions to run after loading
this list of entries.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/validation.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">log_timings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_validations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Perform all the standard checks on parsed contents.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">      log_timings: An optional function to use for logging the time of individual</span>
<span class="sd">        operations.</span>
<span class="sd">      extra_validations: A list of extra validation functions to run after loading</span>
<span class="sd">        this list of entries.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">validation_tests</span> <span class="o">=</span> <span class="n">VALIDATIONS</span>
    <span class="k">if</span> <span class="n">extra_validations</span><span class="p">:</span>
        <span class="n">validation_tests</span> <span class="o">+=</span> <span class="n">extra_validations</span>

    <span class="c1"># Run various validation routines define above.</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">validation_function</span> <span class="ow">in</span> <span class="n">validation_tests</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">misc_utils</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span><span class="s1">'function: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">validation_function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
                                 <span class="n">log_timings</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">new_errors</span> <span class="o">=</span> <span class="n">validation_function</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_errors</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.validation.validate_active_accounts">
<code class="highlight language-python">
validate_active_accounts<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.validation.validate_active_accounts" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check that all references to accounts occurs on active accounts.</p>
<p>We basically check that references to accounts from all directives other
than Open and Close occur at dates the open-close interval of that account.
This should be good for all of the directive types where we can extract an
account name.</p>
<p>Note that this is more strict a check than comparing the dates: we actually
check that no references to account are made on the same day before the open
directive appears for that account. This is a nice property to have, and is
supported by our custom sorting routine that will sort open entries before
transaction entries, given the same date.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/validation.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_active_accounts</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
    <span class="sd">"""Check that all references to accounts occurs on active accounts.</span>

<span class="sd">    We basically check that references to accounts from all directives other</span>
<span class="sd">    than Open and Close occur at dates the open-close interval of that account.</span>
<span class="sd">    This should be good for all of the directive types where we can extract an</span>
<span class="sd">    account name.</span>

<span class="sd">    Note that this is more strict a check than comparing the dates: we actually</span>
<span class="sd">    check that no references to account are made on the same day before the open</span>
<span class="sd">    directive appears for that account. This is a nice property to have, and is</span>
<span class="sd">    supported by our custom sorting routine that will sort open entries before</span>
<span class="sd">    transaction entries, given the same date.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">error_pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">active_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">opened_accounts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">):</span>
            <span class="n">active_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
            <span class="n">opened_accounts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Close</span><span class="p">):</span>
            <span class="n">active_set</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">getters</span><span class="o">.</span><span class="n">get_entry_accounts</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">account</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">active_set</span><span class="p">:</span>
                    <span class="c1"># Allow document and note directives that occur after an</span>
                    <span class="c1"># account is closed.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">ALLOW_AFTER_CLOSE</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">account</span> <span class="ow">in</span> <span class="n">opened_accounts</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="c1"># Register an error to be logged later, with an appropriate</span>
                    <span class="c1"># message.</span>
                    <span class="n">error_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">account</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>

    <span class="c1"># Refine the error message to disambiguate between the case of an account</span>
    <span class="c1"># that has never been seen and one that was simply not active at the time.</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">account</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">error_pairs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">opened_accounts</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">"Invalid reference to inactive account '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">"Invalid reference to unknown account '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.validation.validate_check_transaction_balances">
<code class="highlight language-python">
validate_check_transaction_balances<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.validation.validate_check_transaction_balances" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check again that all transaction postings balance, as users may have
transformed transactions.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/validation.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_check_transaction_balances</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Check again that all transaction postings balance, as users may have</span>
<span class="sd">    transformed transactions.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="c1"># Note: this is a bit slow; we could limit our checks to the original</span>
    <span class="c1"># transactions by using the hash function in the loader.</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">):</span>
            <span class="c1"># IMPORTANT: This validation is _crucial_ and cannot be skipped.</span>
            <span class="c1"># This is where we actually detect and warn on unbalancing</span>
            <span class="c1"># transactions. This _must_ come after the user routines, because</span>
            <span class="c1"># unbalancing input is legal, as those types of transactions may be</span>
            <span class="c1"># "fixed up" by a user-plugin. In other words, we want to allow</span>
            <span class="c1"># users to input unbalancing transactions as long as the final</span>
            <span class="c1"># transactions objects that appear on the stream (after processing</span>
            <span class="c1"># the plugins) are balanced. See {9e6c14b51a59}.</span>
            <span class="c1">#</span>
            <span class="c1"># Detect complete sets of postings that have residual balance;</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">compute_residual</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">)</span>
            <span class="n">tolerances</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">infer_tolerances</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">residual</span><span class="o">.</span><span class="n">is_small</span><span class="p">(</span><span class="n">tolerances</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ValidationError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                                    <span class="s2">"Transaction does not balance: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">residual</span><span class="p">),</span>
                                    <span class="n">entry</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.validation.validate_currency_constraints">
<code class="highlight language-python">
validate_currency_constraints<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.validation.validate_currency_constraints" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check the currency constraints from account open declarations.</p>
<p>Open directives admit an optional list of currencies that specify the only
types of commodities that the running inventory for this account may
contain. This function checks that all postings are only made in those
commodities.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/validation.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_currency_constraints</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Check the currency constraints from account open declarations.</span>

<span class="sd">    Open directives admit an optional list of currencies that specify the only</span>
<span class="sd">    types of commodities that the running inventory for this account may</span>
<span class="sd">    contain. This function checks that all postings are only made in those</span>
<span class="sd">    commodities.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>

    <span class="c1"># Get all the open entries with currency constraints.</span>
    <span class="n">open_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">:</span> <span class="n">entry</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Open</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">currencies</span><span class="p">}</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="c1"># Look up the corresponding account's valid currencies; skip the</span>
            <span class="c1"># check if there are none specified.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">open_entry</span> <span class="o">=</span> <span class="n">open_map</span><span class="p">[</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">]</span>
                <span class="n">valid_currencies</span> <span class="o">=</span> <span class="n">open_entry</span><span class="o">.</span><span class="n">currencies</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_currencies</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Perform the check.</span>
            <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_currencies</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="s2">"Invalid currency </span><span class="si">{}</span><span class="s2"> for account '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">account</span><span class="p">),</span>
                        <span class="n">entry</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.validation.validate_data_types">
<code class="highlight language-python">
validate_data_types<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.validation.validate_data_types" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check that all the data types of the attributes of entries are as expected.</p>
<p>Users are provided with a means to filter the list of entries. They're able to
write code that manipulates those tuple objects without any type constraints.
With discipline, this mostly works, but I know better: check, just to make sure.
This routine checks all the data types and assumptions on entries.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/validation.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_data_types</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Check that all the data types of the attributes of entries are as expected.</span>

<span class="sd">    Users are provided with a means to filter the list of entries. They're able to</span>
<span class="sd">    write code that manipulates those tuple objects without any type constraints.</span>
<span class="sd">    With discipline, this mostly works, but I know better: check, just to make sure.</span>
<span class="sd">    This routine checks all the data types and assumptions on entries.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">sanity_check_types</span><span class="p">(</span>
                <span class="n">entry</span><span class="p">,</span> <span class="n">options_map</span><span class="p">[</span><span class="s2">"allow_deprecated_none_for_tags_and_links"</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ValidationError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                                <span class="s2">"Invalid data types: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
                                <span class="n">entry</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.validation.validate_documents_paths">
<code class="highlight language-python">
validate_documents_paths<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.validation.validate_documents_paths" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check that all filenames in resolved Document entries are absolute filenames.</p>
<p>The processing of document entries is assumed to result in absolute paths.
Relative paths are resolved at the parsing stage and at point we want to
make sure we don't have to do any further processing on them.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/validation.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_documents_paths</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">):</span>
    <span class="sd">"""Check that all filenames in resolved Document entries are absolute filenames.</span>

<span class="sd">    The processing of document entries is assumed to result in absolute paths.</span>
<span class="sd">    Relative paths are resolved at the parsing stage and at point we want to</span>
<span class="sd">    make sure we don't have to do any further processing on them.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ValidationError</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"Invalid relative path for entry"</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Document</span><span class="p">)</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">filename</span><span class="p">))]</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.validation.validate_duplicate_balances">
<code class="highlight language-python">
validate_duplicate_balances<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.validation.validate_duplicate_balances" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check that balance entries occur only once per day.</p>
<p>Because we do not support time, and the declaration order of entries is
meant to be kept irrelevant, two balance entries with different amounts
should not occur in the file. We do allow two identical balance assertions,
however, because this may occur during import.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/validation.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span> 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_duplicate_balances</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
    <span class="sd">"""Check that balance entries occur only once per day.</span>

<span class="sd">    Because we do not support time, and the declaration order of entries is</span>
<span class="sd">    meant to be kept irrelevant, two balance entries with different amounts</span>
<span class="sd">    should not occur in the file. We do allow two identical balance assertions,</span>
<span class="sd">    however, because this may occur during import.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Mapping of (account, currency, date) to Balance entry.</span>
    <span class="n">balance_entries</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Balance</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">previous_entry</span> <span class="o">=</span> <span class="n">balance_entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">amount</span> <span class="o">!=</span> <span class="n">previous_entry</span><span class="o">.</span><span class="n">amount</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="s2">"Duplicate balance assertion with different amounts"</span><span class="p">,</span>
                        <span class="n">entry</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">balance_entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.validation.validate_duplicate_commodities">
<code class="highlight language-python">
validate_duplicate_commodities<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.validation.validate_duplicate_commodities" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check that commodty entries are unique for each commodity.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/validation.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_duplicate_commodities</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
    <span class="sd">"""Check that commodty entries are unique for each commodity.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Mapping of (account, currency, date) to Balance entry.</span>
    <span class="n">commodity_entries</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Commodity</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">currency</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">previous_entry</span> <span class="o">=</span> <span class="n">commodity_entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">previous_entry</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="s2">"Duplicate commodity directives for '</span><span class="si">{}</span><span class="s2">'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                        <span class="n">entry</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">commodity_entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="beancount.ops.validation.validate_open_close">
<code class="highlight language-python">
validate_open_close<span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">)</span> </code>
<a class="headerlink" href="#beancount.ops.validation.validate_open_close" title="Permanent link"></a></h3>
<div class="doc doc-contents">
<p>Check constraints on open and close directives themselves.</p>
<p>This method checks two kinds of constraints:</p>
<ol>
<li>
<p>An open or a close directive may only show up once for each account. If a
   duplicate is detected, an error is generated.</p>
</li>
<li>
<p>Close directives may only appears if an open directive has been seen
   previous (chronologically).</p>
</li>
<li>
<p>The date of close directives must be strictly greater than their
  corresponding open directive.</p>
</li>
</ol>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>entries</code></td>
<td><code></code></td>
<td>
<p>A list of directives.</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>unused_options_map</code></td>
<td><code></code></td>
<td>
<p>An options map.</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code></code></td>
<td>
<p>A list of new errors, if any were found.</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>beancount/ops/validation.py</code></summary>
<table class="highlighttable">
<tr>
<td class="linenos">
<div class="linenodiv">
<pre><span></span>35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96</pre>
</div>
</td>
<td class="code">
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">validate_open_close</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">unused_options_map</span><span class="p">):</span>
    <span class="sd">"""Check constraints on open and close directives themselves.</span>

<span class="sd">    This method checks two kinds of constraints:</span>

<span class="sd">    1. An open or a close directive may only show up once for each account. If a</span>
<span class="sd">       duplicate is detected, an error is generated.</span>

<span class="sd">    2. Close directives may only appears if an open directive has been seen</span>
<span class="sd">       previous (chronologically).</span>

<span class="sd">    3. The date of close directives must be strictly greater than their</span>
<span class="sd">      corresponding open directive.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of directives.</span>
<span class="sd">      unused_options_map: An options map.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of new errors, if any were found.</span>
<span class="sd">    """</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">open_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">close_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Open</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">account</span> <span class="ow">in</span> <span class="n">open_map</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="s2">"Duplicate open directive for </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">),</span>
                        <span class="n">entry</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">open_map</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Close</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">account</span> <span class="ow">in</span> <span class="n">close_map</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="s2">"Duplicate close directive for </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">),</span>
                        <span class="n">entry</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">open_entry</span> <span class="o">=</span> <span class="n">open_map</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">open_entry</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">ValidationError</span><span class="p">(</span>
                                <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                                <span class="s2">"Internal error: closing date for </span><span class="si">{}</span><span class="s2"> "</span>
                                <span class="s2">"appears before opening date"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">),</span>
                                <span class="n">entry</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">ValidationError</span><span class="p">(</span>
                            <span class="n">entry</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                            <span class="s2">"Unopened account </span><span class="si">{}</span><span class="s2"> is being closed"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">),</span>
                            <span class="n">entry</span><span class="p">))</span>

                <span class="n">close_map</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">account</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre>
</div>
</td>
</tr>
</table>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<footer>
<div aria-label="footer navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-right" href="beancount.utils.html" title="beancount.utils">Next <span class="icon icon-circle-arrow-right"></span></a>
<a class="btn btn-neutral" href="index.html" title="beancount"><span class="icon icon-circle-arrow-left"></span> Previous</a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<a class="fa fa-github" href="https://github.com/xuhcc/beancount-docs/" style="float: left; color: #fcfcfc"> GitHub</a>
<span><a href="index.html" style="color: #fcfcfc;">« Previous</a></span>
<span style="margin-left: 15px"><a href="beancount.utils.html" style="color: #fcfcfc">Next »</a></span>
</span>
</div>
<script>var base_url = '..';</script>
<script defer="" src="../js/theme.js"></script>
<script defer="">
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>
</body>
</html>
